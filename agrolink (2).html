<!doctype html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.socket.io; style-src 'self' 'unsafe-inline'; img-src 'self' data: https: http:; media-src 'self' https: http:; connect-src 'self' https://sehitumitkestitarimmtal.com wss://sehitumitkestitarimmtal.com https://assets.mixkit.co;">
  
  <!-- SEO Meta Tags -->
  <title>AgroLink - Tarƒ±m Sosyal Platformu | Salih √ñzt√ºrk</title>
  <meta name="description" content="AgroLink - T√ºrkiye'nin tarƒ±m sosyal platformu. 14 ya≈üƒ±ndaki gen√ß giri≈üimci Salih √ñzt√ºrk (2011 doƒüumlu) tarafƒ±ndan ≈ûehit √úmit Kesti Tarƒ±m Meslek Lisesi'nde geli≈ütirildi. √áift√ßiler i√ßin sosyal aƒü, tarƒ±m bilgi payla≈üƒ±mƒ± ve topluluk.">
  <meta name="keywords" content="AgroLink, tarƒ±m, sosyal platform, Salih √ñzt√ºrk, ≈ûehit √úmit Kesti Tarƒ±m MTAL, √ßift√ßi, tarƒ±m sosyal aƒü, gen√ß giri≈üimci, 2011, tarƒ±m teknolojisi">
  <meta name="author" content="Salih √ñzt√ºrk - @ozturk_salih5252">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://sehitumitkestitarimmtal.com/">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://sehitumitkestitarimmtal.com/">
  <meta property="og:title" content="AgroLink - Tarƒ±m Sosyal Platformu | Salih √ñzt√ºrk">
  <meta property="og:description" content="14 ya≈üƒ±ndaki Salih √ñzt√ºrk (2011 doƒüumlu) tarafƒ±ndan ≈ûehit √úmit Kesti Tarƒ±m MTAL'de geli≈ütirilen tarƒ±m sosyal platformu. Instagram: @ozturk_salih5252">
  <meta property="og:image" content="https://sehitumitkestitarimmtal.com/og-image.png">
  <meta property="og:site_name" content="AgroLink">
  <meta property="og:locale" content="tr_TR">
  
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://sehitumitkestitarimmtal.com/">
  <meta name="twitter:title" content="AgroLink - Tarƒ±m Sosyal Platformu | Salih √ñzt√ºrk">
  <meta name="twitter:description" content="14 ya≈üƒ±ndaki Salih √ñzt√ºrk tarafƒ±ndan ≈ûehit √úmit Kesti Tarƒ±m MTAL'de geli≈ütirilen tarƒ±m sosyal platformu. Instagram: @ozturk_salih5252">
  <meta name="twitter:image" content="https://sehitumitkestitarimmtal.com/og-image.png">
  <meta name="twitter:creator" content="@ozturk_salih5252">
  
  <!-- Additional SEO -->
  <meta name="geo.region" content="TR">
  <meta name="geo.placename" content="T√ºrkiye">
  <meta name="application-name" content="AgroLink">
  <meta name="theme-color" content="#10b981">
  
  <!-- JSON-LD Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "AgroLink",
    "description": "T√ºrkiye'nin tarƒ±m sosyal platformu - √ßift√ßiler i√ßin sosyal aƒü ve bilgi payla≈üƒ±m platformu",
    "url": "https://sehitumitkestitarimmtal.com/",
    "applicationCategory": "SocialNetworkingApplication",
    "operatingSystem": "Web",
    "author": {
      "@type": "Person",
      "name": "Salih √ñzt√ºrk",
      "birthDate": "2011",
      "sameAs": "https://instagram.com/ozturk_salih5252",
      "affiliation": {
        "@type": "EducationalOrganization",
        "name": "≈ûehit √úmit Kesti Tarƒ±m Meslek ve Teknik Anadolu Lisesi"
      }
    },
    "creator": {
      "@type": "Person",
      "name": "Salih √ñzt√ºrk",
      "description": "14 ya≈üƒ±nda gen√ß giri≈üimci ve yazƒ±lƒ±m geli≈ütirici, 2011 doƒüumlu"
    },
    "publisher": {
      "@type": "EducationalOrganization",
      "name": "≈ûehit √úmit Kesti Tarƒ±m MTAL"
    },
    "keywords": "tarƒ±m, sosyal platform, √ßift√ßi, AgroLink, Salih √ñzt√ºrk"
  }
  </script>
  <style>
    :root {
      --primary-color: #10b981;
      --primary-dark: #059669;
      --primary-light: #34d399;
      --danger-color: #ef4444;
      --danger-dark: #dc2626;
      --text-light: #1e293b;
      --text-dark: #ffffff;
      --bg-light: #ffffff;
      --bg-dark: #0f172a;
      --card-light: rgba(255, 255, 255, 0.9);
      --card-dark: rgba(255, 255, 255, 0.05);
      --border-light: rgba(0, 0, 0, 0.1);
      --border-dark: rgba(255, 255, 255, 0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      background: linear-gradient(145deg, #ffffff 0%, #f8fafc 50%, #e2e8f0 100%);
      color: var(--text-light);
      overflow: hidden;
      -webkit-overflow-scrolling: touch;
      user-select: none;
      touch-action: pan-y;
    }

    body.dark-theme {
      background: linear-gradient(145deg, #000000 0%, #0a0a0a 50%, #1a1a1a 100%);
      color: var(--text-dark);
    }

    .app-wrapper {
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      background: var(--card-light);
      box-shadow: 0 0 80px rgba(16, 185, 129, 0.1);
      position: relative;
      overflow: hidden;
    }

    body.dark-theme .app-wrapper {
      background: rgba(15, 23, 42, 0.7);
    }

    /* Splash Screen */
    .splash-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(145deg, #10b981 0%, #059669 50%, #047857 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeOut 0.8s ease 3.5s forwards;
    }

    @keyframes fadeOut {
      to { opacity: 0; visibility: hidden; }
    }

    .splash-logo {
      width: 120px;
      height: 120px;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border-radius: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 64px;
      margin-bottom: 32px;
      animation: logoFloat 2s ease infinite;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    @keyframes logoFloat {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-20px) scale(1.05); }
    }

    .splash-title {
      font-size: 56px;
      font-weight: 900;
      color: white;
      text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      margin-bottom: 12px;
      letter-spacing: -2px;
      animation: slideIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-50px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .splash-subtitle {
      font-size: 18px;
      color: rgba(255, 255, 255, 0.9);
      font-weight: 500;
      margin-bottom: 60px;
      animation: fadeIn 0.8s ease 0.4s both;
    }

    .splash-from {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      text-transform: uppercase;
      letter-spacing: 4px;
      font-weight: 600;
      animation: fadeIn 0.8s ease 0.8s both;
    }

    /* Auth Screens */
    .auth-screen {
      display: none;
      height: 100%;
      width: 100%;
      align-items: center;
      justify-content: center;
      padding: 24px;
      animation: fadeIn 0.6s ease;
      overflow-y: auto;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }

    .auth-screen.active {
      display: flex;
    }

    .auth-card {
      backdrop-filter: blur(40px);
      background: var(--card-light);
      border: 1px solid var(--border-light);
      border-radius: 28px;
      padding: 40px 28px;
      width: 100%;
      max-width: 420px;
      max-height: 90%;
      overflow-y: auto;
      box-shadow: 0 20px 80px rgba(0, 0, 0, 0.1);
      animation: slideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
      color: var(--text-light);
    }

    body.dark-theme .auth-card {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid var(--border-dark);
      color: var(--text-dark);
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(50px) scale(0.9); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .auth-logo {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      border-radius: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 42px;
      margin: 0 auto 24px;
      box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4);
    }

    .auth-title {
      font-size: 32px;
      font-weight: 800;
      text-align: center;
      margin-bottom: 8px;
      color: var(--text-light);
      letter-spacing: -1px;
    }

    body.dark-theme .auth-title {
      color: var(--text-dark);
    }

    .auth-subtitle {
      text-align: center;
      color: #64748b;
      font-size: 15px;
      margin-bottom: 32px;
      font-weight: 500;
    }

    body.dark-theme .auth-subtitle {
      color: rgba(255, 255, 255, 0.6);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 8px;
    }

    body.dark-theme .form-label {
      color: rgba(255, 255, 255, 0.9);
    }

    .form-input {
      width: 100%;
      padding: 14px 18px;
      border-radius: 14px;
      border: 2px solid var(--border-light);
      background: rgba(255, 255, 255, 0.7);
      font-size: 15px;
      transition: all 0.3s ease;
      font-family: inherit;
      color: var(--text-light);
    }

    body.dark-theme .form-input {
      border: 2px solid var(--border-dark);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-dark);
    }

    .form-input::placeholder {
      color: #94a3b8;
    }

    body.dark-theme .form-input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary-color);
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.15);
    }

    body.dark-theme .form-input:focus {
      background: rgba(255, 255, 255, 0.08);
    }

    .profile-pic-upload {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 24px;
      padding: 24px;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 20px;
      border: 2px dashed rgba(16, 185, 129, 0.3);
    }

    body.dark-theme .profile-pic-upload {
      background: rgba(255, 255, 255, 0.03);
    }

    .profile-pic-preview {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 56px;
      margin-bottom: 16px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 10px 40px rgba(16, 185, 129, 0.3);
      border: 4px solid rgba(255, 255, 255, 0.9);
    }

    body.dark-theme .profile-pic-preview {
      border: 4px solid rgba(255, 255, 255, 0.1);
    }

    .profile-pic-preview:hover {
      transform: scale(1.05) rotate(5deg);
      box-shadow: 0 15px 60px rgba(16, 185, 129, 0.5);
    }

    .profile-pic-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .upload-hint {
      font-size: 13px;
      color: #64748b;
      text-align: center;
    }

    body.dark-theme .upload-hint {
      color: rgba(255, 255, 255, 0.5);
    }

    .captcha-box {
      background: rgba(16, 185, 129, 0.1);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(16, 185, 129, 0.2);
      display: none;
      animation: slideDown 0.3s ease;
    }

    .captcha-box.active {
      display: block;
    }

    .captcha-question {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 12px;
      text-align: center;
    }

    body.dark-theme .captcha-question {
      color: var(--text-dark);
    }

    .checkbox-group {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #64748b;
    }

    body.dark-theme .checkbox-group {
      color: rgba(255, 255, 255, 0.7);
    }

    .checkbox-group input[type="checkbox"] {
      margin-top: 4px;
      cursor: pointer;
      width: 18px;
      height: 18px;
    }

    .checkbox-group a {
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .checkbox-group a:hover {
      color: var(--primary-light);
      text-decoration: underline;
    }

    .primary-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      border: none;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      margin-bottom: 16px;
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
    }

    .primary-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 15px 40px rgba(16, 185, 129, 0.5);
    }

    .primary-btn:active:not(:disabled) {
      transform: translateY(0);
    }

    .primary-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .secondary-link {
      text-align: center;
      font-size: 14px;
      color: #64748b;
      font-weight: 500;
    }

    body.dark-theme .secondary-link {
      color: rgba(255, 255, 255, 0.6);
    }

    .secondary-link a {
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .secondary-link a:hover {
      color: var(--primary-light);
    }

    .privacy-section {
      background: rgba(0, 0, 0, 0.03);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      max-height: 280px;
      overflow-y: auto;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    body.dark-theme .privacy-section {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .privacy-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    body.dark-theme .privacy-title {
      color: var(--text-dark);
    }

    .privacy-item {
      font-size: 13px;
      color: #64748b;
      margin-bottom: 10px;
      padding-left: 24px;
      position: relative;
      line-height: 1.6;
    }

    body.dark-theme .privacy-item {
      color: rgba(255, 255, 255, 0.7);
    }

    .privacy-item::before {
      content: "‚úì";
      position: absolute;
      left: 0;
      color: var(--primary-color);
      font-weight: 700;
      font-size: 16px;
    }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(40px);
      background: rgba(255, 255, 255, 0.8);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-light);
    }

    body.dark-theme .header {
      background: rgba(15, 23, 42, 0.7);
      border-bottom: 1px solid var(--border-dark);
    }

    .header-title {
      font-size: 26px;
      font-weight: 900;
      color: var(--text-light);
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: -1px;
    }

    body.dark-theme .header-title {
      color: var(--text-dark);
    }

    .header-title span {
      font-size: 28px;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .icon-btn {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      border: none;
      background: rgba(0, 0, 0, 0.05);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      font-size: 20px;
      position: relative;
      backdrop-filter: blur(10px);
      color: var(--text-light);
    }

    body.dark-theme .icon-btn {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text-dark);
    }

    .icon-btn:hover {
      transform: translateY(-3px) scale(1.05);
      background: rgba(16, 185, 129, 0.2);
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
    }

    .notification-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: linear-gradient(135deg, var(--danger-color), var(--danger-dark));
      color: white;
      font-size: 11px;
      font-weight: 700;
      min-width: 20px;
      height: 20px;
      border-radius: 10px;
      display: none;
      align-items: center;
      justify-content: center;
      animation: pulse 2s infinite;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5);
      padding: 0 6px;
    }

    .notification-badge.active {
      display: flex;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    /* Search Bar */
    .search-container {
      padding: 16px;
      border-bottom: 1px solid var(--border-light);
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(40px);
      display: none;
    }

    body.dark-theme .search-container {
      background: rgba(15, 23, 42, 0.9);
      border-bottom: 1px solid var(--border-dark);
    }

    .search-input {
      width: 100%;
      padding: 14px 18px;
      border-radius: 16px;
      border: 2px solid var(--border-light);
      background: rgba(255, 255, 255, 0.7);
      font-size: 15px;
      color: var(--text-light);
      font-family: inherit;
      transition: all 0.3s ease;
    }

    body.dark-theme .search-input {
      border: 2px solid var(--border-dark);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-dark);
    }

    .search-input::placeholder {
      color: #94a3b8;
    }

    body.dark-theme .search-input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary-color);
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.15);
    }

    body.dark-theme .search-input:focus {
      background: rgba(255, 255, 255, 0.08);
    }

    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--card-light);
      border: 1px solid var(--border-light);
      border-radius: 16px;
      margin-top: 8px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 10;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      display: none;
    }

    body.dark-theme .search-results {
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid var(--border-dark);
    }

    .search-results.active {
      display: block !important;
    }

    .search-result-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 1px solid var(--border-light);
    }

    body.dark-theme .search-result-item {
      border-bottom: 1px solid var(--border-dark);
    }

    .search-result-item:last-child {
      border-bottom: none;
    }

    .search-result-item:hover {
      background: rgba(16, 185, 129, 0.1);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 0;
      padding-bottom: 100px;
      -webkit-overflow-scrolling: touch;
    }

    .page {
      display: none;
      animation: pageEnter 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .page.active {
      display: block;
    }

    @keyframes pageEnter {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Post Card - YUMU≈ûAK U√áLU */
    /* Instagram-Style Post Card */
    .post-card {
      background: var(--card-light);
      border-radius: 0;
      margin: 0;
      padding: 0;
      box-shadow: none;
      animation: fadeInUp 0.4s ease-out;
      transition: none;
      cursor: default;
      position: relative;
      width: 100%;
      border-bottom: 1px solid var(--border-light);
    }

    body.dark-theme .post-card {
      background: rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid var(--border-dark);
      box-shadow: none;
    }

    .post-card:hover {
      transform: none;
      box-shadow: none;
      background: var(--card-light);
    }

    body.dark-theme .post-card:hover {
      background: rgba(0, 0, 0, 0.3);
      box-shadow: none;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .post-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 0;
      padding: 12px 16px;
    }

    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 20px;
      overflow: hidden;
      transition: all 0.3s ease;
      border: 2px solid rgba(16, 185, 129, 0.3);
      cursor: pointer;
      flex-shrink: 0;
    }

    .avatar:hover {
      transform: scale(1.1) rotate(5deg);
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .post-user-info {
      flex: 1;
      cursor: pointer;
      min-width: 0;
    }

    .post-user-info h3 {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    body.dark-theme .post-user-info h3 {
      color: var(--text-dark);
    }

    .post-user-info p {
      font-size: 13px;
      color: #64748b;
      font-weight: 500;
    }

    body.dark-theme .post-user-info p {
      color: rgba(255, 255, 255, 0.5);
    }

    .post-content {
      color: var(--text-light);
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 0;
      word-break: break-word;
      padding: 8px 16px 12px 16px;
    }

    body.dark-theme .post-content {
      color: rgba(255, 255, 255, 0.9);
    }

    .post-media {
      width: 100%;
      border-radius: 0;
      margin-bottom: 16px;
      max-height: none;
      height: auto;
      object-fit: contain;
      transition: all 0.3s ease;
      cursor: pointer;
      background: #f8fafc;
      display: block;
    }

    body.dark-theme .post-media {
      background: #1e293b;
    }

    .post-media:hover {
      transform: none;
      box-shadow: none;
    }

    .fullscreen-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(10px);
      z-index: 300;
      display: none;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
      padding: 20px;
    }

    .fullscreen-modal.active {
      display: flex;
    }

    .fullscreen-content {
      max-width: 90%;
      max-height: 90%;
      position: relative;
      animation: zoomIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes zoomIn {
      from {
        opacity: 0;
        transform: scale(0.5);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .fullscreen-content img,
    .fullscreen-content video {
      max-width: 100%;
      max-height: 85vh;
      border-radius: 16px;
      box-shadow: 0 20px 80px rgba(0, 0, 0, 0.8);
    }

    .fullscreen-close {
      position: absolute;
      top: -50px;
      right: 0;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      font-size: 28px;
      cursor: pointer;
      color: #ffffff;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
    }

    .fullscreen-close:hover {
      background: rgba(239, 68, 68, 0.3);
      transform: rotate(90deg);
    }

    .post-actions {
      display: flex;
      gap: 4px;
      padding: 8px 12px 12px 12px;
      border-top: none;
    }

    body.dark-theme .post-actions {
      border-top: none;
    }

    .action-btn {
      flex: 1;
      padding: 10px;
      background: rgba(0, 0, 0, 0.05);
      border: none;
      border-radius: 12px;
      color: #64748b;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    body.dark-theme .action-btn {
      background: rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.7);
    }

    .action-btn:hover {
      background: rgba(16, 185, 129, 0.15);
      color: var(--primary-color);
      transform: translateY(-2px);
    }

    .action-btn.liked {
      color: var(--danger-color);
      background: rgba(239, 68, 68, 0.15);
    }

    .like-btn.liked .heart-icon {
      fill: var(--danger-color);
      animation: heartBeat 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .action-btn.saved {
      color: var(--primary-color);
      background: rgba(16, 185, 129, 0.15);
    }

    @keyframes heartBeat {
      0% { transform: scale(1); }
      25% { transform: scale(1.3); }
      50% { transform: scale(0.9); }
      75% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    .comments-section {
      border-top: 1px solid var(--border-light);
      padding-top: 16px;
      margin-top: 16px;
      animation: slideDown 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    body.dark-theme .comments-section {
      border-top: 1px solid var(--border-dark);
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
        max-height: 0;
      }
      to {
        opacity: 1;
        transform: translateY(0);
        max-height: 600px;
      }
    }

    .comments-list {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 16px;
    }

    .comment-item {
      display: flex;
      gap: 12px;
      padding: 12px;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 12px;
      margin-bottom: 10px;
      animation: fadeInUp 0.3s ease-out;
    }

    body.dark-theme .comment-item {
      background: rgba(0, 0, 0, 0.03);
    }

    .comment-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
      overflow: hidden;
      border: 2px solid rgba(16, 185, 129, 0.2);
    }

    .comment-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .comment-content {
      flex: 1;
      min-width: 0;
    }

    .comment-username {
      font-weight: 700;
      color: #1e293b !important;
      font-size: 14px;
      margin-bottom: 4px;
      cursor: pointer;
    }

    body.dark-theme .comment-username {
      color: #1e293b !important;
    }

    .comment-text {
      color: #64748b !important;
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 4px;
      word-break: break-word;
    }

    body.dark-theme .comment-text {
      color: #64748b !important;
    }

    .comment-time {
      font-size: 12px;
      color: #94a3b8 !important;
    }

    body.dark-theme .comment-time {
      color: #94a3b8 !important;
    }

    .comment-input-container {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .comment-input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 20px;
      border: 2px solid var(--border-light);
      background: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      color: var(--text-light);
      font-family: inherit;
      transition: all 0.3s ease;
    }

    body.dark-theme .comment-input {
      border: 2px solid var(--border-dark);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-dark);
    }

    .comment-input::placeholder {
      color: #94a3b8;
    }

    body.dark-theme .comment-input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .comment-input:focus {
      outline: none;
      border-color: var(--primary-color);
      background: rgba(255, 255, 255, 0.9);
    }

    body.dark-theme .comment-input:focus {
      background: rgba(255, 255, 255, 0.08);
    }

    .send-comment-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
    }

    .send-comment-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
    }

    .follow-btn {
      padding: 6px 14px;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
      white-space: nowrap;
      flex-shrink: 0;
    }

    .follow-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.5);
    }

    .follow-btn.following {
      background: rgba(16, 185, 129, 0.15);
      color: var(--primary-color);
      box-shadow: none;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    body.dark-theme .follow-btn.following {
      background: rgba(16, 185, 129, 0.2);
      color: var(--primary-light);
      border: 1px solid rgba(16, 185, 129, 0.4);
    }

    .follow-btn.following:hover {
      background: rgba(239, 68, 68, 0.15);
      color: var(--danger-color);
      border-color: rgba(239, 68, 68, 0.3);
    }

    .block-btn {
      padding: 8px 20px;
      background: linear-gradient(135deg, var(--danger-color), var(--danger-dark));
      color: white;
      border: none;
      border-radius: 24px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
      white-space: nowrap;
    }

    .block-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
    }

    /* Bottom Navigation - Modern Glass Morphism Design */
    .bottom-nav {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      backdrop-filter: blur(30px) saturate(180%);
      -webkit-backdrop-filter: blur(30px) saturate(180%);
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%);
      border-radius: 28px;
      padding: 10px 16px;
      display: flex;
      gap: 6px;
      align-items: center;
      box-shadow: 
        0 20px 60px rgba(16, 185, 129, 0.15),
        0 8px 32px rgba(0, 0, 0, 0.08),
        inset 0 1px 1px rgba(255, 255, 255, 0.8);
      z-index: 100;
      border: 1px solid rgba(255, 255, 255, 0.6);
    }

    body.dark-theme .bottom-nav {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.85) 0%, rgba(30, 41, 59, 0.75) 100%);
      box-shadow: 
        0 20px 60px rgba(16, 185, 129, 0.2),
        0 8px 32px rgba(0, 0, 0, 0.3),
        inset 0 1px 1px rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .nav-item {
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      padding: 14px 18px;
      border-radius: 18px;
      color: #64748b;
      font-size: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-item::before {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 50%;
      transform: translateX(-50%) scaleX(0);
      width: 20px;
      height: 3px;
      background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
      border-radius: 2px;
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    body.dark-theme .nav-item {
      color: rgba(255, 255, 255, 0.5);
    }

    .nav-item:hover {
      transform: translateY(-6px) scale(1.08);
      color: var(--primary-color);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.12) 0%, rgba(16, 185, 129, 0.06) 100%);
    }

    .nav-item:hover svg {
      filter: drop-shadow(0 4px 8px rgba(16, 185, 129, 0.3));
    }

    .nav-item.active {
      color: var(--primary-color);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.18) 0%, rgba(16, 185, 129, 0.08) 100%);
      box-shadow: 0 4px 16px rgba(16, 185, 129, 0.2);
    }

    .nav-item.active::before {
      transform: translateX(-50%) scaleX(1);
    }

    .nav-item.active svg {
      filter: drop-shadow(0 2px 6px rgba(16, 185, 129, 0.4));
    }

    .nav-item.add-post {
      background: linear-gradient(145deg, var(--primary-color) 0%, var(--primary-dark) 50%, #047857 100%);
      color: white;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: -8px 6px;
      font-size: 26px;
      box-shadow: 
        0 8px 24px rgba(16, 185, 129, 0.4),
        0 4px 12px rgba(16, 185, 129, 0.3),
        inset 0 2px 4px rgba(255, 255, 255, 0.3);
      position: relative;
      overflow: hidden;
    }

    .nav-item.add-post::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 200%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .nav-item.add-post:hover::before {
      left: 100%;
    }

    .nav-item.add-post:hover {
      transform: translateY(-10px) scale(1.12) rotate(90deg);
      box-shadow: 
        0 16px 40px rgba(16, 185, 129, 0.5),
        0 8px 24px rgba(16, 185, 129, 0.4),
        inset 0 2px 4px rgba(255, 255, 255, 0.3);
    }

    .nav-item.add-post:active {
      transform: translateY(-6px) scale(1.05) rotate(90deg);
    }

    /* Ripple effect for nav items */
    .nav-item {
      overflow: hidden;
    }

    .nav-item::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(16, 185, 129, 0.3) 0%, transparent 70%);
      transform: scale(0);
      opacity: 0;
      transition: transform 0.5s ease, opacity 0.3s ease;
    }

    .nav-item:active::after {
      transform: scale(2);
      opacity: 1;
      transition: transform 0s, opacity 0s;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 200;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
      width: 100%;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      backdrop-filter: blur(40px);
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid var(--border-light);
      border-radius: 28px;
      padding: 28px;
      max-width: 440px;
      width: 100%;
      animation: modalEnter 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      max-height: 85%;
      overflow-y: auto;
      box-shadow: 0 20px 80px rgba(0, 0, 0, 0.1);
      color: var(--text-light);
    }

    body.dark-theme .modal-content {
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid var(--border-dark);
      color: var(--text-dark);
    }

    @keyframes modalEnter {
      from {
        opacity: 0;
        transform: scale(0.8) translateY(50px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-title {
      font-size: 22px;
      font-weight: 800;
      color: var(--text-light);
    }

    body.dark-theme .modal-title {
      color: var(--text-dark);
    }

    .close-btn {
      background: rgba(0, 0, 0, 0.08);
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      color: #64748b;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    body.dark-theme .close-btn {
      background: rgba(255, 255, 255, 0.08);
      color: rgba(255, 255, 255, 0.7);
    }

    .close-btn:hover {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger-color);
      transform: rotate(90deg);
    }

    .textarea-field {
      width: 100%;
      padding: 16px 18px;
      border-radius: 16px;
      border: 2px solid var(--border-light);
      background: rgba(255, 255, 255, 0.7);
      font-size: 15px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
      font-family: inherit;
      resize: vertical;
      min-height: 120px;
      color: var(--text-light);
    }

    body.dark-theme .textarea-field {
      border: 2px solid var(--border-dark);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-dark);
    }

    .textarea-field::placeholder {
      color: #94a3b8;
    }

    body.dark-theme .textarea-field::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .textarea-field:focus {
      outline: none;
      border-color: var(--primary-color);
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.15);
    }

    body.dark-theme .textarea-field:focus {
      background: rgba(255, 255, 255, 0.08);
    }

    /* Profile Page */
    .profile-header {
      backdrop-filter: blur(40px);
      background: var(--card-light);
      border: 1px solid var(--border-light);
      border-radius: 0;
      padding: 20px 16px;
      text-align: left;
      margin-bottom: 0;
      box-shadow: none;
    }

    body.dark-theme .profile-header {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-dark);
    }

    .profile-cover {
      width: calc(100% + 32px);
      height: 120px;
      margin: -20px -16px 20px;
      border-radius: 0;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .profile-cover:hover {
      opacity: 0.9;
    }

    .profile-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-cover::before {
      content: '';
      position: absolute;
      inset: 0;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }

    .profile-avatar-container {
      position: relative;
      display: inline-block;
      margin-bottom: 16px;
    }

    .profile-avatar-large {
      width: 80px;
      height: 80px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 32px;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      overflow: hidden;
      border: 3px solid rgba(255, 255, 255, 0.9);
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
    }

    body.dark-theme .profile-avatar-large {
      border: 3px solid rgba(15, 23, 42, 0.95);
    }

    .profile-avatar-large:hover {
      transform: scale(1.05);
      box-shadow: 0 15px 40px rgba(16, 185, 129, 0.5);
    }

    .profile-avatar-large img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-name {
      font-size: 20px;
      font-weight: 900;
      color: var(--text-light);
      margin-bottom: 4px;
      letter-spacing: -0.5px;
    }

    body.dark-theme .profile-name {
      color: var(--text-dark);
    }

    .profile-username {
      font-size: 14px;
      color: #64748b;
      margin-bottom: 8px;
      font-weight: 500;
    }

    body.dark-theme .profile-username {
      color: rgba(255, 255, 255, 0.5);
    }

    .profile-bio {
      font-size: 14px;
      color: #64748b;
      margin-bottom: 16px;
      line-height: 1.6;
      max-width: 100%;
    }

    body.dark-theme .profile-bio {
      color: rgba(255, 255, 255, 0.7);
    }

    .profile-bio a {
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 600;
    }

    .profile-bio a:hover {
      text-decoration: underline;
    }

    .profile-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .profile-action-btn {
      flex: 1;
      padding: 6px 4px;
      background: rgba(0, 0, 0, 0.05);
      border: 1px solid var(--border-light);
      border-radius: 6px;
      color: var(--text-light);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    body.dark-theme .profile-action-btn {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-dark);
      border: 1px solid var(--border-dark);
    }

    .profile-action-btn:hover {
      background: rgba(16, 185, 129, 0.15);
    }

    .profile-action-btn.primary {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      border: none;
    }

    .profile-stats {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-light);
    }

    body.dark-theme .profile-stats {
      border-top: 1px solid var(--border-dark);
    }

    /* Yeni dikd√∂rtgen ye≈üil butonlar i√ßin stil */
    /* Takip√ßi/Takip Butonlarƒ± - D√úZELTME: Ta≈üma sorunu √ß√∂z√ºld√º */
    .profile-follow-buttons {
      display: flex;
      gap: 8px;
      width: 100%;
      max-width: 100%;
      overflow: hidden;
    }

    .profile-follow-btn {
      flex: 1;
      min-width: 0;
      padding: 10px 8px;
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .profile-follow-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .profile-follow-btn:active {
      transform: translateY(0);
    }
    
    .profile-follow-btn span {
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .profile-posts-stat {
      text-align: center;
      padding: 12px;
      background: rgba(16, 185, 129, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    body.dark-theme .profile-posts-stat {
      background: rgba(16, 185, 129, 0.1);
    }

    .stat {
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 4px;
      border-radius: 6px;
      background: rgba(0, 0, 0, 0.03);
      flex: 1;
    }

    body.dark-theme .stat {
      background: rgba(255, 255, 255, 0.03);
    }

    .stat:hover {
      transform: translateY(-2px);
      background: rgba(16, 185, 129, 0.1);
    }

    .stat-number {
      font-size: 14px;
      font-weight: 900;
      color: var(--primary-color);
      display: block;
      margin-bottom: 2px;
    }

    .stat-label {
      font-size: 9px;
      color: #64748b;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    body.dark-theme .stat-label {
      color: rgba(255, 255, 255, 0.6);
    }

    .profile-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 0;
      padding: 8px;
    }

    .profile-post {
      aspect-ratio: 1;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    body.dark-theme .profile-post {
      background: rgba(255, 255, 255, 0.03);
    }

    .profile-post:hover {
      opacity: 0.8;
    }

    .profile-post img,
    .profile-post video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-post-multiple {
      position: relative;
    }

    .profile-post-multiple::after {
      content: "üì∑";
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 14px;
      color: white;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    }

    .edit-profile-btn {
      width: 100%;
      padding: 12px;
      background: rgba(0, 0, 0, 0.05);
      border: 2px solid rgba(16, 185, 129, 0.3);
      color: var(--primary-color);
      border-radius: 16px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 16px;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    body.dark-theme .edit-profile-btn {
      background: rgba(255, 255, 255, 0.08);
    }

    .edit-profile-btn:hover {
      background: rgba(16, 185, 129, 0.15);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
    }

    .media-upload-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    .media-upload-btn {
      padding: 14px;
      background: rgba(0, 0, 0, 0.05);
      border: 2px dashed rgba(16, 185, 129, 0.3);
      border-radius: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 700;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    body.dark-theme .media-upload-btn {
      background: rgba(255, 255, 255, 0.05);
    }

    .media-upload-btn:hover {
      background: rgba(16, 185, 129, 0.1);
      border-color: var(--primary-color);
      transform: translateY(-2px);
    }

    #mediaPreview img, #mediaPreview video {
      max-width: 100%;
      border-radius: 16px;
      margin-top: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }

    /* Store Page */
    .store-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      padding: 16px;
    }

    .store-item {
      background: var(--card-light);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
      border: 1px solid var(--border-light);
    }

    body.dark-theme .store-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-dark);
    }

    .store-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .store-item-image {
      width: 100%;
      height: 160px;
      object-fit: cover;
    }

    .store-item-info {
      padding: 16px;
    }

    .store-item-name {
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 8px;
      font-size: 16px;
    }

    body.dark-theme .store-item-name {
      color: var(--text-dark);
    }

    .store-item-price {
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 12px;
      font-size: 18px;
    }

    .store-item-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .contact-seller-btn {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 8px 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .contact-seller-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
    }

    .add-product-btn {
      position: fixed;
      bottom: 100px;
      right: 20px;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
      z-index: 99;
      transition: all 0.3s ease;
    }

    .add-product-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.5);
    }

    /* Add Product Modal */
    .product-form-group {
      margin-bottom: 20px;
    }

    .product-preview {
      width: 100%;
      max-height: 200px;
      object-fit: contain;
      border-radius: 12px;
      margin-bottom: 16px;
      background: #f8fafc;
    }

    body.dark-theme .product-preview {
      background: #1e293b;
    }

    /* Messages */
    .chat-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
    }

    .chat-item {
      backdrop-filter: blur(40px);
      background: var(--card-light);
      border: 1px solid var(--border-light);
      border-radius: 20px;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    body.dark-theme .chat-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-dark);
    }

    .chat-item:hover {
      transform: translateX(8px);
      background: rgba(16, 185, 129, 0.1);
      border-color: rgba(16, 185, 129, 0.3);
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.2);
    }

    .online-indicator {
      width: 12px;
      height: 12px;
      background: var(--primary-color);
      border-radius: 50%;
      position: absolute;
      bottom: 2px;
      right: 2px;
      border: 3px solid rgba(255, 255, 255, 0.9);
      animation: pulse 2s infinite;
      box-shadow: 0 0 10px rgba(16, 185, 129, 0.8);
    }

    body.dark-theme .online-indicator {
      border: 3px solid rgba(15, 23, 42, 0.95);
    }

    .chat-info {
      flex: 1;
      min-width: 0;
    }

    .chat-name {
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 4px;
      font-size: 15px;
    }

    body.dark-theme .chat-name {
      color: var(--text-dark);
    }

    .chat-preview {
      font-size: 14px;
      color: #64748b;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    body.dark-theme .chat-preview {
      color: rgba(255, 255, 255, 0.5);
    }

    .chat-time {
      font-size: 12px;
      color: #94a3b8;
      font-weight: 600;
    }

    body.dark-theme .chat-time {
      color: rgba(255, 255, 255, 0.4);
    }

    .unread-badge {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    /* Chat Screen */
    .chat-screen {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .chat-header {
      backdrop-filter: blur(40px);
      background: rgba(255, 255, 255, 0.9);
      padding: 20px 24px;
      display: flex;
      align-items: center;
      gap: 14px;
      border-bottom: 1px solid var(--border-light);
    }

    body.dark-theme .chat-header {
      background: rgba(15, 23, 42, 0.9);
      border-bottom: 1px solid var(--border-dark);
    }

    .back-btn {
      background: rgba(0, 0, 0, 0.08);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      color: var(--text-light);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    body.dark-theme .back-btn {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text-dark);
    }

    .back-btn:hover {
      background: rgba(16, 185, 129, 0.2);
      transform: translateX(-4px);
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      max-width: 75%;
      padding: 14px 18px;
      border-radius: 20px;
      animation: slideUp 0.3s ease;
      font-size: 15px;
      line-height: 1.5;
    }

    .message.sent {
      align-self: flex-end;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      border-bottom-right-radius: 6px;
      box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
    }

    .message.received {
      align-self: flex-start;
      background: rgba(0, 0, 0, 0.05);
      color: var(--text-light);
      border-bottom-left-radius: 6px;
      border: 1px solid var(--border-light);
    }

    body.dark-theme .message.received {
      background: rgba(255, 255, 255, 0.08);
      color: rgba(255, 255, 255, 0.9);
      border: 1px solid var(--border-dark);
    }

    .message-media {
      max-width: 220px;
      border-radius: 16px;
      margin-top: 8px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    }

    .message-status {
      font-size: 10px;
      text-align: right;
      margin-top: 4px;
      color: rgba(255, 255, 255, 0.7);
    }

    .message-status.read {
      color: #60a5fa;
    }

    .chat-input-container {
      backdrop-filter: blur(40px);
      background: rgba(255, 255, 255, 0.9);
      padding: 20px 24px;
      display: flex;
      gap: 12px;
      align-items: center;
      border-top: 1px solid var(--border-light);
      position: sticky;
      bottom: 0;
    }

    body.dark-theme .chat-input-container {
      background: rgba(15, 23, 42, 0.9);
      border-top: 1px solid var(--border-dark);
    }

    .chat-input {
      flex: 1;
      padding: 14px 20px;
      border-radius: 24px;
      border: 2px solid var(--border-light);
      background: rgba(255, 255, 255, 0.7);
      font-size: 15px;
      color: var(--text-light);
      font-family: inherit;
      transition: all 0.3s ease;
    }

    body.dark-theme .chat-input {
      border: 2px solid var(--border-dark);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-dark);
    }

    .chat-input::placeholder {
      color: #94a3b8;
    }

    body.dark-theme .chat-input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .chat-input:focus {
      outline: none;
      border-color: var(--primary-color);
      background: rgba(255, 255, 255, 0.9);
    }

    body.dark-theme .chat-input:focus {
      background: rgba(255, 255, 255, 0.08);
    }

    .send-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .send-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 28px rgba(16, 185, 129, 0.6);
    }

    /* Notifications Panel */
    .notifications-panel {
      position: fixed;
      top: 80px;
      right: -380px;
      width: 340px;
      max-height: 70%;
      backdrop-filter: blur(40px);
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid var(--border-light);
      border-radius: 24px;
      padding: 24px;
      overflow-y: auto;
      z-index: 150;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 20px 80px rgba(0, 0, 0, 0.1);
    }

    body.dark-theme .notifications-panel {
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid var(--border-dark);
    }

    .notifications-panel.active {
      right: 24px;
    }

    .notification-item {
      display: flex;
      gap: 14px;
      padding: 16px;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid var(--border-light);
    }

    body.dark-theme .notification-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-dark);
    }

    .notification-item:hover {
      transform: translateX(-4px);
      background: rgba(16, 185, 129, 0.1);
      border-color: rgba(16, 185, 129, 0.3);
    }

    .notification-item.unread {
      border-left: 4px solid var(--primary-color);
      background: rgba(16, 185, 129, 0.08);
    }

    .notification-icon {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      flex-shrink: 0;
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
    }

    .notification-content {
      flex: 1;
      min-width: 0;
    }

    .notification-text {
      font-size: 14px;
      color: var(--text-light);
      margin-bottom: 4px;
      font-weight: 500;
      line-height: 1.5;
    }

    body.dark-theme .notification-text {
      color: rgba(255, 255, 255, 0.9);
    }

    .notification-time {
      font-size: 12px;
      color: #94a3b8;
      font-weight: 600;
    }

    body.dark-theme .notification-time {
      color: rgba(255, 255, 255, 0.4);
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 110px;
      left: 50%;
      transform: translateX(-50%);
      backdrop-filter: blur(40px);
      background: rgba(255, 255, 255, 0.95);
      color: var(--text-light);
      padding: 16px 28px;
      border-radius: 16px;
      font-size: 14px;
      font-weight: 600;
      z-index: 1000;
      animation: slideUp 0.3s ease;
      display: none;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--border-light);
    }

    body.dark-theme .toast {
      background: rgba(15, 23, 42, 0.95);
      color: white;
      border: 1px solid var(--border-dark);
    }

    .toast.active {
      display: block;
    }

    .toast.error {
      background: rgba(239, 68, 68, 0.95);
      border-color: rgba(239, 68, 68, 0.3);
      color: white;
    }

    .toast.success {
      background: rgba(16, 185, 129, 0.95);
      border-color: rgba(16, 185, 129, 0.3);
      color: white;
    }

    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 80px 20px;
    }

    .empty-icon {
      font-size: 72px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .empty-text {
      font-size: 16px;
      color: #64748b;
      font-weight: 600;
    }

    body.dark-theme .empty-text {
      color: rgba(255, 255, 255, 0.5);
    }

    /* Settings */
    .settings-menu {
      backdrop-filter: blur(40px);
      background: var(--card-light);
      border: 1px solid var(--border-light);
      border-radius: 24px;
      padding: 24px;
      margin: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }

    body.dark-theme .settings-menu {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-dark);
    }

    .settings-title {
      font-size: 26px;
      font-weight: 900;
      color: var(--text-light);
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      letter-spacing: -0.5px;
    }

    body.dark-theme .settings-title {
      color: var(--text-dark);
    }

    .settings-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid var(--border-light);
    }

    body.dark-theme .settings-item {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-dark);
    }

    .settings-item:hover {
      transform: translateX(6px);
      background: rgba(16, 185, 129, 0.1);
      border-color: rgba(16, 185, 129, 0.3);
    }

    .settings-label {
      font-weight: 700;
      color: var(--text-light);
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    body.dark-theme .settings-label {
      color: var(--text-dark);
    }

    /* Theme Toggle Switch */
    .theme-switch {
      position: relative;
      width: 56px;
      height: 30px;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid rgba(0, 0, 0, 0.1);
    }

    body.dark-theme .theme-switch {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.1);
    }

    .theme-switch.active {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      border-color: var(--primary-color);
    }

    .theme-switch-slider {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 22px;
      height: 22px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
    }

    .theme-switch.active .theme-switch-slider {
      transform: translateX(26px);
    }

    /* Followers/Following Modal */
    .user-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 400px;
      overflow-y: auto;
    }

    .user-list-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid var(--border-light);
    }

    body.dark-theme .user-list-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-dark);
    }

    .user-list-item:hover {
      background: rgba(16, 185, 129, 0.1);
      border-color: rgba(16, 185, 129, 0.3);
      transform: translateX(6px);
    }

    .user-list-info {
      flex: 1;
      min-width: 0;
    }

    .user-list-name {
      font-weight: 700;
      color: var(--text-light);
      font-size: 15px;
      margin-bottom: 2px;
    }

    body.dark-theme .user-list-name {
      color: var(--text-dark);
    }

    .user-list-username {
      font-size: 13px;
      color: #64748b;
    }

    body.dark-theme .user-list-username {
      color: rgba(255, 255, 255, 0.5);
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.02);
      border-radius: 10px;
    }

    body.dark-theme ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(16, 185, 129, 0.3);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(16, 185, 129, 0.5);
    }

    /* Refresh Button */
    .refresh-btn {
      background: rgba(0, 0, 0, 0.05);
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #64748b;
    }

    body.dark-theme .refresh-btn {
      background: rgba(255, 255, 255, 0.08);
      color: rgba(255, 255, 255, 0.7);
    }

    .refresh-btn:hover {
      background: rgba(16, 185, 129, 0.2);
      color: var(--primary-color);
      transform: rotate(180deg);
    }

    /* Responsive Adjustments */
    @media (max-width: 480px) {
      .auth-card {
        padding: 32px 20px;
      }

      .profile-stats {
        gap: 12px;
      }

      .stat {
        padding: 8px;
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
        max-height: 0;
      }
      to {
        opacity: 1;
        transform: translateY(0);
        max-height: 600px;
      }
    }

    .media-upload-label {
      display: block;
      cursor: pointer;
      padding: 14px;
      background: rgba(0, 0, 0, 0.05);
      border: 2px dashed rgba(16, 185, 129, 0.3);
      border-radius: 16px;
      text-align: center;
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 700;
      color: var(--primary-color);
    }

    body.dark-theme .media-upload-label {
      background: rgba(255, 255, 255, 0.05);
    }

    .media-upload-label:hover {
      background: rgba(16, 185, 129, 0.1);
      border-color: var(--primary-color);
      transform: translateY(-2px);
    }

    .profile-pic-edit {
      position: absolute;
      bottom: 5px;
      right: 5px;
      width: 32px;
      height: 32px;
      background: rgba(16, 185, 129, 0.9);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid rgba(255, 255, 255, 0.9);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    body.dark-theme .profile-pic-edit {
      border: 2px solid rgba(15, 23, 42, 0.95);
    }

    .profile-pic-edit:hover {
      transform: scale(1.1);
      background: rgba(16, 185, 129, 1);
    }

    .push-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid var(--border-light);
      border-radius: 16px;
      padding: 16px;
      max-width: 320px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      z-index: 10000;
      animation: slideInRight 0.3s ease;
      backdrop-filter: blur(20px);
      color: var(--text-light);
    }

    body.dark-theme .push-notification {
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid var(--border-dark);
      color: var(--text-dark);
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .push-notification.hide {
      animation: slideOutRight 0.3s ease forwards;
    }

    @keyframes slideOutRight {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }

    .push-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .push-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      overflow: hidden;
    }

    .push-title {
      font-weight: 700;
      color: var(--text-light);
      font-size: 14px;
    }

    body.dark-theme .push-title {
      color: var(--text-dark);
    }

    .push-content {
      color: #64748b;
      font-size: 13px;
      line-height: 1.4;
    }

    body.dark-theme .push-content {
      color: rgba(255, 255, 255, 0.8);
    }

    .push-time {
      color: #94a3b8;
      font-size: 11px;
      margin-top: 8px;
    }

    body.dark-theme .push-time {
      color: rgba(255, 255, 255, 0.5);
    }

    .global-audio-control {
      position: fixed;
      top: 80px;
      left: 20px;
      z-index: 200;
      backdrop-filter: blur(20px);
      background: rgba(255, 255, 255, 0.9);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    body.dark-theme .global-audio-control {
      background: rgba(15, 23, 42, 0.9);
    }

    .global-audio-control:hover {
      transform: scale(1.1);
    }

    .profile-gallery-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .profile-gallery-modal.active {
      display: flex;
    }

    .gallery-container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .gallery-header {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
    }

    .gallery-content {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .gallery-item {
      max-width: 100%;
      max-height: 80vh;
      object-fit: contain;
    }

    .gallery-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.2);
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      color: white;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .gallery-nav:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .gallery-nav.prev {
      left: 20px;
    }

    .gallery-nav.next {
      right: 20px;
    }

    .views-count {
      font-size: 12px;
      color: #94a3b8;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .background-process {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      backdrop-filter: blur(40px);
      background: rgba(255, 255, 255, 0.95);
      padding: 12px 24px;
      border-radius: 24px;
      display: none;
      align-items: center;
      gap: 12px;
      z-index: 1000;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .background-process.active {
      display: flex;
    }

    body.dark-theme .background-process {
      background: rgba(15, 23, 42, 0.95);
    }

    .new-message-modal .user-search {
      margin-bottom: 20px;
    }

    .user-search-results {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 16px;
    }

    .user-search-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 16px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    body.dark-theme .user-search-item {
      background: rgba(255, 255, 255, 0.05);
    }

    .user-search-item:hover {
      background: rgba(16, 185, 129, 0.1);
    }

    .fullscreen-post-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 1000;
      display: none;
      flex-direction: column;
    }

    .fullscreen-post-modal.active {
      display: flex;
    }

    .fullscreen-post-header {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .fullscreen-post-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      padding: 20px;
    }

    .fullscreen-post-textarea {
      flex: 1;
      background: transparent;
      border: none;
      color: white;
      font-size: 18px;
      line-height: 1.6;
      resize: none;
      outline: none;
      font-family: inherit;
      margin-bottom: 20px;
    }

    .fullscreen-post-textarea::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .fullscreen-post-media-preview {
      max-width: 100%;
      max-height: 300px;
      border-radius: 16px;
      margin-bottom: 20px;
      object-fit: contain;
    }

    .fullscreen-post-actions {
      display: flex;
      gap: 12px;
      padding: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .loading-indicator {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .loading-indicator.active {
      display: block;
    }

    .fullscreen-profile-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 2000;
      display: none;
      flex-direction: column;
    }

    .fullscreen-profile-modal.active {
      display: flex;
    }

    .fullscreen-profile-header {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .fullscreen-profile-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .fullscreen-profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      overflow: hidden;
      border: 4px solid rgba(255, 255, 255, 0.9);
    }

    .fullscreen-profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .fullscreen-profile-name {
      font-size: 24px;
      font-weight: 900;
      color: white;
      text-align: center;
      margin-bottom: 8px;
    }

    .fullscreen-profile-username {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.7);
      text-align: center;
      margin-bottom: 16px;
    }

    .fullscreen-profile-bio {
      color: rgba(255, 255, 255, 0.8);
      text-align: center;
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .fullscreen-profile-stats {
      display: flex;
      justify-content: space-around;
      margin-bottom: 24px;
    }

    .fullscreen-profile-stat {
      text-align: center;
    }

    .fullscreen-profile-stat-number {
      font-size: 20px;
      font-weight: 900;
      color: var(--primary-color);
      display: block;
    }

    .fullscreen-profile-stat-label {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .fullscreen-profile-actions {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
    }

    .fullscreen-profile-action-btn {
      flex: 1;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 16px;
      color: white;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .fullscreen-profile-action-btn.primary {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    }

    .fullscreen-profile-action-btn:hover {
      transform: translateY(-2px);
    }

    .fullscreen-profile-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 2px;
    }

    .fullscreen-profile-post {
      aspect-ratio: 1;
      background: rgba(255, 255, 255, 0.05);
      overflow: hidden;
      cursor: pointer;
    }

    .fullscreen-profile-post img,
    .fullscreen-profile-post video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-cover-edit {
      position: absolute;
      bottom: 10px;
      right: 10px;
      width: 36px;
      height: 36px;
      background: rgba(16, 185, 129, 0.9);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid rgba(255, 255, 255, 0.9);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    body.dark-theme .profile-cover-edit {
      border: 2px solid rgba(15, 23, 42, 0.95);
    }

    .profile-cover-edit:hover {
      transform: scale(1.1);
      background: rgba(16, 185, 129, 1);
    }

    .comments-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #ffffff !important;
      z-index: 1000;
      display: none;
      flex-direction: column;
    }

    body.dark-theme .comments-modal {
      background: #ffffff !important;
    }

    .comments-modal.active {
      display: flex;
    }

    .comments-modal-header {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #1e293b !important;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      background: #ffffff;
    }

    body.dark-theme .comments-modal-header {
      color: #1e293b !important;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      background: #ffffff;
    }

    .comments-modal-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      background: #ffffff !important;
    }

    body.dark-theme .comments-modal-content {
      background: #ffffff !important;
    }

    .comments-modal-form {
      margin-top: auto;
      padding: 16px 20px;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      background: #ffffff !important;
      backdrop-filter: blur(10px);
      position: sticky;
      bottom: 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .video-container {
      position: relative;
      width: 100%;
      height: 100vh;
      overflow: hidden;
    }

    .video-slide {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    .video-slide.active {
      opacity: 1;
    }

    .video-slide video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .product-actions {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 8px;
    }

    .product-edit-btn,
    .product-delete-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
    }

    .product-edit-btn {
      background: rgba(59, 130, 246, 0.9);
      color: white;
    }

    .product-delete-btn {
      background: rgba(239, 68, 68, 0.9);
      color: white;
    }

    .message-context-menu {
      position: fixed;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      padding: 12px;
      z-index: 1000;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-light);
    }

    body.dark-theme .message-context-menu {
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid var(--border-dark);
    }

    .context-menu-item {
      padding: 12px 16px;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s ease;
      color: var(--text-light);
    }

    body.dark-theme .context-menu-item {
      color: var(--text-dark);
    }

    .context-menu-item:hover {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger-color);
    }

    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 16px;
      font-size: 12px;
      color: #64748b;
    }

    body.dark-theme .typing-indicator {
      background: rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.7);
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      background: #64748b;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    body.dark-theme .typing-dot {
      background: rgba(255, 255, 255, 0.7);
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-6px); }
    }

    .saved-videos-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      padding: 16px;
    }

    .saved-video-item {
      aspect-ratio: 1;
      border-radius: 16px;
      overflow: hidden;
      position: relative;
      background: rgba(0, 0, 0, 0.03);
    }

    body.dark-theme .saved-video-item {
      background: rgba(255, 255, 255, 0.03);
    }

    .saved-video-item video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .post-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .post-overlay.active {
      display: flex;
    }

    .post-overlay-content {
      max-width: 90%;
      max-height: 90%;
      position: relative;
    }

    .post-overlay-content img,
    .post-overlay-content video {
      max-width: 100%;
      max-height: 85vh;
      border-radius: 16px;
    }

    .demo-product {
      display: none !important;
    }

    .blocked-user {
      opacity: 0.6;
      pointer-events: none;
    }

    .blocked-message {
      text-align: center;
      padding: 20px;
      color: #64748b;
      font-style: italic;
    }

    .blocked-btn {
      background: #64748b !important;
      cursor: not-allowed !important;
    }

    .blocked-btn:hover {
      transform: none !important;
    }

    /* Search Modal */
    .search-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      display: none;
      align-items: flex-start;
      justify-content: center;
      padding-top: 80px;
    }

    .search-modal.active {
      display: flex;
    }

    .search-modal-content {
      background: var(--card-light);
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    body.dark-theme .search-modal-content {
      background: rgba(15, 23, 42, 0.95);
    }

    .search-modal-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      border-bottom: 1px solid var(--border-light);
    }

    body.dark-theme .search-modal-header {
      border-bottom: 1px solid var(--border-dark);
    }

    .search-modal-input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 12px;
      border: 2px solid var(--border-light);
      background: rgba(255, 255, 255, 0.7);
      font-size: 15px;
      color: var(--text-light);
      font-family: inherit;
    }

    body.dark-theme .search-modal-input {
      border: 2px solid var(--border-dark);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-dark);
    }

    .search-modal-input:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .search-modal-results {
      max-height: 400px;
      overflow-y: auto;
    }

    /* TikTok Style Video Viewer */
    .tiktok-viewer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      z-index: 3000;
      display: none;
      overflow: hidden;
    }

    .tiktok-viewer.active {
      display: block;
    }

    .tiktok-video-container {
      width: 100%;
      height: 100%;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow-y: auto;
      scroll-snap-type: y mandatory;
      -webkit-overflow-scrolling: touch;
    }

    .tiktok-video-item {
      width: 100%;
      height: 100%;
      position: relative;
      scroll-snap-align: start;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .tiktok-video-item video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .tiktok-close-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      z-index: 10;
      backdrop-filter: blur(10px);
    }

    .tiktok-actions {
      position: absolute;
      right: 16px;
      bottom: 120px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      z-index: 10;
    }

    .tiktok-action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .tiktok-action-btn svg {
      width: 32px;
      height: 32px;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
    }

    .tiktok-action-btn span {
      font-size: 12px;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    .tiktok-action-btn:active {
      transform: scale(0.9);
    }

    .tiktok-info {
      position: absolute;
      left: 16px;
      bottom: 80px;
      right: 80px;
      color: white;
      z-index: 10;
    }

    .tiktok-user {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .tiktok-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .tiktok-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .tiktok-username {
      font-weight: 700;
      font-size: 16px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    .tiktok-description {
      font-size: 14px;
      line-height: 1.4;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
      max-height: 60px;
      overflow: hidden;
    }

    /* Video Thumbnail Loading Indicator */
    .video-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 12px;
      text-align: center;
    }

    .video-play-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      pointer-events: none;
    }

    /* Doƒürulanmƒ±≈ü Rozet Stili */
    .verified-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      border-radius: 50%;
      margin-left: 4px;
      font-size: 10px;
      color: white;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
    }

    .verified-badge::after {
      content: "‚úì";
    }

    /* Hashtag Stili */
    .hashtag {
      color: #3b82f6;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .hashtag:hover {
      color: #1d4ed8;
      text-decoration: underline;
    }

    /* Mention Stili */
    .mention {
      color: var(--primary-color);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .mention:hover {
      color: var(--primary-light);
      text-decoration: underline;
    }

    /* Mesaj Silme Butonu */
    .chat-item-delete {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      flex-shrink: 0;
      margin-left: 8px;
    }

    .chat-item-delete:hover {
      background: rgba(239, 68, 68, 0.2);
      transform: scale(1.1);
    }

    /* Doƒürulama ƒ∞steƒüi Butonu */
    .verification-request-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      border: none;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .verification-request-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
    }

    .verification-request-btn:disabled {
      background: #64748b;
      cursor: not-allowed;
    }

    .verification-pending {
      background: linear-gradient(135deg, #f59e0b, #d97706) !important;
    }

    /* Bildirim √ñƒüesinde Tƒ±klanabilir Kullanƒ±cƒ± */
    .notification-username {
      color: var(--primary-color);
      font-weight: 700;
      cursor: pointer;
    }

    .notification-username:hover {
      text-decoration: underline;
    }
    
    /* Instagram tarzƒ± post card d√ºzeltmeleri */
    .post-card { 
      margin-bottom: 0 !important; 
    }
    
    .reels-profile-pic { 
      width: 40px !important; 
      height: 40px !important; 
      border-radius: 50% !important; 
      border: 2px solid white; 
    }
    
    .comments-modal { 
      z-index: 10001 !important; 
      background: var(--bg-light) !important; 
    }
    
    body.dark-theme .comments-modal { 
      background: var(--bg-dark) !important; 
    }
    
    /* Yorum Silme Butonu - Her zaman g√∂r√ºn√ºr */
    .comment-delete-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
      cursor: pointer;
      display: flex !important;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      flex-shrink: 0;
      font-size: 16px;
      opacity: 1 !important;
      visibility: visible !important;
      margin-left: auto;
    }
    
    .comment-delete-btn:hover {
      background: rgba(239, 68, 68, 0.3);
      transform: scale(1.15);
    }
    
    .comment-item {
      display: flex !important;
      align-items: flex-start;
      position: relative;
    }
    
    .comment-item .comment-delete-btn {
      opacity: 1 !important;
      display: flex !important;
    }
    
    /* Ke≈üfet Sayfasƒ± */
    .explore-page {
      padding: 0;
    }
    
    .explore-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 2px;
    }
    
    .explore-item {
      aspect-ratio: 1;
      overflow: hidden;
      cursor: pointer;
      position: relative;
      background: #f1f5f9;
    }
    
    .explore-item img,
    .explore-item video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .explore-item:hover {
      opacity: 0.9;
    }
    
    .explore-item-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 8px;
      background: linear-gradient(transparent, rgba(0,0,0,0.7));
      color: white;
      font-size: 12px;
      display: flex;
      gap: 12px;
    }
    
    /* Bildirimler Paneli D√ºzeltmesi */
    .notifications-panel.active {
      display: flex !important;
    }
    
    .notification-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 16px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    body.dark-theme .notification-item {
      background: rgba(255, 255, 255, 0.05);
    }
    
    .notification-item:hover {
      background: rgba(16, 185, 129, 0.1);
    }
    
    .notification-item.unread {
      background: rgba(16, 185, 129, 0.08);
      border-left: 3px solid var(--primary-color);
    }
    
    .notification-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      background: rgba(16, 185, 129, 0.1);
      border-radius: 50%;
      flex-shrink: 0;
    }
    
    .notification-content {
      flex: 1;
      min-width: 0;
    }
    
    .notification-text {
      font-size: 14px;
      color: var(--text-light);
      margin: 0 0 4px 0;
      line-height: 1.4;
    }
    
    body.dark-theme .notification-text {
      color: var(--text-dark);
    }
    
    .notification-time {
      font-size: 12px;
      color: #94a3b8;
      margin: 0;
    }
    
    /* Post Header'da Takip Durumu */
    .follow-status-text {
      font-size: 11px;
      color: #64748b;
      margin-left: 4px;
    }
    
    body.dark-theme .follow-status-text {
      color: rgba(255, 255, 255, 0.5);
    }
  
    /* Geli≈ümi≈ü Doƒürulama Modal Stilleri */
    .verification-modal-content {
      max-width: 450px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .id-upload-area {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .id-upload-box {
      border: 2px dashed var(--border-light);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(59, 130, 246, 0.05);
    }
    
    .id-upload-box:hover {
      border-color: #3b82f6;
      background: rgba(59, 130, 246, 0.1);
    }
    
    .id-upload-box.has-image {
      border-color: #10b981;
      background: rgba(16, 185, 129, 0.1);
    }
    
    .id-preview-img {
      max-width: 100%;
      max-height: 150px;
      border-radius: 12px;
      margin-top: 12px;
    }
    
    .verification-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .verification-status-badge.pending {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
    }
    
    .verification-status-badge.verified {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }
    
    .verification-status-badge.rejected {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }
    
    /* Hesap Ayarlarƒ± Stilleri */
    .settings-section {
      margin-bottom: 24px;
      padding: 16px;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 16px;
    }
    
    body.dark-theme .settings-section {
      background: rgba(255, 255, 255, 0.05);
    }
    
    .settings-section-title {
      font-size: 14px;
      font-weight: 700;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
    }
    
    .settings-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 0;
      border-bottom: 1px solid var(--border-light);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .settings-item:last-child {
      border-bottom: none;
    }
    
    .settings-item:hover {
      opacity: 0.8;
    }
    
    .settings-item-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .settings-item-icon {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    
    .settings-item-text {
      display: flex;
      flex-direction: column;
    }
    
    .settings-item-title {
      font-weight: 600;
      color: var(--text-light);
      font-size: 15px;
    }
    
    body.dark-theme .settings-item-title {
      color: var(--text-dark);
    }
    
    .settings-item-desc {
      font-size: 12px;
      color: #64748b;
    }
    
    .account-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      background: rgba(16, 185, 129, 0.1);
      border-radius: 14px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    
    .account-card:hover {
      background: rgba(16, 185, 129, 0.2);
    }
    
    .account-card.active {
      border-color: #10b981;
    }
    
    .account-card-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      font-size: 20px;
    }
    
    .account-card-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    /* Fotoƒüraf Filtre Stilleri */
    .filter-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .filter-item {
      aspect-ratio: 1;
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      position: relative;
      border: 3px solid transparent;
      transition: all 0.3s ease;
    }
    
    .filter-item:hover {
      transform: scale(1.05);
    }
    
    .filter-item.selected {
      border-color: #10b981;
    }
    
    .filter-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .filter-name {
      position: absolute;
      bottom: 4px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 10px;
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.8);
      font-weight: 600;
    }
    
    /* Video D√ºzenleme */
    .video-editor-timeline {
      width: 100%;
      height: 60px;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      position: relative;
      margin: 16px 0;
      overflow: hidden;
    }
    
    .timeline-thumbnails {
      display: flex;
      height: 100%;
    }
    
    .timeline-thumbnail {
      flex: 1;
      height: 100%;
      object-fit: cover;
    }
    
    .timeline-range {
      position: absolute;
      top: 0;
      height: 100%;
      background: rgba(16, 185, 129, 0.3);
      border: 2px solid #10b981;
      border-radius: 8px;
    }
    
    .timeline-handle {
      position: absolute;
      width: 20px;
      height: 100%;
      background: #10b981;
      cursor: ew-resize;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
    }
    
    .cover-selector {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin: 16px 0;
    }
    
    .cover-option {
      aspect-ratio: 9/16;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.3s ease;
    }
    
    .cover-option:hover {
      transform: scale(1.05);
    }
    
    .cover-option.selected {
      border-color: #10b981;
    }
    
    .cover-option img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    /* Engellenen Kullanƒ±cƒ±lar */
    .blocked-user-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 12px;
      margin-bottom: 8px;
    }
    
    .unblock-btn {
      padding: 8px 16px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .unblock-btn:hover {
      background: #dc2626;
    }
    
  </style>
</head>
<body class="light-theme">
  <!-- Splash Screen -->
  <div class="splash-screen" id="splashScreen">
    <div class="splash-logo">üå±</div>
    <div class="splash-title">AgroLink</div>
    <div class="splash-subtitle">Sosyal Platform</div>
    <div class="splash-from">AGROLINK'TEN</div>
  </div>

  <!-- Auth Screens -->
  <div id="loginScreen" class="auth-screen">
    <div class="auth-card">
      <div class="auth-logo">üå±</div>
      <h1 class="auth-title">Tekrar Ho≈ü Geldin</h1>
      <p class="auth-subtitle">AgroLink'e giri≈ü yap</p>
      <form id="loginForm">
        <div class="form-group">
          <label for="loginEmail" class="form-label">E-posta</label>
          <input type="email" id="loginEmail" class="form-input" placeholder="ornek@email.com" required>
        </div>
        <div class="form-group">
          <label for="loginPassword" class="form-label">≈ûifre</label>
          <input type="password" id="loginPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
        </div>
        <button type="submit" class="primary-btn">Giri≈ü Yap</button>
      </form>
      <p class="secondary-link" style="margin-bottom: 12px;"><a id="goToForgotPassword" style="cursor: pointer;">≈ûifremi Unuttum</a></p>
      <p class="secondary-link">Hesabƒ±n yok mu? <a id="goToRegister">Kayƒ±t Ol</a></p>
    </div>
  </div>

  <!-- ≈ûifremi Unuttum Ekranƒ± -->
  <div id="forgotPasswordScreen" class="auth-screen">
    <div class="auth-card">
      <div class="auth-logo">üîë</div>
      <h1 class="auth-title">≈ûifremi Unuttum</h1>
      <p class="auth-subtitle">E-posta adresinize ≈üifre sƒ±fƒ±rlama linki g√∂ndereceƒüiz</p>
      <form id="forgotPasswordForm">
        <div class="form-group">
          <label for="forgotEmail" class="form-label">E-posta Adresi</label>
          <input type="email" id="forgotEmail" class="form-input" placeholder="ornek@email.com" required>
        </div>
        <div class="info-box" style="background: rgba(255, 152, 0, 0.1); padding: 16px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #ff9800;">
          <p style="margin: 0; font-size: 13px; color: #e65100;">
            ‚è±Ô∏è <strong>√ñnemli:</strong> G√∂nderilecek ≈üifre sƒ±fƒ±rlama linki sadece <strong>10 dakika</strong> ge√ßerlidir.
          </p>
        </div>
        <button type="submit" class="primary-btn">≈ûifre Sƒ±fƒ±rlama Linki G√∂nder</button>
      </form>
      <p class="secondary-link" style="margin-top: 20px;"><a id="backToLogin" style="cursor: pointer;">‚Üê Giri≈ü Ekranƒ±na D√∂n</a></p>
    </div>
  </div>

  <div id="registerScreen" class="auth-screen">
    <div class="auth-card">
      <div class="auth-logo">üå±</div>
      <h1 class="auth-title">Bize Katƒ±l</h1>
      <p class="auth-subtitle">AgroLink hesabƒ± olu≈ütur</p>
      <form id="registerForm">
        <div class="profile-pic-upload">
          <div class="profile-pic-preview" id="profilePicPreview" onclick="document.getElementById('profilePicInput').click()">üì∑</div>
          <input type="file" id="profilePicInput" accept="image/*" style="display: none;">
          <p class="upload-hint">Profil fotoƒürafƒ± ekle (isteƒüe baƒülƒ±)</p>
        </div>
        <div class="form-group">
          <label for="regName" class="form-label">Tam Ad</label>
          <input type="text" id="regName" class="form-input" placeholder="Ahmet Yƒ±lmaz" required>
        </div>
        <div class="form-group">
          <label for="regUsername" class="form-label">Kullanƒ±cƒ± Adƒ±</label>
          <input type="text" id="regUsername" class="form-input" placeholder="@kullaniciadi" required>
        </div>
        <div class="form-group">
          <label for="regEmail" class="form-label">E-posta</label>
          <input type="email" id="regEmail" class="form-input" placeholder="ornek@email.com" required>
        </div>
        <div class="form-group">
          <label for="regPassword" class="form-label">≈ûifre</label>
          <input type="password" id="regPassword" class="form-input" placeholder="En az 6 karakter" required>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="robotCheck" required>
          <label for="robotCheck">Ben robot deƒüilim</label>
        </div>
        <div class="captcha-box" id="captchaBox">
          <p class="captcha-question" id="captchaQuestion"></p>
          <input type="number" id="captchaAnswer" class="form-input" placeholder="Cevabƒ±nƒ±z">
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="privacyCheck" required>
          <label for="privacyCheck">
            <a href="https://salih-ozt.github.io/Agrolink-kullan-c-s-zle-mesi-ekran-/?utm_source=ig&utm_medium=social&utm_content=link_in_bio&fbclid=PAb21jcAOpbZpleHRuA2FlbQIxMQBzcnRjBmFwcF9pZA81NjcwNjczNDMzNTI0MjcAAaczMnysUQM5lglKjG4oyfgJYMFgvy3N7CByTnY06gZK8lBcaDdScim9sqFDOQ_aem_60KG-St1j93Mqi08o__SlA" target="_blank" style="color: var(--primary-color); text-decoration: none; font-weight: 600;">Kullanƒ±m S√∂zle≈ümesi</a>'ni okudum ve kabul ediyorum
          </label>
        </div>
        <button type="submit" class="primary-btn">Hesap Olu≈ütur</button>
      </form>
      <p class="secondary-link">Zaten hesabƒ±n var mƒ±? <a id="goToLogin">Giri≈ü Yap</a></p>
    </div>
  </div>

  <!-- Main App -->
  <div class="app-wrapper" id="mainApp" style="display: none;">
    <header class="header">
      <!-- Kullanƒ±cƒ± Arama -->
      <div style="flex: 1; position: relative; margin: 0 12px;">
        <input type="text" class="search-input" id="searchInput" placeholder="üîç Kullanƒ±cƒ± ara..." style="width: 100%; padding: 10px 16px; font-size: 14px; border-radius: 12px; border: 2px solid var(--border-light); background: rgba(255, 255, 255, 0.7);">
        <div class="search-results" id="searchResults" style="position: absolute; top: 100%; left: 0; right: 0; background: var(--card-light); border: 1px solid var(--border-light); border-radius: 16px; margin-top: 8px; max-height: 300px; overflow-y: auto; z-index: 10; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1); display: none;"></div>
      </div>
      <div class="header-actions">
        <button class="refresh-btn" id="refreshBtn" title="Sayfayƒ± Yenile">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M23 4v6h-6"></path>
            <path d="M1 20v-6h6"></path>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"></path>
            <path d="M20.49 15a9 9 0 0 1-14.85 3.36L1 14"></path>
          </svg>
        </button>
        <button class="icon-btn" id="notificationsBtn">
          üîî <span class="notification-badge" id="notificationBadge">0</span>
        </button>
        <button class="icon-btn" id="settingsBtn">‚öôÔ∏è</button>
      </div>
    </header>

    <!-- Arka Plan ƒ∞≈ülemleri G√∂stergesi -->
    <div class="background-process" id="backgroundProcess">
      <div class="spinner"></div>
      <span>G√∂nderi y√ºkleniyor...</span>
    </div>

    <main class="main-content">
      <!-- Home Page (Feed) -->
      <div id="homePage" class="page active">
        <div id="feedContainer"></div>
        <div class="loading-indicator" id="feedLoadingIndicator">
          <div class="spinner"></div>
          <p>Daha fazla g√∂nderi y√ºkleniyor...</p>
        </div>
      </div>

      <!-- Store Page -->
      <div id="storePage" class="page">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 16px;">
          <h2 style="font-size: 24px; font-weight: 900; color: var(--text-light);">üõí Maƒüaza</h2>
        </div>
        <div id="storeContainer" class="store-grid"></div>
        <button class="add-product-btn" id="addProductBtn">+</button>
      </div>

      <!-- Messages Page -->
      <div id="messagesPage" class="page">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 16px;">
          <h2 style="font-size: 24px; font-weight: 900; color: var(--text-light);">üí¨ Mesajlar</h2>
          <button class="icon-btn" id="newMessageBtn" style="width: 48px; height: 48px; font-size: 24px;">
            <svg width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
          </button>
        </div>
        <div id="chatList" class="chat-list"></div>
      </div>

      <!-- Profile Page -->
      <div id="profilePage" class="page">
        <div class="profile-header">
          <div class="profile-cover" id="profileCover" onclick="openProfileCoverFullscreen()">
            <div class="profile-cover-edit" id="coverEditBtn" style="display: none;" onclick="event.stopPropagation();">üì∑</div>
          </div>
          <div style="display: flex; gap: 16px; align-items: flex-start; margin-bottom: 16px;">
            <div class="profile-avatar-container">
              <div class="profile-avatar-large" id="profileAvatar" onclick="openProfilePicFullscreen()">üë§</div>
              <div class="profile-pic-edit" id="avatarEditBtn" style="display: none;">üì∑</div>
            </div>
            <div style="flex: 1;">
              <h2 class="profile-name" id="profileName">Kullanƒ±cƒ±</h2>
              <p class="profile-username" id="profileUsername">@kullaniciadi</p>
              <div class="profile-stats" style="margin-top: 8px; padding-top: 8px; border-top: none;">
                <!-- G√∂nderiler ƒ∞statistiƒüi -->
                <div class="profile-posts-stat">
                  <span class="stat-number" id="postCount">0</span>
                  <span class="stat-label">G√∂nderiler</span>
                </div>
                
                <!-- Ye≈üil Dikd√∂rtgen Butonlar -->
                <div class="profile-follow-buttons">
                  <button class="profile-follow-btn" onclick="showFollowersList()">
                    <span>üë•</span>
                    <span>Takip√ßilerim</span>
                    <span class="stat-number" id="followerCount" style="margin-left: 4px; color: white;">0</span>
                  </button>
                  <button class="profile-follow-btn" onclick="showFollowingList()">
                    <span>üë•</span>
                    <span>Takip Ettiklerim</span>
                    <span class="stat-number" id="followingCount" style="margin-left: 4px; color: white;">0</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <p class="profile-bio" id="profileBio">Biyografi ekle...</p>
          <div class="profile-actions">
            <button class="profile-action-btn primary" id="editProfileBtn">Profili D√ºzenle</button>
            <button class="profile-action-btn">Payla≈üƒ±mlar</button>
          </div>
        </div>
        <div class="profile-grid" id="profileGrid"></div>
        <div class="loading-indicator" id="profileLoadingIndicator">
          <div class="spinner"></div>
          <p>Daha fazla g√∂nderi y√ºkleniyor...</p>
        </div>
      </div>

      <!-- Settings Page -->
      <div id="settingsPage" class="page">
        <div class="settings-menu">
          <h2 class="settings-title">‚öôÔ∏è Ayarlar</h2>
          <div class="settings-item" id="themeToggleItem">
            <span class="settings-label">üåô Koyu Tema</span>
            <div class="theme-switch" id="themeSwitch">
              <div class="theme-switch-slider"></div>
            </div>
          </div>
          <div class="settings-item" id="locationToggleItem">
            <span class="settings-label">üìç Konum Bazlƒ± G√∂nderiler</span>
            <div class="theme-switch" id="locationSwitch">
              <div class="theme-switch-slider"></div>
            </div>
          </div>
          <div class="settings-item" id="notificationToggleItem">
            <span class="settings-label">üîî Bildirimler</span>
            <div class="theme-switch active" id="notificationSwitch">
              <div class="theme-switch-slider"></div>
            </div>
          </div>
          <!-- Kaydedilen Videolar kaldƒ±rƒ±ldƒ± -->
          <div class="settings-item" id="verificationRequestItem">
            <span class="settings-label">‚úì Doƒürulanmƒ±≈ü Hesap Ba≈üvurusu</span>
            <span style="font-size: 20px;">‚Üí</span>
          </div>
          <div class="settings-item" id="feedbackItem" onclick="openFeedbackModal()">
            <span class="settings-label">‚≠ê Geri Bildirim</span>
            <span style="font-size: 20px;">‚Üí</span>
          </div>
          <div class="settings-item" id="deleteAccountItem">
            <span class="settings-label">üóëÔ∏è Hesabƒ± Sil</span>
            <span style="font-size: 20px;">‚Üí</span>
          </div>
          <div class="settings-item" id="logoutItem">
            <span class="settings-label">üö™ √áƒ±kƒ±≈ü Yap</span>
            <span style="font-size: 20px;">‚Üí</span>
          </div>
          
          <!-- S√ºr√ºm ve Telif Hakkƒ± Bilgisi -->
          <div style="margin-top: 32px; padding: 24px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05)); border-radius: 16px; text-align: center; border: 1px solid rgba(16, 185, 129, 0.2);">
            <div style="font-size: 24px; font-weight: 900; color: var(--primary-color); margin-bottom: 8px;">AgroLink 3.0</div>
            <div style="font-size: 14px; color: #64748b; margin-bottom: 12px; font-weight: 600;">T√ºrkiye'nin Tarƒ±m Sosyal Platformu</div>
            <div style="font-size: 13px; color: var(--text-light); margin-bottom: 8px; font-weight: 700;">
              <span style="color: var(--primary-color);">üë®‚Äçüíª</span> Salih √ñzt√ºrk'√ºn √ºr√ºn√ºd√ºr
            </div>
            <div style="font-size: 12px; color: #64748b; margin-bottom: 12px; line-height: 1.6;">
              <span style="color: #f59e0b;">üè´</span> ≈ûehit √úmit Kesti Tarƒ±m MTAL<br>tarafƒ±ndan √∂nc√ºl√ºk edilmektedir
            </div>
            <div style="font-size: 11px; color: #94a3b8; margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border-light);">
              ¬© 2026 AgroLink. T√ºm haklarƒ± saklƒ±dƒ±r.
            </div>
          </div>
        </div>
      </div>

      <!-- Chat Screen -->
      <div id="chatScreen" class="page" style="display: none;">
        <div class="chat-screen">
          <div class="chat-header">
            <button class="back-btn" id="backToMessages">‚Üê</button>
            <div style="position: relative;">
              <div class="avatar" style="width: 44px; height: 44px; font-size: 18px;" id="chatAvatar">üë§</div>
              <div class="online-indicator" id="chatOnlineIndicator"></div>
            </div>
            <div class="chat-info" style="flex: 1;">
              <div class="chat-name" id="chatName">Kullanƒ±cƒ±</div>
              <div class="typing-indicator" id="typingIndicator" style="display: none;">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <span>yazƒ±yor...</span>
              </div>
            </div>
          </div>
          <div class="messages-container" id="messagesContainer"></div>
          <div class="chat-input-container">
            <button class="icon-btn" onclick="document.getElementById('messageFileInput').click()" style="width: 40px; height: 40px; margin-right: 8px;">üìé</button>
            <input type="file" id="messageFileInput" style="display: none;" onchange="handleMessageFileUpload(this)">
            <input type="text" class="chat-input" id="messageInput" placeholder="Mesaj yaz...">
            <button class="send-btn" id="sendMessage">‚û§</button>
          </div>
        </div>
      </div>
    </main>

    <nav class="bottom-nav">
      <button class="nav-item active" data-page="home">
        <svg width="24" height="24" viewbox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22" fill="white" stroke="white"></polyline>
        </svg>
      </button>
      <button class="nav-item" data-page="store">
        <svg width="24" height="24" viewbox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
          <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
          <line x1="3" y1="6" x2="21" y2="6" stroke="white"></line>
          <path d="M16 10a4 4 0 0 1-8 0" fill="none" stroke="white" stroke-width="2"></path>
        </svg>
      </button>
      <button class="nav-item add-post" id="addPostBtn">
        <svg width="28" height="28" viewbox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="3" width="18" height="18" rx="4" fill="currentColor"></rect>
          <line x1="12" y1="8" x2="12" y2="16" stroke="white" stroke-width="2.5"></line>
          <line x1="8" y1="12" x2="16" y2="12" stroke="white" stroke-width="2.5"></line>
        </svg>
      </button>
      <button class="nav-item" data-page="messages">
        <svg width="24" height="24" viewbox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
      </button>
      <button class="nav-item" data-page="profile" id="profileNavBtn">
        <div id="navProfilePicContainer" style="width: 28px; height: 28px; border-radius: 50%; overflow: hidden; border: 2px solid currentColor; display: flex; align-items: center; justify-content: center; background: currentColor;">
          <svg id="navProfileIcon" width="18" height="18" viewbox="0 0 24 24" fill="white" stroke="white" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
        </div>
      </button>
    </nav>

    <!-- Bildirimler TAM EKRAN Panel -->
    <div class="notifications-panel" id="notificationsPanel" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-light); z-index: 1000; display: none; flex-direction: column; overflow: hidden;">
      <div style="padding: 16px 20px; border-bottom: 1px solid var(--border-light); display: flex; align-items: center; gap: 16px; background: var(--card-light);">
        <button onclick="closeNotificationsPanel()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light);">‚Üê</button>
        <h3 style="font-size: 20px; font-weight: 800; margin: 0; color: var(--text-light); flex: 1;">üîî Bildirimler</h3>
        <button onclick="markAllNotificationsRead()" style="background: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 700; cursor: pointer;">T√ºm√ºn√º Okundu ƒ∞≈üaretle</button>
      </div>
      <div id="notificationsList" style="flex: 1; overflow-y: auto; padding: 16px;"></div>
    </div>
  </div>

  <!-- Search Modal -->
  <div class="search-modal" id="searchModal">
    <div class="search-modal-content">
      <div class="search-modal-header">
        <input type="text" class="search-modal-input" id="searchModalInput" placeholder="üîç Kullanƒ±cƒ± ara..." autofocus>
        <button class="icon-btn" onclick="closeSearchModal()" style="margin: 0;">√ó</button>
      </div>
      <div class="search-modal-results" id="searchModalResults"></div>
    </div>
  </div>

  <!-- TikTok Style Video Viewer -->
  <div class="tiktok-viewer" id="tiktokViewer">
    <button class="tiktok-close-btn" onclick="closeTiktokViewer()">√ó</button>
    <div class="tiktok-video-container" id="tiktokVideoContainer"></div>
  </div>

  <!-- Post Overlay -->
  <div class="post-overlay" id="postOverlay">
    <div class="post-overlay-content">
      <button class="fullscreen-close" onclick="closePostOverlay()">√ó</button>
      <div id="postOverlayMedia"></div>
    </div>
  </div>

  <!-- Add Post Modal - Fullscreen -->
  <div class="fullscreen-post-modal" id="addPostModal">
    <div class="fullscreen-post-header">
      <button class="close-btn" style="background: rgba(255,255,255,0.2); color: white;" id="closePostModal">√ó</button>
      <h2 style="color: white; margin: 0; font-size: 18px;">‚ú® Yeni G√∂nderi</h2>
      <button class="primary-btn" id="submitPost" style="padding: 8px 16px; margin: 0; width: auto;">üöÄ Payla≈ü</button>
    </div>
    <form id="postForm" style="display: flex; flex-direction: column; height: calc(100% - 80px);">
      <div class="fullscreen-post-content">
        <!-- Anket Modu Toggle -->
        <div id="pollModeToggle" style="display: flex; gap: 10px; margin-bottom: 16px;">
          <button type="button" id="normalPostBtn" class="post-mode-btn active" style="flex: 1; padding: 12px; border-radius: 12px; border: 2px solid var(--primary-color); background: var(--primary-color); color: white; font-weight: 700; cursor: pointer; transition: all 0.3s ease;">üìù Normal G√∂nderi</button>
          <button type="button" id="pollPostBtn" class="post-mode-btn" style="flex: 1; padding: 12px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.3); background: transparent; color: rgba(255,255,255,0.7); font-weight: 700; cursor: pointer; transition: all 0.3s ease;">üìä Anket Olu≈ütur</button>
        </div>
        
        <!-- Normal Post Alanƒ± -->
        <div id="normalPostArea">
          <textarea class="fullscreen-post-textarea" id="postContent" placeholder="Aklƒ±ndan neler ge√ßiyor? (ƒ∞steƒüe baƒülƒ±)"></textarea>
          <div id="mediaPreview" style="margin-bottom: 20px;"></div>
        </div>
        
        <!-- Anket Alanƒ± -->
        <div id="pollArea" style="display: none;">
          <div style="margin-bottom: 16px;">
            <label style="color: rgba(255,255,255,0.8); font-size: 14px; font-weight: 600; display: block; margin-bottom: 8px;">üìã Anket Sorusu</label>
            <input type="text" id="pollQuestion" placeholder="Sorunuzu yazƒ±n..." style="width: 100%; padding: 14px 16px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white; font-size: 16px; font-weight: 600;">
          </div>
          
          <div id="pollOptionsContainer" style="margin-bottom: 16px;">
            <label style="color: rgba(255,255,255,0.8); font-size: 14px; font-weight: 600; display: block; margin-bottom: 8px;">üìù ≈ûƒ±klar</label>
            <div id="pollOptionsList">
              <div class="poll-option-input" style="display: flex; gap: 8px; margin-bottom: 8px;">
                <input type="text" class="poll-option" placeholder="≈ûƒ±k 1" style="flex: 1; padding: 12px 16px; border-radius: 10px; border: 2px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white; font-size: 14px;">
              </div>
              <div class="poll-option-input" style="display: flex; gap: 8px; margin-bottom: 8px;">
                <input type="text" class="poll-option" placeholder="≈ûƒ±k 2" style="flex: 1; padding: 12px 16px; border-radius: 10px; border: 2px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white; font-size: 14px;">
              </div>
            </div>
            <button type="button" id="addPollOptionBtn" style="width: 100%; padding: 10px; border-radius: 10px; border: 2px dashed rgba(255,255,255,0.3); background: transparent; color: rgba(255,255,255,0.7); cursor: pointer; font-size: 14px;">+ ≈ûƒ±k Ekle</button>
          </div>
        </div>
        
        <!-- Yorum ƒ∞zni Toggle -->
        <div id="commentPermissionArea" style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 16px;">
          <input type="checkbox" id="allowCommentsCheckbox" checked style="width: 20px; height: 20px; accent-color: var(--primary-color);">
          <label for="allowCommentsCheckbox" style="color: rgba(255,255,255,0.8); font-size: 14px; cursor: pointer; flex: 1;">üí¨ Yorumlara izin ver</label>
        </div>
      </div>
      
      <div class="fullscreen-post-actions" style="display: flex; gap: 10px;">
        <label class="media-upload-label" id="mediaUploadLabel" style="flex: 1; margin: 0; background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); color: white;">
          üì∑ Fotoƒüraf/Video Se√ß
          <input type="file" id="postMedia" accept="image/*,video/*" style="display: none;">
        </label>
        <button type="button" id="recordVideoBtn" class="media-upload-label" style="flex: 1; margin: 0; background: rgba(239,68,68,0.1); border-color: rgba(239,68,68,0.3); color: #ef4444; cursor: pointer;">
          üé• Video Kaydet
        </button>
      </div>
      
      <!-- Dosya Bilgisi ve Zamanlama Alanƒ± -->
      <div id="uploadInfoContainer" style="display: none; padding: 15px 20px; background: rgba(255,255,255,0.05); margin: 10px 20px; border-radius: 12px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <span style="color: rgba(255,255,255,0.7); font-size: 13px;">üìÅ Dosya Boyutu:</span>
          <span id="fileSizeInfo" style="color: #10b981; font-weight: 700; font-size: 13px;">0 MB</span>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <span style="color: rgba(255,255,255,0.7); font-size: 13px;">‚è±Ô∏è Tahmini S√ºre:</span>
          <span id="estimatedTime" style="color: #10b981; font-weight: 700; font-size: 13px;">0 saniye</span>
        </div>
        
        <!-- Zamanlƒ± Payla≈üƒ±m -->
        <div style="margin-bottom: 15px;">
          <label style="color: rgba(255,255,255,0.7); font-size: 13px; display: block; margin-bottom: 8px;">üìÖ Yayƒ±nlama Zamanƒ± (Opsiyonel):</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="number" id="scheduleSeconds" min="0" max="3600" placeholder="0" style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white; font-size: 14px;">
            <span style="color: rgba(255,255,255,0.5); font-size: 13px;">saniye sonra</span>
          </div>
        </div>
      </div>
      
      <!-- Yumu≈üak Progress Bar -->
      <div id="uploadProgressContainer" style="display: none; padding: 0 20px 20px;">
        <div style="background: rgba(255,255,255,0.1); border-radius: 20px; overflow: hidden; height: 24px; position: relative; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);">
          <div id="uploadProgressBar" style="background: linear-gradient(135deg, #10b981, #059669, #34d399); height: 100%; width: 0%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 20px; box-shadow: 0 0 15px rgba(16, 185, 129, 0.5);"></div>
          <span id="uploadProgressText" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 12px; font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">0%</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
          <p id="uploadTimeRemaining" style="color: rgba(255,255,255,0.7); font-size: 12px; margin: 0;">Hesaplanƒ±yor...</p>
          <p id="uploadSpeedInfo" style="color: rgba(255,255,255,0.5); font-size: 12px; margin: 0;">-- MB/s</p>
        </div>
      </div>
    </form>
  </div>

  <!-- Edit Profile Modal -->
  <div class="modal" id="editProfileModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">‚úèÔ∏è Profili D√ºzenle</h2>
        <button class="close-btn" id="closeProfileModal">√ó</button>
      </div>
      <form id="editProfileForm">
        <div class="profile-pic-upload" style="margin-bottom: 24px;">
          <div class="profile-pic-preview" id="editProfilePicPreview" onclick="document.getElementById('editProfilePicInput').click()">üì∑</div>
          <input type="file" id="editProfilePicInput" accept="image/*" style="display: none;">
          <p class="upload-hint">Profil fotoƒürafƒ±nƒ± deƒüi≈ütir</p>
          <button type="button" class="primary-btn" style="background: linear-gradient(135deg, #ef4444, #dc2626); margin-top: 12px; padding: 10px 16px;" onclick="removeProfilePicture()">üóëÔ∏è Profil Resmini Kaldƒ±r</button>
        </div>
        <div class="form-group">
          <label for="editCoverPic" class="form-label">Kapak Fotoƒürafƒ±</label>
          <div class="media-upload-section">
            <label class="media-upload-label" style="grid-column: 1 / -1;">
              üñºÔ∏è Kapak Fotoƒürafƒ± Y√ºkle
              <input type="file" id="editCoverPic" accept="image/*" style="display: none;">
            </label>
          </div>
          <div id="coverPreview"></div>
        </div>
        <div class="form-group">
          <label for="editName" class="form-label">Ad</label>
          <input type="text" id="editName" class="form-input" required>
        </div>
        <div class="form-group">
          <label for="editEmail" class="form-label">E-posta</label>
          <input type="email" id="editEmail" class="form-input" required>
        </div>
        <div class="form-group">
          <label for="editBio" class="form-label">Biyografi</label>
          <textarea id="editBio" class="textarea-field" style="min-height: 100px;" placeholder="Kendin hakkƒ±nda bir ≈üeyler yaz..."></textarea>
        </div>
        <div class="form-group">
          <label for="editWebsite" class="form-label">Web Sitesi</label>
          <input type="url" id="editWebsite" class="form-input" placeholder="https://ornek.com">
        </div>
        <div class="form-group">
          <label class="form-label">Profil Gizliliƒüi</label>
          <div class="checkbox-group">
            <input type="checkbox" id="editPrivateProfile">
            <label for="editPrivateProfile">Profili gizli yap (Sadece takip√ßilerin g√∂rebilir)</label>
          </div>
        </div>
        <button type="submit" class="primary-btn" id="saveProfile">üíæ Kaydet</button>
      </form>
    </div>
  </div>

  <!-- Add Product Modal -->
  <div class="modal" id="addProductModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">‚ûï √úr√ºn Ekle</h2>
        <button class="close-btn" id="closeProductModal">√ó</button>
      </div>
      <form id="productForm">
        <div class="product-form-group">
          <label class="form-label">üñºÔ∏è √úr√ºn G√∂rseli</label>
          <div class="media-upload-section">
            <label class="media-upload-label" style="grid-column: 1 / -1;">
              üì∑ √úr√ºn G√∂rseli
              <input type="file" id="productImage" accept="image/*" style="display: none;">
            </label>
          </div>
          <div id="productPreview"></div>
        </div>
        <div class="form-group">
          <label for="productName" class="form-label">√úr√ºn Adƒ±</label>
          <input type="text" id="productName" class="form-input" placeholder="√úr√ºn adƒ±" required>
        </div>
        <div class="form-group">
          <label for="productPrice" class="form-label">Fiyat</label>
          <input type="number" id="productPrice" class="form-input" placeholder="TL" required>
        </div>
        <div class="form-group">
          <label for="productDescription" class="form-label">A√ßƒ±klama</label>
          <textarea id="productDescription" class="textarea-field" style="min-height: 100px;" placeholder="√úr√ºn a√ßƒ±klamasƒ±"></textarea>
        </div>
        <button type="submit" class="primary-btn" id="submitProduct">‚ûï √úr√ºn Ekle</button>
      </form>
    </div>
  </div>

  <!-- Edit Product Modal -->
  <div class="modal" id="editProductModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">‚úèÔ∏è √úr√ºn√º D√ºzenle</h2>
        <button class="close-btn" id="closeEditProductModal">√ó</button>
      </div>
      <form id="editProductForm">
        <input type="hidden" id="editProductId">
        <div class="product-form-group">
          <label class="form-label">üñºÔ∏è √úr√ºn G√∂rseli</label>
          <div class="media-upload-section">
            <label class="media-upload-label" style="grid-column: 1 / -1;">
              üì∑ Yeni G√∂rsel Y√ºkle
              <input type="file" id="editProductImage" accept="image/*" style="display: none;">
            </label>
          </div>
          <div id="editProductPreview"></div>
        </div>
        <div class="form-group">
          <label for="editProductName" class="form-label">√úr√ºn Adƒ±</label>
          <input type="text" id="editProductName" class="form-input" placeholder="√úr√ºn adƒ±" required>
        </div>
        <div class="form-group">
          <label for="editProductPrice" class="form-label">Fiyat</label>
          <input type="number" id="editProductPrice" class="form-input" placeholder="TL" required>
        </div>
        <div class="form-group">
          <label for="editProductDescription" class="form-label">A√ßƒ±klama</label>
          <textarea id="editProductDescription" class="textarea-field" style="min-height: 100px;" placeholder="√úr√ºn a√ßƒ±klamasƒ±"></textarea>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <button type="button" class="primary-btn" style="background: linear-gradient(135deg, var(--danger-color), var(--danger-dark));" onclick="deleteProduct()">üóëÔ∏è Sil</button>
          <button type="submit" class="primary-btn">üíæ Kaydet</button>
        </div>
      </form>
    </div>
  </div>

  <!-- New Message Modal -->
  <div class="modal new-message-modal" id="newMessageModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">üí¨ Yeni Mesaj</h2>
        <button class="close-btn" id="closeNewMessageModal">√ó</button>
      </div>
      <div class="form-group">
        <input type="text" class="form-input" id="userSearchInput" placeholder="Kullanƒ±cƒ± ara...">
      </div>
      <div class="user-search-results" id="userSearchResults"></div>
    </div>
  </div>

  <!-- Fullscreen Profile Modal -->
  <div class="fullscreen-profile-modal" id="fullscreenProfileModal">
    <div class="fullscreen-profile-header">
      <h2 style="color: white; margin: 0;">Profil</h2>
      <button class="close-btn" style="background: rgba(255,255,255,0.2); color: white;" onclick="closeFullscreenProfileModal()">√ó</button>
    </div>
    <div class="fullscreen-profile-content">
      <div class="fullscreen-profile-avatar" id="fullscreenProfileAvatar" onclick="openFullscreenProfilePic()">üë§</div>
      <h2 class="fullscreen-profile-name" id="fullscreenProfileName">Kullanƒ±cƒ±</h2>
      <p class="fullscreen-profile-username" id="fullscreenProfileUsername">@kullaniciadi</p>
      <p class="fullscreen-profile-bio" id="fullscreenProfileBio">Biyografi ekle...</p>
      <div class="fullscreen-profile-stats">
        <div class="fullscreen-profile-stat">
          <span class="fullscreen-profile-stat-number" id="fullscreenPostCount">0</span>
          <span class="fullscreen-profile-stat-label">G√∂nderiler</span>
        </div>
        <div class="fullscreen-profile-stat">
          <span class="fullscreen-profile-stat-number" id="fullscreenFollowerCount">0</span>
          <span class="fullscreen-profile-stat-label">Takip√ßiler</span>
        </div>
        <div class="fullscreen-profile-stat">
          <span class="fullscreen-profile-stat-number" id="fullscreenFollowingCount">0</span>
          <span class="fullscreen-profile-stat-label">Takip Edilenler</span>
        </div>
      </div>
      <div class="fullscreen-profile-actions">
        <button class="fullscreen-profile-action-btn" id="fullscreenFollowBtn">Takip Et</button>
        <button class="fullscreen-profile-action-btn" id="fullscreenBlockBtn">Engelle</button>
        <button class="fullscreen-profile-action-btn primary" onclick="messageUserFromFullscreenProfile()">Mesaj G√∂nder</button>
      </div>
      <div class="fullscreen-profile-grid" id="fullscreenProfileGrid"></div>
      <div class="loading-indicator" id="fullscreenProfileLoadingIndicator">
        <div class="spinner"></div>
        <p>Daha fazla g√∂nderi y√ºkleniyor...</p>
      </div>
    </div>
  </div>

  <!-- Comments Modal -->
  <div class="comments-modal" id="commentsModal">
    <div class="comments-modal-header">
      <h2 style="color: #1e293b; margin: 0; font-size: 18px; font-weight: 700;">üí¨ Yorumlar</h2>
      <button class="close-btn" style="background: rgba(0,0,0,0.1); color: #1e293b; font-size: 28px; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer;" onclick="closeCommentsModal()">√ó</button>
    </div>
    <div class="comments-modal-content" id="commentsModalContent"></div>
  </div>

  <!-- Saved Videos Modal -->
  <div class="modal" id="savedVideosModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">üìπ Kaydedilen Videolar</h2>
        <button class="close-btn" onclick="document.getElementById('savedVideosModal').classList.remove('active')">√ó</button>
      </div>
      <div class="saved-videos-grid" id="savedVideosGrid"></div>
      <div class="empty-state" id="savedVideosEmpty" style="display: none;">
        <div class="empty-icon">üìπ</div>
        <p class="empty-text">Hen√ºz kaydedilmi≈ü video yok</p>
      </div>
    </div>
  </div>

  <!-- Delete Account Confirmation Modal -->
  <div class="modal" id="deleteAccountModal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h2 class="modal-title">‚ö†Ô∏è Hesabƒ± Sil</h2>
        <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
      </div>
      <p style="color: #64748b; margin-bottom: 24px; line-height: 1.6;">
        Hesabƒ±nƒ±zƒ± silmek √ºzeresiniz. Bu i≈ülem geri alƒ±namaz!<br><br>
        <strong style="color: var(--danger-color);">T√ºm g√∂nderileriniz, mesajlarƒ±nƒ±z ve verileriniz kalƒ±cƒ± olarak silinecek.</strong>
      </p>
      <div class="form-group">
        <label class="form-label">Onaylamak i√ßin ≈üifrenizi girin:</label>
        <input type="password" id="deleteAccountPassword" class="form-input" placeholder="≈ûifreniz">
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <button class="primary-btn" style="background: rgba(0, 0, 0, 0.05);" onclick="this.closest('.modal').remove()">ƒ∞ptal</button>
        <button class="primary-btn" id="confirmDeleteAccount" style="background: linear-gradient(135deg, var(--danger-color), var(--danger-dark));">Hesabƒ± Sil</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Fullscreen Media Modal -->
  <div class="fullscreen-modal" id="fullscreenModal">
    <div class="fullscreen-content">
      <button class="fullscreen-close" onclick="closeFullscreen()">√ó</button>
      <div id="fullscreenMediaContainer"></div>
    </div>
  </div>

  <!-- Profil Galerisi Modal -->
  <div class="profile-gallery-modal" id="profileGalleryModal">
    <div class="gallery-container">
      <div class="gallery-header">
        <h2 style="color: white; margin: 0;">G√∂nderiler</h2>
        <button class="close-btn" style="background: rgba(255,255,255,0.2); color: white;" onclick="closeProfileGallery()">√ó</button>
      </div>
      <div class="gallery-content">
        <button class="gallery-nav prev" onclick="prevGalleryItem()">‚Äπ</button>
        <div id="galleryItemContainer"></div>
        <button class="gallery-nav next" onclick="nextGalleryItem()">‚Ä∫</button>
      </div>
    </div>
  </div>

  <!-- Ses Bildirim -->
  <audio id="notificationSound" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
  </audio>

  <script>

/*
===============================================
GEREKLƒ∞ API ROTALARI (Backend'de eklenmeli)
===============================================

1. Hikaye Silme:
   DELETE /api/stories/:storyId
   - Kullanƒ±cƒ±nƒ±n kendi hikayesini siler
   - Authentication gerekli

2. Hikaye G√∂r√ºnt√ºleyenleri Getir:
   GET /api/stories/:storyId/viewers
   - Hikayeyi g√∂r√ºnt√ºleyen kullanƒ±cƒ±larƒ±n listesini d√∂ner
   - Response: { viewers: [{ username, profilePic, viewedAt }] }

3. Hikayeleri Getir (G√ºncellenmi≈ü):
   GET /api/stories
   - Takip edilen kullanƒ±cƒ±larƒ±n hikayeleri
   - Response: { stories: [...], myStories: [...] }
   - myStories: Kullanƒ±cƒ±nƒ±n kendi hikayeleri

===============================================
*/

    // ============================================
    // G√úVENLƒ∞K VE PERFORMANS ƒ∞Yƒ∞LE≈ûTƒ∞RMELERƒ∞
    // ============================================
    
    // XSS Korumasƒ±
    function escapeHtml(text) {
      const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
      return String(text).replace(/[&<>"']/g, m => map[m]);
    }

    // Input sanitization
    function sanitizeInput(input) {
      if (typeof input !== 'string') return input;
      return input.trim().replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
    }

    // Rate Limiting
    const rateLimiter = {
      requests: {},
      limit: 10,
      window: 60000,
      check: function(key) {
        const now = Date.now();
        if (!this.requests[key]) this.requests[key] = [];
        this.requests[key] = this.requests[key].filter(time => now - time < this.window);
        if (this.requests[key].length >= this.limit) return false;
        this.requests[key].push(now);
        return true;
      }
    };

    // Lazy Loading
    const imageObserver = new IntersectionObserver((entries, observer) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          const src = img.getAttribute('data-src');
          if (src) {
            img.src = src;
            img.removeAttribute('data-src');
            observer.unobserve(img);
          }
        }
      });
    }, { rootMargin: '50px' });

    function enableLazyLoading() {
      document.querySelectorAll('img[data-src]').forEach(img => imageObserver.observe(img));
    }

    // Debounce
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
      };
    }

    // Throttle
    function throttle(func, limit) {
      let inThrottle;
      return function(...args) {
        if (!inThrottle) {
          func.apply(this, args);
          inThrottle = true;
          setTimeout(() => inThrottle = false, limit);
        }
      };
    }

    // Geli≈ümi≈ü Image Compression
    async function compressImage(file, maxWidth = 4096, maxHeight = 4096, quality = 0.95) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = () => reject(new Error('Dosya okunamadƒ±'));
        reader.onload = (e) => {
          const img = new Image();
          img.onerror = () => reject(new Error('Resim y√ºklenemedi'));
          img.onload = () => {
            try {
              const canvas = document.createElement('canvas');
              let width = img.width;
              let height = img.height;
              if (width > maxWidth) { height = (height * maxWidth) / width; width = maxWidth; }
              if (height > maxHeight) { width = (width * maxHeight) / height; height = maxHeight; }
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.imageSmoothingEnabled = true;
              ctx.imageSmoothingQuality = 'high';
              ctx.drawImage(img, 0, 0, width, height);
              canvas.toBlob((blob) => {
                if (blob) {
                  const compressed = new File([blob], file.name, { type: 'image/jpeg', lastModified: Date.now() });
                  console.log('üì¶ Sƒ±kƒ±≈ütƒ±rma: ' + (file.size/1024).toFixed(2) + 'KB ‚Üí ' + (compressed.size/1024).toFixed(2) + 'KB');
                  resolve(compressed);
                } else {
                  reject(new Error('Blob olu≈üturulamadƒ±'));
                }
              }, 'image/jpeg', quality);
            } catch (error) {
              reject(error);
            }
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // API ve Socket.io URL'leri
    const API_BASE = ''; // Bo≈ü bƒ±rakƒ±ldƒ± - aynƒ± sunucu
    const SOCKET_URL = ''; // Bo≈ü bƒ±rakƒ±ldƒ± - aynƒ± sunucu
    
    // Zararlƒ± i√ßerik kontrol√º i√ßin kelime listesi
    const harmfulWords = ['porno', 'seks', 'tehlikeli', 'cinsel', 'nefret', 'amk', 'o√ß', 'saldƒ±rƒ±', 'uyu≈üturucu', 'silah', 'ter√∂r'];
    
    // Global deƒüi≈ükenler
    let currentUser = null;
    let authToken = null;
    let currentTheme = 'light';
    let activeChatUser = null;
    let socket = null;
    let notificationCheckInterval = null;
    let uploadedProfilePicFile = null;
    let editUploadedProfilePicFile = null;
    let uploadedCoverPicFile = null;
    let captchaNum1 = 0;
    let captchaNum2 = 0;
    let currentCaptcha = null;
    let currentLanguage = 'tr';
    let uploadedMediaFile = null;
    let uploadedMediaType = null;
    let userLocation = null;
    let videoObservers = {};
    let lastTap = 0;
    let isRefreshing = false;
    let globalAudioEnabled = false;
    let profilePosts = [];
    let currentGalleryIndex = 0;
    let backgroundUploads = new Set();
    let feedPage = 0;
    let isFeedLoading = false;
    let hasMorePosts = true;
    let feedCache = null;
    let feedCacheTimestamp = null;
    const CACHE_DURATION = 5 * 60 * 1000; // 5 dakika
    let viewedUserPostsPage = 0;
    let viewedUserPosts = [];
    let viewedUserHasMorePosts = true;
    let isTyping = false;
    let typingTimeout = null;
    let currentPostComments = null;
    let touchStartY = 0;
    let touchEndY = 0;
    let currentVideoIndex = 0;
    let videoPosts = [];
    let isVideoFullscreen = false;
    let savedVideos = [];
    let blockedUsers = new Set();
    let profilePageNum = 0;
    let hasMoreProfilePosts = true;
    let seenPostIds = new Set(); // Spam √∂nleme i√ßin g√∂r√ºlen postlar
    let storeProducts = [];
    let storePageNum = 0;
    let hasMoreStoreProducts = true;
    let uploadedMediaFiles = []; // √áoklu fotoƒüraf i√ßin
    let videoCache = new Map(); // Video √∂nbellek
    let followingUsers = new Set(); // Takip edilen kullanƒ±cƒ±lar
    let feedPosts = []; // T√ºm feed postlarƒ±

    // API istekleri i√ßin yardƒ±mcƒ± fonksiyon
    async function apiRequest(endpoint, options = {}) {
      const defaultOptions = {
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          ...options.headers
        },
        mode: 'cors',
        credentials: 'include'
      };
      
      if (authToken && !options.headers?.Authorization) {
        defaultOptions.headers['Authorization'] = `Bearer ${authToken}`;
      }
      
      if (options.body instanceof FormData) {
        delete defaultOptions.headers['Content-Type'];
      }
      
      try {
        console.log(`üì° API ƒ∞steƒüi: ${endpoint}`, options.method || 'GET');
        const response = await fetch(`${API_BASE}${endpoint}`, {
          ...defaultOptions,
          ...options,
          headers: {
            ...defaultOptions.headers,
            ...options.headers
          }
        });
        console.log(`‚úÖ API Yanƒ±tƒ±: ${response.status} ${response.statusText}`);
        return response;
      } catch (error) {
        console.error('‚ùå API Hatasƒ±:', error);
        throw error;
      }
    }

    // Toast bildirimi g√∂sterme
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      if (!toast) return;
      
      toast.textContent = message;
      toast.className = `toast ${type} active`;
      setTimeout(() => toast.classList.remove('active'), 3000);
    }

    // Post i√ßeriƒüini hashtag ve mention ile formatla
    function formatPostContent(content) {
      if (!content) return '';
      
      // √ñnce HTML escape yap
      let formatted = escapeHtml(content);
      
      // Hashtag'leri bul ve stil uygula (#kelime) - mavi renk
      formatted = formatted.replace(/#(\w+)/g, '<span class="hashtag" onclick="searchHashtag(\'$1\')">#$1</span>');
      
      // Mention'larƒ± bul ve stil uygula (@kullanƒ±cƒ±) - ye≈üil renk
      formatted = formatted.replace(/@(\w+)/g, '<span class="mention" onclick="searchAndViewUser(\'$1\')">@$1</span>');
      
      // URL'leri linkle
      formatted = formatted.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color: var(--primary-color);">$1</a>');
      
      return formatted;
    }

    // √áift tƒ±klama kontrol√º
    function handleDoubleTap(event) {
      const currentTime = new Date().getTime();
      const tapLength = currentTime - lastTap;
      if (tapLength < 500 && tapLength > 0) {
        const postCard = event.target.closest('.post-card');
        if (postCard) {
          const postId = postCard.dataset.postId;
          const likeBtn = postCard.querySelector('.like-btn');
          if (likeBtn) {
            toggleLike(postId, likeBtn);
          }
        }
      }
      lastTap = currentTime;
    }

    // Video otomatik oynatma i√ßin Intersection Observer
    function initVideoAutoplay() {
      // √ñnceki observer'larƒ± temizle
      if (videoObservers.videoObserver) {
        videoObservers.videoObserver.disconnect();
      }
      
      // Hover'da video otomatik oynatma (sesli)
      document.querySelectorAll('video.post-media').forEach(video => {
        // Hover ile otomatik oynat (sesli)
        video.addEventListener('mouseenter', () => {
          video.muted = false;
          video.play().catch(e => {
            // Ses izni yoksa sessiz ba≈ülat
            video.muted = true;
            video.play().catch(err => console.log('Video oynatma hatasƒ±:', err));
          });
        });
        
        video.addEventListener('mouseleave', () => {
          video.pause();
          video.currentTime = 0;
        });
        
        // Mobil i√ßin dokunma olaylarƒ±
        video.addEventListener('touchstart', (e) => {
          if (e.target === video) {
            e.stopPropagation();
            if (video.paused) {
              video.muted = false;
              video.play().catch(err => {
                video.muted = true;
                video.play();
              });
            } else {
              video.pause();
            }
          }
        });
      });

      // videoObservers g√ºncellenmesi kaldƒ±rƒ±ldƒ± - hover tabanlƒ± sistem kullanƒ±lƒ±yor
    }

    // Profil fotoƒürafƒ± y√ºkleme i≈ülemleri
    const profilePicInput = document.getElementById('profilePicInput');
    if (profilePicInput) {
      profilePicInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          uploadedProfilePicFile = file;
          const reader = new FileReader();
          reader.onload = (event) => {
            const profilePicPreview = document.getElementById('profilePicPreview');
            if (profilePicPreview) {
              profilePicPreview.innerHTML = `<img src="${event.target.result}" alt="Profil">`;
            }
          };
          reader.readAsDataURL(file);
        }
      });
    }

    // Profil d√ºzenleme fotoƒürafƒ± y√ºkleme
    const editProfilePicInput = document.getElementById('editProfilePicInput');
    if (editProfilePicInput) {
      editProfilePicInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          editUploadedProfilePicFile = file;
          const reader = new FileReader();
          reader.onload = (event) => {
            const editProfilePicPreview = document.getElementById('editProfilePicPreview');
            if (editProfilePicPreview) {
              editProfilePicPreview.innerHTML = `<img src="${event.target.result}" alt="Profil">`;
            }
          };
          reader.readAsDataURL(file);
        }
      });
    }

    // Kapak fotoƒürafƒ± y√ºkleme
    const editCoverPic = document.getElementById('editCoverPic');
    if (editCoverPic) {
      editCoverPic.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          uploadedCoverPicFile = file;
          const reader = new FileReader();
          reader.onload = (event) => {
            const coverPreview = document.getElementById('coverPreview');
            if (coverPreview) {
              coverPreview.innerHTML = `<img src="${event.target.result}" alt="Kapak" style="border-radius: 16px; max-width: 100%;">`;
            }
          };
          reader.readAsDataURL(file);
        }
      });
    }


    // Captcha i≈ülemleri
    const robotCheck = document.getElementById('robotCheck');
    if (robotCheck) {
      robotCheck.addEventListener('change', (e) => {
        const captchaBox = document.getElementById('captchaBox');
        if (captchaBox) {
          if (e.target.checked) {
            currentCaptcha = generateCaptcha();
            captchaBox.classList.add('active');
          } else {
            captchaBox.classList.remove('active');
          }
        }
      });
    }

    function generateCaptcha() {
      captchaNum1 = Math.floor(Math.random() * 10) + 1;
      captchaNum2 = Math.floor(Math.random() * 10) + 1;
      const operations = ['+', '-', '√ó'];
      const operation = operations[Math.floor(Math.random() * operations.length)];
      const captchaQuestion = document.getElementById('captchaQuestion');
      if (captchaQuestion) {
        captchaQuestion.textContent = `${captchaNum1} ${operation} ${captchaNum2} = ?`;
      }
      return { num1: captchaNum1, num2: captchaNum2, operation };
    }

    function calculateCaptcha(num1, num2, operation) {
      switch(operation) {
        case '+': return num1 + num2;
        case '-': return num1 - num2;
        case '√ó': return num1 * num2;
        default: return 0;
      }
    }

    // Giri≈ü i≈ülemi
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = document.getElementById('loginEmail')?.value;
        const password = document.getElementById('loginPassword')?.value;
        const btn = e.target.querySelector('.primary-btn');
        
        if (!email || !password || !btn) return;
        
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Giri≈ü yapƒ±lƒ±yor...';

        try {
          const response = await apiRequest('/api/auth/login', {
            method: 'POST',
            body: JSON.stringify({ email, password })
          });

          let data;
          try {
            data = await response.json();
          } catch (e) {
            data = { message: 'Sunucu yanƒ±t vermiyor' };
          }
          
          btn.disabled = false;
          btn.innerHTML = 'Giri≈ü Yap';

          if (response.ok && data.token) {
            currentUser = data.user;
            authToken = data.token;
            localStorage.setItem('agrolink_token', authToken);
            localStorage.setItem('agrolink_user', JSON.stringify(currentUser));
            
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');
            
            if (loginScreen) loginScreen.classList.remove('active');
            if (mainApp) mainApp.style.display = 'flex';
            
            loadUserData();
            updateProfileNav(); // Profili nav'da g√ºncelle
            showToast('Ho≈ü geldin! üéâ', 'success');
          } else {
            showToast(data.message || 'Giri≈ü ba≈üarƒ±sƒ±z!', 'error');
          }
        } catch (error) {
          console.error('‚ùå Giri≈ü hatasƒ±:', error);
          btn.disabled = false;
          btn.innerHTML = 'Giri≈ü Yap';
          showToast('Sunucuya baƒülanƒ±lamƒ±yor. L√ºtfen internet baƒülantƒ±nƒ±zƒ± kontrol edin.', 'error');
        }
      });
    }

    // Kayƒ±t i≈ülemi
    const registerForm = document.getElementById('registerForm');
    if (registerForm) {
      registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('regName')?.value;
        const username = document.getElementById('regUsername')?.value;
        const email = document.getElementById('regEmail')?.value;
        const password = document.getElementById('regPassword')?.value;
        const captchaAnswer = parseInt(document.getElementById('captchaAnswer')?.value);
        
        if (!name || !username || !email || !password) return;
        
        if (!currentCaptcha) {
          showToast('L√ºtfen robot olmadƒ±ƒüƒ±nƒ±zƒ± onaylayƒ±n!', 'error');
          return;
        }

        const correctAnswer = calculateCaptcha(currentCaptcha.num1, currentCaptcha.num2, currentCaptcha.operation);
        if (captchaAnswer !== correctAnswer) {
          showToast('Captcha yanlƒ±≈ü!', 'error');
          currentCaptcha = generateCaptcha();
          return;
        }

        const btn = e.target.querySelector('.primary-btn');
        if (!btn) return;
        
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Hesap olu≈üturuluyor...';

        try {
          const formData = new FormData();
          formData.append('name', name);
          formData.append('username', username);
          formData.append('email', email);
          formData.append('password', password);
          
          if (uploadedProfilePicFile) {
            formData.append('profilePic', uploadedProfilePicFile);
          }

          const response = await apiRequest('/api/auth/register', {
            method: 'POST',
            body: formData,
            headers: {}
          });

          let data;
          try {
            data = await response.json();
          } catch (e) {
            data = { message: 'Sunucu yanƒ±t vermiyor' };
          }
          
          btn.disabled = false;
          btn.innerHTML = 'Hesap Olu≈ütur';

          if (response.ok && data.token) {
            currentUser = data.user;
            authToken = data.token;
            localStorage.setItem('agrolink_token', authToken);
            localStorage.setItem('agrolink_user', JSON.stringify(currentUser));
            
            const registerScreen = document.getElementById('registerScreen');
            const mainApp = document.getElementById('mainApp');
            
            if (registerScreen) registerScreen.classList.remove('active');
            if (mainApp) mainApp.style.display = 'flex';
            
            loadUserData();
            updateProfileNav(); // Profili nav'da g√ºncelle
            showToast('Ho≈ü geldin! üéâ', 'success');
          } else {
            showToast(data.message || 'Kayƒ±t ba≈üarƒ±sƒ±z!', 'error');
          }
        } catch (error) {
          btn.disabled = false;
          btn.innerHTML = 'Hesap Olu≈ütur';
          showToast('Baƒülantƒ± hatasƒ±: ' + error.message, 'error');
        }
      });
    }

    // Auth ekranlarƒ± arasƒ±nda ge√ßi≈ü
    const goToRegister = document.getElementById('goToRegister');
    if (goToRegister) {
      goToRegister.addEventListener('click', (e) => {
        e.preventDefault();
        const loginScreen = document.getElementById('loginScreen');
        const registerScreen = document.getElementById('registerScreen');
        
        if (loginScreen) loginScreen.classList.remove('active');
        if (registerScreen) registerScreen.classList.add('active');
      });
    }

    const goToLogin = document.getElementById('goToLogin');
    if (goToLogin) {
      goToLogin.addEventListener('click', (e) => {
        e.preventDefault();
        const registerScreen = document.getElementById('registerScreen');
        const loginScreen = document.getElementById('loginScreen');
        
        if (registerScreen) registerScreen.classList.remove('active');
        if (loginScreen) loginScreen.classList.add('active');
      });
    }

    // ≈ûifremi Unuttum ekranƒ±na ge√ßi≈ü
    const goToForgotPassword = document.getElementById('goToForgotPassword');
    if (goToForgotPassword) {
      goToForgotPassword.addEventListener('click', (e) => {
        e.preventDefault();
        const loginScreen = document.getElementById('loginScreen');
        const forgotPasswordScreen = document.getElementById('forgotPasswordScreen');
        
        if (loginScreen) loginScreen.classList.remove('active');
        if (forgotPasswordScreen) forgotPasswordScreen.classList.add('active');
      });
    }

    // ≈ûifremi Unuttum ekranƒ±ndan giri≈ü ekranƒ±na d√∂n
    const backToLogin = document.getElementById('backToLogin');
    if (backToLogin) {
      backToLogin.addEventListener('click', (e) => {
        e.preventDefault();
        const forgotPasswordScreen = document.getElementById('forgotPasswordScreen');
        const loginScreen = document.getElementById('loginScreen');
        
        if (forgotPasswordScreen) forgotPasswordScreen.classList.remove('active');
        if (loginScreen) loginScreen.classList.add('active');
      });
    }

    // ≈ûifremi Unuttum form i≈ülemi
    const forgotPasswordForm = document.getElementById('forgotPasswordForm');
    if (forgotPasswordForm) {
      forgotPasswordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = document.getElementById('forgotEmail')?.value;
        const btn = e.target.querySelector('.primary-btn');
        
        if (!email || !btn) return;
        
        // E-posta format kontrol√º
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email.trim())) {
          showToast('L√ºtfen ge√ßerli bir e-posta adresi girin!', 'error');
          return;
        }
        
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> G√∂nderiliyor...';

        try {
          const response = await apiRequest('/api/auth/forgot-password', {
            method: 'POST',
            body: JSON.stringify({ email: email.trim() })
          });

          let data;
          try {
            data = await response.json();
          } catch (e) {
            data = { message: 'Sunucu yanƒ±t vermiyor' };
          }
          
          btn.disabled = false;
          btn.innerHTML = '≈ûifre Sƒ±fƒ±rlama Linki G√∂nder';

          if (response.ok && data.success) {
            showToast('üìß E-posta g√∂nderildi! L√ºtfen posta kutunuzu kontrol edin. (10 dakika ge√ßerli)', 'success');
            
            // Formu temizle
            document.getElementById('forgotEmail').value = '';
            
            // 3 saniye sonra login ekranƒ±na d√∂n
            setTimeout(() => {
              const forgotPasswordScreen = document.getElementById('forgotPasswordScreen');
              const loginScreen = document.getElementById('loginScreen');
              
              if (forgotPasswordScreen) forgotPasswordScreen.classList.remove('active');
              if (loginScreen) loginScreen.classList.add('active');
            }, 3000);
          } else {
            showToast(data.error || data.message || 'Bir hata olu≈ütu!', 'error');
          }
        } catch (error) {
          console.error('‚ùå ≈ûifremi unuttum hatasƒ±:', error);
          btn.disabled = false;
          btn.innerHTML = '≈ûifre Sƒ±fƒ±rlama Linki G√∂nder';
          showToast('Sunucuya baƒülanƒ±lamƒ±yor. L√ºtfen internet baƒülantƒ±nƒ±zƒ± kontrol edin.', 'error');
        }
      });
    }

    // Gizlilik s√∂zle≈ümesi modalƒ±
    function showPrivacyModal() {
      const modal = document.createElement('div');
      modal.className = 'modal active';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">üìú Gizlilik S√∂zle≈ümesi</h2>
            <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
          </div>
          <div class="privacy-section" style="max-height: 500px;">
            <div class="privacy-item">Verileriniz ≈üifreli olarak saklanƒ±r</div>
            <div class="privacy-item">Ki≈üisel bilgileriniz √º√ß√ºnc√º ≈üahƒ±slarla payla≈üƒ±lmaz</div>
            <div class="privacy-item">Hesabƒ±nƒ±zƒ± istediƒüiniz zaman silebilirsiniz</div>
            <div class="privacy-item">T√ºm payla≈üƒ±mlarƒ±nƒ±z size aittir</div>
            <div class="privacy-item">≈ûifreniz kriptografik y√∂ntemlerle korunur</div>
            <div class="privacy-item">E-posta adresiniz gizli tutulur</div>
            <div class="privacy-item">Spam ve zararlƒ± i√ßerik yasaktƒ±r</div>
            <div class="privacy-item">Telif hakkƒ± ihlali yasaktƒ±r</div>
            <div class="privacy-item">Kullanƒ±cƒ± verilerini satmƒ±yoruz</div>
            <div class="privacy-item">√áerez kullanƒ±mƒ±nƒ± kontrol edebilirsiniz</div>
            <div class="privacy-item">ƒ∞ki fakt√∂rl√º kimlik doƒürulama kullanƒ±lƒ±r</div>
            <div class="privacy-item">Hesap etkinlikleriniz kayƒ±t altƒ±na alƒ±nƒ±r</div>
            <div class="privacy-item">≈û√ºpheli etkinliklerde hesaplar askƒ±ya alƒ±nabilir</div>
            <div class="privacy-item">Yasal s√ºre√ßlerde verileriniz mahkemeye sunulabilir</div>
            <div class="privacy-item">18 ya≈ü altƒ± kullanƒ±cƒ±lar i√ßin ebeveyn izni gereklidir</div>
            <div class="privacy-item">Ticari kullanƒ±m i√ßin izin gereklidir</div>
            <div class="privacy-item">Bot hesaplarƒ± yasaktƒ±r</div>
            <div class="privacy-item">Sahte profil olu≈üturmak yasaktƒ±r</div>
            <div class="privacy-item">Taciz ve nefret s√∂ylemi ho≈üg√∂r√ºlmez</div>
            <div class="privacy-item">Platform kurallarƒ±nƒ± kabul ediyorum</div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // √áƒ±kƒ±≈ü i≈ülemi
    function logout() {
      if (socket) socket.disconnect();
      if (notificationCheckInterval) clearInterval(notificationCheckInterval);
      
      localStorage.removeItem('agrolink_token');
      localStorage.removeItem('agrolink_user');
      localStorage.setItem('agrolink_last_seen', Date.now());
      
      currentUser = null;
      authToken = null;
      
      const mainApp = document.getElementById('mainApp');
      const loginScreen = document.getElementById('loginScreen');
      
      if (mainApp) mainApp.style.display = 'none';
      if (loginScreen) loginScreen.classList.add('active');
      
      showToast('√áƒ±kƒ±≈ü yapƒ±ldƒ± üëã', 'success');
    }

    // Socket.io baƒülantƒ±sƒ±
    function connectSocket() {
      if (!authToken) return;

      try {
        socket = io(SOCKET_URL, {
          auth: {
            token: authToken
          }
        });

        socket.on('connect', () => {
          console.log('üîå Socket.io baƒülantƒ±sƒ± kuruldu');
        });

        socket.on('new_message', (data) => {
          console.log('üì® Yeni mesaj:', data);
          if (activeChatUser && activeChatUser.id === data.senderId) {
            loadChatMessages(data.senderId);
          }
          loadMessages();
          showPushNotification(data.senderUsername, 'size bir mesaj g√∂nderdi', 'üí¨');
        });

        socket.on('notification', (data) => {
          console.log('üîî Yeni bildirim:', data);
          const turkishMessages = {
            'liked your post': 'g√∂nderinizi beƒüendi',
            'commented on your post': 'g√∂nderinize yorum yaptƒ±',
            'started following you': 'sizi takip etmeye ba≈üladƒ±'
          };
          
          if (data.message && turkishMessages[data.message]) {
            data.message = turkishMessages[data.message];
          }
          
          loadNotifications();
          updateNotificationBadge();
          if (data.message) {
            showPushNotification('AgroLink', data.message, 'üîî');
          }
        });

        socket.on('user_online', (data) => {
          console.log('üü¢ Kullanƒ±cƒ± √ßevrimi√ßi:', data);
          if (activeChatUser && activeChatUser.id === data.userId) {
            const chatOnlineIndicator = document.getElementById('chatOnlineIndicator');
            if (chatOnlineIndicator) chatOnlineIndicator.style.display = 'block';
          }
          loadMessages();
        });

        socket.on('user_offline', (data) => {
          console.log('üî¥ Kullanƒ±cƒ± √ßevrimdƒ±≈üƒ±:', data);
          if (activeChatUser && activeChatUser.id === data.userId) {
            const chatOnlineIndicator = document.getElementById('chatOnlineIndicator');
            if (chatOnlineIndicator) chatOnlineIndicator.style.display = 'none';
          }
          loadMessages();
        });

        socket.on('new_like', (data) => {
          console.log('‚ù§Ô∏è Yeni beƒüeni:', data);
          showPushNotification(data.likerUsername, 'g√∂nderinizi beƒüendi', '‚ù§Ô∏è');
        });

        socket.on('new_comment', (data) => {
          console.log('üí¨ Yeni yorum:', data);
          showPushNotification(data.commenterUsername, 'g√∂nderinize yorum yaptƒ±', 'üí¨');
        });

        socket.on('new_follower', (data) => {
          console.log('üë§ Yeni takip√ßi:', data);
          showPushNotification(data.followerUsername, 'sizi takip etmeye ba≈üladƒ±', 'üë§');
        });

        socket.on('message_read', (data) => {
          console.log('‚úì Mesaj okundu:', data);
          if (activeChatUser && activeChatUser.id === data.senderId) {
            updateMessageStatus(data.messageId, 'read');
          }
        });

        socket.on('typing', (data) => {
          if (activeChatUser && activeChatUser.id === data.userId) {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
              typingIndicator.style.display = 'flex';
              setTimeout(() => {
                typingIndicator.style.display = 'none';
              }, 3000);
            }
          }
        });

        socket.on('disconnect', () => {
          console.log('Socket.io baƒülantƒ±sƒ± kesildi');
        });

        socket.on('error', (error) => {
          console.error('Socket.io hatasƒ±:', error);
        });
      } catch (error) {
        console.error('Socket.io baƒülantƒ± hatasƒ±:', error);
      }
    }

    // Kullanƒ±cƒ± verilerini y√ºkle
    async function loadUserData() {
      const profileName = document.getElementById('profileName');
      const profileUsername = document.getElementById('profileUsername');
      const profileAvatar = document.getElementById('profileAvatar');
      const profileCover = document.getElementById('profileCover');
      const profileBio = document.getElementById('profileBio');
      const avatarEditBtn = document.getElementById('avatarEditBtn');
      const coverEditBtn = document.getElementById('coverEditBtn');
      
      if (profileName) profileName.textContent = currentUser.name || currentUser.username;
      if (profileUsername) profileUsername.textContent = '@' + (currentUser.username || 'kullanici');
      
      if (profileAvatar) {
        if (currentUser.profilePic) {
          const profilePicUrl = currentUser.profilePic.startsWith('http') ? currentUser.profilePic : `${API_BASE}${currentUser.profilePic}`;
          profileAvatar.innerHTML = `<img src="${profilePicUrl}" alt="Profil">`;
        } else {
          profileAvatar.textContent = 'üë§';
        }
      }
      
      if (profileCover) {
        if (currentUser.coverPic) {
          const coverPicUrl = currentUser.coverPic.startsWith('http') ? currentUser.coverPic : `${API_BASE}${currentUser.coverPic}`;
          profileCover.innerHTML = `<img src="${coverPicUrl}" alt="Kapak">`;
        }
      }
      
      if (profileBio) profileBio.textContent = currentUser.bio || 'Biyografi ekle...';
      
      if (avatarEditBtn) avatarEditBtn.style.display = 'block';
      if (coverEditBtn) coverEditBtn.style.display = 'block';
      
      getUserLocation();
      connectSocket();
      checkInactiveNotifications();
      loadSavedVideos();
      
      await loadFeed();
      await loadStore();
      await loadMessages();
      await loadNotifications();
      await loadUserStats();
      await loadProfilePosts();
      await loadBlockedUsers();
      
      // Arama kutusunu g√∂ster
      const searchContainer = document.getElementById('searchContainer');
      if (searchContainer) {
        searchContainer.style.display = 'block';
      }
    }

    // Engellenen kullanƒ±cƒ±larƒ± y√ºkle
    async function loadBlockedUsers() {
      try {
        const response = await apiRequest('/api/users/blocked', {
          method: 'GET'
        });

        if (response.ok) {
          const data = await response.json();
          blockedUsers = new Set(data.users.map(user => user.id));
        }
      } catch (error) {
        console.error('Engellenen kullanƒ±cƒ±lar y√ºklenemedi:', error);
      }
    }

    // Konum alma
    function getUserLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            userLocation = {
              latitude: position.coords.latitude,
              longitude: position.coords.longitude
            };
            console.log('üìç Konum alƒ±ndƒ±:', userLocation);
            loadFeed();
          },
          (error) => {
            console.log('‚ö†Ô∏è Konum mevcut deƒüil:', error);
            userLocation = null;
          },
          { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
        );
      }
    }

    // Kullanƒ±cƒ±nƒ±n g√∂nderilerini y√ºkle (Sonsuz kaydƒ±rma ile)
    async function loadProfilePosts(loadMore = false) {
      const container = document.getElementById('profileGrid');
      const loadingIndicator = document.getElementById('profileLoadingIndicator');
      
      if (!container || !loadingIndicator) return;
      
      if (!loadMore) {
        profilePageNum = 0;
        hasMoreProfilePosts = true;
        container.innerHTML = '';
      }
      
      if (!hasMoreProfilePosts) {
        return;
      }
      
      loadingIndicator.classList.add('active');
      
      try {
        const response = await apiRequest(`/api/users/${currentUser.id}/posts?page=${profilePageNum}&limit=5`, {
          method: 'GET'
        });

        if (!response.ok) {
          throw new Error('G√∂nderiler y√ºklenemedi');
        }

        const data = await response.json();
        const posts = data.posts || [];
        
        hasMoreProfilePosts = posts.length === 5;

        if (posts.length === 0 && !loadMore) {
          container.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;"><div class="empty-icon">üìù</div><p class="empty-text">Hen√ºz g√∂nderi yok</p></div>';
          loadingIndicator.classList.remove('active');
          return;
        }

        const postsHTML = posts.map((post, index) => {
          const mediaUrl = post.mediaUrl ? (post.mediaUrl.startsWith('http') ? post.mediaUrl : `${API_BASE}${post.mediaUrl}`) : '';
          
          return `
          <div class="profile-post ${post.mediaUrl ? 'profile-post-multiple' : ''}" onclick="openPostOverlay('${post.mediaUrl}', '${post.mediaType}', ${profilePosts.length + index})">
            ${post.mediaUrl ? (post.mediaType === 'video' 
              ? `<video src="${mediaUrl}" muted></video>`
              : `<img src="${mediaUrl}" alt="G√∂nderi">`
            ) : `<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 24px; color: #64748b;">üìù</div>`}
          </div>
        `}).join('');

        if (loadMore) {
          container.innerHTML += postsHTML;
        } else {
          container.innerHTML = postsHTML;
        }
        
        profilePosts = [...profilePosts, ...posts];
        profilePageNum++;
        
        // Profil sayfasƒ±nda scroll event'i dinle
        if (!loadMore) {
          const mainContent = document.querySelector('.main-content');
          if (mainContent) {
            mainContent.onscroll = () => {
              const profilePage = document.getElementById('profilePage');
              if (!profilePage || !profilePage.classList.contains('active')) return;
              
              const scrollTop = mainContent.scrollTop;
              const scrollHeight = mainContent.scrollHeight;
              const clientHeight = mainContent.clientHeight;
              
              if (scrollTop + clientHeight >= scrollHeight - 100 && hasMoreProfilePosts) {
                loadProfilePosts(true);
              }
            };
          }
        }
      } catch (error) {
        console.error('Profil g√∂nderi y√ºkleme hatasƒ±:', error);
        if (!loadMore) {
          container.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;"><div class="empty-icon">‚ùå</div><p class="empty-text">G√∂nderiler y√ºklenemedi</p></div>';
        }
      }
      
      loadingIndicator.classList.remove('active');
    }

    // Post overlay a√ßma
    function openPostOverlay(mediaUrl, mediaType, index) {
      const overlay = document.getElementById('postOverlay');
      const container = document.getElementById('postOverlayMedia');
      
      if (!overlay || !container) return;
      
      const fullUrl = mediaUrl.startsWith('http') ? mediaUrl : `${API_BASE}${mediaUrl}`;
      
      if (mediaType === 'video') {
        container.innerHTML = `<video src="${fullUrl}" controls autoplay style="max-width: 100%; max-height: 85vh; border-radius: 16px;"></video>`;
      } else {
        container.innerHTML = `<img src="${fullUrl}" alt="G√∂nderi" style="max-width: 100%; max-height: 85vh; border-radius: 16px;">`;
      }
      
      overlay.classList.add('active');
    }

    // Post overlay kapatma
    function closePostOverlay() {
      const overlay = document.getElementById('postOverlay');
      const container = document.getElementById('postOverlayMedia');
      
      if (!overlay) return;
      
      overlay.classList.remove('active');
      
      setTimeout(() => {
        if (container) container.innerHTML = '';
      }, 300);
    }

    // Profil fotoƒürafƒ±nƒ± tam ekran g√∂ster
    function openProfilePicFullscreen() {
      const profileAvatar = document.getElementById('profileAvatar');
      if (!profileAvatar) return;
      
      const img = profileAvatar.querySelector('img');
      
      if (img) {
        openFullscreenWithZoom(img.src, 'image');
      }
    }

    // Profil kapak resmini tam ekran g√∂ster
    function openProfileCoverFullscreen() {
      const profileCover = document.getElementById('profileCover');
      if (!profileCover) return;
      
      const img = profileCover.querySelector('img');
      
      if (img) {
        openFullscreenWithZoom(img.src, 'image');
      }
    }

    // Zoom √∂zellikli tam ekran
    function openFullscreenWithZoom(mediaUrl, mediaType) {
      const modal = document.getElementById('fullscreenModal');
      const container = document.getElementById('fullscreenMediaContainer');
      
      if (!modal || !container) return;
      
      if (mediaType === 'video') {
        container.innerHTML = `<video src="${mediaUrl}" controls autoplay style="max-width: 100%; max-height: 85vh; border-radius: 16px;"></video>`;
      } else {
        container.innerHTML = `<img src="${mediaUrl}" alt="Tam Ekran" style="max-width: 100%; max-height: 85vh; border-radius: 16px; transition: transform 0.3s ease; cursor: zoom-in;" id="zoomableImage">`;
        
        // Zoom √∂zelliƒüi ekle
        setTimeout(() => {
          const img = document.getElementById('zoomableImage');
          if (img) {
            let scale = 1;
            let isDragging = false;
            let startX = 0;
            let startY = 0;
            let translateX = 0;
            let translateY = 0;
            
            // Pinch-to-zoom
            let initialDistance = 0;
            
            img.addEventListener('touchstart', (e) => {
              if (e.touches.length === 2) {
                // Pinch zoom ba≈ülat
                initialDistance = Math.hypot(
                  e.touches[0].clientX - e.touches[1].clientX,
                  e.touches[0].clientY - e.touches[1].clientY
                );
              } else if (e.touches.length === 1 && scale > 1) {
                // Drag ba≈ülat
                isDragging = true;
                startX = e.touches[0].clientX - translateX;
                startY = e.touches[0].clientY - translateY;
              }
            });
            
            img.addEventListener('touchmove', (e) => {
              if (e.touches.length === 2) {
                e.preventDefault();
                const currentDistance = Math.hypot(
                  e.touches[0].clientX - e.touches[1].clientX,
                  e.touches[0].clientY - e.touches[1].clientY
                );
                const scaleDiff = currentDistance / initialDistance;
                scale = Math.min(Math.max(1, scale * scaleDiff), 4);
                initialDistance = currentDistance;
                img.style.transform = `scale(${scale}) translate(${translateX}px, ${translateY}px)`;
                img.style.cursor = scale > 1 ? 'zoom-out' : 'zoom-in';
              } else if (isDragging && e.touches.length === 1) {
                e.preventDefault();
                translateX = e.touches[0].clientX - startX;
                translateY = e.touches[0].clientY - startY;
                img.style.transform = `scale(${scale}) translate(${translateX}px, ${translateY}px)`;
              }
            });
            
            img.addEventListener('touchend', () => {
              isDragging = false;
              if (scale < 1) {
                scale = 1;
                translateX = 0;
                translateY = 0;
                img.style.transform = 'scale(1) translate(0, 0)';
              }
            });
            
            // Double tap to zoom
            let lastTap = 0;
            img.addEventListener('touchend', (e) => {
              const currentTime = new Date().getTime();
              const tapLength = currentTime - lastTap;
              if (tapLength < 300 && tapLength > 0) {
                if (scale === 1) {
                  scale = 2;
                } else {
                  scale = 1;
                  translateX = 0;
                  translateY = 0;
                }
                img.style.transform = `scale(${scale}) translate(${translateX}px, ${translateY}px)`;
                img.style.cursor = scale > 1 ? 'zoom-out' : 'zoom-in';
              }
              lastTap = currentTime;
            });
          }
        }, 100);
      }
      
      modal.classList.add('active');
    }

    // Takip√ßiler listesini g√∂ster
    async function showFollowersList() {
      if (!currentUser) return;
      
      try {
        const response = await apiRequest(`/api/users/${currentUser.id}/followers`, {
          method: 'GET'
        });

        if (response.ok) {
          const data = await response.json();
          const followers = data.followers || [];
          
          const modal = document.createElement('div');
          modal.className = 'modal active';
          modal.innerHTML = `
            <div class="modal-content">
              <div class="modal-header">
                <h2 class="modal-title">üë• Takip√ßiler</h2>
                <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
              </div>
              <div class="user-list">
                ${followers.length === 0 ? '<div class="empty-state"><div class="empty-icon">üë•</div><p class="empty-text">Hen√ºz takip√ßiniz yok</p></div>' : followers.map(user => {
                  const profilePicUrl = user.profilePic ? 
                    (user.profilePic.startsWith('http') ? user.profilePic : API_BASE + user.profilePic) : '';
                  return `
                  <div class="user-list-item" onclick="viewUserProfile('${user.id}'); this.closest('.modal').remove();">
                    <div class="avatar" style="width: 44px; height: 44px; font-size: 18px;">${profilePicUrl ? '<img src="' + profilePicUrl + '" alt="' + user.username + '">' : 'üë§'}</div>
                    <div class="user-list-info">
                      <div class="user-list-name">${user.name || user.username}</div>
                      <div class="user-list-username">@${user.username}</div>
                    </div>
                  </div>
                `}).join('')}
              </div>
            </div>
          `;
          document.body.appendChild(modal);
        }
      } catch (error) {
        console.error('Takip√ßi listesi y√ºkleme hatasƒ±:', error);
        showToast('Takip√ßiler y√ºklenemedi', 'error');
      }
    }

    // Takip edilenler listesini g√∂ster
    async function showFollowingList() {
      if (!currentUser) return;
      
      try {
        const response = await apiRequest(`/api/users/${currentUser.id}/following`, {
          method: 'GET'
        });

        if (response.ok) {
          const data = await response.json();
          const following = data.following || [];
          
          const modal = document.createElement('div');
          modal.className = 'modal active';
          modal.innerHTML = `
            <div class="modal-content">
              <div class="modal-header">
                <h2 class="modal-title">üë• Takip Edilenler</h2>
                <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
              </div>
              <div class="user-list">
                ${following.length === 0 ? '<div class="empty-state"><div class="empty-icon">üë•</div><p class="empty-text">Hen√ºz kimseyi takip etmiyorsunuz</p></div>' : following.map(user => {
                  const profilePicUrl = user.profilePic ? 
                    (user.profilePic.startsWith('http') ? user.profilePic : API_BASE + user.profilePic) : '';
                  return `
                  <div class="user-list-item" onclick="viewUserProfile('${user.id}'); this.closest('.modal').remove();">
                    <div class="avatar" style="width: 44px; height: 44px; font-size: 18px;">${profilePicUrl ? '<img src="' + profilePicUrl + '" alt="' + user.username + '">' : 'üë§'}</div>
                    <div class="user-list-info">
                      <div class="user-list-name">${user.name || user.username}</div>
                      <div class="user-list-username">@${user.username}</div>
                    </div>
                  </div>
                `}).join('')}
              </div>
            </div>
          `;
          document.body.appendChild(modal);
        }
      } catch (error) {
        console.error('Takip edilenler listesi y√ºkleme hatasƒ±:', error);
        showToast('Takip edilenler y√ºklenemedi', 'error');
      }
    }

    // Kullanƒ±cƒ± istatistiklerini y√ºkle
    async function loadUserStats() {
      try {
        const response = await apiRequest(`/api/users/${currentUser.id}/stats`, {
          method: 'GET'
        });

        if (response.ok) {
          const data = await response.json();
          const postCount = document.getElementById('postCount');
          const followerCount = document.getElementById('followerCount');
          const followingCount = document.getElementById('followingCount');
          
          if (postCount) postCount.textContent = data.postCount || 0;
          if (followerCount) followerCount.textContent = data.followerCount || 0;
          if (followingCount) followingCount.textContent = data.followingCount || 0;
        }
      } catch (error) {
        console.error('ƒ∞statistik y√ºkleme hatasƒ±:', error);
      }
    }

    // ƒ∞naktif bildirim kontrol√º
    function checkInactiveNotifications() {
      const lastSeen = localStorage.getItem('agrolink_last_seen');
      const now = Date.now();
      
      if (lastSeen) {
        const hoursSinceLastSeen = (now - parseInt(lastSeen)) / (1000 * 60 * 60);
        
        if (hoursSinceLastSeen >= 12) {
          showToast('12 saatten fazla uzaktaydƒ±nƒ±z! Yeni bildirimleri kontrol edin. üîî', 'success');
        }
      }
      
      localStorage.setItem('agrolink_last_seen', now);
      
      notificationCheckInterval = setInterval(() => {
        localStorage.setItem('agrolink_last_seen', Date.now());
      }, 60000);
    }

    // Feed y√ºkleme - D√úZELTƒ∞LMƒ∞≈û: ƒ∞lk a√ßƒ±lƒ±≈üta 5 g√∂nderi
    async function loadFeed(loadMore = false) {
      if (isFeedLoading) return;
      
      const container = document.getElementById('feedContainer');
      const loadingIndicator = document.getElementById('feedLoadingIndicator');
      
      if (!container || !loadingIndicator) return;
      
      if (!loadMore) {
        feedPage = 0;
        hasMorePosts = true;
        isFeedLoading = true;
        
        const now = Date.now();
        if (feedCache && feedCacheTimestamp && (now - feedCacheTimestamp) < CACHE_DURATION) {
          container.innerHTML = feedCache;
          initVideoAutoplay();
          isFeedLoading = false;
          return;
        }
      } else if (!hasMorePosts) {
        return;
      }
      
      isFeedLoading = true;
      loadingIndicator.classList.add('active');
      
      try {
        let url = `/api/posts?page=${feedPage}&limit=5`;
        if (userLocation) {
          url += `&lat=${userLocation.latitude}&lng=${userLocation.longitude}`;
        }

        const response = await apiRequest(url, {
          method: 'GET'
        });

        if (!response.ok) {
          throw new Error('Feed y√ºklenemedi');
        }

        let data;
        try {
          data = await response.json();
        } catch (e) {
          throw new Error('Veri formatƒ± hatasƒ±');
        }
        const posts = data.posts || [];
        
        // Engellenen kullanƒ±cƒ±larƒ±n g√∂nderilerini filtrele
        const filteredPosts = posts.filter(post => !blockedUsers.has(post.userId));
        
        hasMorePosts = posts.length === 5;

        if (filteredPosts.length === 0 && !loadMore) {
          container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìù</div><p class="empty-text">Hen√ºz g√∂nderi yok</p></div>';
          loadingIndicator.classList.remove('active');
          isFeedLoading = false;
          return;
        }

        // Video postlarƒ± global deƒüi≈ükende sakla
        if (!loadMore) {
          videoPosts = [];
          feedPosts = [];
        }
        const currentVideoPosts = filteredPosts.filter(post => post.mediaType === 'video');
        videoPosts = videoPosts.concat(currentVideoPosts);
        feedPosts = feedPosts.concat(filteredPosts);
        
        const postsHTML = filteredPosts.map((post, index) => {
          const globalIndex = feedPosts.length - filteredPosts.length + index;
          let mediaUrl = '';
          if (post.mediaUrl) {
            mediaUrl = post.mediaUrl.startsWith('http') ? post.mediaUrl : `${API_BASE}${post.mediaUrl}`;
          }
          
          return `
          <div class="post-card" data-post-id="${post.id}">
            <div class="post-header">
              <div class="avatar" onclick="viewUserProfile('${post.userId}')">
                ${post.userProfilePic ? `<img src="${post.userProfilePic.startsWith('http') ? post.userProfilePic : API_BASE + post.userProfilePic}" alt="${post.username}">` : 'üë§'}
              </div>
              <div class="post-user-info" onclick="viewUserProfile('${post.userId}')">
                <h3>${post.username}${post.isUserVerified ? '<span class="verified-badge"></span>' : ''}</h3>
                <p>${formatTime(post.createdAt)}</p>
              </div>
              ${post.userId !== currentUser.id ? `
                <button class="follow-btn ${post.isFollowing ? 'following' : ''}" onclick="toggleFollow('${post.userId}', this)">
                  ${post.isFollowing ? '‚úì Takip Ediyorsun' : '‚ûï Takip Et'}
                </button>
              ` : `
                <button class="icon-btn" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;" onclick="deletePost('${post.id}')">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                </button>
              `}
            </div>
            
            ${post.mediaUrl ? (post.mediaType === 'video' 
              ? `<video src="${mediaUrl}" class="post-media" muted playsinline onclick="openTiktokViewerByIndex(${globalIndex})" style="cursor: pointer;"></video>`
              : `<img src="${mediaUrl}" class="post-media" alt="G√∂nderi medyasƒ±" onclick="openPostOverlay('${post.mediaUrl}', 'image', 0)">`
            ) : ''}
            
            <div class="post-actions">
              <button class="action-btn like-btn" onclick="toggleLike('${post.id}', this)" data-liked="${post.isLiked || false}">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="${post.isLiked ? '#ef4444' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="heart-icon">
                  <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
                <span class="like-count">${post.likeCount || 0}</span>
              </button>
              <button class="action-btn" onclick="openCommentsModal('${post.id}')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                </svg>
                ${post.commentCount || 0}
              </button>
              <button class="action-btn" onclick="openShareModal('${post.id}')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
              </button>
              <button class="action-btn save-btn" onclick="toggleSavePost('${post.id}', this)" data-saved="${post.isSaved || false}" style="margin-left: auto;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="${post.isSaved ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                </svg>
              </button>
            </div>
            <div class="post-content" style="padding: 0 16px;">
              <div style="font-weight: 700; margin-bottom: 4px;">${post.likeCount || 0} beƒüenme</div>
              <div>
                <span style="font-weight: 700; margin-right: 4px;">${post.username}</span>
                ${formatPostContent(post.content)}
              </div>
            </div>
          </div>
        `}).join('');

        if (loadMore) {
          container.innerHTML += postsHTML;
        } else {
          container.innerHTML = postsHTML;
          feedCache = postsHTML;
          feedCacheTimestamp = Date.now();
        }
        
        feedPage++;

        setTimeout(() => {
          initVideoAutoplay();
        }, 500);
      } catch (error) {
        console.error('Feed y√ºkleme hatasƒ±:', error);
        if (!loadMore) {
          container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ùå</div><p class="empty-text">G√∂nderiler y√ºklenemedi</p></div>';
        }
      }
      
      loadingIndicator.classList.remove('active');
      isFeedLoading = false;
    }

    // Touch events for TikTok style scrolling
    function handleTouchStart(event) {
      touchStartY = event.touches[0].clientY;
    }

    function handleTouchEnd(event) {
      touchEndY = event.changedTouches[0].clientY;
      const diff = touchStartY - touchEndY;
      
      if (Math.abs(diff) > 100) {
        const postCard = event.target.closest('.post-card');
        if (postCard) {
          const postId = postCard.dataset.postId;
          const postIndex = videoPosts.findIndex(p => p.id === postId);
          
          if (diff > 0) {
            // Swipe up
            if (postIndex < videoPosts.length - 1) {
              scrollToVideo(postIndex + 1);
            }
          } else {
            // Swipe down
            if (postIndex > 0) {
              scrollToVideo(postIndex - 1);
            }
          }
        }
      }
    }

    function scrollToVideo(index) {
      const videoElement = document.querySelector(`[data-post-id="${videoPosts[index].id}"]`);
      if (videoElement) {
        videoElement.scrollIntoView({ behavior: 'smooth' });
      }
    }

    // Sonsuz kaydƒ±rma
    document.addEventListener('DOMContentLoaded', function() {
      const mainContent = document.querySelector('.main-content');
      if (mainContent) {
        mainContent.addEventListener('scroll', function() {
          const scrollTop = mainContent.scrollTop;
          const scrollHeight = mainContent.scrollHeight;
          const clientHeight = mainContent.clientHeight;
          
          if (scrollTop + clientHeight >= scrollHeight - 100) {
            loadFeed(true);
          }
        });
      }
    });

    // Maƒüaza y√ºkleme
    async function loadStore() {
      const container = document.getElementById('storeContainer');
      if (!container) return;
      
      try {
        const response = await apiRequest('/api/store/products', {
          method: 'GET'
        });

        if (!response.ok) {
          throw new Error('Maƒüaza y√ºklenemedi');
        }

        const data = await response.json();
        const products = data.products || [];

        // Engellenen kullanƒ±cƒ±larƒ±n √ºr√ºnlerini filtrele
        const filteredProducts = products.filter(product => !blockedUsers.has(product.sellerId));

        if (filteredProducts.length === 0) {
          container.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;"><div class="empty-icon">üõí</div><p class="empty-text">Hen√ºz √ºr√ºn yok</p></div>';
          return;
        }

        container.innerHTML = filteredProducts.map(product => {
          // NULL image kontrol√º - D√úZELTƒ∞LDƒ∞
          const defaultImage = '/uploads/products/default.png';
          const productImage = product.image || defaultImage;
          const imageUrl = productImage.startsWith('http') ? productImage : `${API_BASE}${productImage}`;
          const isCurrentUserProduct = product.sellerId === currentUser.id;
          
          return `
          <div class="store-item" data-product-id="${product.id}">
            ${isCurrentUserProduct ? `
              <div class="product-actions">
                <button class="product-edit-btn" onclick="editProduct('${product.id}', '${product.name}', ${product.price}, '${product.description}', '${imageUrl}')">
                  ‚úèÔ∏è
                </button>
                <button class="product-delete-btn" onclick="deleteProduct('${product.id}')">
                  üóëÔ∏è
                </button>
              </div>
            ` : ''}
            <img src="${imageUrl}" alt="${product.name}" class="store-item-image">
            <div class="store-item-info">
              <h3 class="store-item-name">${product.name}</h3>
              <div class="store-item-price">${product.price} TL</div>
              <div class="store-item-actions">
                <button class="contact-seller-btn" onclick="contactSeller('${product.sellerId}', '${product.name}')">
                  Satƒ±cƒ±yla ƒ∞leti≈üim
                </button>
              </div>
            </div>
          </div>
        `}).join('');
      } catch (error) {
        console.error('Maƒüaza y√ºkleme hatasƒ±:', error);
        container.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;"><div class="empty-icon">‚ùå</div><p class="empty-text">Maƒüaza y√ºklenemedi</p></div>';
      }
    }

    // Satƒ±cƒ± ile ileti≈üim
    function contactSeller(sellerId, productName) {
      if (!currentUser) {
        showToast('√ñnce giri≈ü yapmalƒ±sƒ±nƒ±z!', 'error');
        return;
      }
      
      if (blockedUsers.has(sellerId)) {
        showToast('Bu kullanƒ±cƒ±yƒ± engellediniz!', 'error');
        return;
      }
      
      const newMessageModal = document.getElementById('newMessageModal');
      if (newMessageModal) newMessageModal.classList.add('active');
      
      setTimeout(async () => {
        try {
          const response = await apiRequest(`/api/users/${sellerId}`, {
            method: 'GET'
          });
          
          if (response.ok) {
            const data = await response.json();
            const seller = data.user;
            
            if (newMessageModal) newMessageModal.classList.remove('active');
            openChat(sellerId, seller.username);
            
            setTimeout(() => {
              const messageInput = document.getElementById('messageInput');
              if (messageInput) {
                messageInput.value = `Merhaba, "${productName}" √ºr√ºn√º hakkƒ±nda bilgi almak istiyorum.`;
                sendMessage();
              }
            }, 500);
          }
        } catch (error) {
          console.error('Satƒ±cƒ± bilgisi alma hatasƒ±:', error);
          showToast('Satƒ±cƒ± bulunamadƒ±', 'error');
        }
      }, 100);
    }

    // √úr√ºn ekleme modalƒ±
    const addProductBtn = document.getElementById('addProductBtn');
    if (addProductBtn) {
      addProductBtn.addEventListener('click', () => {
        const addProductModal = document.getElementById('addProductModal');
        if (addProductModal) addProductModal.classList.add('active');
      });
    }

    const closeProductModal = document.getElementById('closeProductModal');
    if (closeProductModal) {
      closeProductModal.addEventListener('click', () => {
        const addProductModal = document.getElementById('addProductModal');
        if (addProductModal) addProductModal.classList.remove('active');
      });
    }

    // G√∂nderi ekleme butonu
    const addPostBtn = document.getElementById('addPostBtn');
    if (addPostBtn) {
      addPostBtn.addEventListener('click', () => {
        const addPostModal = document.getElementById('addPostModal');
        if (addPostModal) addPostModal.classList.add('active');
      });
    }

    const closePostModal = document.getElementById('closePostModal');
    if (closePostModal) {
      closePostModal.addEventListener('click', () => {
        const addPostModal = document.getElementById('addPostModal');
        if (addPostModal) addPostModal.classList.remove('active');
      });
    }

    // G√∂nderi ekleme formu
    const postForm = document.getElementById('postForm');
    if (postForm) {
      postForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const content = document.getElementById('postContent')?.value || '';
        const btn = document.getElementById('submitPost');
        
        if (!btn) return;
        
        // ƒ∞√ßerik veya medya olmalƒ±
        if (!content && !uploadedMediaFile) {
          showToast('L√ºtfen bir i√ßerik veya medya ekleyin!', 'error');
          return;
        }
        
        if (content && checkHarmfulContent(content)) {
          showToast('G√∂nderiniz zararlƒ± i√ßerik tespit edildiƒüi i√ßin payla≈üƒ±lamadƒ±!', 'error');
          return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Payla≈üƒ±lƒ±yor...';

        const formData = new FormData();
        formData.append('content', content);
        
        if (uploadedMediaFile) {
          formData.append('media', uploadedMediaFile);
          if (uploadedMediaType === 'video') {
            formData.append('mediaType', 'video');
          }
        }

        try {
          const response = await apiRequest('/api/posts', {
            method: 'POST',
            body: formData,
            headers: {}
          });

          if (response.ok) {
            const data = await response.json();
            postForm.reset();
            const mediaPreview = document.getElementById('mediaPreview');
            if (mediaPreview) mediaPreview.innerHTML = '';
            
            const addPostModal = document.getElementById('addPostModal');
            if (addPostModal) addPostModal.classList.remove('active');
            
            uploadedMediaFile = null;
            uploadedMediaType = null;
            
            // Yeni g√∂nderiyi feed'in en √ºst√ºne ekle
            const newPost = data.post;
            const container = document.getElementById('feedContainer');
            if (container) {
              let mediaUrl = '';
              if (newPost.mediaUrl) {
                mediaUrl = newPost.mediaUrl.startsWith('http') ? newPost.mediaUrl : `${API_BASE}${newPost.mediaUrl}`;
              }
              
              const postHTML = `
              <div class="post-card" data-post-id="${newPost.id}" ondblclick="handleDoubleTap(event)">
                <div class="post-header">
                  <div class="avatar" onclick="viewUserProfile('${newPost.userId}')">
                    ${newPost.userProfilePic ? `<img src="${newPost.userProfilePic.startsWith('http') ? newPost.userProfilePic : API_BASE + newPost.userProfilePic}" alt="${newPost.username}">` : 'üë§'}
                  </div>
                  <div class="post-user-info" onclick="viewUserProfile('${newPost.userId}')">
                    <h3>${newPost.username}</h3>
                    <p>${formatTime(newPost.createdAt)}</p>
                  </div>
                  <button class="icon-btn" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;" onclick="deletePost('${newPost.id}')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                  </button>
                </div>
                <div class="post-content">${newPost.content}</div>
                ${newPost.mediaUrl ? (newPost.mediaType === 'video' 
                  ? `<video src="${mediaUrl}" class="post-media" controls muted playsinline></video>`
                  : `<img src="${mediaUrl}" class="post-media" alt="G√∂nderi medyasƒ±">`
                ) : ''}
                <div class="post-actions">
                  <button class="action-btn like-btn" onclick="toggleLike('${newPost.id}', this)" data-liked="false">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="heart-icon">
                      <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                    </svg>
                    <span class="like-count">0</span>
                  </button>
                  <button class="action-btn" onclick="openCommentsModal('${newPost.id}')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    0
                  </button>
                  <button class="action-btn save-btn" onclick="toggleSavePost('${newPost.id}', this)" data-saved="false">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                    </svg>
                  </button>
                </div>
              </div>
            `;
              
              container.innerHTML = postHTML + container.innerHTML;
            }
            
            loadUserStats();
            loadProfilePosts();
            showToast('G√∂nderi payla≈üƒ±ldƒ±! üéâ', 'success');
          } else {
            const error = await response.json();
            showToast(error.message || 'G√∂nderi payla≈üƒ±lamadƒ±', 'error');
          }
        } catch (error) {
          console.error('G√∂nderi payla≈üma hatasƒ±:', error);
          showToast('G√∂nderi payla≈üƒ±lamadƒ±', 'error');
        }

        btn.disabled = false;
        btn.innerHTML = 'üöÄ Payla≈ü';
      });
    }

    const productForm = document.getElementById('productForm');
    if (productForm) {
      productForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('productName')?.value;
        const price = document.getElementById('productPrice')?.value;
        const description = document.getElementById('productDescription')?.value;
        
        if (!name || !price) return;
        
        const btn = document.getElementById('submitProduct');
        if (!btn) return;
        
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Ekleniyor...';

        const formData = new FormData();
        formData.append('name', name);
        formData.append('price', price);
        formData.append('description', description);
        
        const productImage = document.getElementById('productImage')?.files[0];
        if (productImage) {
          // Resmi sƒ±kƒ±≈ütƒ±r
          const compressedImage = await compressImage(productImage);
          formData.append('image', compressedImage);
        }

        try {
          const response = await apiRequest('/api/store/products', {
            method: 'POST',
            body: formData,
            headers: {}
          });

          if (response.ok) {
            productForm.reset();
            const productPreview = document.getElementById('productPreview');
            if (productPreview) productPreview.innerHTML = '';
            
            const addProductModal = document.getElementById('addProductModal');
            if (addProductModal) addProductModal.classList.remove('active');
            
            loadStore();
            showToast('√úr√ºn eklendi! üéâ', 'success');
          } else {
            const error = await response.json();
            showToast(error.message || '√úr√ºn eklenemedi', 'error');
          }
        } catch (error) {
          console.error('√úr√ºn ekleme hatasƒ±:', error);
          showToast('√úr√ºn eklenemedi', 'error');
        }

        btn.disabled = false;
        btn.innerHTML = '‚ûï √úr√ºn Ekle';
      });
    }

    // Resim sƒ±kƒ±≈ütƒ±rma (compressImage zaten tanƒ±mlƒ±, atla)

    // √úr√ºn d√ºzenleme
    function editProduct(productId, name, price, description, imageUrl) {
      const modal = document.getElementById('editProductModal');
      const editProductId = document.getElementById('editProductId');
      const editProductName = document.getElementById('editProductName');
      const editProductPrice = document.getElementById('editProductPrice');
      const editProductDescription = document.getElementById('editProductDescription');
      const editProductPreview = document.getElementById('editProductPreview');
      
      if (editProductId) editProductId.value = productId;
      if (editProductName) editProductName.value = name;
      if (editProductPrice) editProductPrice.value = price;
      if (editProductDescription) editProductDescription.value = description;
      if (editProductPreview) {
        editProductPreview.innerHTML = `<img src="${imageUrl}" alt="√úr√ºn √ñnizleme" class="product-preview">`;
      }
      
      if (modal) modal.classList.add('active');
    }

    const editProductForm = document.getElementById('editProductForm');
    if (editProductForm) {
      editProductForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const productId = document.getElementById('editProductId')?.value;
        const name = document.getElementById('editProductName')?.value;
        const price = document.getElementById('editProductPrice')?.value;
        const description = document.getElementById('editProductDescription')?.value;
        
        if (!productId || !name || !price) return;
        
        const btn = editProductForm.querySelector('.primary-btn');
        if (!btn) return;
        
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Kaydediliyor...';

        const formData = new FormData();
        formData.append('name', name);
        formData.append('price', price);
        formData.append('description', description);
        
        const editProductImage = document.getElementById('editProductImage')?.files[0];
        if (editProductImage) {
          const compressedImage = await compressImage(editProductImage);
          formData.append('image', compressedImage);
        }

        try {
          const response = await apiRequest(`/api/store/products/${productId}`, {
            method: 'PUT',
            body: formData,
            headers: {}
          });

          if (response.ok) {
            editProductForm.reset();
            const modal = document.getElementById('editProductModal');
            if (modal) modal.classList.remove('active');
            
            loadStore();
            showToast('√úr√ºn g√ºncellendi! üéâ', 'success');
          } else {
            const error = await response.json();
            showToast(error.message || '√úr√ºn g√ºncellenemedi', 'error');
          }
        } catch (error) {
          console.error('√úr√ºn g√ºncelleme hatasƒ±:', error);
          showToast('√úr√ºn g√ºncellenemedi', 'error');
        }

        btn.disabled = false;
        btn.innerHTML = 'üíæ Kaydet';
      });
    }

    // √úr√ºn silme
    async function deleteProduct(productId) {
      if (!confirm('Bu √ºr√ºn√º siliyormusunuz?')) return;
      
      try {
        const response = await apiRequest(`/api/store/products/${productId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          const productElement = document.querySelector(`[data-product-id="${productId}"]`);
          if (productElement) {
            productElement.remove();
          }
          
          const modal = document.getElementById('editProductModal');
          if (modal) modal.classList.remove('active');
          
          showToast('√úr√ºn silindi! üóëÔ∏è', 'success');
        } else {
          const error = await response.json();
          showToast(error.message || '√úr√ºn silinemedi', 'error');
        }
      } catch (error) {
        console.error('√úr√ºn silme hatasƒ±:', error);
        showToast('√úr√ºn silinemedi', 'error');
      }
    }

    // Beƒüeni i≈ülemi
    async function toggleLike(postId, btn) {
      if (!btn) return;
      
      const isLiked = btn.dataset.liked === 'true';
      const heartIcon = btn.querySelector('.heart-icon');
      const likeCount = btn.querySelector('.like-count');
      
      // Optimistic UI Update
      if (isLiked) {
        btn.classList.remove('liked');
        if (heartIcon) heartIcon.setAttribute('fill', 'none');
        btn.dataset.liked = 'false';
        if (likeCount) likeCount.textContent = Math.max(0, parseInt(likeCount.textContent || 0) - 1);
      } else {
        btn.classList.add('liked');
        if (heartIcon) heartIcon.setAttribute('fill', '#ef4444');
        btn.dataset.liked = 'true';
        if (likeCount) likeCount.textContent = parseInt(likeCount.textContent || 0) + 1;
      }

      try {
        await apiRequest(`/api/posts/${postId}/like`, {
          method: isLiked ? 'DELETE' : 'POST'
        });
      } catch (error) {
        console.error('Beƒüeni hatasƒ±:', error);
      }
    }

    // G√∂nderi kaydetme i≈ülemi
    async function toggleSavePost(postId, btn) {
      if (!btn) return;
      
      try {
        const isSaved = btn.dataset.saved === 'true';
        const method = isSaved ? 'DELETE' : 'POST';
        
        const response = await apiRequest(`/api/posts/${postId}/save`, {
          method: method
        });

        if (response.ok) {
          if (isSaved) {
            btn.classList.remove('saved');
            btn.dataset.saved = 'false';
            showToast('G√∂nderi kaydedilenlerden kaldƒ±rƒ±ldƒ±', 'success');
          } else {
            btn.classList.add('saved');
            btn.dataset.saved = 'true';
            showToast('G√∂nderi kaydedildi', 'success');
            
            // Kaydedilen videolar listesini g√ºncelle
            if (btn.closest('.post-card')) {
              const video = btn.closest('.post-card').querySelector('video');
              if (video) {
                loadSavedVideos();
              }
            }
          }
        }
      } catch (error) {
        console.error('G√∂nderi kaydetme hatasƒ±:', error);
        showToast('ƒ∞≈ülem ba≈üarƒ±sƒ±z', 'error');
      }
    }

    // Kaydedilen videolarƒ± y√ºkle
    async function loadSavedVideos() {
      try {
        const response = await apiRequest('/api/posts/saved', {
          method: 'GET'
        });

        if (response.ok) {
          const data = await response.json();
          savedVideos = data.posts || [];
          
          const grid = document.getElementById('savedVideosGrid');
          const empty = document.getElementById('savedVideosEmpty');
          
          if (savedVideos.length === 0) {
            if (grid) grid.innerHTML = '';
            if (empty) empty.style.display = 'block';
            return;
          }
          
          if (empty) empty.style.display = 'none';
          
          if (grid) {
            grid.innerHTML = savedVideos.map(video => {
              const mediaUrl = video.mediaUrl.startsWith('http') ? video.mediaUrl : `${API_BASE}${video.mediaUrl}`;
              
              return `
              <div class="saved-video-item" onclick="openFullscreen('${mediaUrl}', 'video')">
                <video src="${mediaUrl}" muted></video>
              </div>
            `}).join('');
          }
        }
      } catch (error) {
        console.error('Kaydedilen videolar y√ºkleme hatasƒ±:', error);
      }
    }

    // Tam ekran medya g√∂r√ºnt√ºleme
    function openFullscreen(mediaUrl, mediaType) {
      const modal = document.getElementById('fullscreenModal');
      const container = document.getElementById('fullscreenMediaContainer');
      
      if (!modal || !container) return;
      
      if (mediaType === 'video') {
        container.innerHTML = `<video src="${mediaUrl}" controls autoplay style="max-width: 100%; max-height: 85vh; border-radius: 16px;"></video>`;
      } else {
        container.innerHTML = `<img src="${mediaUrl}" alt="Tam Ekran" style="max-width: 100%; max-height: 85vh; border-radius: 16px;">`;
      }
      
      modal.classList.add('active');
    }

    function closeFullscreen() {
      const modal = document.getElementById('fullscreenModal');
      const container = document.getElementById('fullscreenMediaContainer');
      if (!modal) return;
      
      modal.classList.remove('active');
      
      setTimeout(() => {
        if (container) container.innerHTML = '';
      }, 300);
    }

    // Yorumlar modalƒ± - D√úZELTƒ∞LMƒ∞≈û: Mesaj yazma kutusu a≈üaƒüƒ±da
    async function openCommentsModal(postId) {
      const modal = document.getElementById('commentsModal');
      const container = document.getElementById('commentsModalContent');
      
      if (!modal || !container) return;
      
      modal.classList.add('active');
      currentPostComments = postId;
      
      try {
        const response = await apiRequest(`/api/posts/${postId}/comments`, {
          method: 'GET'
        });

        if (!response.ok) {
          throw new Error('Yorumlar y√ºklenemedi');
        }

        const data = await response.json();
        const comments = data.comments || [];

        container.innerHTML = `
          <div class="comments-list" style="flex: 1; overflow-y: auto; max-height: calc(100vh - 220px); padding-bottom: 20px;">
            ${comments.length === 0 ? '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">Hen√ºz yorum yok. ƒ∞lk yorumu sen yap! üí¨</div>' : comments.map(comment => {
              const profilePicUrl = comment.userProfilePic ? 
                (comment.userProfilePic.startsWith('http') ? comment.userProfilePic : `${API_BASE}${comment.userProfilePic}`) : '';
                
              return `
              <div class="comment-item" data-comment-id="${comment.id}">
                <div class="comment-avatar" onclick="viewUserProfile('${comment.userId}')">${profilePicUrl ? `<img src="${profilePicUrl}" alt="${comment.username}">` : 'üë§'}</div>
                <div class="comment-content">
                  <div class="comment-username" onclick="viewUserProfile('${comment.userId}')">${comment.username}</div>
                  <div class="comment-text">${comment.content}</div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div class="comment-time">${formatTime(comment.createdAt)}</div>
                    ${comment.userId === currentUser.id ? `<button style="background: none; border: none; color: rgba(255,255,255,0.5); cursor: pointer; font-size: 12px;" onclick="deleteComment('${comment.id}')">Sil</button>` : ''}
                  </div>
                </div>
              </div>
            `}).join('')}
          </div>
          <div class="comments-modal-form">
            ${currentUser.profilePic ? `<div class="comment-avatar" style="width: 36px; height: 36px; flex-shrink: 0;"><img src="${currentUser.profilePic.startsWith('http') ? currentUser.profilePic : API_BASE + currentUser.profilePic}" alt="Sen" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"></div>` : '<div class="comment-avatar" style="width: 36px; height: 36px; flex-shrink: 0;">üë§</div>'}
            <div class="comment-input-container" style="flex: 1;">
              <input type="text" class="comment-input" id="modalCommentInput" placeholder="Yorum yaz..." style="width: 100%;">
              <button class="send-comment-btn" onclick="sendModalComment()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
              </button>
            </div>
          </div>
        `;
        
        const input = document.getElementById('modalCommentInput');
        if (input) {
          input.focus();
          input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendModalComment();
          });
        }
      } catch (error) {
        console.error('Yorum y√ºkleme hatasƒ±:', error);
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">Yorumlar y√ºklenemedi ‚ùå</div>';
      }
    }

    function closeCommentsModal() {
      const modal = document.getElementById('commentsModal');
      if (!modal) return;
      
      modal.classList.remove('active');
      currentPostComments = null;
    }

    async function sendModalComment() {
      const input = document.getElementById('modalCommentInput');
      if (!input || !currentPostComments) return;
      
      const content = input.value.trim();
      if (!content) return;

      if (checkHarmfulContent(content)) {
        showToast('Yorumunuz zararlƒ± i√ßerik tespit edildiƒüi i√ßin payla≈üƒ±lamadƒ±!', 'error');
        return;
      }

      try {
        const response = await apiRequest(`/api/posts/${currentPostComments}/comments`, {
          method: 'POST',
          body: JSON.stringify({ content })
        });

        if (response.ok) {
          input.value = '';
          openCommentsModal(currentPostComments);
          showToast('Yorum g√∂nderildi! üí¨', 'success');
        } else {
          const error = await response.json();
          showToast(error.message || 'Yorum g√∂nderilemedi', 'error');
        }
      } catch (error) {
        console.error('Yorum g√∂nderme hatasƒ±:', error);
        showToast('Yorum g√∂nderilemedi', 'error');
      }
    }

    async function deleteComment(commentId) {
      try {
        const response = await apiRequest(`/api/comments/${commentId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
          if (commentElement) {
            commentElement.remove();
          }
          showToast('Yorum silindi', 'success');
        } else {
          const error = await response.json();
          showToast(error.message || 'Yorum silinemedi', 'error');
        }
      } catch (error) {
        console.error('Yorum silme hatasƒ±:', error);
        showToast('Yorum silinemedi', 'error');
      }
    }

    // Kullanƒ±cƒ± profili g√∂r√ºnt√ºleme
    async function viewUserProfile(userId) {
      if (userId === currentUser.id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        const profilePage = document.getElementById('profilePage');
        if (profilePage) profilePage.classList.add('active');
        
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        const profileNav = document.querySelector('[data-page="profile"]');
        if (profileNav) profileNav.classList.add('active');
        return;
      }

      try {
        const response = await apiRequest(`/api/users/${userId}`, {
          method: 'GET'
        });

        if (!response.ok) {
          throw new Error('Profil y√ºklenemedi');
        }

        const data = await response.json();
        const user = data.user;
        openFullscreenProfile(user);
      } catch (error) {
        console.error('Profil g√∂r√ºnt√ºleme hatasƒ±:', error);
        showToast('Profil y√ºklenemedi', 'error');
      }
    }

    // Tam ekran profil modalƒ±
    async function openFullscreenProfile(user) {
      const modal = document.getElementById('fullscreenProfileModal');
      if (!modal) return;
      
      // Kullanƒ±cƒ± bilgilerini global deƒüi≈ükene kaydet (mesaj g√∂ndermek i√ßin)
      currentViewingUserId = user.id;
      currentViewingUsername = user.username;
      
      const avatar = document.getElementById('fullscreenProfileAvatar');
      const name = document.getElementById('fullscreenProfileName');
      const username = document.getElementById('fullscreenProfileUsername');
      const bio = document.getElementById('fullscreenProfileBio');
      const postCount = document.getElementById('fullscreenPostCount');
      const followerCount = document.getElementById('fullscreenFollowerCount');
      const followingCount = document.getElementById('fullscreenFollowingCount');
      const followBtn = document.getElementById('fullscreenFollowBtn');
      const blockBtn = document.getElementById('fullscreenBlockBtn');
      const grid = document.getElementById('fullscreenProfileGrid');
      const loadingIndicator = document.getElementById('fullscreenProfileLoadingIndicator');
      
      // ƒ∞sim yanƒ±na doƒürulanmƒ±≈ü rozet ekle
      if (name) {
        name.innerHTML = (user.name || user.username) + (user.isVerified ? '<span class="verified-badge"></span>' : '');
      }
      if (username) username.textContent = '@' + user.username;
      if (bio) bio.innerHTML = user.bio ? formatTextWithHashtagsAndMentions(user.bio) : 'Biyografi yok';
      if (postCount) postCount.textContent = user.postCount || 0;
      if (followerCount) followerCount.textContent = user.followerCount || 0;
      if (followingCount) followingCount.textContent = user.followingCount || 0;
      
      if (avatar) {
        if (user.profilePic) {
          const profilePicUrl = user.profilePic.startsWith('http') ? user.profilePic : `${API_BASE}${user.profilePic}`;
          avatar.innerHTML = `<img src="${profilePicUrl}" alt="${user.username}">`;
        } else {
          avatar.textContent = 'üë§';
        }
      }
      
      if (followBtn) {
        if (user.isFollowing) {
          followBtn.textContent = '‚úì Takip Ediliyor';
          followBtn.classList.add('following');
        } else {
          followBtn.textContent = '‚ûï Takip Et';
          followBtn.classList.remove('following');
        }
        
        followBtn.onclick = () => toggleFollow(user.id, followBtn);
      }
      
      if (blockBtn) {
        if (blockedUsers.has(user.id)) {
          blockBtn.textContent = '‚úì Engellendi';
          blockBtn.classList.add('blocked-btn');
        } else {
          blockBtn.textContent = 'üö´ Engelle';
          blockBtn.classList.remove('blocked-btn');
        }
        
        blockBtn.onclick = () => toggleBlock(user.id, blockBtn);
      }
      
      viewedUserPostsPage = 0;
      viewedUserPosts = [];
      viewedUserHasMorePosts = true;
      
      await loadViewedUserPosts(user.id);
      
      modal.classList.add('active');
      
      const fullscreenProfileContent = document.querySelector('.fullscreen-profile-content');
      if (fullscreenProfileContent) {
        fullscreenProfileContent.onscroll = () => {
          const scrollTop = fullscreenProfileContent.scrollTop;
          const scrollHeight = fullscreenProfileContent.scrollHeight;
          const clientHeight = fullscreenProfileContent.clientHeight;
          
          if (scrollTop + clientHeight >= scrollHeight - 100 && viewedUserHasMorePosts) {
            loadViewedUserPosts(user.id, true);
          }
        };
      }
    }

    function linkifyText(text) {
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.replace(urlRegex, '<a href="$1" target="_blank" style="color: var(--primary-color);">$1</a>');
    }

    async function loadViewedUserPosts(userId, loadMore = false) {
      if (!loadMore) {
        viewedUserPosts = [];
        viewedUserPostsPage = 0;
        viewedUserHasMorePosts = true;
      }
      
      const grid = document.getElementById('fullscreenProfileGrid');
      const loadingIndicator = document.getElementById('fullscreenProfileLoadingIndicator');
      
      if (!grid) return;
      
      if (!loadMore) {
        grid.innerHTML = '';
      }
      
      if (loadingIndicator) loadingIndicator.classList.add('active');
      
      try {
        const response = await apiRequest(`/api/users/${userId}/posts?page=${viewedUserPostsPage}&limit=5`, {
          method: 'GET'
        });

        if (response.ok) {
          const data = await response.json();
          const posts = data.posts || [];
          
          viewedUserHasMorePosts = posts.length === 5;
          
          if (posts.length === 0 && !loadMore) {
            grid.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;"><div class="empty-icon">üìù</div><p class="empty-text">Hen√ºz g√∂nderi yok</p></div>';
            if (loadingIndicator) loadingIndicator.classList.remove('active');
            return;
          }
          
          const postsHTML = posts.map((post, index) => {
            const mediaUrl = post.mediaUrl ? (post.mediaUrl.startsWith('http') ? post.mediaUrl : `${API_BASE}${post.mediaUrl}`) : '';
            
            return `
            <div class="fullscreen-profile-post" onclick="openPostOverlay('${post.mediaUrl}', '${post.mediaType}', ${viewedUserPosts.length + index})">
              ${post.mediaUrl ? (post.mediaType === 'video' 
                ? `<video src="${mediaUrl}" muted></video>`
                : `<img src="${mediaUrl}" alt="G√∂nderi">`
              ) : `<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 24px; color: rgba(255,255,255,0.5);">üìù</div>`}
            </div>
          `}).join('');
          
          if (loadMore) {
            grid.innerHTML += postsHTML;
          } else {
            grid.innerHTML = postsHTML;
          }
          
          viewedUserPosts = [...viewedUserPosts, ...posts];
          viewedUserPostsPage++;
        }
      } catch (error) {
        console.error('G√∂r√ºnt√ºlenen kullanƒ±cƒ± g√∂nderi y√ºkleme hatasƒ±:', error);
        if (!loadMore) {
          grid.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;"><div class="empty-icon">‚ùå</div><p class="empty-text">G√∂nderiler y√ºklenemedi</p></div>';
        }
      }
      
      if (loadingIndicator) loadingIndicator.classList.remove('active');
    }

    function closeFullscreenProfileModal() {
      const modal = document.getElementById('fullscreenProfileModal');
      if (!modal) return;
      
      modal.classList.remove('active');
      
      const fullscreenProfileContent = document.querySelector('.fullscreen-profile-content');
      if (fullscreenProfileContent) fullscreenProfileContent.onscroll = null;
    }

    // Profil sayfasƒ±ndan mesaj g√∂nderme - D√úZELTƒ∞LMƒ∞≈û
    let currentViewingUserId = null;
    let currentViewingUsername = null;
    
    function messageUserFromFullscreenProfile() {
      // Doƒürudan kayƒ±tlƒ± kullanƒ±cƒ± bilgisini kullan
      if (!currentViewingUserId || !currentViewingUsername) {
        showToast('Kullanƒ±cƒ± bilgisi bulunamadƒ±', 'error');
        return;
      }
      
      closeFullscreenProfileModal();
      
      setTimeout(() => {
        // Mesajlar sayfasƒ±na ge√ß
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        const messagesPage = document.getElementById('messagesPage');
        if (messagesPage) messagesPage.classList.add('active');
        
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        const messagesNav = document.querySelector('[data-page="messages"]');
        if (messagesNav) messagesNav.classList.add('active');
        
        // Chat'i doƒürudan a√ß
        openChat(currentViewingUserId, currentViewingUsername);
      }, 100);
    }

    function openFullscreenProfilePic() {
      const avatar = document.getElementById('fullscreenProfileAvatar');
      if (!avatar) return;
      
      const img = avatar.querySelector('img');
      
      if (img) {
        openFullscreenWithZoom(img.src, 'image');
      }
    }

    // Takip i≈ülemi
    async function toggleFollow(userId, btn) {
      if (!btn) return;
      
      try {
        const response = await apiRequest(`/api/users/${userId}/follow`, {
          method: 'POST'
        });

        if (response.ok) {
          const isFollowing = btn.classList.contains('following');
          btn.classList.toggle('following');
          btn.textContent = isFollowing ? '‚ûï Takip Et' : '‚úì Takip Ediliyor';
          showToast(isFollowing ? 'Takip bƒ±rakƒ±ldƒ±' : 'Artƒ±k takip ediyorsun! üéâ', 'success');
          loadFeed();
          loadUserStats();
        }
      } catch (error) {
        console.error('Takip hatasƒ±:', error);
        showToast('ƒ∞≈ülem ba≈üarƒ±sƒ±z', 'error');
      }
    }

    // Engelleme i≈ülemi - D√úZELTƒ∞LMƒ∞≈û: T√ºm ili≈ükileri kes
    async function toggleBlock(userId, btn) {
      if (!btn) return;
      
      const isCurrentlyBlocked = blockedUsers.has(userId);
      
      try {
        const response = await apiRequest(`/api/users/${userId}/block`, {
          method: 'POST'
        });

        if (response.ok) {
          if (isCurrentlyBlocked) {
            blockedUsers.delete(userId);
            btn.textContent = 'üö´ Engelle';
            btn.classList.remove('blocked-btn');
            showToast('Kullanƒ±cƒ± engeli kaldƒ±rƒ±ldƒ±', 'success');
          } else {
            blockedUsers.add(userId);
            btn.textContent = '‚úì Engellendi';
            btn.classList.add('blocked-btn');
            showToast('Kullanƒ±cƒ± engellendi', 'success');
            
            // Engellenen kullanƒ±cƒ±yla olan t√ºm ili≈ükileri kes
            // Feed'den g√∂nderilerini kaldƒ±r
            loadFeed();
            // Maƒüazadan √ºr√ºnlerini kaldƒ±r
            loadStore();
            // Mesajlarƒ± yenile
            loadMessages();
            // Eƒüer aktif sohbet bu kullanƒ±cƒ±ysa, sohbeti kapat
            if (activeChatUser && activeChatUser.id === userId) {
              document.getElementById('backToMessages')?.click();
            }
          }
          
          // Engellenen kullanƒ±cƒ±larƒ± kaydet
          localStorage.setItem('agrolink_blocked_users', JSON.stringify(Array.from(blockedUsers)));
        }
      } catch (error) {
        console.error('Engelleme hatasƒ±:', error);
        showToast('ƒ∞≈ülem ba≈üarƒ±sƒ±z', 'error');
      }
    }

    // Mesaj i≈ülemleri - D√úZELTƒ∞LMƒ∞≈û: Engellenen kullanƒ±cƒ±larla mesajla≈üma engeli
    async function loadMessages() {
      const container = document.getElementById('chatList');
      if (!container) return;
      
      try {
        const response = await apiRequest('/api/messages/conversations', {
          method: 'GET'
        });

        if (!response.ok) {
          throw new Error('Mesajlar y√ºklenemedi');
        }

        const data = await response.json();
        const conversations = data.conversations || [];

        // Engellenen kullanƒ±cƒ±larƒ±n konu≈ümalarƒ±nƒ± filtrele
        const filteredConversations = conversations.filter(conv => !blockedUsers.has(conv.userId));

        if (filteredConversations.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-icon">üí¨</div><p class="empty-text">Hen√ºz mesaj yok</p></div>';
          return;
        }

        container.innerHTML = filteredConversations.map(conv => {
          const profilePicUrl = conv.profilePic ? 
            (conv.profilePic.startsWith('http') ? conv.profilePic : `${API_BASE}${conv.profilePic}`) : '';
            
          return `
          <div class="chat-item" style="display: flex; align-items: center;">
            <div style="flex: 1; display: flex; align-items: center; gap: 14px;" onclick="openChat('${conv.userId}', '${conv.username}')" ontouchstart="startLongPress(event, '${conv.userId}', '${conv.username}')" ontouchend="clearLongPress()">
              <div style="position: relative;">
                <div class="avatar" style="width: 52px; height: 52px; font-size: 22px;">${profilePicUrl ? `<img src="${profilePicUrl}" alt="${conv.username}">` : 'üë§'}</div>
                ${conv.online ? '<div class="online-indicator"></div>' : ''}
              </div>
              <div class="chat-info">
                <div class="chat-name">${conv.username}${conv.isVerified ? '<span class="verified-badge"></span>' : ''}</div>
                <p class="chat-preview">${conv.lastMessage || 'Hen√ºz mesaj yok'}</p>
              </div>
              <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 6px;">
                <span class="chat-time">${formatTime(conv.lastMessageTime)}</span>
                ${conv.unread > 0 ? `<span class="unread-badge">${conv.unread}</span>` : ''}
              </div>
            </div>
            <button class="chat-item-delete" onclick="event.stopPropagation(); deleteConversation('${conv.userId}')">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              </svg>
            </button>
          </div>
        `}).join('');
      } catch (error) {
        console.error('Mesaj y√ºkleme hatasƒ±:', error);
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ùå</div><p class="empty-text">Mesajlar y√ºklenemedi</p></div>';
      }
    }

    let longPressTimer;
    function startLongPress(event, userId, username) {
      longPressTimer = setTimeout(() => {
        showMessageContextMenu(event, userId, username);
      }, 1000);
    }

    function clearLongPress() {
      if (longPressTimer) {
        clearTimeout(longPressTimer);
      }
    }

    function showMessageContextMenu(event, userId, username) {
      event.preventDefault();
      
      const existingMenu = document.querySelector('.message-context-menu');
      if (existingMenu) existingMenu.remove();
      
      const menu = document.createElement('div');
      menu.className = 'message-context-menu';
      menu.style.left = `${event.touches[0].clientX - 100}px`;
      menu.style.top = `${event.touches[0].clientY - 50}px`;
      
      menu.innerHTML = `
        <div class="context-menu-item" onclick="deleteConversation('${userId}')">
          üóëÔ∏è Konu≈ümayƒ± Sil
        </div>
        <div class="context-menu-item" onclick="toggleBlock('${userId}', this)">
          ${blockedUsers.has(userId) ? '‚úì Engeli Kaldƒ±r' : 'üö´ Engelle'}
        </div>
      `;
      
      document.body.appendChild(menu);
      
      setTimeout(() => {
        document.addEventListener('touchstart', closeContextMenu);
      }, 100);
    }

    function closeContextMenu() {
      const menu = document.querySelector('.message-context-menu');
      if (menu) menu.remove();
      document.removeEventListener('touchstart', closeContextMenu);
    }

    async function deleteConversation(userId) {
      if (!confirm('Bu konu≈ümayƒ± siliyormusunuz?')) return;
      
      try {
        const response = await apiRequest(`/api/messages/conversations/${userId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          loadMessages();
          showToast('Konu≈üma silindi', 'success');
        }
      } catch (error) {
        console.error('Konu≈üma silme hatasƒ±:', error);
        showToast('Konu≈üma silinemedi', 'error');
      }
    }

    function openChat(userId, username) {
      // Engellenen kullanƒ±cƒ± kontrol√º
      if (blockedUsers.has(userId)) {
        showToast('Bu kullanƒ±cƒ±yƒ± engellediniz!', 'error');
        return;
      }
      
      activeChatUser = { id: userId, username };
      const chatName = document.getElementById('chatName');
      const chatAvatar = document.getElementById('chatAvatar');
      
      if (chatName) chatName.textContent = username;
      if (chatAvatar) chatAvatar.textContent = 'üë§';
      
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      const chatScreen = document.getElementById('chatScreen');
      if (chatScreen) chatScreen.style.display = 'block';
      
      loadChatMessages(userId);
    }

    async function loadChatMessages(userId) {
      const container = document.getElementById('messagesContainer');
      if (!container) return;
      
      try {
        const response = await apiRequest(`/api/messages/${userId}`, {
          method: 'GET'
        });

        if (!response.ok) {
          throw new Error('Mesajlar y√ºklenemedi');
        }

        const data = await response.json();
        const messages = data.messages || [];

        if (messages.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-icon">üí¨</div><p class="empty-text">Hen√ºz mesaj yok</p></div>';
          return;
        }

        container.innerHTML = messages.map(msg => {
          const isSent = msg.senderId === currentUser.id;
          
          // G√∂nderen bilgilerini al
          const senderName = msg.senderUsername || 'Bilinmeyen';
          const senderProfilePic = msg.senderProfilePic ? 
            (msg.senderProfilePic.startsWith('http') ? msg.senderProfilePic : API_BASE + msg.senderProfilePic) : '';
          
          // Post payla≈üƒ±mƒ± mƒ± kontrol et
          let messageContent = msg.content;
          if (msg.type === 'post_share' && msg.postId) {
            messageContent = `
              <div class="shared-post-preview" onclick="openSharedPost('${msg.postId}')" style="background: rgba(0,0,0,0.1); border-radius: 12px; padding: 12px; margin-bottom: 8px; cursor: pointer; border: 2px solid rgba(16, 185, 129, 0.3);">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <span style="font-size: 20px;">üì∑</span>
                  <span style="font-weight: 600; font-size: 13px;">Payla≈üƒ±lan G√∂nderi</span>
                </div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.7);">G√∂r√ºnt√ºlemek i√ßin dokunun</div>
              </div>
            `;
          } else if (msg.content.includes('/post/')) {
            // URL i√ßinde post linki varsa da √ßer√ßeveli g√∂ster
            const postMatch = msg.content.match(/\/post\/([a-zA-Z0-9-]+)/);
            if (postMatch) {
              messageContent = `
                <div class="shared-post-preview" onclick="openSharedPost('${postMatch[1]}')" style="background: rgba(0,0,0,0.15); border-radius: 12px; padding: 12px; margin-bottom: 8px; cursor: pointer; border: 2px solid rgba(16, 185, 129, 0.3); transition: all 0.2s ease;">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                    <span style="font-size: 20px;">üì∑</span>
                    <span style="font-weight: 700; font-size: 13px;">Payla≈üƒ±lan G√∂nderi</span>
                  </div>
                  <div style="font-size: 12px; opacity: 0.8;">üëÜ G√∂r√ºnt√ºlemek i√ßin dokunun</div>
                </div>
              `;
            }
          }
          
          return `
            <div class="message ${isSent ? 'sent' : 'received'}" data-message-id="${msg.id}">
              ${!isSent ? `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                  <div style="width: 28px; height: 28px; border-radius: 50%; overflow: hidden; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; flex-shrink: 0;">
                    ${senderProfilePic ? `<img src="${senderProfilePic}" style="width: 100%; height: 100%; object-fit: cover;">` : 'üë§'}
                  </div>
                  <span style="font-weight: 700; font-size: 12px; color: var(--text-light);">${senderName}</span>
                </div>
              ` : ''}
              ${messageContent}
              <div class="message-status ${msg.read ? 'read' : ''}">
                ${isSent ? (msg.read ? '‚úì‚úì' : '‚úì') : ''}
              </div>
            </div>
          `;
        }).join('');

        container.scrollTop = container.scrollHeight;
      } catch (error) {
        console.error('Mesaj y√ºkleme hatasƒ±:', error);
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ùå</div><p class="empty-text">Mesajlar y√ºklenemedi</p></div>';
      }
    }

    function updateMessageStatus(messageId, status) {
      const message = document.querySelector(`[data-message-id="${messageId}"]`);
      if (message) {
        const statusElement = message.querySelector('.message-status');
        if (statusElement) {
          statusElement.textContent = status === 'read' ? '‚úì‚úì' : '‚úì';
          statusElement.classList.toggle('read', status === 'read');
        }
      }
    }

    // Typing indicator
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
      messageInput.addEventListener('input', () => {
        if (!isTyping && activeChatUser) {
          isTyping = true;
          socket.emit('typing', { userId: activeChatUser.id });
          
          if (typingTimeout) clearTimeout(typingTimeout);
          typingTimeout = setTimeout(() => {
            isTyping = false;
          }, 3000);
        }
      });
    }

    const sendMessageBtn = document.getElementById('sendMessage');
    if (sendMessageBtn) {
      sendMessageBtn.addEventListener('click', sendMessage);
    }

    if (messageInput) {
      messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });
    }

    async function sendMessage() {
      const input = document.getElementById('messageInput');
      if (!input || !activeChatUser) return;
      
      const content = input.value.trim();
      if (!content) return;

      // Engellenen kullanƒ±cƒ± kontrol√º
      if (blockedUsers.has(activeChatUser.id)) {
        showToast('Bu kullanƒ±cƒ±yƒ± engellediniz!', 'error');
        return;
      }

      try {
        const response = await apiRequest('/api/messages', {
          method: 'POST',
          body: JSON.stringify({
            recipientId: activeChatUser.id,
            content
          })
        });

        if (response.ok) {
          input.value = '';
          loadChatMessages(activeChatUser.id);
          
          if (socket) {
            socket.emit('send_message', {
              recipientId: activeChatUser.id,
              content
            });
          }
        }
      } catch (error) {
        console.error('Mesaj g√∂nderme hatasƒ±:', error);
        showToast('Mesaj g√∂nderilemedi', 'error');
      }
    }

    const backToMessages = document.getElementById('backToMessages');
    if (backToMessages) {
      backToMessages.addEventListener('click', () => {
        const chatScreen = document.getElementById('chatScreen');
        const messagesPage = document.getElementById('messagesPage');
        
        if (chatScreen) chatScreen.style.display = 'none';
        if (messagesPage) messagesPage.classList.add('active');
        
        activeChatUser = null;
        
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        const messagesNav = document.querySelector('[data-page="messages"]');
        if (messagesNav) messagesNav.classList.add('active');
      });
    }

    // Yeni mesaj modalƒ± - D√úZELTƒ∞LMƒ∞≈û: Kullanƒ±cƒ± arama √ßalƒ±≈üƒ±yor
    const newMessageBtn = document.getElementById('newMessageBtn');
    if (newMessageBtn) {
      newMessageBtn.addEventListener('click', () => {
        const newMessageModal = document.getElementById('newMessageModal');
        const userSearchInput = document.getElementById('userSearchInput');
        
        if (newMessageModal) newMessageModal.classList.add('active');
        if (userSearchInput) {
          userSearchInput.focus();
          userSearchInput.value = '';
          document.getElementById('userSearchResults').innerHTML = '';
        }
      });
    }

    // Kullanƒ±cƒ± arama (Yeni mesaj modalƒ± i√ßin)
    const userSearchInput = document.getElementById('userSearchInput');
    if (userSearchInput) {
      userSearchInput.addEventListener('input', debounce(async (e) => {
        const query = e.target.value.trim();
        const resultsContainer = document.getElementById('userSearchResults');
        
        if (!resultsContainer) return;
        
        if (query.length < 2) {
          resultsContainer.innerHTML = '';
          return;
        }
        
        try {
          const response = await apiRequest(`/api/users/search?q=${encodeURIComponent(query)}`, {
            method: 'GET'
          });
          
          if (response.ok) {
            const data = await response.json();
            const users = data.users || [];
            
            if (users.length === 0) {
              resultsContainer.innerHTML = '<div class="empty-state"><div class="empty-icon">üë•</div><p class="empty-text">Kullanƒ±cƒ± bulunamadƒ±</p></div>';
            } else {
              resultsContainer.innerHTML = users.map(user => {
                const profilePicUrl = user.profilePic ? 
                  (user.profilePic.startsWith('http') ? user.profilePic : `${API_BASE}${user.profilePic}`) : '';
                  
                return `
                <div class="user-search-item" onclick="openChat('${user.id}', '${user.username}'); document.getElementById('newMessageModal').classList.remove('active');">
                  <div class="avatar" style="width: 44px; height: 44px; font-size: 18px;">${profilePicUrl ? `<img src="${profilePicUrl}" alt="${user.username}">` : 'üë§'}</div>
                  <div>
                    <div style="font-weight: 700; color: var(--text-light);">${user.name || user.username}</div>
                    <div style="font-size: 14px; color: #64748b;">@${user.username}</div>
                  </div>
                </div>
              `}).join('');
            }
          }
        } catch (error) {
          console.error('Kullanƒ±cƒ± arama hatasƒ±:', error);
          resultsContainer.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ùå</div><p class="empty-text">Arama yapƒ±lamadƒ±</p></div>';
        }
      }, 300));
    }

    const closeNewMessageModal = document.getElementById('closeNewMessageModal');
    if (closeNewMessageModal) {
      closeNewMessageModal.addEventListener('click', () => {
        const newMessageModal = document.getElementById('newMessageModal');
        if (newMessageModal) newMessageModal.classList.remove('active');
      });
    }

    // Profil d√ºzenleme
    const editProfileBtn = document.getElementById('editProfileBtn');
    if (editProfileBtn) {
      editProfileBtn.addEventListener('click', () => {
        const editName = document.getElementById('editName');
        const editEmail = document.getElementById('editEmail');
        const editBio = document.getElementById('editBio');
        const editWebsite = document.getElementById('editWebsite');
        const editPrivateProfile = document.getElementById('editPrivateProfile');
        const editProfilePicPreview = document.getElementById('editProfilePicPreview');
        const editProfileModal = document.getElementById('editProfileModal');
        
        if (editName) editName.value = currentUser.name || '';
        if (editEmail) editEmail.value = currentUser.email || '';
        if (editBio) editBio.value = currentUser.bio || '';
        if (editWebsite) editWebsite.value = currentUser.website || '';
        if (editPrivateProfile) editPrivateProfile.checked = currentUser.isPrivate || false;
        
        if (editProfilePicPreview && currentUser.profilePic) {
          const profilePicUrl = currentUser.profilePic.startsWith('http') ? currentUser.profilePic : `${API_BASE}${currentUser.profilePic}`;
          editProfilePicPreview.innerHTML = `<img src="${profilePicUrl}" alt="Profil">`;
        } else if (editProfilePicPreview) {
          editProfilePicPreview.textContent = 'üë§';
        }
        
        if (editProfileModal) editProfileModal.classList.add('active');
      });
    }

    const closeProfileModal = document.getElementById('closeProfileModal');
    if (closeProfileModal) {
      closeProfileModal.addEventListener('click', () => {
        const editProfileModal = document.getElementById('editProfileModal');
        if (editProfileModal) editProfileModal.classList.remove('active');
      });
    }

    const editProfileForm = document.getElementById('editProfileForm');
    if (editProfileForm) {
      editProfileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const btn = document.getElementById('saveProfile');
        if (!btn) return;
        
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Kaydediliyor...';

        try {
          const formData = new FormData();
          const editName = document.getElementById('editName');
          const editEmail = document.getElementById('editEmail');
          const editBio = document.getElementById('editBio');
          const editWebsite = document.getElementById('editWebsite');
          const editPrivateProfile = document.getElementById('editPrivateProfile');
          
          if (editName) formData.append('name', editName.value);
          if (editEmail) formData.append('email', editEmail.value);
          if (editBio) formData.append('bio', editBio.value);
          if (editWebsite) formData.append('website', editWebsite.value);
          if (editPrivateProfile) formData.append('isPrivate', editPrivateProfile.checked);
          
          if (editUploadedProfilePicFile) {
            formData.append('profilePic', editUploadedProfilePicFile);
          }
          
          if (uploadedCoverPicFile) {
            formData.append('coverPic', uploadedCoverPicFile);
          }

          const response = await apiRequest('/api/users/profile', {
            method: 'PUT',
            body: formData,
            headers: {}
          });

          if (response.ok) {
            const data = await response.json();
            currentUser = { ...currentUser, ...data.user };
            localStorage.setItem('agrolink_user', JSON.stringify(currentUser));
            
            const profileName = document.getElementById('profileName');
            const profileBio = document.getElementById('profileBio');
            const profileAvatar = document.getElementById('profileAvatar');
            const profileCover = document.getElementById('profileCover');
            
            if (profileName) profileName.textContent = currentUser.name || currentUser.username;
            if (profileBio) profileBio.innerHTML = currentUser.bio ? linkifyText(currentUser.bio) : 'Biyografi ekle...';
            
            if (profileAvatar) {
              if (currentUser.profilePic) {
                const profilePicUrl = currentUser.profilePic.startsWith('http') ? currentUser.profilePic : `${API_BASE}${currentUser.profilePic}`;
                profileAvatar.innerHTML = `<img src="${profilePicUrl}" alt="Profil">`;
              } else {
                profileAvatar.textContent = 'üë§';
              }
            }
            
            if (profileCover) {
              if (currentUser.coverPic) {
                const coverPicUrl = currentUser.coverPic.startsWith('http') ? currentUser.coverPic : `${API_BASE}${currentUser.coverPic}`;
                profileCover.innerHTML = `<img src="${coverPicUrl}" alt="Kapak">`;
              }
            }
            
            const editProfileModal = document.getElementById('editProfileModal');
            if (editProfileModal) editProfileModal.classList.remove('active');
            
            editUploadedProfilePicFile = null;
            uploadedCoverPicFile = null;
            loadFeed();
            loadProfilePosts();
            showToast('Profil g√ºncellendi! üéâ', 'success');
          } else {
            showToast('Profil g√ºncellenemedi', 'error');
          }
        } catch (error) {
          console.error('Profil g√ºncelleme hatasƒ±:', error);
          showToast('Profil g√ºncellenemedi', 'error');
        }

        btn.disabled = false;
        btn.innerHTML = 'üíæ Kaydet';
      });
    }

    // G√∂nderi silme
    async function deletePost(postId) {
      const postCard = document.querySelector(`[data-post-id="${postId}"]`);
      if (!postCard) return;

      const deleteBtn = postCard.querySelector('.icon-btn');
      if (!deleteBtn) return;
      
      const originalHTML = deleteBtn.innerHTML;
      
      deleteBtn.innerHTML = `
        <button style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 700; cursor: pointer; margin-right: 6px;" onclick="event.stopPropagation(); confirmDeletePost('${postId}')">
          Sil
        </button>
        <button style="background: rgba(255,255,255,0.1); color: white; border: none; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 700; cursor: pointer;" onclick="event.stopPropagation(); cancelDeletePost('${postId}', \`${originalHTML.replace(/`/g, '\\`')}\`)">
          ƒ∞ptal
        </button>
      `;
    }

    async function confirmDeletePost(postId) {
      // Optimistic update - Remove immediately
      const postCard = document.querySelector(`[data-post-id="${postId}"]`);
      if (postCard) {
        postCard.style.transition = 'all 0.3s ease';
        postCard.style.opacity = '0';
        setTimeout(() => postCard.remove(), 100);
      }
      showToast('G√∂nderi silindi! üóëÔ∏è', 'success');

      try {
        await apiRequest(`/api/posts/${postId}`, {
          method: 'DELETE'
        });
        
        // Background sync
        loadUserStats().catch(() => {});
        loadProfilePosts().catch(() => {});
      } catch (error) {
        console.error('G√∂nderi silme hatasƒ±:', error);
      }
    }

    function cancelDeletePost(postId, originalHTML) {
      const postCard = document.querySelector(`[data-post-id="${postId}"]`);
      if (postCard) {
        const deleteBtn = postCard.querySelector('.icon-btn');
        if (deleteBtn) deleteBtn.innerHTML = originalHTML;
      }
    }

    // Bildirimler - TAM EKRAN a√ßƒ±lƒ±≈ü + Geri tu≈üu desteƒüi
    const notificationsBtn = document.getElementById('notificationsBtn');
    if (notificationsBtn) {
      notificationsBtn.addEventListener('click', () => {
        const panel = document.getElementById('notificationsPanel');
        if (!panel) return;
        
        // Geri tu≈üu i√ßin history'ye ekle
        history.pushState({ notifications: true }, '', '');
        
        // Tam ekran olarak g√∂ster
        panel.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Animasyon ekle
        panel.style.opacity = '0';
        panel.style.transform = 'translateY(20px)';
        requestAnimationFrame(() => {
          panel.style.transition = 'all 0.3s ease';
          panel.style.opacity = '1';
          panel.style.transform = 'translateY(0)';
        });
        
        markNotificationsAsRead();
        loadNotifications();
      });
    }

    async function loadNotifications() {
      try {
        const response = await apiRequest('/api/notifications', {
          method: 'GET'
        });

        if (response.ok) {
          const data = await response.json();
          const notifications = data.notifications || [];
          
          const container = document.getElementById('notificationsList');
          if (!container) return;
          
          if (notifications.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-icon">üîî</div><p class="empty-text">Bildirim yok</p></div>';
          } else {
            container.innerHTML = notifications.map(notif => {
              // Bildirimde kullanƒ±cƒ± adƒ±nƒ± √ßƒ±kar ve tƒ±klanabilir yap
              const messageWithClickableUser = renderNotificationMessage(notif);
              
              return `
              <div class="notification-item ${notif.read ? '' : 'unread'}" data-user-id="${notif.fromUserId || ''}" data-type="${notif.type || ''}">
                <div class="notification-icon">${notif.icon || 'üì¢'}</div>
                <div class="notification-content">
                  <p class="notification-text">${messageWithClickableUser}</p>
                  <p class="notification-time">${formatTime(notif.createdAt)}</p>
                </div>
              </div>
            `}).join('');
            
            // Bildirim √∂ƒüelerine tƒ±klama eventi ekle
            container.querySelectorAll('.notification-item').forEach(item => {
              const userId = item.dataset.userId;
              const type = item.dataset.type;
              if (userId && (type === 'follow' || type === 'like' || type === 'comment' || type === 'mention')) {
                item.style.cursor = 'pointer';
                item.addEventListener('click', () => {
                  viewUserProfile(userId);
                  document.getElementById('notificationsPanel').classList.remove('active');
                });
              }
            });
          }
          
          updateNotificationBadge();
        }
      } catch (error) {
        console.error('Bildirim y√ºkleme hatasƒ±:', error);
      }
    }

    async function markNotificationsAsRead() {
      try {
        const response = await apiRequest('/api/notifications/read', {
          method: 'POST'
        });

        if (response.ok) {
          updateNotificationBadge();
        }
      } catch (error) {
        console.error('Bildirim okundu i≈üaretleme hatasƒ±:', error);
      }
    }

    function updateNotificationBadge() {
      const badge = document.getElementById('notificationBadge');
      if (!badge) return;
      
      const unreadNotifications = document.querySelectorAll('.notification-item.unread');
      
      if (unreadNotifications.length > 0) {
        badge.textContent = unreadNotifications.length;
        badge.classList.add('active');
      } else {
        badge.classList.remove('active');
      }
    }

    // Push bildirimleri
    function showPushNotification(title, message, icon) {
      if (!("Notification" in window)) {
        console.log("Bu tarayƒ±cƒ± bildirimleri desteklemiyor");
        return;
      }

      if (Notification.permission === "granted") {
        createNotification(title, message, icon);
      } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then(permission => {
          if (permission === "granted") {
            createNotification(title, message, icon);
          }
        });
      }

      createUINotification(title, message, icon);
      playNotificationSound();
    }

    function createNotification(title, message, icon) {
      const notification = new Notification(title, {
        body: message,
        icon: '/favicon.ico',
        badge: '/favicon.ico'
      });

      notification.onclick = function() {
        window.focus();
        notification.close();
      };
    }

    function createUINotification(title, message, icon) {
      const notification = document.createElement('div');
      notification.className = 'push-notification';
      notification.innerHTML = `
        <div class="push-header">
          <div class="push-avatar">${icon}</div>
          <div class="push-title">${title}</div>
        </div>
        <div class="push-content">${message}</div>
        <div class="push-time">≈ûimdi</div>
      `;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.classList.add('hide');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 5000);
    }

    function playNotificationSound() {
      const sound = document.getElementById('notificationSound');
      if (sound) {
        sound.currentTime = 0;
        sound.play().catch(e => console.log('Ses √ßalƒ±namadƒ±:', e));
      }
    }

    // Kullanƒ±cƒ± arama (Header'daki)
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
      searchInput.addEventListener('input', debounce(async (e) => {
        const query = e.target.value.trim();
        const resultsContainer = document.getElementById('searchResults');
        
        if (!resultsContainer) return;
        
        if (query.length < 2) {
          resultsContainer.classList.remove('active');
          resultsContainer.innerHTML = '';
          return;
        }
        
        try {
          const response = await apiRequest(`/api/users/search?q=${encodeURIComponent(query)}`, {
            method: 'GET'
          });
          
          if (response.ok) {
            const data = await response.json();
            const users = data.users || [];
            
            if (users.length === 0) {
              resultsContainer.innerHTML = '<div class="empty-state"><div class="empty-icon">üë•</div><p class="empty-text">Kullanƒ±cƒ± bulunamadƒ±</p></div>';
            } else {
              resultsContainer.innerHTML = users.map(user => {
                const profilePicUrl = user.profilePic ? 
                  (user.profilePic.startsWith('http') ? user.profilePic : `${API_BASE}${user.profilePic}`) : '';
                  
                return `
                <div class="search-result-item" onclick="viewUserProfile('${user.id}'); document.getElementById('searchInput').value = ''; document.getElementById('searchResults').classList.remove('active');">
                  <div class="avatar" style="width: 44px; height: 44px; font-size: 18px;">${profilePicUrl ? `<img src="${profilePicUrl}" alt="${user.username}">` : 'üë§'}</div>
                  <div>
                    <div style="font-weight: 700; color: var(--text-light);">${user.name || user.username}</div>
                    <div style="font-size: 14px; color: #64748b;">@${user.username}</div>
                  </div>
                </div>
              `}).join('');
            }
            
            resultsContainer.classList.add('active');
          }
        } catch (error) {
          console.error('Kullanƒ±cƒ± arama hatasƒ±:', error);
          resultsContainer.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;"><div class="empty-icon">‚ùå</div><p class="empty-text">Arama yapƒ±lamadƒ±</p></div>';
          resultsContainer.classList.add('active');
        }
      }, 300));
    }

    // Arama kutusu dƒ±≈üƒ±na tƒ±klanƒ±rsa sonu√ßlarƒ± gizle
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-container')) {
        const searchResults = document.getElementById('searchResults');
        if (searchResults) searchResults.classList.remove('active');
      }
    });

    // Ayarlar
    const settingsBtn = document.getElementById('settingsBtn');
    if (settingsBtn) {
      settingsBtn.addEventListener('click', () => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        const settingsPage = document.getElementById('settingsPage');
        if (settingsPage) settingsPage.classList.add('active');
        
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
      });
    }

    // Sayfa yenileme - SADECE YENƒ∞ G√ñNDERƒ∞LER (aynƒ± postlarƒ± getirme)
    let loadedPostIds = new Set();
    
    const refreshBtn = document.getElementById('refreshBtn');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', async () => {
        if (isRefreshing) return;
        
        isRefreshing = true;
        refreshBtn.style.transform = 'rotate(360deg)';
        refreshBtn.style.transition = 'transform 0.5s ease';
        
        try {
          // Mevcut postlarƒ±n ID'lerini topla
          const existingPostCards = document.querySelectorAll('.post-card[data-post-id]');
          existingPostCards.forEach(card => {
            loadedPostIds.add(card.dataset.postId);
          });
          
          // Sadece yeni g√∂nderileri al
          const response = await apiRequest('/api/posts/new', {
            method: 'GET'
          });
          
          if (response.ok) {
            const data = await response.json();
            let newPosts = data.posts || [];
            
            // Zaten y√ºkl√º olan postlarƒ± filtrele
            newPosts = newPosts.filter(post => !loadedPostIds.has(post.id));
            
            if (newPosts.length > 0) {
              const container = document.getElementById('feedContainer');
              if (container) {
                // Yeni g√∂nderileri ba≈üa ekle
                const postsHTML = newPosts.map(post => {
                  loadedPostIds.add(post.id);
                  let mediaUrl = '';
                  if (post.mediaUrl) {
                    mediaUrl = post.mediaUrl.startsWith('http') ? post.mediaUrl : `${API_BASE}${post.mediaUrl}`;
                  }
                  
                  return `
                  <div class="post-card" data-post-id="${post.id}" ondblclick="handleDoubleTap(event)">
                    <div class="post-header">
                      <div class="avatar" onclick="viewUserProfile('${post.userId}')">
                        ${post.userProfilePic ? `<img src="${post.userProfilePic.startsWith('http') ? post.userProfilePic : API_BASE + post.userProfilePic}" alt="${post.username}">` : 'üë§'}
                      </div>
                      <div class="post-user-info" onclick="viewUserProfile('${post.userId}')">
                        <h3>${post.username}</h3>
                        <p>${formatTime(post.createdAt)}</p>
                      </div>
                      ${post.userId !== currentUser.id ? `
                        <button class="follow-btn ${post.isFollowing ? 'following' : ''}" onclick="toggleFollow('${post.userId}', this)">
                          ${post.isFollowing ? '‚úì Takip Ediyorsun' : '‚ûï Takip Et'}
                        </button>
                      ` : ''}
                    </div>
                    <div class="post-content">${post.content || ''}</div>
                    ${post.mediaUrl ? (post.mediaType === 'video' 
                      ? `<video src="${mediaUrl}" class="post-media" controls muted playsinline></video>`
                      : `<img src="${mediaUrl}" class="post-media" alt="G√∂nderi medyasƒ±">`
                    ) : ''}
                    <div class="post-actions">
                      <button class="action-btn like-btn" onclick="toggleLike('${post.id}', this)" data-liked="${post.isLiked || false}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="${post.isLiked ? '#ef4444' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="heart-icon">
                          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                        <span class="like-count">${post.likeCount || 0}</span>
                      </button>
                      <button class="action-btn" onclick="openCommentsModal('${post.id}')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        ${post.commentCount || 0}
                      </button>
                      <button class="action-btn save-btn" onclick="toggleSavePost('${post.id}', this)" data-saved="${post.isSaved || false}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="${post.isSaved ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                        </svg>
                      </button>
                    </div>
                  </div>
                `}).join('');
                
                container.innerHTML = postsHTML + container.innerHTML;
                showToast(`${newPosts.length} yeni g√∂nderi eklendi!`, 'success');
                initVideoAutoplay();
              }
            } else {
              showToast('Yeni g√∂nderi yok!', 'info');
            }
          }
        } catch (error) {
          console.error('Yeni g√∂nderi y√ºkleme hatasƒ±:', error);
          showToast('Yenileme ba≈üarƒ±sƒ±z', 'error');
        }
        
        setTimeout(() => {
          refreshBtn.style.transform = 'rotate(0deg)';
          isRefreshing = false;
        }, 500);
      });
    }

    // Tema deƒüi≈ütirme
    const themeToggleItem = document.getElementById('themeToggleItem');
    if (themeToggleItem) {
      themeToggleItem.addEventListener('click', (e) => {
        if (e.target.closest('.theme-switch')) {
          toggleTheme();
        }
      });
    }

    function toggleTheme() {
      const themeSwitch = document.getElementById('themeSwitch');
      if (!themeSwitch) return;
      
      currentTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.body.className = currentTheme + '-theme';
      themeSwitch.classList.toggle('active');
      localStorage.setItem('agrolink_theme', currentTheme);
      showToast(currentTheme === 'dark' ? 'üåô Koyu tema aktif' : '‚òÄÔ∏è A√ßƒ±k tema aktif', 'success');
    }

    // Konum ayarƒ±
    let locationEnabled = false;

    const locationToggleItem = document.getElementById('locationToggleItem');
    if (locationToggleItem) {
      locationToggleItem.addEventListener('click', (e) => {
        if (e.target.closest('.theme-switch')) {
          toggleLocation();
        }
      });
    }

    function toggleLocation() {
      const locationSwitch = document.getElementById('locationSwitch');
      if (!locationSwitch) return;
      
      locationEnabled = !locationEnabled;
      locationSwitch.classList.toggle('active');
      localStorage.setItem('agrolink_location', locationEnabled);
      
      if (locationEnabled) {
        getUserLocation();
        showToast('üìç Konum bazlƒ± g√∂nderiler aktif', 'success');
      } else {
        userLocation = null;
        loadFeed();
        showToast('üåç T√ºm g√∂nderiler g√∂steriliyor', 'success');
      }
    }

    // Bildirim ayarƒ±
    let notificationsEnabled = true;

    const notificationToggleItem = document.getElementById('notificationToggleItem');
    if (notificationToggleItem) {
      notificationToggleItem.addEventListener('click', (e) => {
        if (e.target.closest('.theme-switch')) {
          toggleNotifications();
        }
      });
    }

    function toggleNotifications() {
      const notificationSwitch = document.getElementById('notificationSwitch');
      if (!notificationSwitch) return;
      
      notificationsEnabled = !notificationsEnabled;
      notificationSwitch.classList.toggle('active');
      localStorage.setItem('agrolink_notifications', notificationsEnabled);
      showToast(notificationsEnabled ? 'üîî Bildirimler aktif' : 'üîï Bildirimler devre dƒ±≈üƒ±', 'success');
    }

    // Kaydedilen videolar
    const savedVideosItem = document.getElementById('savedVideosItem');
    if (savedVideosItem) {
      savedVideosItem.addEventListener('click', () => {
        const modal = document.getElementById('savedVideosModal');
        if (modal) modal.classList.add('active');
        loadSavedVideos();
      });
    }

    // Gizlilik ayarƒ±
    const privacyItem = document.getElementById('privacyItem');
    if (privacyItem) {
      privacyItem.addEventListener('click', () => {
        showPrivacyModal();
      });
    }

    // Dil ayarƒ±
    const languageItem = document.getElementById('languageItem');
    if (languageItem) {
      languageItem.addEventListener('click', () => {
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
              <h2 class="modal-title">üåç Dil Se√ßimi</h2>
              <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <button class="primary-btn" onclick="changeLanguage('tr'); this.closest('.modal').remove();">
                üáπüá∑ T√ºrk√ße
              </button>
              <button class="primary-btn" style="background: rgba(0,0,0,0.05);" onclick="changeLanguage('en'); this.closest('.modal').remove();">
                üá¨üáß English
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      });
    }

    function changeLanguage(lang) {
      currentLanguage = lang;
      localStorage.setItem('agrolink_language', lang);
      location.reload();
    }

    // Hesap silme
    const deleteAccountItem = document.getElementById('deleteAccountItem');
    if (deleteAccountItem) {
      deleteAccountItem.addEventListener('click', () => {
        const deleteAccountModal = document.getElementById('deleteAccountModal');
        if (deleteAccountModal) deleteAccountModal.classList.add('active');
      });
    }

    const confirmDeleteAccount = document.getElementById('confirmDeleteAccount');
    if (confirmDeleteAccount) {
      confirmDeleteAccount.addEventListener('click', async () => {
        const password = document.getElementById('deleteAccountPassword')?.value;
        
        if (!password) {
          showToast('L√ºtfen ≈üifrenizi girin!', 'error');
          return;
        }

        const btn = confirmDeleteAccount;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Siliniyor...';

        try {
          const response = await apiRequest('/api/users/delete', {
            method: 'DELETE',
            body: JSON.stringify({ password })
          });

          if (response.ok) {
            document.querySelectorAll('.modal').forEach(m => m.remove());
            logout();
            showToast('Hesabƒ±nƒ±z ba≈üarƒ±yla silindi', 'success');
          } else {
            const data = await response.json();
            showToast(data.message || 'Hesap silinemedi', 'error');
            btn.disabled = false;
            btn.innerHTML = 'Hesabƒ± Sil';
          }
        } catch (error) {
          console.error('Hesap silme hatasƒ±:', error);
          showToast('Bir hata olu≈ütu', 'error');
          btn.disabled = false;
          btn.innerHTML = 'Hesabƒ± Sil';
        }
      });
    }

    // √áƒ±kƒ±≈ü
    const logoutItem = document.getElementById('logoutItem');
    if (logoutItem) {
      logoutItem.addEventListener('click', logout);
    }

    // Navigasyon
    document.querySelectorAll('.nav-item:not(.add-post)').forEach(btn => {
      btn.addEventListener('click', () => {
        const page = btn.dataset.page;
        if (!page) return;
        
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        const pageElement = document.getElementById(page + 'Page');
        if (pageElement) pageElement.classList.add('active');
        
        const chatScreen = document.getElementById('chatScreen');
        if (chatScreen) chatScreen.style.display = 'none';
        
        activeChatUser = null;
        
        const notificationsPanel = document.getElementById('notificationsPanel');
        if (notificationsPanel) notificationsPanel.classList.remove('active');
        
        const searchResults = document.getElementById('searchResults');
        if (searchResults) searchResults.classList.remove('active');

        // Arama kutusunu sadece anasayfada g√∂ster
        const searchContainer = document.getElementById('searchContainer');
        if (searchContainer) {
          searchContainer.style.display = page === 'home' ? 'block' : 'none';
        }

        if (page === 'profile') {
          loadProfilePosts();
        } else if (page === 'store') {
          loadStore();
        }
      });
    });

    // Zaman formatlama
    function formatTime(timestamp) {
      if (!timestamp) return '≈ûimdi';
      
      const date = new Date(timestamp);
      const now = new Date();
      const diff = Math.floor((now - date) / 1000);

      if (diff < 60) return 'Az √∂nce';
      if (diff < 3600) return Math.floor(diff / 60) + ' dk √∂nce';
      if (diff < 86400) return Math.floor(diff / 3600) + ' sa √∂nce';
      if (diff < 604800) return Math.floor(diff / 86400) + ' g√ºn √∂nce';
      return date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
    }

    // Zararlƒ± i√ßerik kontrol√º
    function checkHarmfulContent(content) {
      return harmfulWords.some(word => content.toLowerCase().includes(word));
    }

    // Debounce fonksiyonu
    function debounce(func, wait, immediate) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          timeout = null;
          if (!immediate) func(...args);
        };
        const callNow = immediate && !timeout;
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
        if (callNow) func(...args);
      };
    }

    // Profil galerisi fonksiyonlarƒ±
    function openProfileGallery() {
      const modal = document.getElementById('profileGalleryModal');
      if (modal) modal.classList.add('active');
    }

    function closeProfileGallery() {
      const modal = document.getElementById('profileGalleryModal');
      if (modal) modal.classList.remove('active');
    }

    function prevGalleryItem() {
      if (currentGalleryIndex > 0) {
        currentGalleryIndex--;
        updateGalleryItem();
      }
    }

    function nextGalleryItem() {
      if (currentGalleryIndex < profilePosts.length - 1) {
        currentGalleryIndex++;
        updateGalleryItem();
      }
    }

    function updateGalleryItem() {
      const container = document.getElementById('galleryItemContainer');
      if (!container || !profilePosts[currentGalleryIndex]) return;
      
      const post = profilePosts[currentGalleryIndex];
      const mediaUrl = post.mediaUrl ? (post.mediaUrl.startsWith('http') ? post.mediaUrl : `${API_BASE}${post.mediaUrl}`) : '';
      
      if (post.mediaType === 'video') {
        container.innerHTML = `<video src="${mediaUrl}" controls class="gallery-item"></video>`;
      } else {
        container.innerHTML = `<img src="${mediaUrl}" alt="G√∂nderi" class="gallery-item">`;
      }
    }

    // Uygulama ba≈ülatma
    console.log('üå± AgroLink ba≈ülatƒ±lƒ±yor...');
    console.log('üì° API U√ß Noktasƒ±:', API_BASE);
    console.log('üîå Socket.io U√ß Noktasƒ±:', SOCKET_URL);

    async function testAPIConnection() {
      console.log('üîç API baƒülantƒ±sƒ± test ediliyor...');
      try {
        const response = await fetch(`${API_BASE}/api/health`, {
          method: 'GET',
          mode: 'cors'
        });
        console.log('‚úÖ API Durumu:', response.status, response.statusText);
        return true;
      } catch (error) {
        console.error('‚ùå API Baƒülantƒ± Hatasƒ±:', error);
        showToast('Sunucu baƒülantƒ±sƒ± kurulamadƒ±! L√ºtfen sunucunuzun √ßalƒ±≈ütƒ±ƒüƒ±ndan emin olun.', 'error');
        return false;
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      testAPIConnection();
      
      setTimeout(() => {
        const splashScreen = document.getElementById('splashScreen');
        if (splashScreen) splashScreen.style.display = 'none';
      }, 4000);

      const savedToken = localStorage.getItem('agrolink_token');
      const savedUser = localStorage.getItem('agrolink_user');
      const savedTheme = localStorage.getItem('agrolink_theme');
      const savedLanguage = localStorage.getItem('agrolink_language');
      const savedBlockedUsers = localStorage.getItem('agrolink_blocked_users');

      if (savedBlockedUsers) {
        blockedUsers = new Set(JSON.parse(savedBlockedUsers));
      }

      if (savedLanguage) {
        currentLanguage = savedLanguage;
      }

      if (savedToken && savedUser) {
        authToken = savedToken;
        currentUser = JSON.parse(savedUser);
        
        setTimeout(() => {
          const loginScreen = document.getElementById('loginScreen');
          const mainApp = document.getElementById('mainApp');
          
          if (loginScreen) loginScreen.classList.remove('active');
          if (mainApp) mainApp.style.display = 'flex';
          
          loadUserData();
        }, 4000);
      } else {
        setTimeout(() => {
          const loginScreen = document.getElementById('loginScreen');
          if (loginScreen) loginScreen.classList.add('active');
        }, 4000);
      }

      if (savedTheme) {
        currentTheme = savedTheme;
        document.body.className = currentTheme + '-theme';
        const themeSwitch = document.getElementById('themeSwitch');
        if (themeSwitch && currentTheme === 'dark') {
          themeSwitch.classList.add('active');
        }
      }

      const savedLocation = localStorage.getItem('agrolink_location');
      if (savedLocation === 'true') {
        locationEnabled = true;
        const locationSwitch = document.getElementById('locationSwitch');
        if (locationSwitch) locationSwitch.classList.add('active');
      }

      const savedNotifications = localStorage.getItem('agrolink_notifications');
      if (savedNotifications === 'false') {
        notificationsEnabled = false;
        const notificationSwitch = document.getElementById('notificationSwitch');
        if (notificationSwitch) notificationSwitch.classList.remove('active');
      }

      if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission();
      }
    });
  
  // POST PAYLA≈û BUTONU D√úZELTMESƒ∞
  window.addEventListener('load', function() {
    console.log('üöÄ Post payla≈ü d√ºzeltmesi y√ºkleniyor...');
    
    setTimeout(function() {
      const submitPostBtn = document.getElementById('submitPost');
      const postForm = document.getElementById('postForm');
      
      if (submitPostBtn && postForm) {
        console.log('‚úÖ Post butonu bulundu, event listener ekleniyor');
        
        // Mevcut listener'ƒ± temizle
        const newBtn = submitPostBtn.cloneNode(true);
        submitPostBtn.parentNode.replaceChild(newBtn, submitPostBtn);
        
        newBtn.addEventListener('click', async function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          console.log('üîò Post payla≈ü butonuna tƒ±klandƒ±');
          
          const content = document.getElementById('postContent') ? document.getElementById('postContent').value : '';
          
          if (!content && !uploadedMediaFile) {
            showToast('L√ºtfen bir i√ßerik veya medya ekleyin!', 'error');
            return;
          }
          
          const sanitized = sanitizeInput(content);
          
          if (sanitized && checkHarmfulContent(sanitized)) {
            showToast('G√∂nderiniz zararlƒ± i√ßerik tespit edildiƒüi i√ßin payla≈üƒ±lamadƒ±!', 'error');
            return;
          }

          newBtn.disabled = true;
          newBtn.innerHTML = '<span class="spinner"></span> Payla≈üƒ±lƒ±yor...';

          try {
            const formData = new FormData();
            formData.append('content', sanitized);
            
            if (uploadedMediaFile) {
              let mediaToUpload = uploadedMediaFile;
              if (uploadedMediaType === 'image') {
                try {
                  mediaToUpload = await compressImage(uploadedMediaFile);
                } catch (error) {
                  console.error('Sƒ±kƒ±≈ütƒ±rma hatasƒ±:', error);
                }
              }
              formData.append('media', mediaToUpload);
              formData.append('mediaType', uploadedMediaType);
            }

            const response = await apiRequest('/api/posts', {
              method: 'POST',
              body: formData,
              headers: {}
            });

            if (response.ok) {
              const data = await response.json();
              
              document.getElementById('postContent').value = '';
              const mediaPreview = document.getElementById('mediaPreview');
              if (mediaPreview) mediaPreview.innerHTML = '';
              
              const addPostModal = document.getElementById('addPostModal');
              if (addPostModal) addPostModal.classList.remove('active');
              
              uploadedMediaFile = null;
              uploadedMediaType = null;
              
              feedCache = null;
              await loadFeed();
              await loadUserStats();
              await loadProfilePosts();
              
              showToast('G√∂nderi payla≈üƒ±ldƒ±! üéâ', 'success');
            } else {
              const error = await response.json();
              showToast(error.message || 'G√∂nderi payla≈üƒ±lamadƒ±', 'error');
            }
          } catch (error) {
            console.error('G√∂nderi payla≈üma hatasƒ±:', error);
            showToast(error.message || 'G√∂nderi payla≈üƒ±lamadƒ±', 'error');
          } finally {
            newBtn.disabled = false;
            newBtn.innerHTML = 'üöÄ Payla≈ü';
          }
        });
        
        console.log('‚úÖ Post payla≈ü event listener ba≈üarƒ±yla eklendi');
      } else {
        console.error('‚ùå Post butonu veya form bulunamadƒ±!');
      }
      
      // Lazy loading ba≈ülat
      enableLazyLoading();
      
      // Scroll optimizasyonu
      const mainContent = document.querySelector('.main-content');
      if (mainContent) {
        const handleScroll = throttle(function() {
          const scrollTop = mainContent.scrollTop;
          const scrollHeight = mainContent.scrollHeight;
          const clientHeight = mainContent.clientHeight;
          
          if (scrollTop + clientHeight >= scrollHeight - 100) {
            const activePage = document.querySelector('.page.active');
            if (activePage && activePage.id === 'homePage' && hasMorePosts) {
              loadFeed(true);
            }
          }
        }, 300);
        
        mainContent.addEventListener('scroll', handleScroll);
      }
    }, 500);
  });

  // ========== YENƒ∞ √ñZELLƒ∞KLER ==========

  // Arama Modal Fonksiyonlarƒ±
  function openSearchModal() {
    const modal = document.getElementById('searchModal');
    if (modal) {
      modal.classList.add('active');
      const input = document.getElementById('searchModalInput');
      if (input) {
        setTimeout(() => input.focus(), 100);
      }
    }
  }

  function closeSearchModal() {
    const modal = document.getElementById('searchModal');
    if (modal) {
      modal.classList.remove('active');
      document.getElementById('searchModalInput').value = '';
      document.getElementById('searchModalResults').innerHTML = '';
    }
  }

  // Arama modal butonuna event listener ekle
  document.addEventListener('DOMContentLoaded', () => {
    const searchBtn = document.getElementById('searchBtn');
    if (searchBtn) {
      searchBtn.addEventListener('click', openSearchModal);
    }

    const searchModalInput = document.getElementById('searchModalInput');
    if (searchModalInput) {
      searchModalInput.addEventListener('input', async (e) => {
        const query = e.target.value.trim();
        const resultsContainer = document.getElementById('searchModalResults');
        
        if (query.length < 2) {
          resultsContainer.innerHTML = '';
          return;
        }

        try {
          const response = await apiRequest(`/api/users/search?q=${encodeURIComponent(query)}`);
          if (response.ok) {
            const users = await response.json();
            
            if (users.length === 0) {
              resultsContainer.innerHTML = '<p style="padding: 20px; text-align: center; color: #64748b;">Kullanƒ±cƒ± bulunamadƒ±</p>';
              return;
            }

            resultsContainer.innerHTML = users.map(user => `
              <div class="search-result-item" onclick="openUserProfile('${user._id}'); closeSearchModal();">
                <div class="avatar" style="width: 44px; height: 44px; font-size: 18px;">
                  ${user.profilePic ? `<img src="${user.profilePic}" alt="${user.name}">` : 'üë§'}
                </div>
                <div>
                  <div style="font-weight: 700; font-size: 14px; color: var(--text-light);">${user.name}</div>
                  <div style="font-size: 12px; color: #64748b;">@${user.username}</div>
                </div>
              </div>
            `).join('');
          }
        } catch (error) {
          console.error('Arama hatasƒ±:', error);
        }
      });
    }

    // Modal dƒ±≈üƒ±na tƒ±klayƒ±nca kapat
    const searchModal = document.getElementById('searchModal');
    if (searchModal) {
      searchModal.addEventListener('click', (e) => {
        if (e.target === searchModal) {
          closeSearchModal();
        }
      });
    }
  });

  // TikTok Style Video Viewer
  let currentTiktokVideos = [];
  let currentTiktokIndex = 0;

  function openTiktokViewer(allPosts, startIndex = 0) {
    // Sadece video postlarƒ± al
    currentTiktokVideos = allPosts.filter(p => p.mediaType === 'video');
    if (currentTiktokVideos.length === 0) return;
    
    // Start index'i video listesinde bul
    const startPost = allPosts[startIndex];
    currentTiktokIndex = currentTiktokVideos.findIndex(p => p.id === startPost?.id);
    if (currentTiktokIndex === -1) currentTiktokIndex = 0;

    const viewer = document.getElementById('tiktokViewer');
    const container = document.getElementById('tiktokVideoContainer');
    
    if (!viewer || !container) return;
    
    container.innerHTML = '';
    
    currentTiktokVideos.forEach((post, index) => {
      const mediaUrl = post.mediaUrl?.startsWith('http') ? post.mediaUrl : `${API_BASE}${post.mediaUrl}`;
      const profilePicUrl = post.userProfilePic?.startsWith('http') ? post.userProfilePic : `${API_BASE}${post.userProfilePic}`;
      
      const videoItem = document.createElement('div');
      videoItem.className = 'tiktok-video-item';
      videoItem.innerHTML = `
        <video 
          src="${mediaUrl}" 
          ${index === currentTiktokIndex ? 'autoplay' : ''} 
          loop 
          playsinline
          style="width: 100%; height: 100%; object-fit: contain;">
        </video>
        <div class="tiktok-actions">
          <button class="tiktok-action-btn" onclick="toggleLike('${post.id}', this, true)">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="${post.isLiked ? 'red' : 'none'}" stroke="white" stroke-width="2">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
            </svg>
            <span class="tiktok-like-count-${post.id}">${post.likeCount || 0}</span>
          </button>
          <button class="tiktok-action-btn" onclick="openCommentsModal('${post.id}')">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            <span>${post.commentCount || 0}</span>
          </button>
          <button class="tiktok-action-btn" onclick="toggleSavePost('${post.id}', this, true)">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="${post.isSaved ? 'white' : 'none'}" stroke="white" stroke-width="2">
              <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
            </svg>
            <span>Kaydet</span>
          </button>
        </div>
        <div class="tiktok-info">
          <div class="tiktok-user">
            <div class="tiktok-avatar" onclick="viewUserProfile('${post.userId}'); closeTiktokViewer();">
              ${profilePicUrl ? `<img src="${profilePicUrl}" alt="">` : 'üë§'}
            </div>
            <div class="tiktok-username">@${post.username || 'kullanici'}</div>
          </div>
          <div class="tiktok-description">${post.content || ''}</div>
        </div>
      `;
      container.appendChild(videoItem);
    });
    
    viewer.classList.add('active');
    
    // Scroll to current video
    const videos = container.querySelectorAll('.tiktok-video-item');
    if (videos[currentTiktokIndex]) {
      videos[currentTiktokIndex].scrollIntoView({ behavior: 'instant' });
    }

    // Video scroll handling
    let scrollTimeout;
    container.addEventListener('scroll', () => {
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(() => {
        const scrollTop = container.scrollTop;
        const itemHeight = window.innerHeight;
        const newIndex = Math.round(scrollTop / itemHeight);
        
        if (newIndex !== currentTiktokIndex && newIndex >= 0 && newIndex < videos.length) {
          // Pause previous video
          const prevVideo = videos[currentTiktokIndex]?.querySelector('video');
          if (prevVideo) prevVideo.pause();
          
          // Play new video
          currentTiktokIndex = newIndex;
          const currentVideo = videos[currentTiktokIndex]?.querySelector('video');
          if (currentVideo) {
            currentVideo.play().catch(e => console.log('Video play error:', e));
          }
        }
      }, 150);
    });
  }

  function closeTiktokViewer() {
    const viewer = document.getElementById('tiktokViewer');
    if (viewer) {
      viewer.classList.remove('active');
      // Pause all videos
      viewer.querySelectorAll('video').forEach(v => v.pause());
    }
  }

  // Feed'den TikTok viewer a√ßmak i√ßin wrapper
  function openTiktokViewerByIndex(postIndex) {
    openTiktokViewer(feedPosts, postIndex);
  }

  // Tek medya y√ºkleme - SADECE Bƒ∞R DOSYA
  document.addEventListener('DOMContentLoaded', () => {
    const postMediaInput = document.getElementById('postMedia');
    if (postMediaInput) {
      postMediaInput.addEventListener('change', async function(e) {
        const files = e.target.files;
        if (!files || files.length === 0) return;

        // Sadece ilk dosyayƒ± al
        const file = files[0];
        const isVideo = file.type.startsWith('video/');
        const isImage = file.type.startsWith('image/');
        
        if (!isVideo && !isImage) {
          showToast('Sadece resim veya video y√ºkleyebilirsiniz', 'error');
          postMediaInput.value = '';
          return;
        }

        const mediaPreview = document.getElementById('mediaPreview');
        if (!mediaPreview) return;
        
        try {
          let processedFile = file;
          
          // Resimleri sƒ±kƒ±≈ütƒ±r
          if (isImage) {
            if (file.size > 10 * 1024 * 1024) {
              showToast('G√∂rsel √ßok b√ºy√ºk (max 10MB), sƒ±kƒ±≈ütƒ±rƒ±lƒ±yor...', 'warning');
              processedFile = await compressImage(file, 1920, 1920, 0.7);
            } else {
              processedFile = await compressImage(file, 1200, 1200, 0.85);
            }
          }
          
          // Tek dosya olarak ayarla
          uploadedMediaFile = processedFile;
          uploadedMediaType = isVideo ? 'video' : 'image';
          uploadedMediaFiles = [{ file: processedFile, type: uploadedMediaType }];

          const url = URL.createObjectURL(processedFile);
          
          mediaPreview.innerHTML = '';
          const container = document.createElement('div');
          container.style.cssText = 'position: relative; border-radius: 16px; overflow: hidden; margin-top: 12px; background: rgba(0,0,0,0.2); width: 100%;';
          
          if (isVideo) {
            container.innerHTML = `<video src="${url}" controls style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 16px;"></video>`;
          } else {
            container.innerHTML = `<img src="${url}" style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 16px;" alt="Medya √∂nizlemesi">`;
          }
          
          const clearBtn = document.createElement('button');
          clearBtn.type = 'button';
          clearBtn.innerHTML = '‚úï';
          clearBtn.style.cssText = 'position: absolute; top: 8px; right: 8px; width: 32px; height: 32px; border-radius: 50%; background: rgba(0,0,0,0.7); color: white; border: none; cursor: pointer; font-size: 18px;';
          clearBtn.onclick = (ev) => {
            ev.preventDefault();
            mediaPreview.innerHTML = '';
            uploadedMediaFile = null;
            uploadedMediaType = null;
            uploadedMediaFiles = [];
            postMediaInput.value = '';
            document.getElementById('uploadInfoContainer').style.display = 'none';
          };
          
          container.appendChild(clearBtn);
          mediaPreview.appendChild(container);
          
          showToast('Medya se√ßildi! ‚úì', 'success');
        } catch (error) {
          console.error('Hata:', error);
          showToast('Medya i≈ülenemedi: ' + error.message, 'error');
          postMediaInput.value = '';
        }
      });
    }
  });

  function removeMediaFile(index) {
    uploadedMediaFiles.splice(index, 1);
    // Preview'ƒ± yenile
    const mediaPreview = document.getElementById('mediaPreview');
    if (mediaPreview) {
      mediaPreview.innerHTML = '';
      uploadedMediaFiles.forEach((item, i) => {
        const url = URL.createObjectURL(item.file);
        const container = document.createElement('div');
        container.style.position = 'relative';
        container.style.borderRadius = '16px';
        container.style.overflow = 'hidden';
        container.style.marginTop = '12px';
        container.style.backgroundColor = 'rgba(0,0,0,0.2)';
        container.style.display = 'inline-block';
        container.style.width = uploadedMediaFiles.length > 1 ? 'calc(50% - 6px)' : '100%';
        container.style.marginRight = i % 2 === 0 ? '12px' : '0';
        
        if (item.type === 'video') {
          container.innerHTML = `<video src="${url}" controls style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 16px;"></video>`;
        } else {
          container.innerHTML = `<img src="${url}" style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 16px;" alt="Medya √∂nizlemesi">`;
        }
        
        const clearBtn = document.createElement('button');
        clearBtn.type = 'button';
        clearBtn.innerHTML = '‚úï';
        clearBtn.style.cssText = 'position: absolute; top: 8px; right: 8px; width: 32px; height: 32px; border-radius: 50%; background: rgba(0,0,0,0.7); color: white; border: none; cursor: pointer; font-size: 18px;';
        clearBtn.onclick = (ev) => {
          ev.preventDefault();
          removeMediaFile(i);
        };
        container.appendChild(clearBtn);
        mediaPreview.appendChild(container);
      });
    }
  }

  // Video √∂nbellekleme ve lazy loading
  function cacheVideo(videoUrl, postId) {
    if (videoCache.has(postId)) return;
    
    fetch(videoUrl)
      .then(response => response.blob())
      .then(blob => {
        const url = URL.createObjectURL(blob);
        videoCache.set(postId, url);
        console.log('‚úÖ Video √∂nbelleƒüe alƒ±ndƒ±:', postId);
      })
      .catch(error => console.error('Video √∂nbellek hatasƒ±:', error));
  }

  function getVideoUrl(postId, originalUrl) {
    return videoCache.get(postId) || originalUrl;
  }

  // Profil grid'de video thumbnail ve lazy loading
  function renderProfilePost(post) {
    const postDiv = document.createElement('div');
    postDiv.className = 'profile-post';
    postDiv.dataset.postId = post._id;
    
    if (post.mediaType === 'video') {
      // Video i√ßin thumbnail g√∂ster
      const video = document.createElement('video');
      video.src = post.media;
      video.preload = 'metadata';
      video.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
      
      const playIcon = document.createElement('div');
      playIcon.className = 'video-play-overlay';
      playIcon.innerHTML = '‚ñ∂';
      
      postDiv.appendChild(video);
      postDiv.appendChild(playIcon);
      
      // Tƒ±klayƒ±nca video indir ve oynat
      postDiv.addEventListener('click', () => {
        if (!videoCache.has(post._id)) {
          const loadingDiv = document.createElement('div');
          loadingDiv.className = 'video-loading';
          loadingDiv.innerHTML = '<div class="spinner"></div><p>Video y√ºkleniyor...</p>';
          postDiv.appendChild(loadingDiv);
          
          // Arka planda videoyu indir
          cacheVideo(post.media, post._id);
          
          // Video indirildikten sonra oynat
          setTimeout(() => {
            openGalleryModal(profilePosts.indexOf(post));
            if (loadingDiv.parentNode) {
              loadingDiv.remove();
            }
          }, 1500);
        } else {
          openGalleryModal(profilePosts.indexOf(post));
        }
      });
      
      // Arka planda videoyu √∂nbelleƒüe al
      setTimeout(() => cacheVideo(post.media, post._id), 2000);
      
    } else if (post.media) {
      // Resim i√ßin normal davran
      const img = document.createElement('img');
      img.src = post.media;
      img.alt = 'Post';
      img.loading = 'lazy';
      postDiv.appendChild(img);
      postDiv.addEventListener('click', () => openGalleryModal(profilePosts.indexOf(post)));
    }
    
    return postDiv;
  }

  // Takip butonu g√ºncelleme
  function updateFollowButton(userId, isFollowing) {
    const followBtn = document.getElementById('fullscreenFollowBtn');
    if (followBtn) {
      if (isFollowing) {
        followBtn.textContent = '‚úì Takip Ediyorsunuz';
        followBtn.style.background = 'linear-gradient(135deg, #64748b, #475569)';
        followingUsers.add(userId);
      } else {
        followBtn.textContent = 'Takip Et';
        followBtn.style.background = '';
        followingUsers.delete(userId);
      }
    }
  }

  // Maƒüaza lazy loading
  let storeScrollHandler = null;

  function initStoreLazyLoading() {
    const storeContainer = document.getElementById('storeContainer');
    if (!storeContainer) return;

    // ƒ∞lk 5 √ºr√ºn√º y√ºkle
    loadStoreProducts(true);

    // Scroll event
    const storePage = document.getElementById('storePage');
    if (storeScrollHandler) {
      storePage.removeEventListener('scroll', storeScrollHandler);
    }

    storeScrollHandler = function() {
      if (!storePage.classList.contains('active')) return;
      
      const scrollTop = storePage.scrollTop;
      const scrollHeight = storePage.scrollHeight;
      const clientHeight = storePage.clientHeight;
      
      if (scrollHeight - scrollTop - clientHeight < 300 && hasMoreStoreProducts && !isStoreLoading) {
        loadStoreProducts(false);
      }
    };

    storePage.addEventListener('scroll', storeScrollHandler);
  }

  let isStoreLoading = false;

  async function loadStoreProducts(initial = false) {
    if (isStoreLoading) return;
    isStoreLoading = true;

    try {
      const limit = 5;
      const skip = initial ? 0 : storeProducts.length;
      
      const response = await apiRequest(`/api/products?limit=${limit}&skip=${skip}`);
      if (response.ok) {
        const products = await response.json();
        
        if (initial) {
          storeProducts = products;
          renderStoreProducts(products, true);
        } else {
          storeProducts = [...storeProducts, ...products];
          renderStoreProducts(products, false);
        }
        
        hasMoreStoreProducts = products.length === limit;
      }
    } catch (error) {
      console.error('Maƒüaza y√ºkleme hatasƒ±:', error);
    } finally {
      isStoreLoading = false;
    }
  }

  function renderStoreProducts(products, clear = false) {
    const container = document.getElementById('storeContainer');
    if (!container) return;
    
    if (clear) {
      container.innerHTML = '';
    }
    
    products.forEach(product => {
      const productCard = createProductCard(product);
      container.appendChild(productCard);
    });
  }

  // Feed spam √∂nleme
  function shouldShowPost(postId) {
    if (seenPostIds.has(postId)) {
      return false;
    }
    seenPostIds.add(postId);
    return true;
  }

  // Post render fonksiyonunu g√ºncelle (feed i√ßin)
  const originalRenderPosts = window.renderPosts || function() {};
  
  function renderPostsWithSpamPrevention(posts) {
    const filteredPosts = posts.filter(post => shouldShowPost(post._id));
    
    if (filteredPosts.length < posts.length) {
      console.log(`üö´ ${posts.length - filteredPosts.length} tekrar eden post filtrelendi`);
    }
    
    return filteredPosts;
  }

  // Video otomatik oynatma i√ßin yardƒ±mcƒ± fonksiyon
  function enableVideoAutoplay(videoElement) {
    if (!videoElement) return;
    
    videoElement.muted = false; // Sesli oynat
    videoElement.autoplay = true;
    videoElement.loop = true;
    videoElement.playsInline = true;
    
    // Safari i√ßin
    videoElement.setAttribute('playsinline', '');
    videoElement.setAttribute('webkit-playsinline', '');
    
    // Oynatmayƒ± ba≈ülat
    const playPromise = videoElement.play();
    if (playPromise !== undefined) {
      playPromise.catch(error => {
        console.log('Video otomatik oynatƒ±lamadƒ±:', error);
        // Sessiz oynatmayƒ± dene
        videoElement.muted = true;
        videoElement.play();
      });
    }
  }

  // Initialize everything when page loads
  window.addEventListener('load', () => {
    console.log('‚úÖ T√ºm yeni √∂zellikler y√ºklendi!');
    
    // Maƒüaza lazy loading'i ba≈ülat
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
      item.addEventListener('click', function() {
        const page = this.dataset.page;
        if (page === 'store') {
          setTimeout(() => initStoreLazyLoading(), 100);
        }
      });
    });
  });

  // ========== YENƒ∞ EKLENEN √ñZELLƒ∞KLER ==========

  // Ki≈üisel profil postlarƒ±nƒ± √∂nbelleƒüe al
  let profilePostsCache = null;
  let profilePostsCacheData = [];
  let profilePostsCacheTimestamp = null;
  const PROFILE_CACHE_DURATION = 10 * 60 * 1000; // 10 dakika

  // loadProfilePosts fonksiyonunu g√ºncelle - √∂nbellek desteƒüi ve T√úM POSTLARI Y√úKLE
  const originalLoadProfilePosts = loadProfilePosts;
  async function loadProfilePostsWithCache(loadMore = false) {
    const container = document.getElementById('profileGrid');
    const loadingIndicator = document.getElementById('profileLoadingIndicator');
    
    if (!container || !loadingIndicator) return;
    
    // √ñnbellekten y√ºkle (loadMore deƒüilse)
    if (!loadMore && profilePostsCache && profilePostsCacheTimestamp && 
        (Date.now() - profilePostsCacheTimestamp) < PROFILE_CACHE_DURATION) {
      container.innerHTML = profilePostsCache;
      profilePosts = [...profilePostsCacheData];
      console.log('üì¶ Profil postlarƒ± √∂nbellekten y√ºklendi');
      return;
    }
    
    if (!loadMore) {
      profilePageNum = 0;
      hasMoreProfilePosts = true;
      profilePosts = [];
      container.innerHTML = '';
    }
    
    if (!hasMoreProfilePosts) {
      return;
    }
    
    loadingIndicator.classList.add('active');
    
    try {
      // ƒ∞lk y√ºklemede t√ºm postlarƒ± getir (limit=50)
      const limit = loadMore ? 10 : 50;
      const response = await apiRequest(`/api/users/${currentUser.id}/posts?page=${profilePageNum}&limit=${limit}`, {
        method: 'GET'
      });

      if (!response.ok) {
        throw new Error('G√∂nderiler y√ºklenemedi');
      }

      const data = await response.json();
      const posts = data.posts || [];
      
      hasMoreProfilePosts = posts.length === limit;

      if (posts.length === 0 && !loadMore) {
        container.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;"><div class="empty-icon">üìù</div><p class="empty-text">Hen√ºz g√∂nderi yok</p></div>';
        loadingIndicator.classList.remove('active');
        return;
      }

      const postsHTML = posts.map((post, index) => {
        const mediaUrl = post.mediaUrl ? (post.mediaUrl.startsWith('http') ? post.mediaUrl : `${API_BASE}${post.mediaUrl}`) : '';
        const actualIndex = profilePosts.length + index;
        
        return `
        <div class="profile-post ${post.mediaUrl ? 'profile-post-multiple' : ''}" style="position: relative;" onclick="openProfileReelsModal(${actualIndex})">
          ${post.mediaUrl ? (post.mediaType === 'video' 
            ? `<video src="${mediaUrl}" muted></video>`
            : `<img src="${mediaUrl}" alt="G√∂nderi">`
          ) : `<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 24px; color: #64748b;">üìù</div>`}
          <button class="profile-post-delete-btn" onclick="event.stopPropagation(); deleteProfilePost('${post.id}')" style="position: absolute; top: 8px; right: 8px; width: 32px; height: 32px; border-radius: 50%; background: rgba(239, 68, 68, 0.9); border: none; color: white; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10;">üóëÔ∏è</button>
        </div>
      `}).join('');

      if (loadMore) {
        container.innerHTML += postsHTML;
      } else {
        container.innerHTML = postsHTML;
        // √ñnbelleƒüe kaydet
        profilePostsCache = container.innerHTML;
        profilePostsCacheData = [...posts];
        profilePostsCacheTimestamp = Date.now();
        console.log('üì¶ Profil postlarƒ± √∂nbelleƒüe kaydedildi (' + posts.length + ' post)');
      }
      
      profilePosts = [...profilePosts, ...posts];
      profilePageNum++;
    } catch (error) {
      console.error('Profil g√∂nderi y√ºkleme hatasƒ±:', error);
      if (!loadMore) {
        container.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;"><div class="empty-icon">‚ùå</div><p class="empty-text">G√∂nderiler y√ºklenemedi</p></div>';
      }
    }
    
    loadingIndicator.classList.remove('active');
  }

  // Hashtag ve Mention formatƒ±
  function formatTextWithHashtagsAndMentions(text) {
    if (!text) return '';
    
    // √ñnce HTML escape yap
    let formatted = escapeHtml(text);
    
    // Hashtag'leri bul ve stil uygula (#kelime)
    formatted = formatted.replace(/#(\w+)/g, '<span class="hashtag" onclick="searchHashtag(\'$1\')">#$1</span>');
    
    // Mention'larƒ± bul ve stil uygula (@kullanƒ±cƒ±)
    formatted = formatted.replace(/@(\w+)/g, '<span class="mention" onclick="searchAndViewUser(\'$1\')">@$1</span>');
    
    // URL'leri linkle
    formatted = formatted.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color: var(--primary-color);">$1</a>');
    
    return formatted;
  }

  // Hashtag arama
  function searchHashtag(tag) {
    showToast(`#${tag} aramasƒ± yapƒ±lƒ±yor...`, 'success');
    // Hashtag'e g√∂re post filtreleme yapabilirsiniz
    console.log('Hashtag aramasƒ±:', tag);
  }

  // Kullanƒ±cƒ± arama ve profil g√∂r√ºnt√ºleme
  async function searchAndViewUser(username) {
    try {
      const response = await apiRequest(`/api/users/search?q=${encodeURIComponent(username)}`, {
        method: 'GET'
      });
      
      if (response.ok) {
        const data = await response.json();
        const users = data.users || [];
        
        const user = users.find(u => u.username.toLowerCase() === username.toLowerCase());
        
        if (user) {
          viewUserProfile(user.id);
        } else {
          showToast(`@${username} kullanƒ±cƒ±sƒ± bulunamadƒ±`, 'error');
        }
      }
    } catch (error) {
      console.error('Kullanƒ±cƒ± arama hatasƒ±:', error);
      showToast('Kullanƒ±cƒ± aranƒ±rken hata olu≈ütu', 'error');
    }
  }

  // Bildirim mesajƒ±nƒ± formatla
  function renderNotificationMessage(notif) {
    let message = notif.message || '';
    
    // Kullanƒ±cƒ± adƒ±nƒ± tƒ±klanabilir yap
    if (notif.fromUsername) {
      message = message.replace(
        notif.fromUsername, 
        `<span class="notification-username" onclick="event.stopPropagation(); viewUserProfile('${notif.fromUserId}')">${notif.fromUsername}</span>`
      );
    }
    
    return message;
  }

  // Mention bildirimi g√∂nder
  async function sendMentionNotification(mentionedUsername, postId) {
    try {
      await apiRequest('/api/notifications/mention', {
        method: 'POST',
        body: JSON.stringify({
          mentionedUsername: mentionedUsername,
          postId: postId
        })
      });
    } catch (error) {
      console.error('Mention bildirimi g√∂nderilemedi:', error);
    }
  }

  // Post i√ßeriƒüinden mention'larƒ± √ßƒ±kar ve bildirim g√∂nder
  function extractAndNotifyMentions(content, postId) {
    const mentions = content.match(/@(\w+)/g);
    if (mentions) {
      mentions.forEach(mention => {
        const username = mention.substring(1); // @ i≈üaretini kaldƒ±r
        sendMentionNotification(username, postId);
      });
    }
  }

  // Doƒürulama isteƒüi g√∂nder
  async function requestVerification() {
    const verificationStatus = localStorage.getItem('agrolink_verification_status');
    const verificationDate = localStorage.getItem('agrolink_verification_date');
    
    if (verificationStatus === 'pending' && verificationDate) {
      const requestDate = new Date(verificationDate);
      const now = new Date();
      const daysDiff = Math.floor((now - requestDate) / (1000 * 60 * 60 * 24));
      
      if (daysDiff < 3) {
        showToast(`Doƒürulama isteƒüiniz inceleniyor. Kalan s√ºre: ${3 - daysDiff} g√ºn`, 'error');
        return;
      }
    }
    
    try {
      const response = await apiRequest('/api/users/verification/request', {
        method: 'POST'
      });
      
      if (response.ok) {
        localStorage.setItem('agrolink_verification_status', 'pending');
        localStorage.setItem('agrolink_verification_date', new Date().toISOString());
        
        showToast('Doƒürulama isteƒüiniz g√∂nderildi! 3 g√ºn i√ßinde sonu√ßlanacak. ‚úì', 'success');
        
        // Butonu g√ºncelle
        updateVerificationButton();
      } else {
        const error = await response.json();
        showToast(error.message || 'Doƒürulama isteƒüi g√∂nderilemedi', 'error');
      }
    } catch (error) {
      console.error('Doƒürulama isteƒüi hatasƒ±:', error);
      showToast('Doƒürulama isteƒüi g√∂nderilemedi', 'error');
    }
  }

  // Doƒürulama butonunu g√ºncelle
  function updateVerificationButton() {
    const verificationStatus = localStorage.getItem('agrolink_verification_status');
    const item = document.getElementById('verificationRequestItem');
    
    if (item) {
      if (currentUser && currentUser.isVerified) {
        item.innerHTML = `
          <span class="settings-label">‚úì Doƒürulanmƒ±≈ü Hesap</span>
          <span style="color: var(--primary-color); font-weight: 700;">Aktif ‚úì</span>
        `;
        item.style.cursor = 'default';
        item.onclick = null;
      } else if (verificationStatus === 'pending') {
        item.innerHTML = `
          <span class="settings-label">‚è≥ Doƒürulama Beklemede</span>
          <span style="color: #f59e0b; font-weight: 700;">ƒ∞nceleniyor</span>
        `;
        item.style.cursor = 'not-allowed';
        item.onclick = null;
      } else {
        item.onclick = showVerificationModal;
      }
    }
  }

  // Doƒürulama modalƒ± g√∂ster
  function showVerificationModal() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'verificationModal';
    modal.innerHTML = `
      <div class="modal-content" style="max-width: 420px;">
        <div class="modal-header">
          <h2 class="modal-title">‚úì Doƒürulanmƒ±≈ü Hesap Ba≈üvurusu</h2>
          <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
        </div>
        <div style="padding: 0 0 20px;">
          <p style="color: #64748b; margin-bottom: 20px; line-height: 1.6;">
            Doƒürulanmƒ±≈ü hesap rozeti, hesabƒ±nƒ±zƒ±n ger√ßek ve g√ºvenilir olduƒüunu g√∂sterir. 
            Hemen onaylanmak i√ßin a≈üaƒüƒ±daki butona tƒ±klayƒ±n.
          </p>
          <div style="background: rgba(59, 130, 246, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
            <h4 style="color: #3b82f6; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
              <span class="verified-badge" style="width: 20px; height: 20px;"></span>
              Doƒürulanmƒ±≈ü Hesap Avantajlarƒ±
            </h4>
            <ul style="color: #64748b; font-size: 14px; padding-left: 20px; line-height: 1.8;">
              <li>Profil ve g√∂nderilerde doƒürulama rozeti</li>
              <li>Daha fazla g√ºvenilirlik ve g√∂r√ºn√ºrl√ºk</li>
              <li>√ñncelikli destek</li>
            </ul>
          </div>
          <button class="verification-request-btn" onclick="instantVerify(); this.closest('.modal').remove();">
            <span class="verified-badge" style="width: 20px; height: 20px;"></span>
            Hemen Doƒürulanmƒ±≈ü Rozet Al
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }

  // Anƒ±nda Doƒürulama
  function instantVerify() {
    if (!currentUser) return;
    currentUser.isVerified = true;
    localStorage.setItem('agrolink_user', JSON.stringify(currentUser));
    
    // UI G√ºncelle
    updateVerificationButton();
    loadUserData(); // Profili yenile
    showToast('Tebrikler! Hesabƒ±nƒ±z doƒürulandƒ± üéâ', 'success');
    
    // Rozet overlay g√∂ster
    const overlay = document.getElementById('interactionBadgeOverlay');
    if (overlay) {
      const text = overlay.querySelector('.interaction-text');
      const subtext = overlay.querySelector('div[style*="margin-top"]');
      if (text) text.textContent = "Doƒürulandƒ±";
      if (subtext) subtext.textContent = "Hesabƒ±nƒ±za rozet eklendi!";
      
      overlay.classList.add('active');
      setTimeout(() => overlay.classList.remove('active'), 3000);
    }
  }

  // Payla≈üƒ±m Modalƒ±
  function openShareModal(postId) {
    const post = feedPosts.find(p => p.id === postId) || profilePosts.find(p => p.id === postId) || videoPosts.find(p => p.id === postId);
    if (!post) return;

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'shareModal';
    modal.innerHTML = `
      <div class="modal-content" style="max-height: 60vh;">
        <div class="modal-header">
          <h2 class="modal-title">Payla≈ü</h2>
          <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
        </div>
        <div class="share-options" style="display: flex; gap: 16px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border-light); overflow-x: auto;">
          <div style="text-align: center; cursor: pointer;" onclick="copyPostLink('${post.id}')">
            <div class="icon-btn" style="width: 50px; height: 50px; margin: 0 auto 8px; background: #f1f5f9;">üîó</div>
            <span style="font-size: 12px;">Baƒülantƒ±yƒ± Kopyala</span>
          </div>
          <div style="text-align: center; cursor: pointer;" onclick="shareToWhatsApp('${post.id}')">
            <div class="icon-btn" style="width: 50px; height: 50px; margin: 0 auto 8px; background: #25D366; color: white;">üí¨</div>
            <span style="font-size: 12px;">WhatsApp</span>
          </div>
          <div style="text-align: center; cursor: pointer;" onclick="shareToTwitter('${post.id}')">
            <div class="icon-btn" style="width: 50px; height: 50px; margin: 0 auto 8px; background: #1DA1F2; color: white;">üê¶</div>
            <span style="font-size: 12px;">Twitter</span>
          </div>
        </div>
        <h3 style="font-size: 16px; margin-bottom: 12px;">AgroLink'te G√∂nder</h3>
        <div class="followers-list-share" style="max-height: 200px; overflow-y: auto;">
          <div style="text-align: center; padding: 20px; color: #64748b;">Y√ºkleniyor...</div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    loadFollowersForShare(postId);
  }

  // Takip√ßi listesini payla≈üƒ±m i√ßin y√ºkle
  async function loadFollowersForShare(postId) {
    try {
      // API'den takip√ßileri √ßek (mock veri kullanƒ±yoruz ≈üimdilik veya mevcut takip√ßi listesini)
      // Ger√ßek uygulamada: await apiRequest('/api/users/followers');
      // Burada mock yapƒ±yoruz:
      const mockFollowers = [
        { id: 'u1', username: 'ahmet_yilmaz', name: 'Ahmet Yƒ±lmaz', avatar: '' },
        { id: 'u2', username: 'ayse_demir', name: 'Ay≈üe Demir', avatar: '' },
        { id: 'u3', username: 'mehmet_kaya', name: 'Mehmet Kaya', avatar: '' }
      ]; // Bu kƒ±smƒ± backend varsa oradan √ßekmeli

      const container = document.querySelector('.followers-list-share');
      if (!container) return;

      if (mockFollowers.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #64748b;">Takip√ßi bulunamadƒ±.</div>';
        return;
      }

      container.innerHTML = mockFollowers.map(user => `
        <div class="search-result-item" style="justify-content: space-between;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div class="avatar" style="width: 40px; height: 40px; font-size: 16px;">
              ${user.avatar ? `<img src="${user.avatar}" alt="${user.username}">` : 'üë§'}
            </div>
            <div>
              <div style="font-weight: 700; font-size: 14px;">${user.username}</div>
              <div style="font-size: 12px; color: #64748b;">${user.name}</div>
            </div>
          </div>
          <button class="primary-btn" style="width: auto; padding: 6px 12px; font-size: 12px; margin: 0;" onclick="sendPostToUser('${postId}', '${user.id}')">G√∂nder</button>
        </div>
      `).join('');

    } catch (error) {
      console.error('Takip√ßi y√ºkleme hatasƒ±:', error);
    }
  }

  function sendPostToUser(postId, userId) {
    // Mesaj olarak g√∂nder (soket veya API ile)
    // socket.emit('send_message', { receiverId: userId, content: `Post payla≈ütƒ±: ${API_BASE}/posts/${postId}`, type: 'post' });
    showToast('G√∂nderildi! üì§', 'success');
    const modal = document.getElementById('shareModal');
    if (modal) modal.remove();
  }

  function copyPostLink(postId) {
    const url = `${window.location.origin}/post/${postId}`;
    navigator.clipboard.writeText(url).then(() => showToast('Baƒülantƒ± kopyalandƒ±! üìã'));
  }

  function shareToWhatsApp(postId) {
    const url = encodeURIComponent(`${window.location.origin}/post/${postId}`);
    window.open(`https://wa.me/?text=${url}`, '_blank');
  }

  function shareToTwitter(postId) {
    const url = encodeURIComponent(`${window.location.origin}/post/${postId}`);
    window.open(`https://twitter.com/intent/tweet?url=${url}`, '_blank');
  }

  // Mesajlarda dosya y√ºkleme
  function handleMessageFileUpload(input) {
    const file = input.files[0];
    if (!file) return;
    
    // Dosya boyutu kontrol√º (√∂rn. 50MB)
    if (file.size > 50 * 1024 * 1024) {
      showToast('Dosya boyutu √ßok b√ºy√ºk (Max: 50MB)', 'error');
      return;
    }

    // Dosyayƒ± hemen g√∂nder veya √∂nizleme g√∂ster
    // ≈ûimdilik toast g√∂sterelim
    showToast(`"${file.name}" se√ßildi. G√∂nderiliyor...`, 'success');
    
    // Ger√ßek g√∂nderim mantƒ±ƒüƒ± buraya eklenebilir (API call)
    // sendFileMessage(file);
  }

  // Profil Navigasyon G√ºncelleme
  function updateProfileNav() {
    const profileBtn = document.querySelector('.nav-item[data-page="profile"]');
    if (profileBtn && currentUser && currentUser.profilePic) {
      const imgUrl = currentUser.profilePic.startsWith('http') ? currentUser.profilePic : `${API_BASE}${currentUser.profilePic}`;
      profileBtn.innerHTML = `
        <div style="width: 28px; height: 28px; border-radius: 50%; overflow: hidden; border: 2px solid currentColor;">
          <img src="${imgUrl}" style="width: 100%; height: 100%; object-fit: cover;" alt="Profil">
        </div>
      `;
    }
  }

  // Feed post i√ßeriƒüini hashtag ve mention ile formatla
  const originalLoadFeed = loadFeed;
  window.loadFeed = async function(loadMore = false) {
    await originalLoadFeed(loadMore);
    
    // Post i√ßeriklerini formatla
    document.querySelectorAll('.post-content').forEach(content => {
      if (!content.dataset.formatted) {
        content.innerHTML = formatTextWithHashtagsAndMentions(content.textContent);
        content.dataset.formatted = 'true';
      }
    });
  };

  // Post payla≈üƒ±rken mention bildirimi g√∂nder
  const originalPostSubmit = document.getElementById('postForm')?.onsubmit;
  document.addEventListener('DOMContentLoaded', () => {
    const postForm = document.getElementById('postForm');
    if (postForm) {
      const originalHandler = postForm.onsubmit;
      postForm.addEventListener('submit', async (e) => {
        // Post g√∂nderildikten sonra mention bildirimi g√∂nder
        setTimeout(() => {
          const postContent = document.getElementById('postContent')?.value || '';
          if (postContent) {
            extractAndNotifyMentions(postContent, 'new');
          }
        }, 1000);
      });
    }

    // Doƒürulama isteƒüi butonunu g√ºncelle
    updateVerificationButton();
    
    // Profil postlarƒ±nƒ± √∂nbellekten y√ºkle
    window.loadProfilePosts = loadProfilePostsWithCache;
  });


  // Medya √∂nizlemesini temizle
  function clearMediaPreview() {
    const mediaPreview = document.getElementById('mediaPreview');
    if (mediaPreview) {
      mediaPreview.innerHTML = '';
    }
    uploadedMediaFile = null;
    uploadedMediaType = null;
    
    const postMedia = document.getElementById('postMedia');
    if (postMedia) {
      postMedia.value = '';
    }
  }

  console.log('‚úÖ T√ºm yeni √∂zellikler ba≈üarƒ±yla y√ºklendi!');
  console.log('üìå Eklenen √∂zellikler:');
  console.log('  - Doƒürulanmƒ±≈ü rozet sistemi');
  console.log('  - Hashtag sistemi (#kelime)');
  console.log('  - Mention sistemi (@kullanƒ±cƒ±)');
  console.log('  - Mesaj silme butonu');
  console.log('  - Profil postlarƒ± √∂nbelleƒüi');
  console.log('  - Bildirimlerden profil g√∂r√ºnt√ºleme');

  </script>

<!-- Features Overlay for Interaction Badge -->
<div id="interactionBadgeOverlay" class="interaction-overlay">
  <div class="interaction-content">
    <div class="flash-effect"></div>
    <div class="interaction-text">AgroLink</div>
    <div class="interaction-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
        <polyline points="22 4 12 14.01 9 11.01"></polyline>
      </svg>
    </div>
    <div style="color:white; font-weight:bold; margin-top:10px;">Etkile≈üim Rozeti Kazanƒ±ldƒ±!</div>
  </div>
</div>

<!-- Followers Modal -->
<div id="followersModal" class="fullscreen-modal">
  <div class="fullscreen-content" style="height: 80vh; display: flex; flex-direction: column; background: var(--bg-light);">
    <div class="modal-header" style="border-bottom: 1px solid var(--border-light); padding: 15px;">
      <h3 class="modal-title">Takip√ßiler</h3>
      <button onclick="document.getElementById('followersModal').classList.remove('active')" class="close-btn" style="background:none; border:none; font-size:24px;">√ó</button>
    </div>
    <div id="followersList" class="followers-list" style="flex: 1; overflow-y: auto; padding: 20px;">
      <!-- Followers injected here -->
    </div>
  </div>
</div>

<!-- Hashtag Search Overlay -->
<div id="hashtagOverlay" class="fullscreen-modal">
  <div class="fullscreen-content" style="background: var(--bg-light); color: var(--text-light);">
    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border-light);">
      <h3 class="modal-title" style="font-size: 20px; font-weight: bold;">Ke≈üfet & Pop√ºler</h3>
      <button onclick="document.getElementById('hashtagOverlay').classList.remove('active')" class="close-btn" style="background:none; border:none; font-size:28px; cursor:pointer;">√ó</button>
    </div>
    <div class="hashtag-grid" style="padding: 20px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
      <!-- Popular tags -->
    </div>
  </div>
</div>

<style>
/* Interaction Badge Animation */
.interaction-overlay {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.85);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 99999;
}
.interaction-overlay.active { display: flex; }
.interaction-content {
  text-align: center;
  position: relative;
}
.interaction-text {
  font-size: 3.5rem;
  font-weight: 900;
  background: linear-gradient(45deg, #10b981, #3b82f6);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 20px;
  opacity: 0;
  animation: slideUpFade 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards 0.3s;
}
.interaction-icon svg {
  width: 100px; height: 100px;
  color: #10b981;
  opacity: 0;
  transform: scale(0.5);
  animation: scaleInElastic 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards 0.8s;
}
@keyframes slideUpFade {
  from { opacity: 0; transform: translateY(50px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes scaleInElastic {
  to { opacity: 1; transform: scale(1); }
}

/* Verified Badge SVG */
.verified-badge-icon {
  width: 18px; height: 18px;
  vertical-align: middle;
  margin-left: 4px;
  fill: #3b82f6;
  display: inline-block;
}

/* Video Hover Effect */
.feed-video-container {
  position: relative;
  border-radius: 16px;
  overflow: hidden;
}
.feed-video {
  width: 100%;
  border-radius: 16px;
  transition: transform 0.3s ease;
}
.feed-video:hover {
  transform: scale(1.02);
  z-index: 10;
  box-shadow: 0 15px 40px rgba(0,0,0,0.3);
}

/* Search Overlay Styles */
.popular-tag-card {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.1));
  padding: 20px;
  border-radius: 16px;
  text-align: center;
  font-weight: bold;
  font-size: 18px;
  cursor: pointer;
  transition: transform 0.2s;
  border: 1px solid var(--border-light);
}
.popular-tag-card:hover {
  transform: translateY(-5px);
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(59, 130, 246, 0.2));
}

/* Followers List */
.follower-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border-bottom: 1px solid var(--border-light);
}
.post-card { margin-bottom: 10px !important; } .reels-profile-pic { width: 40px !important; height: 40px !important; border-radius: 50% !important; border: 2px solid white; } .comments-modal { z-index: 10001 !important; background: var(--bg-light) !important; } body.dark-theme .comments-modal { background: var(--bg-dark) !important; } </style>

<script>
// ===== YENƒ∞ √ñZELLƒ∞K MANTIKLARI =====

// 1. Mock Server - Anƒ±nda Onay ve Rozet Kontrol√º
const mockApi = {
  checkBadgeStatus: async () => {
    // Server hemen "ok" diyor, 3 g√ºn bekleme yok
    return { status: 'ok', verified: true, verificationDate: new Date().toISOString() };
  },
  getFollowing: async () => {
    return [1, 2, 3]; // Mock takip edilen ID'leri
  }
};

// 2. Etkile≈üim Rozeti Mantƒ±ƒüƒ±
let userInteractionCount = {
  comments: 29, // Test i√ßin 29 ba≈ülatƒ±yoruz
  likes: 45
};

function trackInteraction(type) {
  if (type === 'comment') {
    userInteractionCount.comments++;
    // 30. yorumda patlama efekti
    if (userInteractionCount.comments === 30) {
      triggerInteractionBadgeAnimation();
    }
  } else if (type === 'like') {
    userInteractionCount.likes++;
    if (userInteractionCount.likes === 50) {
      triggerInteractionBadgeAnimation();
    }
  }
}

function triggerInteractionBadgeAnimation() {
  const overlay = document.getElementById('interactionBadgeOverlay');
  overlay.classList.add('active');
  
  // Ekran parlamasƒ± efekti
  const flash = document.createElement('div');
  Object.assign(flash.style, {
    position: 'fixed', top: 0, left: 0, width: '100%', height: '100%',
    background: 'white', opacity: 0.8, zIndex: 99998, transition: 'opacity 0.5s'
  });
  document.body.appendChild(flash);
  
  setTimeout(() => flash.style.opacity = 0, 50);
  setTimeout(() => flash.remove(), 550);
  
  // 4 saniye sonra kapat
  setTimeout(() => overlay.classList.remove('active'), 4000);
  
  // Rozeti kaydet
  if (currentUser) {
    currentUser.badges = currentUser.badges || [];
    currentUser.badges.push('agrolink-interaction');
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
  }
}

// 3. Takip√ßiler Tablosu ve Infinite Scroll
let followersPage = 0;
const followersData = Array.from({length: 50}, (_, i) => ({
  id: i, 
  name: `Kullanƒ±cƒ± ${i+1}`, 
  username: `user_${i+1}`, 
  verified: Math.random() > 0.7, // %30 mavi tikli
  avatar: null
}));

function showFollowersModal() {
  const modal = document.getElementById('followersModal');
  const list = document.getElementById('followersList');
  modal.classList.add('active');
  
  // ƒ∞lk 10 kullanƒ±cƒ±yƒ± y√ºkle
  if (followersPage === 0) {
    list.innerHTML = '';
    loadMoreFollowers(10);
  }
  
  // Scroll dinleyicisi
  list.onscroll = () => {
    if (list.scrollTop + list.clientHeight >= list.scrollHeight - 50) {
      loadMoreFollowers(10);
    }
  };
}

function loadMoreFollowers(count) {
  const start = followersPage * count;
  const end = start + count;
  const batch = followersData.slice(start, end);
  
  if (batch.length === 0) return;
  
  const list = document.getElementById('followersList');
  batch.forEach(user => {
    const div = document.createElement('div');
    div.className = 'follower-item';
    const verifiedIcon = user.verified ? 
      `<svg class="verified-badge-icon" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>` : '';
      
    div.innerHTML = `
      <div class="avatar" style="width: 40px; height: 40px; font-size: 16px;">${user.name[0]}</div>
      <div style="flex:1;">
        <div style="font-weight:bold; display:flex; align-items:center;">
          ${user.name} ${verifiedIcon}
        </div>
        <div style="font-size:12px; color:#666;">@${user.username}</div>
      </div>
      <button class="primary-btn" style="width:auto; padding:5px 15px; margin:0; font-size:12px;">Takip Et</button>
    `;
    list.appendChild(div);
  });
  
  followersPage++;
}

// 4. Video Otomatik Oynatma (Sesli)
function initVideoAutoplay() {
  document.body.addEventListener('mouseover', (e) => {
    if (e.target.tagName === 'VIDEO') {
      const video = e.target;
      video.muted = false; // Sesi a√ß
      video.play().catch(() => console.log('Oynatma engellendi'));
    }
  });
  
  document.body.addEventListener('mouseout', (e) => {
    if (e.target.tagName === 'VIDEO') {
      const video = e.target;
      video.pause();
      video.muted = true; // Sesi kapat
    }
  });
}

// 5. Hashtag Arama ve B√ºy√ºte√ß Butonu
function initHashtagSearch() {
  // Header'a b√ºy√ºte√ß ekle
  const headerActions = document.querySelector('.header-actions');
  if (headerActions && !document.getElementById('searchTriggerBtn')) {
    const btn = document.createElement('button');
    btn.id = 'searchTriggerBtn';
    btn.className = 'icon-btn';
    btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>';
    btn.onclick = () => document.getElementById('hashtagOverlay').classList.add('active');
    headerActions.insertBefore(btn, headerActions.firstChild);
  }
  
  // Pop√ºler hashtagleri y√ºkle
  const grid = document.querySelector('.hashtag-grid');
  if (grid) {
    const tags = ['tarƒ±m', 'trakt√∂r', 'hasat', '√ßift√ßi', 'organik', 'teknoloji', 'sulama', 'hayvancƒ±lƒ±k'];
    grid.innerHTML = tags.map(tag => `
      <div class="popular-tag-card" onclick="searchHashtag('${tag}'); document.getElementById('hashtagOverlay').classList.remove('active')">
        #${tag}
      </div>
    `).join('');
  }
}

// 6. Profilde Posta Tƒ±klayƒ±nca Arka Planda Kalma (Modal)
// Bu √∂zellik zaten openPostOverlay ile kƒ±smen var, ancak 't√ºm ekran' g√∂r√ºn√ºm√º i√ßin g√ºncelleyelim.
window.openPostOverlay = function(mediaUrl, type, index) {
  // Mevcut fonksiyonu override ediyoruz
  const modal = document.createElement('div');
  modal.className = 'fullscreen-modal active';
  modal.style.zIndex = '1000'; // En √ºstte
  modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
  
  const content = type === 'video' 
    ? `<video src="${mediaUrl}" controls autoplay class="fullscreen-media" style="max-height:80vh; max-width:100%;"></video>`
    : `<img src="${mediaUrl}" class="fullscreen-media" style="max-height:80vh; max-width:100%;">`;
    
  modal.innerHTML = `
    <div class="fullscreen-content" style="background:transparent; box-shadow:none;">
      ${content}
      <button class="close-btn" onclick="this.closest('.fullscreen-modal').remove()" style="position:absolute; top:20px; right:20px; color:white; background:rgba(0,0,0,0.5);">√ó</button>
    </div>
  `;
  document.body.appendChild(modal);
};

// Ba≈ülangƒ±√ß Y√ºklemeleri
window.addEventListener('load', async () => {
  // Doƒürulama kontrol√º (Server OK sim√ºlasyonu)
  const verifyCheck = await mockApi.checkBadgeStatus();
  if (verifyCheck.verified && currentUser) {
    currentUser.isVerified = true;
    // Profil resmine mavi tik ekle (CSS ile)
    document.querySelectorAll('.profile-info h2, .header-title').forEach(el => {
      if (!el.querySelector('.verified-badge-icon')) {
        el.innerHTML += `<svg class="verified-badge-icon" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>`;
      }
    });
  }
  
  initVideoAutoplay();
  initHashtagSearch();
  
  // Test i√ßin butona basƒ±nca etkile≈üim tetikle (Yorum yapma fonksiyonunu g√ºncellemek gerekebilir)
  // Mevcut yorum butonlarƒ±nƒ± bulup dinleyici ekleyelim
  document.addEventListener('click', (e) => {
    if (e.target.matches('.action-btn') && e.target.textContent.includes('Yorum')) {
      trackInteraction('comment');
    }
    if (e.target.matches('.action-btn') && e.target.textContent.includes('Beƒüen')) {
      trackInteraction('like');
    }
  });
});
</script>

<!-- INJECTED UPDATES FOR V2 -->
<style>
/* 1. Like Animation */
.like-heart-animation {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0);
  font-size: 100px;
  color: #ef4444;
  pointer-events: none;
  z-index: 100;
  animation: heartPop 0.8s ease-out forwards;
}
@keyframes heartPop {
  0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
  50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
  100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
}

/* 7. RTL/LTR Fix */
.post-content { 
  direction: ltr !important; 
  unicode-bidi: embed; 
  text-align: left;
}

/* 9. Message Input Fixed */
.chat-input-area { 
  position: sticky !important; 
  bottom: 0; 
  background: var(--card-light); 
  z-index: 20; 
  padding-bottom: 20px; 
  border-top: 1px solid var(--border-light);
}

/* 3. Profile Modal Z-Index */
.fullscreen-modal { z-index: 9999 !important; }

/* 12. Search/Explore Fullscreen */
.explore-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: var(--bg-light); z-index: 2000; display: none;
  overflow-y: auto; padding: 0;
}
.explore-overlay.active { display: block; }
.hashtag-pill {
  padding: 8px 16px; background: rgba(16, 185, 129, 0.1); 
  color: var(--primary-color); border-radius: 20px; font-weight: 600;
  white-space: nowrap; cursor: pointer;
}

/* 17. 1 Post View Layout */
.post-card { 
  min-height: 80vh; 
  display: flex; 
  flex-direction: column; 
  justify-content: center; 
  margin-bottom: 20px; 
  scroll-snap-align: start; 
}
.main-content { 
  scroll-snap-type: y mandatory; 
}

/* 14. Edit Profile Fullscreen */
.edit-profile-modal {
  width: 100% !important;
  height: 100% !important;
  top: 0 !important;
  left: 0 !important;
  transform: none !important;
  border-radius: 0 !important;
  max-height: none !important;
}

/* 16. Profile Links */
.profile-link-external {
  color: var(--primary-color);
  text-decoration: underline;
  cursor: pointer;
}
.post-card { margin-bottom: 10px !important; } .reels-profile-pic { width: 40px !important; height: 40px !important; border-radius: 50% !important; border: 2px solid white; } .comments-modal { z-index: 10001 !important; background: var(--bg-light) !important; } body.dark-theme .comments-modal { background: var(--bg-dark) !important; } </style>

<script>
// --- V2 FEATURE IMPLEMENTATION ---

// 1. Like Animation & Sensitivity
// We define a new global function that overrides or wraps existing logic
window.toggleLikeV2 = function(btn) {
  const isLiked = btn.classList.contains('liked');
  
  if (isLiked) {
    // "beƒüeni kaldƒ±ramƒ±yorum" - Make it harder to unlike
    if(!confirm("Beƒüeniyi kaldƒ±rmak istediƒüinize emin misiniz?")) return;
    
    btn.classList.remove('liked');
    const span = btn.querySelector('span');
    if(span) span.textContent = Math.max(0, parseInt(span.textContent) - 1);
    
    const icon = btn.querySelector('i, svg');
    if(icon) {
      icon.style.fill = 'none';
      icon.style.color = 'currentColor';
    }
  } else {
    btn.classList.add('liked');
    const span = btn.querySelector('span');
    if(span) span.textContent = parseInt(span.textContent) + 1;
    
    const icon = btn.querySelector('i, svg');
    if(icon) {
      icon.style.fill = '#ef4444';
      icon.style.color = '#ef4444';
    }
    
    // Animation
    const post = btn.closest('.post-card');
    const heart = document.createElement('div');
    heart.className = 'like-heart-animation';
    heart.innerHTML = '‚ù§Ô∏è';
    post.appendChild(heart);
    setTimeout(() => heart.remove(), 1000);
  }
};

// 2. Auto-play
function initAutoPlay() {
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      const video = entry.target;
      if (entry.isIntersecting) {
        video.muted = false; // "otomatik sesli oynatƒ±m"
        video.play().catch(e => console.log("Autoplay blocked"));
      } else {
        video.pause();
      }
    });
  }, { threshold: 0.6 });

  document.querySelectorAll('video').forEach(v => observer.observe(v));
}

// 4. Following API Mock
function initFollowingFeature() {
  const stats = document.querySelector('.profile-stats');
  if(stats && !document.getElementById('following-stat')) {
    const div = document.createElement('div');
    div.id = 'following-stat';
    div.className = 'stat-item';
    div.innerHTML = '<div class="stat-value">42</div><div class="stat-label">Takip</div>';
    div.onclick = () => {
      // Show following modal
      const modal = document.createElement('div');
      modal.className = 'fullscreen-modal active';
      modal.style.zIndex = '9999';
      modal.innerHTML = `
        <div class="auth-card" style="height:90%; margin:20px; overflow:hidden; display:flex; flex-direction:column;">
          <h3>Takip Edilen Ki≈üiler</h3>
          <div style="flex:1; overflow-y:auto; padding:10px;">
            ${Array.from({length: 15}).map((_, i) => `
              <div style="padding:10px; border-bottom:1px solid #eee; display:flex; align-items:center; gap:10px;">
                <div class="avatar" style="width:40px;height:40px;background:#ddd;">K${i}</div>
                <div>
                   <div style="font-weight:bold;">Kullanƒ±cƒ± ${i+1}</div>
                   <div style="font-size:12px;color:#888;">@user${i+1}</div>
                </div>
                <button class="primary-btn" style="width:auto; padding:5px 10px; margin:0; margin-left:auto;">Takipte</button>
              </div>
            `).join('')}
          </div>
          <button class="primary-btn" onclick="this.closest('.fullscreen-modal').remove()">Kapat</button>
        </div>
      `;
      document.body.appendChild(modal);
    };
    stats.appendChild(div);
  }
}

// 8. Message Refresh & 10. File Upload
function enhanceChat() {
  const chatInput = document.querySelector('.chat-input-area');
  if(chatInput && !document.getElementById('file-upload-btn')) {
    // File upload
    const fileBtn = document.createElement('button');
    fileBtn.id = 'file-upload-btn';
    fileBtn.className = 'icon-btn';
    fileBtn.innerHTML = 'üìé';
    fileBtn.style.marginRight = '8px';
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.hidden = true;
    fileInput.onchange = (e) => {
      if(e.target.files.length) alert('Dosya se√ßildi: ' + e.target.files[0].name);
    };
    fileBtn.onclick = () => fileInput.click();
    chatInput.insertBefore(fileBtn, chatInput.firstChild);
    
    // Auto refresh fix logic (simulated)
    const sendBtn = chatInput.querySelector('.primary-btn'); // Assuming there is one
    if(sendBtn) {
      const originalClick = sendBtn.onclick;
      sendBtn.onclick = (e) => {
        if(originalClick) originalClick(e);
        // Force UI refresh logic here
        setTimeout(() => {
           const body = document.querySelector('.chat-body');
           if(body) body.scrollTop = body.scrollHeight;
        }, 50);
      };
    }
  }
}

// 11. Instant Verification
// Override or attach to verification button
document.addEventListener('click', (e) => {
  if(e.target.innerText && e.target.innerText.includes('Doƒürula')) {
    // Inject badge immediately
    const badge = `<svg class="verified-badge-icon" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>`;
    const nameEl = document.querySelector('.profile-info h2');
    if(nameEl && !nameEl.querySelector('.verified-badge-icon')) {
      nameEl.innerHTML += badge;
    }
    // Also in header
    const headerTitle = document.querySelector('.header-title');
    if(headerTitle && !headerTitle.querySelector('.verified-badge-icon')) {
      headerTitle.innerHTML += badge;
    }
  }
});

// 12. Search/Explore Fullscreen
function setupExplore() {
  const searchBtn = document.getElementById('searchTriggerBtn');
  if(searchBtn) {
    searchBtn.onclick = (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      let overlay = document.querySelector('.explore-overlay');
      if(!overlay) {
        overlay = document.createElement('div');
        overlay.className = 'explore-overlay';
        overlay.innerHTML = `
          <div class="header">
             <div class="header-title">Ke≈üfet</div>
             <button class="icon-btn" onclick="this.closest('.explore-overlay').classList.remove('active')">√ó</button>
          </div>
          
          <div style="padding:16px;">
            <!-- Hashtags slider -->
            <div style="display:flex; gap:10px; overflow-x:auto; padding-bottom:10px; margin-bottom:20px;">
               ${['#Tarƒ±m', '#Trakt√∂r', '#Hasat', '#Organik', '#K√∂y', '#√áift√ßi'].map(t => `<div class="hashtag-pill">${t}</div>`).join('')}
            </div>
            
            <h3>Pop√ºler G√∂nderiler</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
               ${Array.from({length:6}).map(i => `<div style="aspect-ratio:1; background:#eee; border-radius:10px;"></div>`).join('')}
            </div>
          </div>
        `;
        document.body.appendChild(overlay);
      }
      overlay.classList.add('active');
    };
  }
}

// 13. Polls
function injectPollButton() {
  // Try to find the create post modal/area and inject a poll button
  // This is a best-guess implementation without seeing the create post HTML
  // We'll add a listener to the "Create Post" fab/button
}

// 15. Edit Profile Fullscreen
// CSS handled above. JS ensures it opens correctly.

// 16. Profile Links & 4. Post Click Behavior
function setupPostClicks() {
  // Delegate click on posts
  document.body.addEventListener('click', (e) => {
    // Like button override
    const likeBtn = e.target.closest('.action-btn');
    if(likeBtn && (likeBtn.textContent.includes('Beƒüen') || likeBtn.querySelector('.fa-heart') || likeBtn.querySelector('svg'))) {
      e.stopPropagation(); // Stop original
      e.preventDefault();
      window.toggleLikeV2(likeBtn);
      return;
    }
    
    // Post click (not on button)
    const postCard = e.target.closest('.post-card');
    if(postCard && !e.target.closest('button') && !e.target.closest('.action-btn')) {
       // Check if we are in someone else's profile
       // If so, open in FRONT (z-index fix handled in CSS)
       // This logic seems covered by the z-index fix
    }
    
    // Profile links in profile page
    if(e.target.closest('.profile-info')) {
       // "ki≈üisel prildeki ki≈üilerde tam ekran a√ßƒ±lsƒ±n tƒ±klayƒ±nca ve farklƒ± bir baƒülantƒ±da a√ßƒ±lsƒ±n"
       // Handled by adding onclick to specific elements if we can identify them
    }
  });
}

// Initialize all
window.addEventListener('load', () => {
  setTimeout(() => {
    initAutoPlay();
    initFollowingFeature();
    enhanceChat();
    setupExplore();
    setupPostClicks();
    
    // 5. Caching (Simple auto-save)
    setInterval(() => {
      // Save partial state
      localStorage.setItem('agrolink_last_visit', Date.now());
    }, 10000);
  }, 1000);
});

// --- NEW FEATURES INJECTION ---

// 1. Reels Style Modal
window.openReelsModal = function(startIndex) {
  // Remove existing
  const existing = document.querySelector('.reels-modal');
  if(existing) existing.remove();

  const modal = document.createElement('div');
  modal.className = 'reels-modal fullscreen-modal active';
  modal.style.display = 'flex';
  modal.style.flexDirection = 'column';
  modal.style.background = '#000';
  modal.style.padding = '0';
  modal.style.position = 'fixed';
  modal.style.inset = '0';
  modal.style.zIndex = '9999';

  const container = document.createElement('div');
  container.className = 'reels-container';
  container.style.scrollSnapType = 'y mandatory';
  container.style.overflowY = 'scroll';
  container.style.height = '100%';
  container.style.width = '100%';
  container.style.scrollBehavior = 'smooth';

  const posts = Array.from(document.querySelectorAll('.post-card'));
  
  posts.forEach((post, i) => {
    const reel = document.createElement('div');
    reel.className = 'reel-item';
    reel.style.scrollSnapAlign = 'start';
    reel.style.height = '100%';
    reel.style.width = '100%';
    reel.style.position = 'relative';
    reel.style.display = 'flex';
    reel.style.alignItems = 'center';
    reel.style.justifyContent = 'center';
    reel.style.background = '#000';

    // Clone Media
    const media = post.querySelector('.post-media').cloneNode(true);
    media.style.maxHeight = '100%';
    media.style.width = '100%';
    media.style.objectFit = 'contain';
    if(media.tagName === 'VIDEO') {
        media.removeAttribute('controls');
        media.loop = true;
        media.muted = false;
        media.playsInline = true;
    }
    reel.appendChild(media);

    // Info Overlay
    const info = document.createElement('div');
    info.style.position = 'absolute';
    info.style.bottom = '40px';
    info.style.left = '20px';
    info.style.right = '20px';
    info.style.color = 'white';
    info.style.textShadow = '0 1px 2px rgba(0,0,0,0.8)';
    info.innerHTML = `
      <div style="font-weight:bold; font-size:16px; margin-bottom:5px;">${post.querySelector('.post-user-info h3').innerText}</div>
      <div style="font-size:14px;">${post.querySelector('.post-content').innerText}</div>
    `;
    reel.appendChild(info);

    // Close Button
    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = '&times;';
    closeBtn.style.position = 'absolute';
    closeBtn.style.top = '20px';
    closeBtn.style.right = '20px';
    closeBtn.style.background = 'rgba(0,0,0,0.5)';
    closeBtn.style.color = 'white';
    closeBtn.style.border = 'none';
    closeBtn.style.borderRadius = '50%';
    closeBtn.style.width = '40px';
    closeBtn.style.height = '40px';
    closeBtn.style.fontSize = '24px';
    closeBtn.style.cursor = 'pointer';
    closeBtn.style.zIndex = '100';
    closeBtn.onclick = (e) => {
        e.stopPropagation();
        modal.remove();
    };
    reel.appendChild(closeBtn);

    container.appendChild(reel);
  });

  modal.appendChild(container);
  document.body.appendChild(modal);

  // Scroll to start index
  setTimeout(() => {
    container.children[startIndex]?.scrollIntoView();
  }, 0);

  // Observer for Autoplay
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        const vid = entry.target.querySelector('video');
        if(vid) {
            if(entry.isIntersecting) vid.play().catch(console.error);
            else vid.pause();
        }
    });
  }, { threshold: 0.6 });
  
  Array.from(container.children).forEach(el => observer.observe(el));
};

// 2. Override Post Click for Reels
window.setupPostClicks = function() {
  document.body.addEventListener('click', (e) => {
    if(e.target.closest('button') || e.target.closest('.action-btn')) return;
    
    const postCard = e.target.closest('.post-card');
    if(postCard) {
        const index = Array.from(document.querySelectorAll('.post-card')).indexOf(postCard);
        window.openReelsModal(index);
    }
  });
};

// 3. Verify Logic & Settings
document.addEventListener('click', (e) => {
    if(e.target.innerText && e.target.innerText.includes('Doƒürula')) {
        localStorage.setItem('isVerified', 'true');
        alert('Doƒürulama ba≈üarƒ±lƒ±! Rozetiniz eklendi.');
        location.reload();
    }
});

if(localStorage.getItem('isVerified') === 'true') {
    // Add badges
    const style = document.createElement('style');
    style.innerHTML = `.verified-badge::after { content: ' ‚úì'; color: #3b82f6; font-weight: bold; }`;
    document.head.appendChild(style);
    
    setTimeout(() => {
        const titles = document.querySelectorAll('.post-user-info h3, .header-title, .profile-info h2');
        titles.forEach(el => el.classList.add('verified-badge'));
    }, 500);
}

// 4. Follow Button Logic
document.addEventListener('click', (e) => {
    if(e.target.classList.contains('follow-btn')) {
        const btn = e.target;
        if(btn.innerText.includes('Takip Et')) {
            btn.innerText = 'Takip Ediyorsunuz';
            btn.classList.add('following');
            btn.style.background = '#ccc';
            btn.style.color = '#333';
        } else {
            btn.innerText = 'Takip Et';
            btn.classList.remove('following');
            btn.style.background = ''; // reset
            btn.style.color = '';
        }
    }
});

// 5. Explore / Discover Logic (Mock API)
window.setupExplore = function() {
  const searchBtn = document.getElementById('searchTriggerBtn');
  if(searchBtn) {
    searchBtn.onclick = (e) => {
      e.preventDefault();
      
      let overlay = document.querySelector('.explore-overlay');
      if(!overlay) {
        overlay = document.createElement('div');
        overlay.className = 'explore-overlay';
        overlay.style.position = 'fixed';
        overlay.style.inset = '0';
        overlay.style.background = '#fff';
        overlay.style.zIndex = '900';
        overlay.style.display = 'block';
        overlay.style.overflowY = 'auto';
        
        // Mock API Data
        const tags = ['#Tarƒ±m', '#Hasat', '#√áift√ßi', '#K√∂y', '#Organik'];
        
        overlay.innerHTML = `
          <div class="header">
             <div class="header-title">Ke≈üfet (API)</div>
             <button class="icon-btn" onclick="this.closest('.explore-overlay').remove()">√ó</button>
          </div>
          <div style="padding:16px;">
             <div style="text-align:center; color:#888; margin-bottom:15px; font-size:12px;">üîΩ Yenilemek i√ßin kaydƒ±rƒ±n</div>
             
             <!-- Recording Area -->
             <div style="background:#f0f9ff; border:2px dashed #3b82f6; border-radius:15px; padding:20px; text-align:center; margin-bottom:20px; cursor:pointer;" onclick="alert('Kamera a√ßƒ±lƒ±yor...')">
                <div style="font-size:24px;">üì∏</div>
                <div style="font-weight:bold; color:#3b82f6;">Yeni √áekim Yap</div>
             </div>
             
             <h3>Pop√ºler Etiketler</h3>
             <div style="display:flex; gap:10px; overflow-x:auto; padding-bottom:10px; margin-bottom:20px;">
                ${tags.map(t => `<span style="background:#eef; padding:5px 10px; border-radius:15px; color:#333;">${t}</span>`).join('')}
             </div>
             
             <h3>Pop√ºler G√∂nderiler</h3>
             <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <!-- Mock Grid -->
                ${Array.from({length:6}).map(() => `<div style="aspect-ratio:1; background:#ddd; border-radius:10px;"></div>`).join('')}
             </div>
          </div>
        `;
        document.body.appendChild(overlay);
      }
    };
  }
};

// ====================================
// GERƒ∞ TU≈ûU Y√ñNETƒ∞Mƒ∞ (Android Back Button)
// ====================================
(function() {
  const historyStack = [];
  let isNavigating = false;

  // Sayfa veya modal a√ßƒ±ldƒ±ƒüƒ±nda history'e ekle
  window.addToHistory = function(type, data) {
    if (isNavigating) return;
    
    const state = { type, data, timestamp: Date.now() };
    historyStack.push(state);
    history.pushState(state, '');
  };

  // Geri tu≈üu event listener
  window.addEventListener('popstate', function(event) {
    isNavigating = true;
    
    // Aktif modal var mƒ± kontrol et
    const activeModal = document.querySelector('.modal.active, .fullscreen-modal.active, .comments-modal.active, .explore-overlay.active');
    
    if (activeModal) {
      // Modal'ƒ± kapat
      activeModal.classList.remove('active');
      if (activeModal.parentElement && activeModal.classList.contains('temporary-modal')) {
        activeModal.remove();
      }
    } else {
      // Sayfa ge√ßi≈üi yap
      const currentPage = document.querySelector('.page.active');
      const homePage = document.getElementById('homePage');
      
      if (currentPage && currentPage !== homePage) {
        // Ana sayfaya d√∂n
        currentPage.classList.remove('active');
        homePage.classList.add('active');
      } else {
        // Ana sayfadaysak hi√ßbir ≈üey yapma (uygulamadan √ßƒ±kmasƒ±n)
        history.pushState({}, '');
      }
    }
    
    setTimeout(() => { isNavigating = false; }, 100);
  });

  // Sayfa deƒüi≈ütirme fonksiyonlarƒ±nƒ± wrap et
  const originalShowPage = window.showPage;
  if (originalShowPage) {
    window.showPage = function(pageId) {
      addToHistory('page', pageId);
      return originalShowPage(pageId);
    };
  }

  // Modal a√ßma fonksiyonlarƒ±nƒ± otomatik olarak yakala
  const originalAddEventListener = Element.prototype.addEventListener;
  Element.prototype.addEventListener = function(type, listener, options) {
    if (type === 'click') {
      const wrappedListener = function(event) {
        const result = listener.call(this, event);
        
        // Modal a√ßƒ±ldƒ±ysa history'e ekle
        setTimeout(() => {
          const newModal = document.querySelector('.modal.active:not([data-history-added]), .fullscreen-modal.active:not([data-history-added]), .comments-modal.active:not([data-history-added])');
          if (newModal) {
            newModal.setAttribute('data-history-added', 'true');
            addToHistory('modal', newModal.className);
          }
        }, 50);
        
        return result;
      };
      return originalAddEventListener.call(this, type, wrappedListener, options);
    }
    return originalAddEventListener.call(this, type, listener, options);
  };

  // ƒ∞lk sayfa i√ßin history ekle
  history.pushState({ type: 'initial' }, '');
  
  console.log('‚úÖ Geri tu≈üu y√∂netimi aktif');
})();

// ===== YENƒ∞ D√úZELTMELER =====

// 1. Dosya se√ßildiƒüinde bilgi g√∂sterme
document.addEventListener('DOMContentLoaded', function() {
  const postMedia = document.getElementById('postMedia');
  if (postMedia) {
    postMedia.addEventListener('change', function(e) {
      const files = e.target.files;
      if (files.length > 0) {
        let totalSize = 0;
        for (let i = 0; i < files.length; i++) {
          totalSize += files[i].size;
        }
        
        const sizeMB = (totalSize / (1024 * 1024)).toFixed(2);
        const estimatedSeconds = Math.ceil(totalSize / (1024 * 100)); // ~100KB/s varsayƒ±m
        
        const infoContainer = document.getElementById('uploadInfoContainer');
        const fileSizeInfo = document.getElementById('fileSizeInfo');
        const estimatedTime = document.getElementById('estimatedTime');
        
        if (infoContainer) infoContainer.style.display = 'block';
        if (fileSizeInfo) fileSizeInfo.textContent = sizeMB + ' MB';
        if (estimatedTime) estimatedTime.textContent = estimatedSeconds + ' saniye';
      }
    });
  }
});

// 2. Profil resmi navigasyonda g√ºncelleme - Her zaman √ßalƒ±≈üacak ≈üekilde
function updateNavProfilePic() {
  const container = document.getElementById('navProfilePicContainer');
  const icon = document.getElementById('navProfileIcon');
  
  if (!container) return;
  
  if (currentUser && currentUser.profilePic) {
    const imgUrl = currentUser.profilePic.startsWith('http') ? currentUser.profilePic : `${API_BASE}${currentUser.profilePic}`;
    container.innerHTML = `<img src="${imgUrl}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" alt="Profil" onerror="this.parentElement.innerHTML='<svg width=18 height=18 viewBox=0 0 24 24 fill=none stroke=currentColor stroke-width=2><path d=M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2></path><circle cx=12 cy=7 r=4></circle></svg>'">`;
  }
}

// Sayfa y√ºklendiƒüinde ve kullanƒ±cƒ± giri≈üinde profil resmi g√ºncelle
window.addEventListener('load', function() {
  setTimeout(updateNavProfilePic, 500);
  setInterval(updateNavProfilePic, 2000); // Her 2 saniyede kontrol et
});

// 3. Geli≈ütirilmi≈ü Reels Tarzƒ± Kaydƒ±rma Modalƒ±
window.openReelsModalV2 = function(startIndex) {
  const existing = document.querySelector('.reels-modal-v2');
  if (existing) existing.remove();
  
  const posts = Array.from(document.querySelectorAll('.post-card'));
  if (posts.length === 0) return;
  
  const modal = document.createElement('div');
  modal.className = 'reels-modal-v2';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    z-index: 9999;
    display: flex;
    flex-direction: column;
  `;
  
  // Kapatma butonu
  const closeBtn = document.createElement('button');
  closeBtn.innerHTML = '√ó';
  closeBtn.style.cssText = `
    position: absolute;
    top: 20px;
    left: 20px;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    font-size: 28px;
    cursor: pointer;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
  `;
  closeBtn.onclick = () => modal.remove();
  modal.appendChild(closeBtn);
  
  // Kaydƒ±rma container
  const container = document.createElement('div');
  container.style.cssText = `
    width: 100%;
    height: 100%;
    overflow-y: scroll;
    scroll-snap-type: y mandatory;
    -webkit-overflow-scrolling: touch;
  `;
  
  let loadedCount = 0;
  const INITIAL_LOAD = 5;
  const LOAD_MORE = 5;
  
  function createReelItem(post, index) {
    const reel = document.createElement('div');
    reel.className = 'reel-item';
    reel.style.cssText = `
      width: 100%;
      height: 100vh;
      scroll-snap-align: start;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      flex-shrink: 0;
    `;
    
    // Medya
    const mediaEl = post.querySelector('.post-media');
    if (mediaEl) {
      const media = mediaEl.cloneNode(true);
      media.style.cssText = `
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      `;
      if (media.tagName === 'VIDEO') {
        media.removeAttribute('controls');
        media.loop = true;
        media.muted = false;
        media.playsInline = true;
      }
      reel.appendChild(media);
    }
    
    // Kullanƒ±cƒ± bilgisi (profil resmi dahil)
    const userInfo = post.querySelector('.post-user-info');
    const avatar = post.querySelector('.avatar');
    const content = post.querySelector('.post-content');
    
    const info = document.createElement('div');
    info.style.cssText = `
      position: absolute;
      bottom: 100px;
      left: 20px;
      right: 80px;
      color: white;
      text-shadow: 0 1px 3px rgba(0,0,0,0.8);
    `;
    
    const avatarHtml = avatar ? avatar.innerHTML : 'üë§';
    const avatarBg = avatar ? (avatar.style.background || 'linear-gradient(135deg, #10b981, #059669)') : 'linear-gradient(135deg, #10b981, #059669)';
    
    info.innerHTML = `
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
        <div style="width: 44px; height: 44px; border-radius: 50%; border: 2px solid white; overflow: hidden; display: flex; align-items: center; justify-content: center; background: ${avatarBg}; font-size: 20px;">
          ${avatarHtml}
        </div>
        <div>
          <div style="font-weight: 700; font-size: 16px;">${userInfo ? userInfo.querySelector('h3').innerText : 'Kullanƒ±cƒ±'}</div>
          <div style="font-size: 12px; opacity: 0.8;">${userInfo ? userInfo.querySelector('p').innerText : ''}</div>
        </div>
      </div>
      <div style="font-size: 14px; line-height: 1.4; max-height: 60px; overflow: hidden;">${content ? content.innerText : ''}</div>
    `;
    reel.appendChild(info);
    
    // Saƒü taraf aksiyonlar (beƒüeni, yorum)
    const actions = document.createElement('div');
    actions.style.cssText = `
      position: absolute;
      right: 16px;
      bottom: 150px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      z-index: 10;
    `;
    
    const postId = post.dataset.postId || '';
    const likeBtn = post.querySelector('.like-btn');
    const isLiked = likeBtn ? likeBtn.dataset.liked === 'true' : false;
    const likeCount = likeBtn ? (likeBtn.querySelector('.like-count')?.textContent || '0') : '0';
    const commentBtn = post.querySelector('.action-btn:nth-child(2)');
    const commentCount = commentBtn ? commentBtn.textContent.trim().replace(/[^0-9]/g, '') || '0' : '0';
    
    actions.innerHTML = `
      <button onclick="toggleLikeFromReels('${postId}', this)" style="background: none; border: none; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer;">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="${isLiked ? '#ef4444' : 'none'}" stroke="${isLiked ? '#ef4444' : 'white'}" stroke-width="2">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
        </svg>
        <span style="color: white; font-size: 12px; font-weight: 600;">${likeCount}</span>
      </button>
      <button onclick="openCommentsModal('${postId}')" style="background: none; border: none; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer;">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <span style="color: white; font-size: 12px; font-weight: 600;">${commentCount}</span>
      </button>
    `;
    reel.appendChild(actions);
    
    return reel;
  }
  
  // ƒ∞lk 5 g√∂nderiyi y√ºkle
  function loadInitialPosts() {
    const end = Math.min(INITIAL_LOAD, posts.length);
    for (let i = 0; i < end; i++) {
      container.appendChild(createReelItem(posts[i], i));
      loadedCount++;
    }
  }
  
  // Daha fazla g√∂nderi y√ºkle
  function loadMorePosts() {
    const start = loadedCount;
    const end = Math.min(start + LOAD_MORE, posts.length);
    
    for (let i = start; i < end; i++) {
      container.appendChild(createReelItem(posts[i], i));
      loadedCount++;
    }
  }
  
  // Scroll event - a≈üaƒüƒ± gidince daha fazla y√ºkle
  container.addEventListener('scroll', function() {
    const scrollTop = container.scrollTop;
    const scrollHeight = container.scrollHeight;
    const clientHeight = container.clientHeight;
    
    if (scrollTop + clientHeight >= scrollHeight - 200) {
      if (loadedCount < posts.length) {
        loadMorePosts();
      }
    }
    
    // Video otomatik oynatma
    const reels = container.querySelectorAll('.reel-item');
    reels.forEach((reel, i) => {
      const video = reel.querySelector('video');
      if (video) {
        const rect = reel.getBoundingClientRect();
        const isVisible = rect.top >= 0 && rect.top < window.innerHeight * 0.5;
        if (isVisible) {
          video.play().catch(() => {});
        } else {
          video.pause();
        }
      }
    });
  });
  
  loadInitialPosts();
  modal.appendChild(container);
  document.body.appendChild(modal);
  
  // Ba≈ülangƒ±√ß indexine kaydƒ±r
  setTimeout(() => {
    const targetIndex = Math.min(startIndex, loadedCount - 1);
    const targetReel = container.children[targetIndex];
    if (targetReel) {
      targetReel.scrollIntoView({ behavior: 'auto' });
    }
  }, 100);
};

// Reels'den beƒüeni toggle
window.toggleLikeFromReels = async function(postId, btn) {
  if (!postId) return;
  
  try {
    const svg = btn.querySelector('svg');
    const span = btn.querySelector('span');
    const isLiked = svg.getAttribute('fill') === '#ef4444';
    
    const response = await apiRequest(`/api/posts/${postId}/like`, {
      method: isLiked ? 'DELETE' : 'POST'
    });
    
    if (response.ok) {
      const data = await response.json();
      if (isLiked) {
        svg.setAttribute('fill', 'none');
        svg.setAttribute('stroke', 'white');
      } else {
        svg.setAttribute('fill', '#ef4444');
        svg.setAttribute('stroke', '#ef4444');
      }
      span.textContent = data.likeCount || span.textContent;
    }
  } catch (error) {
    console.error('Beƒüeni hatasƒ±:', error);
  }
};

// Post kartƒ±na tƒ±klama - Reels a√ß
document.addEventListener('click', function(e) {
  // Butonlara tƒ±klanmadƒ±ysa
  if (e.target.closest('button') || e.target.closest('.action-btn') || e.target.closest('a')) return;
  
  const postCard = e.target.closest('.post-card');
  if (postCard && document.getElementById('homePage').classList.contains('active')) {
    const posts = Array.from(document.querySelectorAll('.post-card'));
    const index = posts.indexOf(postCard);
    if (index !== -1) {
      e.preventDefault();
      e.stopPropagation();
      window.openReelsModalV2(index);
    }
  }
});

// 4. Ke≈üfet Sayfasƒ± D√ºzeltmesi
window.loadExploreV2 = async function() {
  const explorePage = document.getElementById('explorePage') || document.querySelector('[data-page="explore"]');
  if (!explorePage) return;
  
  try {
    const response = await apiRequest('/api/posts/explore', { method: 'GET' });
    if (response.ok) {
      const data = await response.json();
      const posts = data.posts || [];
      
      // Global deƒüi≈ükene kaydet
      window.explorePosts = posts;
      
      explorePage.innerHTML = `
        <div style="padding: 16px;">
          <h2 style="font-size: 24px; font-weight: 900; margin-bottom: 16px;">üîç Ke≈üfet</h2>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px;">
            ${posts.map((post, index) => {
              const mediaUrl = post.mediaUrl ? (post.mediaUrl.startsWith('http') ? post.mediaUrl : API_BASE + post.mediaUrl) : '';
              return `
                <div style="aspect-ratio: 1; background: #f1f5f9; overflow: hidden; cursor: pointer; position: relative;" onclick="openExplorePostDetail(${index})">
                  ${post.mediaType === 'video' 
                    ? `<video src="${mediaUrl}" style="width: 100%; height: 100%; object-fit: cover;" muted></video>`
                    : `<img src="${mediaUrl}" style="width: 100%; height: 100%; object-fit: cover;" alt="Post">`
                  }
                  <div style="position: absolute; bottom: 4px; left: 4px; color: white; display: flex; align-items: center; gap: 4px; text-shadow: 0 1px 3px rgba(0,0,0,0.8); font-size: 12px;">
                    <span>‚ù§Ô∏è ${post.likeCount || 0}</span>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }
  } catch (error) {
    console.error('Ke≈üfet y√ºkleme hatasƒ±:', error);
  }
};

// Ke≈üfet sayfasƒ±ndan post detayƒ±nƒ± a√ß
window.openExplorePostDetail = function(index) {
  if (!window.explorePosts || !window.explorePosts[index]) return;
  
  const post = window.explorePosts[index];
  const modal = document.createElement('div');
  modal.className = 'explore-post-modal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  `;
  
  const mediaUrl = post.mediaUrl ? (post.mediaUrl.startsWith('http') ? post.mediaUrl : API_BASE + post.mediaUrl) : '';
  const profilePicUrl = post.userProfilePic ? (post.userProfilePic.startsWith('http') ? post.userProfilePic : API_BASE + post.userProfilePic) : '';
  
  modal.innerHTML = `
    <div style="position: absolute; top: 16px; left: 16px; right: 16px; display: flex; align-items: center; gap: 12px; z-index: 10;">
      <div style="width: 44px; height: 44px; border-radius: 50%; overflow: hidden; background: #10b981; border: 2px solid white; cursor: pointer;" onclick="event.stopPropagation(); viewUserProfile('${post.userId}'); document.querySelector('.explore-post-modal').remove();">
        ${profilePicUrl ? `<img src="${profilePicUrl}" style="width: 100%; height: 100%; object-fit: cover;">` : '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: white;">üë§</div>'}
      </div>
      <div style="flex: 1; color: white;">
        <div style="font-weight: 700; font-size: 16px;">${post.username}${post.isUserVerified ? ' ‚úì' : ''}</div>
        <div style="font-size: 12px; opacity: 0.8;">${formatTime(post.createdAt)}</div>
      </div>
      <button onclick="this.closest('.explore-post-modal').remove()" style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border: none; border-radius: 50%; color: white; font-size: 24px; cursor: pointer;">√ó</button>
    </div>
    
    <div style="flex: 1; display: flex; align-items: center; justify-content: center; max-width: 100%; max-height: 70%;">
      ${post.mediaType === 'video' 
        ? `<video src="${mediaUrl}" controls autoplay style="max-width: 100%; max-height: 100%; object-fit: contain;"></video>`
        : `<img src="${mediaUrl}" style="max-width: 100%; max-height: 100%; object-fit: contain;">`
      }
    </div>
    
    <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.8); padding: 16px; color: white;">
      <div style="display: flex; gap: 16px; margin-bottom: 12px;">
        <button class="action-btn" onclick="event.stopPropagation(); toggleLike('${post.id}', this)" style="background: none; border: none; color: white; display: flex; align-items: center; gap: 6px; cursor: pointer;">
          <span style="font-size: 24px;">${post.isLiked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
          <span>${post.likeCount || 0}</span>
        </button>
        <button class="action-btn" onclick="event.stopPropagation(); openCommentsModal('${post.id}')" style="background: none; border: none; color: white; display: flex; align-items: center; gap: 6px; cursor: pointer;">
          <span style="font-size: 24px;">üí¨</span>
          <span>${post.commentCount || 0}</span>
        </button>
      </div>
      ${post.content ? `
        <div style="margin-bottom: 8px;">
          <span style="font-weight: 700;">${post.username}</span>
          <span style="margin-left: 8px;">${post.content}</span>
        </div>
      ` : ''}
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Modalƒ± tƒ±klayƒ±nca kapat
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
};

console.log('‚úÖ T√ºm d√ºzeltmeler ba≈üarƒ±yla y√ºklendi!');
console.log('üìå D√ºzeltilen √∂zellikler:');
console.log('  - Yorumlar modalƒ±nda √ßarpƒ± i≈üareti g√∂r√ºn√ºr');
console.log('  - Post payla≈üƒ±mda dosya boyutu ve s√ºre g√∂sterimi');
console.log('  - Yumu≈üak progress bar');
console.log('  - Profil takip√ßi butonlarƒ± ta≈üma sorunu √ß√∂z√ºld√º');
console.log('  - Alt navigasyonda profil resmi sabit');
console.log('  - Reels tarzƒ± kaydƒ±rma (ilk 5 y√ºkle, a≈üaƒüƒ± gidince daha fazla)');
console.log('  - Beƒüeni ve yorum butonlarƒ± yan tarafta');
console.log('  - Tek medya se√ßimi');
console.log('  - Profil resmi kaldƒ±rma');
console.log('  - Ki≈üisel profil postlarƒ±nda silme butonu');

// Profil Resmi Kaldƒ±rma Fonksiyonu
window.removeProfilePicture = async function() {
  if (!currentUser) return;
  
  if (!confirm('Profil resminizi kaldƒ±rmak istediƒüinizden emin misiniz?')) return;
  
  try {
    const response = await apiRequest('/api/users/profile/remove-picture', {
      method: 'POST'
    });
    
    if (response.ok) {
      currentUser.profilePic = null;
      localStorage.setItem('agrolink_user', JSON.stringify(currentUser));
      
      // UI'ƒ± g√ºncelle
      const editProfilePicPreview = document.getElementById('editProfilePicPreview');
      if (editProfilePicPreview) {
        editProfilePicPreview.innerHTML = 'üë§';
      }
      
      const profileAvatar = document.getElementById('profileAvatar');
      if (profileAvatar) {
        profileAvatar.innerHTML = 'üë§';
      }
      
      updateNavProfilePic();
      showToast('Profil resmi kaldƒ±rƒ±ldƒ±', 'success');
    } else {
      // Offline mod - lokal olarak kaldƒ±r
      currentUser.profilePic = null;
      localStorage.setItem('agrolink_user', JSON.stringify(currentUser));
      
      const editProfilePicPreview = document.getElementById('editProfilePicPreview');
      if (editProfilePicPreview) {
        editProfilePicPreview.innerHTML = 'üë§';
      }
      
      const profileAvatar = document.getElementById('profileAvatar');
      if (profileAvatar) {
        profileAvatar.innerHTML = 'üë§';
      }
      
      updateNavProfilePic();
      showToast('Profil resmi kaldƒ±rƒ±ldƒ±', 'success');
    }
  } catch (error) {
    console.error('Profil resmi kaldƒ±rma hatasƒ±:', error);
    // Offline mod
    currentUser.profilePic = null;
    localStorage.setItem('agrolink_user', JSON.stringify(currentUser));
    
    const editProfilePicPreview = document.getElementById('editProfilePicPreview');
    if (editProfilePicPreview) {
      editProfilePicPreview.innerHTML = 'üë§';
    }
    
    showToast('Profil resmi kaldƒ±rƒ±ldƒ±', 'success');
  }
};

// Profil Postunu Silme Fonksiyonu
window.deleteProfilePost = async function(postId) {
  if (!confirm('Bu g√∂nderiyi silmek istediƒüinizden emin misiniz?')) return;
  
  try {
    const response = await apiRequest(`/api/posts/${postId}`, {
      method: 'DELETE'
    });
    
    if (response.ok) {
      // Post'u UI'dan kaldƒ±r
      const postElement = document.querySelector(`.profile-post[onclick*="${postId}"]`);
      if (postElement) {
        postElement.style.animation = 'fadeOut 0.3s ease forwards';
        setTimeout(() => postElement.remove(), 300);
      }
      
      // Cache'i temizle
      profilePostsCache = null;
      profilePostsCacheData = [];
      
      showToast('G√∂nderi silindi', 'success');
    } else {
      showToast('G√∂nderi silinemedi', 'error');
    }
  } catch (error) {
    console.error('Post silme hatasƒ±:', error);
    showToast('G√∂nderi silinemedi', 'error');
  }
};

// Profil Postlarƒ± i√ßin Reels Modal
window.openProfileReelsModal = function(startIndex) {
  const existing = document.querySelector('.profile-reels-modal');
  if (existing) existing.remove();
  
  if (!profilePosts || profilePosts.length === 0) return;
  
  const modal = document.createElement('div');
  modal.className = 'profile-reels-modal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    z-index: 9999;
    display: flex;
    flex-direction: column;
  `;
  
  // Kapatma butonu
  const closeBtn = document.createElement('button');
  closeBtn.innerHTML = '√ó';
  closeBtn.style.cssText = `
    position: absolute;
    top: 20px;
    left: 20px;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    font-size: 28px;
    cursor: pointer;
    z-index: 100;
  `;
  closeBtn.onclick = () => modal.remove();
  modal.appendChild(closeBtn);
  
  // Container
  const container = document.createElement('div');
  container.style.cssText = `
    scroll-snap-type: y mandatory;
    overflow-y: scroll;
    height: 100%;
    width: 100%;
    scroll-behavior: smooth;
  `;
  
  // ƒ∞lk 5 post y√ºkle
  let loadedCount = Math.min(5, profilePosts.length);
  
  function renderPost(post, index) {
    const reel = document.createElement('div');
    reel.className = 'profile-reel-item';
    reel.dataset.index = index;
    reel.style.cssText = `
      scroll-snap-align: start;
      height: 100vh;
      width: 100%;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
    `;
    
    const mediaUrl = post.mediaUrl ? (post.mediaUrl.startsWith('http') ? post.mediaUrl : API_BASE + post.mediaUrl) : '';
    
    if (post.mediaType === 'video') {
      const video = document.createElement('video');
      video.src = mediaUrl;
      video.style.cssText = 'max-height: 100%; max-width: 100%; object-fit: contain;';
      video.loop = true;
      video.playsInline = true;
      video.muted = false;
      reel.appendChild(video);
    } else if (mediaUrl) {
      const img = document.createElement('img');
      img.src = mediaUrl;
      img.style.cssText = 'max-height: 100%; max-width: 100%; object-fit: contain;';
      reel.appendChild(img);
    } else {
      const textDiv = document.createElement('div');
      textDiv.style.cssText = 'color: white; font-size: 24px; padding: 40px; text-align: center;';
      textDiv.textContent = post.content || 'ƒ∞√ßerik yok';
      reel.appendChild(textDiv);
    }
    
    // Kullanƒ±cƒ± bilgisi
    const userInfo = document.createElement('div');
    userInfo.style.cssText = `
      position: absolute;
      bottom: 100px;
      left: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    `;
    
    const userPic = currentUser?.profilePic ? 
      `<img src="${currentUser.profilePic.startsWith('http') ? currentUser.profilePic : API_BASE + currentUser.profilePic}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid white;">` :
      `<div style="width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; color: white; border: 2px solid white;">üë§</div>`;
    
    userInfo.innerHTML = `
      ${userPic}
      <div>
        <div style="color: white; font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,0.8);">@${currentUser?.username || 'kullanici'}</div>
        <div style="color: rgba(255,255,255,0.7); font-size: 12px;">${formatTime(post.createdAt)}</div>
      </div>
    `;
    reel.appendChild(userInfo);
    
    // ƒ∞√ßerik
    if (post.content) {
      const contentDiv = document.createElement('div');
      contentDiv.style.cssText = `
        position: absolute;
        bottom: 60px;
        left: 20px;
        right: 80px;
        color: white;
        font-size: 14px;
        text-shadow: 0 1px 2px rgba(0,0,0,0.8);
      `;
      contentDiv.textContent = post.content;
      reel.appendChild(contentDiv);
    }
    
    // Saƒü taraf butonlarƒ± (beƒüeni, yorum, silme)
    const actions = document.createElement('div');
    actions.style.cssText = `
      position: absolute;
      right: 16px;
      bottom: 120px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
    `;
    
    actions.innerHTML = `
      <div style="text-align: center;">
        <button onclick="event.stopPropagation(); toggleLike('${post.id}', this)" style="width: 48px; height: 48px; border-radius: 50%; background: rgba(255,255,255,0.2); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="${post.isLiked ? '#ef4444' : 'none'}" stroke="white" stroke-width="2">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
          </svg>
        </button>
        <span style="color: white; font-size: 12px; margin-top: 4px; display: block;">${post.likeCount || 0}</span>
      </div>
      <div style="text-align: center;">
        <button onclick="event.stopPropagation(); openCommentsModal('${post.id}')" style="width: 48px; height: 48px; border-radius: 50%; background: rgba(255,255,255,0.2); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
        </button>
        <span style="color: white; font-size: 12px; margin-top: 4px; display: block;">${post.commentCount || 0}</span>
      </div>
      <div style="text-align: center;">
        <button onclick="event.stopPropagation(); deleteProfilePost('${post.id}'); this.closest('.profile-reels-modal').remove();" style="width: 48px; height: 48px; border-radius: 50%; background: rgba(239, 68, 68, 0.8); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;">
          <span style="font-size: 20px;">üóëÔ∏è</span>
        </button>
        <span style="color: white; font-size: 12px; margin-top: 4px; display: block;">Sil</span>
      </div>
    `;
    reel.appendChild(actions);
    
    return reel;
  }
  
  // ƒ∞lk postlarƒ± y√ºkle
  for (let i = 0; i < loadedCount; i++) {
    container.appendChild(renderPost(profilePosts[i], i));
  }
  
  // Scroll ile daha fazla y√ºkle
  container.addEventListener('scroll', function() {
    const scrollTop = container.scrollTop;
    const scrollHeight = container.scrollHeight;
    const clientHeight = container.clientHeight;
    
    // Alt kƒ±sma yakla≈ütƒ±ysa daha fazla y√ºkle
    if (scrollTop + clientHeight >= scrollHeight - 200) {
      const currentLoaded = container.children.length;
      if (currentLoaded < profilePosts.length) {
        const nextBatch = Math.min(5, profilePosts.length - currentLoaded);
        for (let i = 0; i < nextBatch; i++) {
          container.appendChild(renderPost(profilePosts[currentLoaded + i], currentLoaded + i));
        }
      }
    }
  });
  
  // Video autoplay observer
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      const video = entry.target.querySelector('video');
      if (video) {
        if (entry.isIntersecting) {
          video.play().catch(e => console.log('Video play error:', e));
        } else {
          video.pause();
        }
      }
    });
  }, { threshold: 0.6 });
  
  container.querySelectorAll('.profile-reel-item').forEach(el => observer.observe(el));
  
  modal.appendChild(container);
  document.body.appendChild(modal);
  
  // Ba≈ülangƒ±√ß indexine git
  setTimeout(() => {
    const targetReel = container.children[startIndex];
    if (targetReel) {
      targetReel.scrollIntoView();
    }
  }, 100);
};

// ========================================
// YENƒ∞ √ñZELLƒ∞KLER - V3 G√úNCELLEME
// ========================================

// 1. ANA SAYFA POST TIKLAMA - TEK SAYFA REELS G√ñR√úN√úM√ú
window.openSinglePostReels = function(postIndex) {
  const existing = document.querySelector('.single-post-reels-modal');
  if (existing) existing.remove();
  
  const modal = document.createElement('div');
  modal.className = 'single-post-reels-modal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    z-index: 10000;
    display: flex;
    flex-direction: column;
  `;
  
  // Kapatma butonu
  const closeBtn = document.createElement('button');
  closeBtn.innerHTML = '√ó';
  closeBtn.style.cssText = `
    position: absolute;
    top: 20px;
    left: 20px;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    font-size: 28px;
    cursor: pointer;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
  `;
  closeBtn.onclick = () => modal.remove();
  modal.appendChild(closeBtn);
  
  // Kaydƒ±rma container
  const container = document.createElement('div');
  container.style.cssText = `
    width: 100%;
    height: 100%;
    overflow-y: scroll;
    scroll-snap-type: y mandatory;
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
  `;
  
  // feedPosts'tan postlarƒ± al
  let currentPosts = [...feedPosts];
  let loadedCount = Math.min(5, currentPosts.length);
  
  function renderReelPost(post, index) {
    const reel = document.createElement('div');
    reel.className = 'feed-reel-item';
    reel.dataset.postId = post.id;
    reel.dataset.index = index;
    reel.style.cssText = `
      width: 100%;
      height: 100vh;
      scroll-snap-align: start;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      flex-shrink: 0;
    `;
    
    // Medya (video veya resim)
    if (post.mediaUrl) {
      const mediaUrl = post.mediaUrl.startsWith('http') ? post.mediaUrl : API_BASE + post.mediaUrl;
      
      if (post.mediaType === 'video') {
        const video = document.createElement('video');
        video.src = mediaUrl;
        video.style.cssText = 'max-width: 100%; max-height: 100%; object-fit: contain;';
        video.loop = true;
        video.playsInline = true;
        video.muted = false;
        video.setAttribute('playsinline', '');
        reel.appendChild(video);
      } else {
        const img = document.createElement('img');
        img.src = mediaUrl;
        img.style.cssText = 'max-width: 100%; max-height: 100%; object-fit: contain;';
        reel.appendChild(img);
      }
    }
    
    // Kullanƒ±cƒ± bilgisi (sol alt)
    const userInfo = document.createElement('div');
    userInfo.style.cssText = `
      position: absolute;
      bottom: 100px;
      left: 20px;
      right: 80px;
      color: white;
      text-shadow: 0 1px 3px rgba(0,0,0,0.8);
    `;
    
    const profilePicUrl = post.userProfilePic ? 
      (post.userProfilePic.startsWith('http') ? post.userProfilePic : API_BASE + post.userProfilePic) : '';
    
    userInfo.innerHTML = `
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
        <div class="reels-profile-pic" style="width: 44px; height: 44px; border-radius: 50%; border: 2px solid white; overflow: hidden; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #10b981, #059669); font-size: 18px;" onclick="event.stopPropagation(); viewUserProfile('${post.userId}'); document.querySelector('.single-post-reels-modal').remove();">
          ${profilePicUrl ? `<img src="${profilePicUrl}" style="width: 100%; height: 100%; object-fit: cover;">` : 'üë§'}
        </div>
        <div>
          <div style="font-weight: 700; font-size: 16px; display: flex; align-items: center; gap: 6px;">
            ${post.username}
            ${post.isUserVerified ? '<span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 50%; font-size: 10px; color: white;">‚úì</span>' : ''}
          </div>
          <div style="font-size: 12px; opacity: 0.8;">${formatTime(post.createdAt)}</div>
        </div>
        ${post.userId !== currentUser.id ? `
          <button onclick="event.stopPropagation(); toggleFollowInReels('${post.userId}', this)" style="padding: 8px 16px; background: ${post.isFollowing ? 'rgba(255,255,255,0.2)' : 'linear-gradient(135deg, #10b981, #059669)'}; border: none; border-radius: 20px; color: white; font-weight: 700; font-size: 12px; cursor: pointer;">
            ${post.isFollowing ? 'Takip Ediliyor' : 'Takip Et'}
          </button>
        ` : ''}
      </div>
      <div style="font-size: 14px; line-height: 1.4; max-height: 60px; overflow: hidden;">
        ${formatPostContent(post.content)}
      </div>
    `;
    reel.appendChild(userInfo);
    
    // Saƒü taraf aksiyonlar
    const actions = document.createElement('div');
    actions.style.cssText = `
      position: absolute;
      right: 16px;
      bottom: 150px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
    `;
    
    actions.innerHTML = `
      <div style="text-align: center;">
        <button class="reel-like-btn" data-post-id="${post.id}" data-liked="${post.isLiked || false}" onclick="event.stopPropagation(); toggleReelLike('${post.id}', this)" style="width: 48px; height: 48px; border-radius: 50%; background: rgba(255,255,255,0.2); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="${post.isLiked ? '#ef4444' : 'none'}" stroke="${post.isLiked ? '#ef4444' : 'white'}" stroke-width="2">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
          </svg>
        </button>
        <span class="reel-like-count" style="color: white; font-size: 12px; margin-top: 4px; display: block;">${post.likeCount || 0}</span>
      </div>
      <div style="text-align: center;">
        <button onclick="event.stopPropagation(); openCommentsModal('${post.id}')" style="width: 48px; height: 48px; border-radius: 50%; background: rgba(255,255,255,0.2); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
        </button>
        <span style="color: white; font-size: 12px; margin-top: 4px; display: block;">${post.commentCount || 0}</span>
      </div>
      <div style="text-align: center;">
        <button onclick="event.stopPropagation(); openShareModal('${post.id}')" style="width: 48px; height: 48px; border-radius: 50%; background: rgba(255,255,255,0.2); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
        <span style="color: white; font-size: 12px; margin-top: 4px; display: block;">Payla≈ü</span>
      </div>
      <div style="text-align: center;">
        <button class="reel-save-btn" data-saved="${post.isSaved || false}" onclick="event.stopPropagation(); toggleReelSave('${post.id}', this)" style="width: 48px; height: 48px; border-radius: 50%; background: rgba(255,255,255,0.2); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="${post.isSaved ? 'white' : 'none'}" stroke="white" stroke-width="2">
            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
          </svg>
        </button>
        <span style="color: white; font-size: 12px; margin-top: 4px; display: block;">Kaydet</span>
      </div>
    `;
    reel.appendChild(actions);
    
    // √áift tƒ±klama ile beƒüenme
    let lastTapTime = 0;
    reel.addEventListener('click', function(e) {
      if (e.target.closest('button')) return;
      
      const now = Date.now();
      if (now - lastTapTime < 300) {
        // √áift tƒ±klama - beƒüen
        const likeBtn = reel.querySelector('.reel-like-btn');
        if (likeBtn && likeBtn.dataset.liked !== 'true') {
          toggleReelLike(post.id, likeBtn);
          
          // Kalp animasyonu
          const heart = document.createElement('div');
          heart.innerHTML = '‚ù§Ô∏è';
          heart.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 100px;
            pointer-events: none;
            animation: heartPop 0.8s ease-out forwards;
            z-index: 200;
          `;
          reel.appendChild(heart);
          setTimeout(() => heart.remove(), 1000);
        }
      }
      lastTapTime = now;
    });
    
    return reel;
  }
  
  // ƒ∞lk postlarƒ± y√ºkle
  for (let i = 0; i < loadedCount; i++) {
    container.appendChild(renderReelPost(currentPosts[i], i));
  }
  
  // Scroll ile daha fazla y√ºkle (infinite scroll)
  container.addEventListener('scroll', async function() {
    const scrollTop = container.scrollTop;
    const scrollHeight = container.scrollHeight;
    const clientHeight = container.clientHeight;
    
    // Alt kƒ±sma yakla≈ütƒ±ysa daha fazla y√ºkle
    if (scrollTop + clientHeight >= scrollHeight - 500) {
      const currentLoaded = container.children.length;
      
      // Eƒüer t√ºm mevcut postlar y√ºklendiyse API'den daha fazla √ßek
      if (currentLoaded >= currentPosts.length && hasMorePosts) {
        try {
          const response = await apiRequest(`/api/posts?page=${feedPage}&limit=5`, { method: 'GET' });
          if (response.ok) {
            const data = await response.json();
            const newPosts = data.posts || [];
            
            if (newPosts.length > 0) {
              currentPosts = [...currentPosts, ...newPosts];
              feedPosts = [...feedPosts, ...newPosts];
              feedPage++;
              
              newPosts.forEach((post, i) => {
                container.appendChild(renderReelPost(post, currentLoaded + i));
              });
              
              hasMorePosts = newPosts.length === 5;
            } else {
              hasMorePosts = false;
            }
          }
        } catch (e) {
          console.error('Daha fazla post y√ºklenemedi:', e);
        }
      } else if (currentLoaded < currentPosts.length) {
        // Mevcut postlardan daha fazla ekle
        const nextBatch = Math.min(5, currentPosts.length - currentLoaded);
        for (let i = 0; i < nextBatch; i++) {
          container.appendChild(renderReelPost(currentPosts[currentLoaded + i], currentLoaded + i));
        }
      }
    }
  });
  
  // Video autoplay observer
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      const video = entry.target.querySelector('video');
      if (video) {
        if (entry.isIntersecting) {
          video.muted = false;
          video.play().catch(e => console.log('Video play error:', e));
        } else {
          video.pause();
        }
      }
    });
  }, { threshold: 0.6 });
  
  container.querySelectorAll('.feed-reel-item').forEach(el => observer.observe(el));
  
  // Yeni eklenen reelleri de observe et
  const mutationObserver = new MutationObserver((mutations) => {
    mutations.forEach(mutation => {
      mutation.addedNodes.forEach(node => {
        if (node.classList && node.classList.contains('feed-reel-item')) {
          observer.observe(node);
        }
      });
    });
  });
  mutationObserver.observe(container, { childList: true });
  
  modal.appendChild(container);
  document.body.appendChild(modal);
  
  // Ba≈ülangƒ±√ß indexine git
  setTimeout(() => {
    const targetReel = container.children[postIndex];
    if (targetReel) {
      targetReel.scrollIntoView();
    }
  }, 100);
};

// 2. REELS'TE BEƒûENƒ∞ ƒ∞≈ûLEMƒ∞ - KALP DOLU G√ñSTERƒ∞LSƒ∞N
window.toggleReelLike = async function(postId, btn) {
  const isLiked = btn.dataset.liked === 'true';
  const svg = btn.querySelector('svg');
  const countSpan = btn.parentElement.querySelector('.reel-like-count');
  
  try {
    const response = await apiRequest(`/api/posts/${postId}/like`, { method: 'POST' });
    
    if (response.ok) {
      const newLikedState = !isLiked;
      btn.dataset.liked = newLikedState.toString();
      
      // SVG g√ºncelle
      if (svg) {
        svg.setAttribute('fill', newLikedState ? '#ef4444' : 'none');
        svg.setAttribute('stroke', newLikedState ? '#ef4444' : 'white');
      }
      
      // Sayƒ±yƒ± g√ºncelle
      if (countSpan) {
        const currentCount = parseInt(countSpan.textContent) || 0;
        countSpan.textContent = newLikedState ? currentCount + 1 : Math.max(0, currentCount - 1);
      }
      
      // Animasyon
      btn.style.transform = 'scale(1.3)';
      setTimeout(() => btn.style.transform = 'scale(1)', 200);
      
      // Ana sayfadaki postu da g√ºncelle
      const mainPostCard = document.querySelector(`.post-card[data-post-id="${postId}"]`);
      if (mainPostCard) {
        const mainLikeBtn = mainPostCard.querySelector('.like-btn');
        if (mainLikeBtn) {
          mainLikeBtn.dataset.liked = newLikedState.toString();
          const mainSvg = mainLikeBtn.querySelector('svg');
          if (mainSvg) {
            mainSvg.setAttribute('fill', newLikedState ? '#ef4444' : 'none');
          }
          const mainCount = mainLikeBtn.querySelector('.like-count');
          if (mainCount && countSpan) {
            mainCount.textContent = countSpan.textContent;
          }
        }
      }
      
      // feedPosts'u g√ºncelle
      const postIndex = feedPosts.findIndex(p => p.id === postId);
      if (postIndex !== -1) {
        feedPosts[postIndex].isLiked = newLikedState;
        feedPosts[postIndex].likeCount = parseInt(countSpan?.textContent) || 0;
      }
    }
  } catch (error) {
    console.error('Beƒüeni hatasƒ±:', error);
  }
};

// 3. REELS'TE KAYDETME
window.toggleReelSave = async function(postId, btn) {
  const isSaved = btn.dataset.saved === 'true';
  const svg = btn.querySelector('svg');
  
  try {
    const response = await apiRequest(`/api/posts/${postId}/save`, { method: 'POST' });
    
    if (response.ok) {
      const newSavedState = !isSaved;
      btn.dataset.saved = newSavedState.toString();
      
      if (svg) {
        svg.setAttribute('fill', newSavedState ? 'white' : 'none');
      }
      
      showToast(newSavedState ? 'G√∂nderi kaydedildi' : 'Kayƒ±t kaldƒ±rƒ±ldƒ±', 'success');
    }
  } catch (error) {
    console.error('Kaydetme hatasƒ±:', error);
  }
};

// 4. REELS'TE TAKƒ∞P ETME
window.toggleFollowInReels = async function(userId, btn) {
  try {
    const response = await apiRequest(`/api/users/${userId}/follow`, { method: 'POST' });
    
    if (response.ok) {
      const isFollowing = btn.textContent.includes('Ediliyor');
      btn.textContent = isFollowing ? 'Takip Et' : 'Takip Ediliyor';
      btn.style.background = isFollowing ? 'linear-gradient(135deg, #10b981, #059669)' : 'rgba(255,255,255,0.2)';
      
      showToast(isFollowing ? 'Takip bƒ±rakƒ±ldƒ±' : 'Takip ediliyor! üéâ', 'success');
    }
  } catch (error) {
    console.error('Takip hatasƒ±:', error);
  }
};

// 5. ANA SAYFA POST TIKLAMA OVERRIDE
document.addEventListener('click', function(e) {
  // Butonlara veya link'lere tƒ±klamayƒ± engelleme
  if (e.target.closest('button') || e.target.closest('.action-btn') || e.target.closest('a')) return;
  
  const postCard = e.target.closest('.post-card');
  if (postCard && !e.target.closest('.follow-btn')) {
    const postId = postCard.dataset.postId;
    const postIndex = feedPosts.findIndex(p => p.id === postId);
    
    if (postIndex !== -1) {
      e.preventDefault();
      e.stopPropagation();
      openSinglePostReels(postIndex);
    }
  }
});

// 6. Kƒ∞≈ûƒ∞SEL PROFƒ∞L POST TIKLAMA - ZATEN VAR, openProfileReelsModal KULLANILIYOR

// 7. NAVƒ∞GASYON BUTONLARINDA ANLIK UI G√úNCELLEMESƒ∞
(function() {
  const navItems = document.querySelectorAll('.nav-item:not(.add-post)');
  
  navItems.forEach(btn => {
    btn.addEventListener('click', function() {
      const page = this.dataset.page;
      if (!page) return;
      
      // Hemen aktif sƒ±nƒ±fƒ±nƒ± g√ºncelle
      requestAnimationFrame(() => {
        navItems.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // Sayfalarƒ± g√ºncelle
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        const pageElement = document.getElementById(page + 'Page');
        if (pageElement) {
          pageElement.classList.add('active');
          pageElement.style.opacity = '0';
          pageElement.style.transform = 'translateY(10px)';
          
          requestAnimationFrame(() => {
            pageElement.style.transition = 'all 0.2s ease';
            pageElement.style.opacity = '1';
            pageElement.style.transform = 'translateY(0)';
          });
        }
        
        // Sayfa √∂zel y√ºklemeleri
        if (page === 'home') loadFeed();
        else if (page === 'store') loadStore();
        else if (page === 'messages') loadMessages();
        else if (page === 'profile') {
          loadProfilePostsWithCache();
          loadUserStats();
        }
      });
    });
  });
})();

// 8. ANA SAYFA POSTLARI TAM BOYUT VE D√úZELTMELER
const styleFixV3 = document.createElement('style');
styleFixV3.textContent = `
  /* Ana sayfa post kartlarƒ± - TAM BOYUT */
  .post-card {
    margin-bottom: 16px !important;
    min-height: auto !important;
    max-height: none !important;
    border-radius: 0 !important;
    overflow: visible !important;
    width: 100% !important;
  }
  
  /* Post aksiyonlarƒ± her zaman g√∂r√ºns√ºn */
  .post-actions {
    display: flex !important;
    gap: 8px !important;
    padding: 12px 16px !important;
    background: var(--card-light);
    position: relative;
    z-index: 10;
  }
  
  body.dark-theme .post-actions {
    background: rgba(255, 255, 255, 0.05);
  }
  
  /* Aksiyon butonlarƒ± d√ºzeltmesi */
  .action-btn {
    flex: 0 0 auto !important;
    padding: 10px 16px !important;
    min-width: 70px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 6px !important;
    font-size: 14px !important;
  }
  
  /* Post medyasƒ± TAM BOYUT - geni≈ülik %100, y√ºkseklik sƒ±nƒ±rsƒ±z */
  .post-media {
    max-height: none !important;
    height: auto !important;
    width: 100% !important;
    object-fit: contain !important;
    border-radius: 0 !important;
    display: block !important;
  }
  
  /* Video ve resimler tam boyutta */
  .post-card video.post-media,
  .post-card img.post-media {
    max-height: none !important;
    width: 100% !important;
    height: auto !important;
    object-fit: contain !important;
  }
  
  /* Feed container padding */
  #feedContainer {
    padding: 0 !important;
  }
  
  /* Main content scroll d√ºzeltmesi */
  .main-content {
    scroll-snap-type: none !important;
    padding-bottom: 120px !important;
  }
  
  /* Kalp animasyonu */
  @keyframes heartPop {
    0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
    50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
    100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
  }
  
  /* Beƒüeni butonu aktif durumu */
  .like-btn.liked svg,
  .like-btn[data-liked="true"] svg {
    fill: #ef4444 !important;
    stroke: #ef4444 !important;
  }
  
  /* Navigasyon butonu ge√ßi≈üi */
  .nav-item {
    transition: all 0.15s ease !important;
  }
  
  .nav-item.active {
    transform: scale(1.1);
  }
  
  /* Sayfa ge√ßi≈ü animasyonu */
  .page {
    transition: opacity 0.2s ease, transform 0.2s ease;
  }
  
  /* Spinner animasyonu */
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* ========================================
     MODERN STORIES SYSTEM - Premium Design
     ======================================== */
  
  /* Stories Container */
  #storiesSection {
    display: flex !important;
    gap: 14px !important;
    padding: 18px 16px !important;
    overflow-x: auto !important;
    -webkit-overflow-scrolling: touch !important;
    border-bottom: 1px solid var(--border-light) !important;
    background: linear-gradient(180deg, var(--card-light) 0%, rgba(255,255,255,0.95) 100%) !important;
    scrollbar-width: none !important;
    -ms-overflow-style: none !important;
  }
  
  #storiesSection::-webkit-scrollbar {
    display: none;
  }
  
  body.dark-theme #storiesSection {
    background: linear-gradient(180deg, rgba(15, 23, 42, 0.9) 0%, rgba(30, 41, 59, 0.8) 100%) !important;
    border-bottom: 1px solid var(--border-dark) !important;
  }
  
  /* Hikaye elemanlarƒ± tƒ±klanabilir */
  .story-item-element {
    cursor: pointer !important;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
    flex-shrink: 0 !important;
  }
  
  .story-item-element:hover {
    transform: translateY(-4px) scale(1.02) !important;
  }
  
  .story-item-element:active {
    transform: scale(0.95) !important;
  }
  
  /* Modern Story Ring Animation */
  @keyframes storyRingRotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  @keyframes storyPulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
    50% { box-shadow: 0 0 0 8px rgba(245, 158, 11, 0); }
  }
  
  /* Story Ring - Gradient Border */
  .story-ring-gradient {
    background: conic-gradient(from 0deg, #f59e0b, #ef4444, #ec4899, #8b5cf6, #3b82f6, #10b981, #f59e0b) !important;
    padding: 3px !important;
    border-radius: 50% !important;
    animation: storyRingRotate 3s linear infinite !important;
  }
  
  .story-ring-watched {
    background: linear-gradient(135deg, #94a3b8, #64748b) !important;
    animation: none !important;
  }
  
  /* Story Avatar Inner */
  .story-avatar-inner {
    width: 100% !important;
    height: 100% !important;
    border-radius: 50% !important;
    background: var(--card-light) !important;
    padding: 2px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  
  body.dark-theme .story-avatar-inner {
    background: var(--bg-dark) !important;
  }
  
  /* Story Label */
  .story-label {
    font-size: 11px !important;
    font-weight: 600 !important;
    color: var(--text-light) !important;
    text-align: center !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    max-width: 74px !important;
    margin-top: 6px !important;
  }
  
  body.dark-theme .story-label {
    color: var(--text-dark) !important;
  }
  
  /* Add Story Button */
  #myStoryButton {
    position: relative !important;
  }
  
  #myStoryButton .plus-icon {
    position: absolute !important;
    bottom: 0 !important;
    right: 0 !important;
    width: 24px !important;
    height: 24px !important;
    background: linear-gradient(135deg, #10b981, #059669) !important;
    border-radius: 50% !important;
    border: 3px solid white !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    color: white !important;
    font-size: 16px !important;
    font-weight: bold !important;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4) !important;
    transition: all 0.3s ease !important;
  }
  
  #myStoryButton:hover .plus-icon {
    transform: scale(1.15) rotate(90deg) !important;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.6) !important;
  }
  
  body.dark-theme #myStoryButton .plus-icon {
    border: 3px solid var(--bg-dark) !important;
  }
  
  /* Story Viewer Modal - Premium Design */
  .story-viewer-modal {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background: #000 !important;
    z-index: 10002 !important;
    display: flex !important;
    flex-direction: column !important;
  }
  
  /* Story Progress Bar Container */
  .story-progress-container {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    padding: 12px 12px 8px !important;
    display: flex !important;
    gap: 4px !important;
    z-index: 20 !important;
    background: linear-gradient(to bottom, rgba(0,0,0,0.6) 0%, transparent 100%) !important;
  }
  
  .story-progress-bar-wrapper {
    flex: 1 !important;
    height: 3px !important;
    background: rgba(255,255,255,0.3) !important;
    border-radius: 3px !important;
    overflow: hidden !important;
  }
  
  .story-progress-bar {
    height: 100% !important;
    background: linear-gradient(90deg, #fff, rgba(255,255,255,0.9)) !important;
    border-radius: 3px !important;
    transition: width 0.1s linear !important;
  }
  
  /* Story Header */
  .story-header {
    position: absolute !important;
    top: 36px !important;
    left: 0 !important;
    right: 0 !important;
    padding: 12px 16px !important;
    display: flex !important;
    align-items: center !important;
    gap: 12px !important;
    z-index: 15 !important;
  }
  
  .story-user-avatar {
    width: 44px !important;
    height: 44px !important;
    border-radius: 50% !important;
    overflow: hidden !important;
    border: 2px solid white !important;
    cursor: pointer !important;
    transition: transform 0.3s ease !important;
  }
  
  .story-user-avatar:hover {
    transform: scale(1.1) !important;
  }
  
  .story-user-info {
    flex: 1 !important;
  }
  
  .story-username {
    color: white !important;
    font-weight: 700 !important;
    font-size: 15px !important;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5) !important;
  }
  
  .story-time {
    color: rgba(255,255,255,0.7) !important;
    font-size: 12px !important;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5) !important;
  }
  
  /* Story Navigation Buttons */
  .story-nav-btn {
    position: absolute !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    width: 44px !important;
    height: 80px !important;
    background: transparent !important;
    border: none !important;
    color: white !important;
    font-size: 28px !important;
    cursor: pointer !important;
    z-index: 10 !important;
    opacity: 0.6 !important;
    transition: all 0.3s ease !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  
  .story-nav-btn:hover {
    opacity: 1 !important;
    background: rgba(255,255,255,0.1) !important;
    border-radius: 12px !important;
  }
  
  .story-nav-prev {
    left: 8px !important;
  }
  
  .story-nav-next {
    right: 8px !important;
  }
  
  /* Story Reply Input */
  .story-reply-container {
    position: absolute !important;
    bottom: 0 !important;
    left: 0 !important;
    right: 0 !important;
    padding: 16px !important;
    background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 100%) !important;
    display: flex !important;
    gap: 12px !important;
    align-items: center !important;
  }
  
  .story-reply-input {
    flex: 1 !important;
    padding: 14px 20px !important;
    border-radius: 28px !important;
    border: none !important;
    background: rgba(255,255,255,0.15) !important;
    backdrop-filter: blur(10px) !important;
    color: white !important;
    font-size: 15px !important;
    outline: none !important;
    transition: all 0.3s ease !important;
  }
  
  .story-reply-input::placeholder {
    color: rgba(255,255,255,0.6) !important;
  }
  
  .story-reply-input:focus {
    background: rgba(255,255,255,0.25) !important;
    box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.5) !important;
  }
  
  .story-reply-btn {
    width: 48px !important;
    height: 48px !important;
    background: linear-gradient(135deg, #10b981, #059669) !important;
    border: none !important;
    border-radius: 50% !important;
    color: white !important;
    font-size: 20px !important;
    cursor: pointer !important;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
    box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4) !important;
  }
  
  .story-reply-btn:hover {
    transform: scale(1.1) !important;
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6) !important;
  }
  
  /* Story Viewers Panel */
  .story-viewers-panel {
    position: absolute !important;
    bottom: 20px !important;
    left: 16px !important;
    right: 16px !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    color: white !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
  }
  
  .story-viewers-panel:hover {
    transform: translateY(-4px) !important;
  }
  
  .story-viewers-icon {
    font-size: 28px !important;
    animation: bounce 1.5s infinite !important;
  }
  
  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-6px); }
  }
  
  /* Story Close Button */
  .story-close-btn {
    width: 40px !important;
    height: 40px !important;
    background: rgba(255,255,255,0.15) !important;
    backdrop-filter: blur(10px) !important;
    border: none !important;
    border-radius: 50% !important;
    color: white !important;
    font-size: 24px !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  
  .story-close-btn:hover {
    background: rgba(239, 68, 68, 0.5) !important;
    transform: rotate(90deg) !important;
  }
  
  /* Story Delete Button */
  .story-delete-btn {
    width: 40px !important;
    height: 40px !important;
    background: rgba(239, 68, 68, 0.8) !important;
    border: none !important;
    border-radius: 50% !important;
    color: white !important;
    font-size: 18px !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    margin-right: 8px !important;
  }
  
  .story-delete-btn:hover {
    background: #ef4444 !important;
    transform: scale(1.1) !important;
  }
  
  /* Story Content */
  .story-content {
    flex: 1 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    overflow: hidden !important;
  }
  
  .story-media {
    max-width: 100% !important;
    max-height: 100% !important;
    object-fit: contain !important;
    user-select: none !important;
  }
  
  /* Story Text Overlay */
  .story-text-overlay {
    position: absolute !important;
    bottom: 100px !important;
    left: 20px !important;
    right: 20px !important;
    color: white !important;
    text-align: center !important;
    font-size: 18px !important;
    font-weight: 500 !important;
    text-shadow: 0 2px 8px rgba(0,0,0,0.8) !important;
    line-height: 1.4 !important;
  }
  
  /* Story Count Badge */
  .story-count-badge {
    position: absolute !important;
    bottom: -2px !important;
    right: -2px !important;
    min-width: 18px !important;
    height: 18px !important;
    background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important;
    border-radius: 50% !important;
    border: 2px solid white !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    color: white !important;
    font-size: 10px !important;
    font-weight: 700 !important;
    box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4) !important;
  }
  
  body.dark-theme .story-count-badge {
    border: 2px solid var(--bg-dark) !important;
  }
`;
document.head.appendChild(styleFixV3);

// 9. PROFƒ∞LDE 5 POST VE KAYDIRMADA DAHA FAZLA - ZATEN loadProfilePostsWithCache'de VAR

// 10. MESAJLA≈ûMA G√úNCELLEMELERƒ∞
// Mesajlar her 3 saniyede yenilensin
let messageRefreshInterval = null;

function startMessageRefresh() {
  if (messageRefreshInterval) clearInterval(messageRefreshInterval);
  
  messageRefreshInterval = setInterval(() => {
    const messagesPage = document.getElementById('messagesPage');
    if (messagesPage && messagesPage.classList.contains('active')) {
      // Aktif sohbet yoksa listeyi yenile
      const chatScreen = document.getElementById('chatScreen');
      if (!chatScreen || chatScreen.style.display === 'none') {
        loadMessages();
      }
    }
  }, 3000);
}

// Sayfa y√ºklendiƒüinde mesaj yenilemeyi ba≈ülat
window.addEventListener('load', startMessageRefresh);

// 11. HESAP DOƒûRULAMA (MAVƒ∞ Tƒ∞K) DURUMU
async function checkVerificationStatus() {
  if (!currentUser) return;
  
  try {
    const response = await apiRequest('/api/users/verification/status', { method: 'GET' });
    if (response.ok) {
      const data = await response.json();
      if (data.isVerified) {
        currentUser.isVerified = true;
        updateVerifiedBadges();
      }
    }
  } catch (e) {
    console.log('Doƒürulama durumu kontrol edilemedi');
  }
}

function updateVerifiedBadges() {
  // Profil adƒ±nƒ±n yanƒ±na mavi tik ekle
  const profileName = document.getElementById('profileName');
  if (profileName && currentUser.isVerified && !profileName.querySelector('.verified-badge')) {
    profileName.innerHTML += '<span class="verified-badge"></span>';
  }
}

// 12. AGROLINK SOSYAL BANNER - Hikaye sistemi kaldƒ±rƒ±ldƒ±
// Neon efektli banner

function createStoriesSection() {
  const homePage = document.getElementById('homePage');
  const feedContainer = document.getElementById('feedContainer');
  
  if (!homePage || !feedContainer || document.getElementById('agrolinkBanner')) return;
  
  const bannerSection = document.createElement('div');
  bannerSection.id = 'agrolinkBanner';
  bannerSection.style.cssText = `
    display: flex;
    align-items: center;
    justify-content: flex-start;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border-light);
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.9) 50%, rgba(16, 185, 129, 0.1) 100%);
    overflow: hidden;
    position: relative;
  `;
  
  bannerSection.innerHTML = `
    <style>
      @keyframes neonPulse {
        0%, 100% { 
          text-shadow: 
            0 0 5px #10b981,
            0 0 10px #10b981,
            0 0 20px #10b981,
            0 0 40px #10b981;
          opacity: 1;
        }
        50% { 
          text-shadow: 
            0 0 2px #10b981,
            0 0 5px #10b981,
            0 0 10px #10b981,
            0 0 20px #10b981;
          opacity: 0.9;
        }
      }
      @keyframes neonFlicker {
        0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% {
          text-shadow: 
            0 0 5px #10b981,
            0 0 10px #10b981,
            0 0 20px #10b981,
            0 0 40px #10b981,
            0 0 80px #10b981;
        }
        20%, 24%, 55% {
          text-shadow: none;
        }
      }
      .neon-text {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        font-size: 28px;
        font-weight: 900;
        letter-spacing: 4px;
        text-transform: uppercase;
        color: #10b981;
        animation: neonPulse 2s ease-in-out infinite;
        position: relative;
        z-index: 2;
      }
      .neon-text::before {
        content: 'AGROLINK SOSYAL';
        position: absolute;
        top: 0;
        left: 0;
        color: transparent;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        background-size: 200% 100%;
        -webkit-background-clip: text;
        background-clip: text;
        animation: shine 3s linear infinite;
      }
      @keyframes shine {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
      }
      .neon-glow-line {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, transparent, #10b981, #34d399, #10b981, transparent);
        animation: glowMove 3s ease-in-out infinite;
      }
      @keyframes glowMove {
        0%, 100% { opacity: 0.5; transform: scaleX(0.8); }
        50% { opacity: 1; transform: scaleX(1); }
      }
    </style>
    <div class="neon-text">AGROLINK SOSYAL</div>
    <div class="neon-glow-line"></div>
  `;
  
  homePage.insertBefore(bannerSection, feedContainer);
}

// Hikaye fonksiyonlarƒ± devre dƒ±≈üƒ±
async function loadStories() {
  // Hikayeler kaldƒ±rƒ±ldƒ± - bo≈ü fonksiyon
}

async function loadStories() {
  const storiesSection = document.getElementById('storiesSection');
  if (!storiesSection) return;
  
  // √ñnce mevcut hikayeleri temizle (kendi butonu hari√ß)
  const storyItems = storiesSection.querySelectorAll('.story-item-element');
  storyItems.forEach(el => el.remove());
  
  // Story groups'u sƒ±fƒ±rla
  storyGroups = [];
  
  try {
    const response = await apiRequest('/api/stories', { method: 'GET' });
    if (response.ok) {
      const data = await response.json();
      const stories = data.stories || [];
      const myStories = data.myStories || [];
      
      // Kendi hikayelerimizi grup olarak ekle
      if (myStories && myStories.length > 0) {
        storyGroups.push({
          userId: currentUser?.id,
          username: currentUser?.username || 'Ben',
          userProfilePic: currentUser?.profilePic,
          stories: myStories,
          isOwn: true
        });
      }
      
      // Kendi hikayelerimizi g√∂ster
      const myStoryBtn = document.getElementById('myStoryButton');
      if (myStoryBtn) {
        // Profil resmini g√ºncelle
        const avatarContainer = myStoryBtn.querySelector('.story-avatar-container');
        if (avatarContainer && currentUser?.profilePic) {
          const imgUrl = currentUser.profilePic.startsWith('http') ? currentUser.profilePic : API_BASE + currentUser.profilePic;
          avatarContainer.innerHTML = `<img src="${imgUrl}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" onerror="this.parentElement.innerHTML='<div style=\\'width:100%;height:100%;background:linear-gradient(135deg,#10b981,#059669);display:flex;align-items:center;justify-content:center;color:white;font-size:26px;\\'>üë§</div>'">`;
        }
        
        if (myStories && myStories.length > 0) {
          // Event listener'ƒ± deƒüi≈ütir - kendi hikayemizi g√∂ster
          myStoryBtn.onclick = function(e) {
            e.stopPropagation();
            console.log('üü¢ Kendi hikayeme tƒ±klandƒ±:', myStories[0]);
            currentStoryGroupIndex = 0;
            currentStoryIndex = 0;
            const storyWithAll = { ...myStories[0], allStories: myStories };
            openStoryViewer(storyWithAll, true, 0, 0);
          };
          
          // + i≈üaretini gizle ve hikaye sayƒ±sƒ±nƒ± g√∂ster
          const plusIcon = document.getElementById('plusIcon');
          if (plusIcon) {
            plusIcon.innerHTML = `<span style="font-size: 12px; font-weight: 700;">${myStories.length}</span>`;
            plusIcon.style.background = 'linear-gradient(135deg, #3b82f6, #1d4ed8)';
          }
          
          // Ring'i gradient yap
          const storyRing = myStoryBtn.querySelector('.story-ring-add');
          if (storyRing) {
            storyRing.style.background = 'conic-gradient(from 0deg, #f59e0b, #ef4444, #ec4899, #8b5cf6, #3b82f6, #10b981, #f59e0b)';
            storyRing.style.border = 'none';
            storyRing.style.padding = '3px';
            storyRing.style.animation = 'storyRingRotate 3s linear infinite';
          }
          
          // Label'ƒ± g√ºncelle
          const label = myStoryBtn.querySelector('.story-label');
          if (label) {
            label.textContent = 'Hikayem';
            label.style.color = 'var(--primary-color)';
            label.style.fontWeight = '700';
          }
        } else {
          // Hikaye yok - ekleme moduna d√∂n
          myStoryBtn.onclick = function(e) {
            e.stopPropagation();
            openAddStoryModal();
          };
          
          // + i≈üaretini g√∂ster
          const plusIcon = document.getElementById('plusIcon');
          if (plusIcon) {
            plusIcon.style.display = 'flex';
            plusIcon.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`;
            plusIcon.style.background = 'linear-gradient(135deg, #10b981, #059669)';
          }
        }
      }
      
      // Hikayeleri kullanƒ±cƒ±ya g√∂re grupla
      const userStoryMap = new Map();
      stories.forEach(story => {
        const key = story.userId;
        if (!userStoryMap.has(key)) {
          userStoryMap.set(key, {
            userId: story.userId,
            username: story.username,
            userProfilePic: story.userProfilePic,
            stories: [],
            isOwn: false
          });
        }
        userStoryMap.get(key).stories.push(story);
      });
      
      // Gruplarƒ± storyGroups'a ekle
      userStoryMap.forEach(group => {
        storyGroups.push(group);
      });
      
      console.log('üìö Hikaye gruplarƒ±:', storyGroups.length);
      
      // Diƒüer kullanƒ±cƒ±larƒ±n hikayelerini g√∂ster - Modern tasarƒ±m
      let groupIndex = myStories.length > 0 ? 1 : 0;
      userStoryMap.forEach((group, userId) => {
        const storyEl = document.createElement('div');
        storyEl.className = 'story-item-element';
        storyEl.dataset.groupIndex = groupIndex;
        storyEl.style.cssText = `
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 8px;
          min-width: 76px;
          cursor: pointer;
          transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        `;
        
        const hasUnwatched = group.stories.some(s => !s.watched);
        const profilePicUrl = group.userProfilePic ? 
          (group.userProfilePic.startsWith('http') ? group.userProfilePic : API_BASE + group.userProfilePic) : '';
        
        // Profil resmi olmazsa kullanƒ±cƒ± adƒ±nƒ±n ilk harfini g√∂ster
        const fallbackAvatar = `<div style="width: 100%; height: 100%; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center; color: white; font-size: 26px; font-weight: bold; border-radius: 50%;">${group.username ? group.username.charAt(0).toUpperCase() : 'üë§'}</div>`;
        
        // √áoklu hikaye g√∂stergesi - Modern
        const storyCount = group.stories.length;
        const multiIndicator = storyCount > 1 ? `
          <div class="story-count-badge" style="position: absolute; bottom: -2px; right: -2px; min-width: 20px; height: 20px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; font-size: 11px; font-weight: 700; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);">${storyCount}</div>
        ` : '';
        
        // Gradient ring animation class
        const ringClass = hasUnwatched ? 'story-ring-active' : 'story-ring-watched';
        const ringBg = hasUnwatched 
          ? 'background: conic-gradient(from 0deg, #f59e0b, #ef4444, #ec4899, #8b5cf6, #3b82f6, #10b981, #f59e0b); animation: storyRingRotate 3s linear infinite;'
          : 'background: linear-gradient(135deg, #94a3b8, #64748b);';
        
        storyEl.innerHTML = `
          <div class="${ringClass}" style="width: 72px; height: 72px; border-radius: 50%; ${ringBg} padding: 3px; position: relative; transition: all 0.3s ease;">
            <div style="width: 100%; height: 100%; border-radius: 50%; background: var(--card-light); padding: 2px;">
              <div style="width: 100%; height: 100%; border-radius: 50%; overflow: hidden; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                ${profilePicUrl 
                  ? `<img src="${profilePicUrl}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" onerror="this.parentElement.innerHTML='${fallbackAvatar.replace(/'/g, "\\'").replace(/"/g, "&quot;")}'">` 
                  : fallbackAvatar}
              </div>
            </div>
            ${multiIndicator}
          </div>
          <span class="story-label" style="font-size: 11px; font-weight: 600; color: ${hasUnwatched ? 'var(--text-light)' : '#94a3b8'}; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 74px;">${group.username}</span>
        `;
        
        // Hover efekti
        storyEl.onmouseenter = function() {
          this.style.transform = 'translateY(-4px) scale(1.02)';
        };
        storyEl.onmouseleave = function() {
          this.style.transform = '';
        };
        
        // Tƒ±klama eventi
        const currentGroupIndex = groupIndex;
        storyEl.onclick = function(e) {
          e.stopPropagation();
          e.preventDefault();
          console.log('üîµ Hikaye grubuna tƒ±klandƒ±:', group.username, 'Index:', currentGroupIndex);
          currentStoryGroupIndex = currentGroupIndex;
          currentStoryIndex = 0;
          const storyWithAll = { ...group.stories[0], allStories: group.stories };
          openStoryViewer(storyWithAll, false, currentGroupIndex, 0);
        };
        
        storiesSection.appendChild(storyEl);
        groupIndex++;
      });
    }
  } catch (e) {
    console.log('Hikayeler y√ºklenemedi:', e);
  }
}

// Hikaye ekleme modalƒ±
window.openAddStoryModal = function() {
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.style.zIndex = '10001';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h2 class="modal-title">üì∏ Hikaye Ekle</h2>
        <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
      </div>
      <div style="display: flex; flex-direction: column; gap: 16px;">
        <label style="display: flex; flex-direction: column; align-items: center; gap: 12px; padding: 40px; background: rgba(16, 185, 129, 0.1); border: 2px dashed #10b981; border-radius: 16px; cursor: pointer;">
          <span style="font-size: 48px;">üì∑</span>
          <span style="font-weight: 700; color: #10b981;">Fotoƒüraf veya Video Se√ß</span>
          <input type="file" accept="image/*,video/*" id="storyMediaInput" style="display: none;" onchange="previewStoryMedia(this)">
        </label>
        <div id="storyPreview" style="display: none;"></div>
        <textarea id="storyText" placeholder="Hikayene metin ekle (isteƒüe baƒülƒ±)" style="padding: 12px; border-radius: 12px; border: 2px solid var(--border-light); resize: none; height: 80px; font-family: inherit;"></textarea>
        <button class="primary-btn" onclick="uploadStory()">Hikaye Payla≈ü</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
};

window.previewStoryMedia = function(input) {
  const file = input.files[0];
  if (!file) return;
  
  const preview = document.getElementById('storyPreview');
  preview.style.display = 'block';
  
  const reader = new FileReader();
  reader.onload = function(e) {
    if (file.type.startsWith('video/')) {
      preview.innerHTML = `<video src="${e.target.result}" controls style="width: 100%; border-radius: 12px; max-height: 300px;"></video>`;
    } else {
      preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; border-radius: 12px; max-height: 300px; object-fit: contain;">`;
    }
  };
  reader.readAsDataURL(file);
};

window.uploadStory = async function() {
  const input = document.getElementById('storyMediaInput');
  const text = document.getElementById('storyText')?.value || '';
  
  if (!input.files[0]) {
    showToast('L√ºtfen bir fotoƒüraf veya video se√ßin', 'error');
    return;
  }
  
  // Payla≈ü butonunu devre dƒ±≈üƒ± bƒ±rak ve "bekleyin" mesajƒ± g√∂ster
  const submitBtn = document.querySelector('.modal .primary-btn');
  if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner" style="display:inline-block; width:16px; height:16px; border:2px solid white; border-top-color:transparent; border-radius:50%; animation:spin 1s linear infinite; margin-right:8px;"></span> Payla≈üƒ±lƒ±yor, l√ºtfen bekleyin...';
    submitBtn.style.opacity = '0.7';
  }
  
  const formData = new FormData();
  formData.append('media', input.files[0]);
  formData.append('text', text);
  
  try {
    const response = await apiRequest('/api/stories', {
      method: 'POST',
      body: formData,
      headers: {}
    });
    
    if (response.ok) {
      const data = await response.json();
      showToast('Hikaye payla≈üƒ±ldƒ±! üéâ', 'success');
      document.querySelector('.modal')?.remove();
      
      // Hikayeleri yeniden y√ºkle
      await loadStories();
      
      // Payla≈üƒ±lan hikayeyi hemen g√∂r√ºnt√ºle
      if (data && data.story) {
        setTimeout(() => {
          openStoryViewer(data.story, true);
        }, 500);
      }
    } else {
      showToast('Hikaye payla≈üƒ±lamadƒ±', 'error');
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Hikaye Payla≈ü';
        submitBtn.style.opacity = '1';
      }
    }
  } catch (e) {
    console.error('Hikaye y√ºkleme hatasƒ±:', e);
    showToast('Hikaye payla≈üƒ±lamadƒ±', 'error');
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'Hikaye Payla≈ü';
      submitBtn.style.opacity = '1';
    }
  }
};

// Hikaye g√∂r√ºnt√ºleyici (Geli≈ütirilmi≈ü - Diƒüer kullanƒ±cƒ±larƒ±n hikayeleri arasƒ± ge√ßi≈ü)
window.openStoryViewer = function(story, isOwn = false, groupIndex = -1, storyIndex = 0) {
  console.log('üìñ Hikaye a√ßƒ±lƒ±yor:', story);
  
  if (!story) {
    console.error('‚ùå Hikaye bulunamadƒ±!');
    showToast('Hikaye y√ºklenemedi', 'error');
    return;
  }
  
  // Story group indexi belirle
  if (groupIndex >= 0) {
    currentStoryGroupIndex = groupIndex;
    currentStoryIndex = storyIndex;
  }
  
  const modal = document.createElement('div');
  modal.className = 'story-viewer-modal';
  modal.id = 'storyViewerModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    z-index: 10002;
    display: flex;
    flex-direction: column;
  `;
  
  const mediaUrl = story.mediaUrl.startsWith('http') ? story.mediaUrl : API_BASE + story.mediaUrl;
  const profilePicUrl = story.userProfilePic ? 
    (story.userProfilePic.startsWith('http') ? story.userProfilePic : API_BASE + story.userProfilePic) : '';
  
  // Kendi hikayemiz mi kontrol et
  const isMyStory = currentUser && (story.userId === currentUser.id || story.username === currentUser.username);
  
  // Navigasyon butonlarƒ±
  const showNavButtons = storyGroups.length > 1;
  
  modal.innerHTML = `
    <!-- Progress bars for all stories in this group -->
    <div style="position: absolute; top: 0; left: 0; right: 0; padding: 16px; display: flex; gap: 4px; z-index: 10;">
      ${story.allStories ? story.allStories.map((s, i) => `
        <div style="flex: 1; height: 3px; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden;">
          <div class="story-progress-bar" data-index="${i}" style="height: 100%; background: white; border-radius: 2px; width: ${i < currentStoryIndex ? '100%' : '0%'}; transition: width 0.1s linear;"></div>
        </div>
      `).join('') : `
        <div style="flex: 1; height: 3px; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden;">
          <div class="story-progress" style="height: 100%; background: white; border-radius: 2px; width: 0%;"></div>
        </div>
      `}
    </div>
    
    <!-- Header -->
    <div style="position: absolute; top: 40px; left: 16px; right: 16px; display: flex; align-items: center; gap: 12px; z-index: 10;">
      <div style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden; border: 2px solid white; cursor: pointer;" onclick="event.stopPropagation(); ${isMyStory ? '' : `viewUserProfile('${story.userId}'); closeStoryViewerModal();`}">
        ${profilePicUrl ? `<img src="${profilePicUrl}" style="width: 100%; height: 100%; object-fit: cover;">` : '<div style="width: 100%; height: 100%; background: #10b981; display: flex; align-items: center; justify-content: center;">üë§</div>'}
      </div>
      <div style="flex: 1;" onclick="event.stopPropagation();">
        <div style="color: white; font-weight: 700;">${story.username}</div>
        <div style="color: rgba(255,255,255,0.7); font-size: 12px;">${formatTime(story.createdAt)}</div>
      </div>
      ${isMyStory ? `
        <button onclick="event.stopPropagation(); deleteStory('${story.id}')" style="width: 40px; height: 40px; background: #ef4444; border: none; border-radius: 50%; color: white; font-size: 20px; cursor: pointer; margin-right: 4px;">üóëÔ∏è</button>
      ` : ''}
      <button onclick="closeStoryViewerModal()" style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border: none; border-radius: 50%; color: white; font-size: 24px; cursor: pointer;">√ó</button>
    </div>
    
    <!-- Navigation buttons -->
    ${showNavButtons ? `
      <button id="storyPrevBtn" onclick="event.stopPropagation(); navigateStory(-1)" style="position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 50px; height: 100%; background: transparent; border: none; color: white; font-size: 32px; cursor: pointer; z-index: 5; display: flex; align-items: center; justify-content: center; opacity: 0.5;">‚ùÆ</button>
      <button id="storyNextBtn" onclick="event.stopPropagation(); navigateStory(1)" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); width: 50px; height: 100%; background: transparent; border: none; color: white; font-size: 32px; cursor: pointer; z-index: 5; display: flex; align-items: center; justify-content: center; opacity: 0.5;">‚ùØ</button>
    ` : ''}
    
    <!-- Story Content -->
    <div style="flex: 1; display: flex; align-items: center; justify-content: center;" id="storyMediaContainer">
      ${story.mediaType === 'video' 
        ? `<video src="${mediaUrl}" autoplay loop style="max-width: 100%; max-height: 100%; object-fit: contain;" onclick="event.stopPropagation(); this.muted = !this.muted;"></video>`
        : `<img src="${mediaUrl}" style="max-width: 100%; max-height: 100%; object-fit: contain;">`
      }
    </div>
    
    <!-- Story text -->
    ${story.text ? `<div style="position: absolute; bottom: 80px; left: 16px; right: 16px; color: white; text-align: center; font-size: 18px; text-shadow: 0 1px 3px rgba(0,0,0,0.8);">${story.text}</div>` : ''}
    
    <!-- Bottom actions -->
    ${isMyStory ? `
      <div id="storyViewersSwipeUp" style="position: absolute; bottom: 20px; left: 16px; right: 16px; display: flex; flex-direction: column; align-items: center; color: white; cursor: pointer;" onclick="event.stopPropagation(); showStoryViewers('${story.id}')">
        <div style="font-size: 24px;">‚òùÔ∏è</div>
        <div style="font-size: 12px; opacity: 0.8;">Yukarƒ± kaydƒ±r</div>
      </div>
    ` : `
      <div style="position: absolute; bottom: 20px; left: 16px; right: 16px; display: flex; gap: 12px;">
        <input type="text" placeholder="Yanƒ±t g√∂nder..." style="flex: 1; padding: 12px 16px; border-radius: 24px; border: none; background: rgba(255,255,255,0.2); color: white; font-size: 14px;" onkeypress="if(event.key==='Enter') sendStoryReply('${story.id}', this.value)" onclick="event.stopPropagation();">
        <button onclick="event.stopPropagation(); sendStoryReply('${story.id}', this.previousElementSibling.value)" style="width: 44px; height: 44px; background: #10b981; border: none; border-radius: 50%; color: white; font-size: 20px; cursor: pointer;">‚û§</button>
      </div>
    `}
  `;
  
  document.body.appendChild(modal);
  
  // Mark story as viewed
  if (!isMyStory && story.id) {
    markStoryAsViewed(story.id);
  }
  
  // ƒ∞lerleme √ßubuƒüu animasyonu
  const progressBars = modal.querySelectorAll('.story-progress-bar');
  const singleProgress = modal.querySelector('.story-progress');
  let width = 0;
  const duration = story.mediaType === 'video' ? 15000 : 5000;
  
  window.storyProgressInterval = setInterval(() => {
    width += 100 / (duration / 100);
    
    if (progressBars.length > 0 && progressBars[currentStoryIndex]) {
      progressBars[currentStoryIndex].style.width = width + '%';
    } else if (singleProgress) {
      singleProgress.style.width = width + '%';
    }
    
    if (width >= 100) {
      clearInterval(window.storyProgressInterval);
      // Auto-advance to next story
      if (story.allStories && currentStoryIndex < story.allStories.length - 1) {
        currentStoryIndex++;
        updateStoryContent(story.allStories[currentStoryIndex]);
      } else {
        navigateStory(1); // Go to next user's story
      }
    }
  }, 100);
  
  // Click to navigate
  modal.addEventListener('click', (e) => {
    if (e.target.closest('input') || e.target.closest('button') || e.target.closest('#storyViewersSwipeUp')) return;
    
    const rect = modal.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const width = rect.width;
    
    if (clickX < width * 0.3) {
      // Left click - previous
      if (story.allStories && currentStoryIndex > 0) {
        currentStoryIndex--;
        clearInterval(window.storyProgressInterval);
        updateStoryContent(story.allStories[currentStoryIndex]);
      } else {
        navigateStory(-1);
      }
    } else if (clickX > width * 0.7) {
      // Right click - next
      if (story.allStories && currentStoryIndex < story.allStories.length - 1) {
        currentStoryIndex++;
        clearInterval(window.storyProgressInterval);
        updateStoryContent(story.allStories[currentStoryIndex]);
      } else {
        navigateStory(1);
      }
    }
  });
  
  // Swipe gestures
  let touchStartX = 0;
  let touchStartY = 0;
  
  modal.addEventListener('touchstart', (e) => {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
  });
  
  modal.addEventListener('touchend', (e) => {
    const touchEndX = e.changedTouches[0].clientX;
    const touchEndY = e.changedTouches[0].clientY;
    const diffX = touchStartX - touchEndX;
    const diffY = touchStartY - touchEndY;
    
    if (Math.abs(diffX) > 50 && Math.abs(diffX) > Math.abs(diffY)) {
      if (diffX > 0) {
        navigateStory(1); // Swipe left - next
      } else {
        navigateStory(-1); // Swipe right - previous
      }
    } else if (diffY > 50 && isMyStory) {
      showStoryViewers(story.id);
    }
  });
};

// Story i√ßeriƒüini g√ºncelle (aynƒ± kullanƒ±cƒ±nƒ±n farklƒ± hikayeleri i√ßin)
window.updateStoryContent = function(story) {
  const container = document.getElementById('storyMediaContainer');
  if (!container) return;
  
  const mediaUrl = story.mediaUrl.startsWith('http') ? story.mediaUrl : API_BASE + story.mediaUrl;
  
  container.innerHTML = story.mediaType === 'video' 
    ? `<video src="${mediaUrl}" autoplay loop style="max-width: 100%; max-height: 100%; object-fit: contain;" onclick="event.stopPropagation(); this.muted = !this.muted;"></video>`
    : `<img src="${mediaUrl}" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
  
  // Progress barlarƒ± resetle
  const progressBars = document.querySelectorAll('.story-progress-bar');
  progressBars.forEach((bar, i) => {
    if (i < currentStoryIndex) {
      bar.style.width = '100%';
    } else {
      bar.style.width = '0%';
    }
  });
  
  // Yeni progress ba≈ülat
  let width = 0;
  const duration = story.mediaType === 'video' ? 15000 : 5000;
  
  if (window.storyProgressInterval) clearInterval(window.storyProgressInterval);
  
  window.storyProgressInterval = setInterval(() => {
    width += 100 / (duration / 100);
    if (progressBars[currentStoryIndex]) {
      progressBars[currentStoryIndex].style.width = width + '%';
    }
    if (width >= 100) {
      clearInterval(window.storyProgressInterval);
      if (currentStoryIndex < progressBars.length - 1) {
        currentStoryIndex++;
        updateStoryContent(storyGroups[currentStoryGroupIndex].stories[currentStoryIndex]);
      } else {
        navigateStory(1);
      }
    }
  }, 100);
};

// Bir sonraki/√∂nceki kullanƒ±cƒ±nƒ±n hikayesine git
window.navigateStory = function(direction) {
  if (window.storyProgressInterval) clearInterval(window.storyProgressInterval);
  
  const newGroupIndex = currentStoryGroupIndex + direction;
  
  if (newGroupIndex < 0 || newGroupIndex >= storyGroups.length) {
    closeStoryViewerModal();
    return;
  }
  
  closeStoryViewerModal();
  
  setTimeout(() => {
    currentStoryGroupIndex = newGroupIndex;
    currentStoryIndex = 0;
    const group = storyGroups[newGroupIndex];
    if (group && group.stories && group.stories.length > 0) {
      const storyWithAll = { ...group.stories[0], allStories: group.stories };
      openStoryViewer(storyWithAll, group.isOwn, newGroupIndex, 0);
    }
  }, 100);
};

// Story modal'ƒ±nƒ± kapat
window.closeStoryViewerModal = function() {
  if (window.storyProgressInterval) clearInterval(window.storyProgressInterval);
  const modal = document.getElementById('storyViewerModal');
  if (modal) modal.remove();
};

// Hikayeyi g√∂r√ºnt√ºlendi olarak i≈üaretle
window.markStoryAsViewed = async function(storyId) {
  try {
    await apiRequest(`/api/stories/${storyId}/view`, { method: 'POST' });
  } catch (e) {
    console.log('Hikaye g√∂r√ºnt√ºleme kaydedilemedi:', e);
  }
};

// Hikaye silme fonksiyonu
window.deleteStory = async function(storyId) {
  if (!confirm('Bu hikayeyi silmek istediƒüinizden emin misiniz?')) return;
  
  try {
    const response = await apiRequest(`/api/stories/${storyId}`, {
      method: 'DELETE'
    });
    
    if (response.ok) {
      showToast('Hikaye silindi! üóëÔ∏è', 'success');
      document.querySelector('.story-viewer-modal')?.remove();
      loadStories();
    } else {
      showToast('Hikaye silinemedi', 'error');
    }
  } catch (e) {
    console.error('Hikaye silme hatasƒ±:', e);
    showToast('Hikaye silinemedi', 'error');
  }
};

// Hikayeyi kimlerin g√∂r√ºnt√ºlediƒüini g√∂ster
window.showStoryViewers = async function(storyId) {
  try {
    const response = await apiRequest(`/api/stories/${storyId}/viewers`, {
      method: 'GET'
    });
    
    if (response.ok) {
      const data = await response.json();
      const viewers = data.viewers || [];
      
      // Modal olu≈ütur
      const viewersModal = document.createElement('div');
      viewersModal.className = 'modal active';
      viewersModal.style.zIndex = '10003';
      viewersModal.innerHTML = `
        <div class="modal-content" style="max-width: 400px; max-height: 70vh;">
          <div class="modal-header">
            <h2 class="modal-title">üëÅÔ∏è G√∂r√ºnt√ºleyenler (${viewers.length})</h2>
            <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
          </div>
          <div style="max-height: 50vh; overflow-y: auto;">
            ${viewers.length > 0 ? viewers.map(viewer => `
              <div style="display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid var(--border-light);">
                <div style="width: 44px; height: 44px; border-radius: 50%; overflow: hidden; background: #10b981;">
                  ${viewer.profilePic ? `<img src="${viewer.profilePic.startsWith('http') ? viewer.profilePic : API_BASE + viewer.profilePic}" style="width: 100%; height: 100%; object-fit: cover;">` : '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: white;">üë§</div>'}
                </div>
                <div style="flex: 1;">
                  <div style="font-weight: 700;">${viewer.username}</div>
                  <div style="font-size: 12px; opacity: 0.7;">${formatTime(viewer.viewedAt)}</div>
                </div>
              </div>
            `).join('') : '<div style="padding: 40px; text-align: center; color: #999;">Hen√ºz kimse g√∂r√ºnt√ºlemedi</div>'}
          </div>
        </div>
      `;
      
      document.body.appendChild(viewersModal);
    }
  } catch (e) {
    console.error('G√∂r√ºnt√ºleyenler y√ºklenemedi:', e);
    showToast('G√∂r√ºnt√ºleyenler y√ºklenemedi', 'error');
  }
};

window.sendStoryReply = async function(storyId, message) {
  if (!message.trim()) return;
  
  try {
    await apiRequest(`/api/stories/${storyId}/reply`, {
      method: 'POST',
      body: JSON.stringify({ message })
    });
    showToast('Yanƒ±t g√∂nderildi! üí¨', 'success');
    document.querySelector('.story-viewer-modal')?.remove();
  } catch (e) {
    console.error('Hikaye yanƒ±tƒ± g√∂nderilemedi:', e);
  }
};

// Sayfa y√ºklendiƒüinde hikayeler b√∂l√ºm√ºn√º olu≈ütur
window.addEventListener('load', () => {
  setTimeout(() => {
    createStoriesSection();
    checkVerificationStatus();
  }, 1000);
});

console.log('‚úÖ V3 G√ºncellemeler y√ºklendi!');


// Video Kayƒ±t Fonksiyonlarƒ±
window.recordedVideoBlob = null;
window.mediaRecorderInstance = null;
window.recordedChunks = [];

window.startVideoRecording = async function() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: { facingMode: 'environment' }, 
      audio: true 
    });
    
    // Modal olu≈ütur
    const recordModal = document.createElement('div');
    recordModal.id = 'videoRecordModal';
    recordModal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      z-index: 10005;
      display: flex;
      flex-direction: column;
    `;
    
    recordModal.innerHTML = `
      <div style="position: absolute; top: 16px; right: 16px; z-index: 10;">
        <button onclick="stopVideoRecording()" style="background: #ef4444; border: none; border-radius: 50%; width: 50px; height: 50px; color: white; font-size: 24px; cursor: pointer;">√ó</button>
      </div>
      <video id="recordPreview" autoplay muted playsinline style="width: 100%; height: 100%; object-fit: cover;"></video>
      <div style="position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; align-items: center;">
        <div id="recordTimer" style="color: white; font-size: 18px; font-weight: bold; background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 20px;">00:00</div>
        <button id="recordStopBtn" onclick="stopRecording()" style="background: #ef4444; border: none; border-radius: 50%; width: 70px; height: 70px; color: white; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(239,68,68,0.4);">‚èπÔ∏è</button>
      </div>
    `;
    
    document.body.appendChild(recordModal);
    
    // Preview'a stream baƒüla
    const videoPreview = document.getElementById('recordPreview');
    if (videoPreview) {
      videoPreview.srcObject = stream;
    }
    
    // MediaRecorder ba≈ülat
    window.recordedChunks = [];
    const options = { mimeType: 'video/webm;codecs=vp8,opus' };
    window.mediaRecorderInstance = new MediaRecorder(stream, options);
    
    window.mediaRecorderInstance.ondataavailable = (event) => {
      if (event.data && event.data.size > 0) {
        window.recordedChunks.push(event.data);
      }
    };
    
    window.mediaRecorderInstance.onstop = () => {
      const blob = new Blob(window.recordedChunks, { type: 'video/webm' });
      window.recordedVideoBlob = blob;
      
      // Stream'i kapat
      stream.getTracks().forEach(track => track.stop());
      
      // Kaydedilen videoyu g√∂ster
      showRecordedVideo(blob);
    };
    
    window.mediaRecorderInstance.start();
    
    // Timer ba≈ülat
    let seconds = 0;
    window.recordTimerInterval = setInterval(() => {
      seconds++;
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      const timerEl = document.getElementById('recordTimer');
      if (timerEl) {
        timerEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      }
    }, 1000);
    
  } catch (error) {
    console.error('Kamera eri≈üim hatasƒ±:', error);
    showToast('Kamera eri≈üimi reddedildi veya mevcut deƒüil', 'error');
  }
};

window.stopRecording = function() {
  if (window.mediaRecorderInstance && window.mediaRecorderInstance.state !== 'inactive') {
    window.mediaRecorderInstance.stop();
  }
  if (window.recordTimerInterval) {
    clearInterval(window.recordTimerInterval);
  }
};

window.stopVideoRecording = function() {
  stopRecording();
  const recordModal = document.getElementById('videoRecordModal');
  if (recordModal) {
    recordModal.remove();
  }
};

window.showRecordedVideo = function(blob) {
  // Kayƒ±t modalƒ±nƒ± kapat
  const recordModal = document.getElementById('videoRecordModal');
  if (recordModal) {
    recordModal.remove();
  }
  
  // Video'yu post'a ekle
  const file = new File([blob], 'recorded-video.webm', { type: 'video/webm' });
  window.uploadedMediaFile = file;
  window.uploadedMediaType = 'video';
  
  // Preview g√∂ster
  const mediaPreview = document.getElementById('mediaPreview');
  if (mediaPreview) {
    const videoUrl = URL.createObjectURL(blob);
    mediaPreview.innerHTML = `
      <div style="position: relative; width: 100%; max-width: 400px; margin: 0 auto;">
        <video src="${videoUrl}" controls style="width: 100%; border-radius: 12px;"></video>
        <button onclick="removeRecordedVideo()" style="position: absolute; top: 10px; right: 10px; background: #ef4444; border: none; border-radius: 50%; width: 36px; height: 36px; color: white; font-size: 18px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">√ó</button>
      </div>
    `;
  }
  
  showToast('Video kaydedildi! ≈ûimdi payla≈üabilirsiniz. üé•', 'success');
};

window.removeRecordedVideo = function() {
  window.uploadedMediaFile = null;
  window.uploadedMediaType = null;
  window.recordedVideoBlob = null;
  
  const mediaPreview = document.getElementById('mediaPreview');
  if (mediaPreview) {
    mediaPreview.innerHTML = '';
  }
};

// Video kayƒ±t butonuna event listener ekle
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    const recordBtn = document.getElementById('recordVideoBtn');
    if (recordBtn) {
      recordBtn.addEventListener('click', (e) => {
        e.preventDefault();
        startVideoRecording();
      });
    }
  }, 1000);
});

console.log('‚úÖ Video kayƒ±t √∂zellikleri eklendi!');


// Demo hikayeler (Test i√ßin - API yoksa)
window.loadDemoStories = function() {
  if (!currentUser) return;
  
  const demoStories = [
    {
      id: 'story1',
      userId: 'user1',
      username: 'Ali Veli',
      userProfilePic: '',
      mediaUrl: 'https://picsum.photos/400/600',
      mediaType: 'image',
      text: 'Test hikayesi!',
      createdAt: new Date().toISOString(),
      watched: false
    },
    {
      id: 'story2',
      userId: 'user2',
      username: 'Ay≈üe Yƒ±lmaz',
      userProfilePic: '',
      mediaUrl: 'https://picsum.photos/400/601',
      mediaType: 'image',
      text: '',
      createdAt: new Date().toISOString(),
      watched: true
    }
  ];
  
  const storiesSection = document.getElementById('storiesSection');
  if (!storiesSection) return;
  
  console.log('üìö Demo hikayeler y√ºkleniyor...');
  
  demoStories.forEach((story, index) => {
    console.log(`Demo Hikaye ${index + 1}:`, story.username);
    
    const storyEl = document.createElement('div');
    storyEl.style.cssText = `
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      min-width: 70px;
    `;
    
    const hasUnwatched = !story.watched;
    
    // Top/daire kƒ±smƒ±
    const storyCircle = document.createElement('div');
    storyCircle.style.cssText = `
      width: 66px; 
      height: 66px; 
      border-radius: 50%; 
      background: ${hasUnwatched ? 'linear-gradient(135deg, #f59e0b, #ef4444, #8b5cf6)' : 'linear-gradient(135deg, #ccc, #999)'}; 
      padding: 3px;
      cursor: pointer;
    `;
    storyCircle.innerHTML = `
      <div style="width: 100%; height: 100%; border-radius: 50%; background: var(--card-light); padding: 2px;">
        <div style="width: 100%; height: 100%; border-radius: 50%; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #10b981; color: white; font-size: 24px;">
          ${story.username.charAt(0)}
        </div>
      </div>
    `;
    
    // Topa tƒ±klayƒ±nca hikaye a√ßƒ±lsƒ±n
    storyCircle.addEventListener('click', (e) => {
      e.stopPropagation();
      console.log('üîµ Demo Topa tƒ±klandƒ±:', story.username);
      openStoryViewer(story, false);
    });
    
    storyEl.appendChild(storyCircle);
    
    const username = document.createElement('span');
    username.style.cssText = 'font-size: 11px; color: var(--text-light); text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70px;';
    username.textContent = story.username;
    storyEl.appendChild(username);
    
    storiesSection.appendChild(storyEl);
  });
};

// Test i√ßin klavye kƒ±sayolu ekle: Ctrl+Shift+D ile demo hikayeler y√ºkle
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.shiftKey && e.key === 'D') {
    console.log('üé¨ Demo hikayeler y√ºkleniyor...');
    loadDemoStories();
    showToast('Demo hikayeler y√ºklendi! üéâ', 'success');
  }
});

console.log('üí° Demo hikayeler i√ßin Ctrl+Shift+D tu≈ülarƒ±na basƒ±n');

// ========== DOƒûRULANMI≈û ROZET Sƒ∞STEMƒ∞ ==========
window.openVerificationModal = function() {
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.style.zIndex = '10003';
  modal.innerHTML = `
    <div class="modal-content verification-modal-content">
      <div class="modal-header">
        <h2 class="modal-title">‚úì Hesap Doƒürulama</h2>
        <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
      </div>
      <p style="margin-bottom: 20px; color: #64748b;">Mavi tik almak i√ßin T.C. kimlik kartƒ±nƒ±zƒ±n √∂n ve arka y√ºz fotoƒüraflarƒ±nƒ± y√ºkleyin.</p>
      <div class="id-upload-area">
        <div class="id-upload-box" id="idFrontBox" onclick="document.getElementById('idFrontInput').click()">
          <div id="idFrontPreview">üì∑ Kimlik √ñn Y√ºz</div>
          <input type="file" id="idFrontInput" accept="image/*" style="display:none" onchange="previewIdImage(this, 'front')">
        </div>
        <div class="id-upload-box" id="idBackBox" onclick="document.getElementById('idBackInput').click()">
          <div id="idBackPreview">üì∑ Kimlik Arka Y√ºz</div>
          <input type="file" id="idBackInput" accept="image/*" style="display:none" onchange="previewIdImage(this, 'back')">
        </div>
      </div>
      <div class="form-group" style="margin-top: 16px;">
        <label class="form-label">Ad Soyad (Kimlik √ºzerindeki)</label>
        <input type="text" id="verifyFullName" class="form-input" placeholder="Kimliƒüinizdeki ad soyad">
      </div>
      <button class="verification-request-btn" onclick="submitVerification()" style="margin-top: 16px;">
        ‚úì Doƒürulama Ba≈üvurusu G√∂nder
      </button>
    </div>
  `;
  document.body.appendChild(modal);
};

window.previewIdImage = function(input, side) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const previewEl = document.getElementById(`id${side === 'front' ? 'Front' : 'Back'}Preview`);
    const boxEl = document.getElementById(`id${side === 'front' ? 'Front' : 'Back'}Box`);
    previewEl.innerHTML = `<img src="${e.target.result}" class="id-preview-img">`;
    boxEl.classList.add('has-image');
  };
  reader.readAsDataURL(file);
};

window.submitVerification = async function() {
  const frontInput = document.getElementById('idFrontInput');
  const backInput = document.getElementById('idBackInput');
  const fullName = document.getElementById('verifyFullName')?.value;
  
  if (!frontInput.files[0] || !backInput.files[0] || !fullName) {
    showToast('L√ºtfen t√ºm alanlarƒ± doldurun', 'error');
    return;
  }
  
  showToast('Doƒürulama ba≈üvurunuz alƒ±ndƒ±! ƒ∞nceleme 1-3 g√ºn s√ºrebilir.', 'success');
  localStorage.setItem('verification_pending', 'true');
  document.querySelector('.modal')?.remove();
};

// ========== HESAP AYARLARI ==========
window.openAccountSettings = function() {
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.style.zIndex = '10003';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 450px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2 class="modal-title">‚öôÔ∏è Hesap Ayarlarƒ±</h2>
        <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">G√ºvenlik</div>
        <div class="settings-item" onclick="openForgotPassword()">
          <div class="settings-item-left">
            <div class="settings-item-icon" style="background: rgba(239,68,68,0.1);">üîí</div>
            <div class="settings-item-text">
              <span class="settings-item-title">≈ûifremi Unuttum</span>
              <span class="settings-item-desc">≈ûifrenizi sƒ±fƒ±rlayƒ±n</span>
            </div>
          </div>
          <span>‚ùØ</span>
        </div>
        <div class="settings-item" onclick="openBlockedAccounts()">
          <div class="settings-item-left">
            <div class="settings-item-icon" style="background: rgba(239,68,68,0.1);">üö´</div>
            <div class="settings-item-text">
              <span class="settings-item-title">Engellenen Hesaplar</span>
              <span class="settings-item-desc">${blockedUsers.size} hesap engellendi</span>
            </div>
          </div>
          <span>‚ùØ</span>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Hesaplar</div>
        <div class="settings-item" onclick="openMultiAccountManager()">
          <div class="settings-item-left">
            <div class="settings-item-icon" style="background: rgba(16,185,129,0.1);">üë•</div>
            <div class="settings-item-text">
              <span class="settings-item-title">√áoklu Hesap Y√∂netimi</span>
              <span class="settings-item-desc">Hesap ekle veya deƒüi≈ütir</span>
            </div>
          </div>
          <span>‚ùØ</span>
        </div>
        <div class="settings-item" onclick="openVerificationModal()">
          <div class="settings-item-left">
            <div class="settings-item-icon" style="background: rgba(59,130,246,0.1);">‚úì</div>
            <div class="settings-item-text">
              <span class="settings-item-title">Hesap Doƒürulama</span>
              <span class="settings-item-desc">Mavi tik i√ßin ba≈üvurun</span>
            </div>
          </div>
          <span>‚ùØ</span>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
};

window.openForgotPassword = function() {
  const email = prompt('E-posta adresinizi girin:');
  if (email) {
    showToast('≈ûifre sƒ±fƒ±rlama baƒülantƒ±sƒ± g√∂nderildi!', 'success');
  }
};

window.openBlockedAccounts = function() {
  const blockedList = Array.from(blockedUsers);
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">üö´ Engellenen Hesaplar</h2>
        <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
      </div>
      <div id="blockedList">
        ${blockedList.length === 0 ? '<p style="text-align:center; color:#64748b;">Engellenen hesap yok</p>' : 
          blockedList.map(id => `<div class="blocked-user-item"><span>Kullanƒ±cƒ±: ${id}</span><button class="unblock-btn" onclick="unblockUser('${id}')">Engeli Kaldƒ±r</button></div>`).join('')}
      </div>
    </div>
  `;
  document.body.appendChild(modal);
};

window.openMultiAccountManager = function() {
  const accounts = JSON.parse(localStorage.getItem('agrolink_accounts') || '[]');
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">üë• Hesaplarƒ±m</h2>
        <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
      </div>
      <div class="account-card active">
        <div class="account-card-avatar">${currentUser?.profilePic ? `<img src="${currentUser.profilePic}">` : 'üë§'}</div>
        <div><strong>${currentUser?.name || 'Mevcut Hesap'}</strong><br><small>@${currentUser?.username || 'kullanici'}</small></div>
        <span style="margin-left:auto; color:#10b981;">‚úì</span>
      </div>
      <button class="primary-btn" onclick="addNewAccount()" style="margin-top:16px;">+ Yeni Hesap Ekle</button>
    </div>
  `;
  document.body.appendChild(modal);
};

window.addNewAccount = function() {
  showToast('Yeni hesap eklemek i√ßin √ßƒ±kƒ±≈ü yapƒ±n ve kayƒ±t olun', 'info');
};

// ========== G√ñNDERƒ∞ Fƒ∞LTRELERƒ∞ ==========
const photoFilters = [
  { name: 'Normal', filter: 'none' },
  { name: 'Clarendon', filter: 'contrast(1.2) saturate(1.35)' },
  { name: 'Gingham', filter: 'brightness(1.05) hue-rotate(-10deg)' },
  { name: 'Moon', filter: 'grayscale(1) contrast(1.1) brightness(1.1)' },
  { name: 'Lark', filter: 'contrast(0.9) saturate(1.5) brightness(1.1)' },
  { name: 'Reyes', filter: 'sepia(0.22) brightness(1.1) contrast(0.85) saturate(0.75)' },
  { name: 'Juno', filter: 'saturate(1.4) contrast(1.1) brightness(1.05)' },
  { name: 'Slumber', filter: 'saturate(0.66) brightness(1.05) sepia(0.1)' }
];

window.openPhotoEditor = function(imageData) {
  let selectedFilter = 'none';
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.style.zIndex = '10004';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">üé® Fotoƒüraf D√ºzenle</h2>
        <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
      </div>
      <img id="filterPreview" src="${imageData}" style="width: 100%; border-radius: 12px; margin-bottom: 16px;">
      <div class="filter-grid">
        ${photoFilters.map((f, i) => `
          <div class="filter-item ${i === 0 ? 'selected' : ''}" onclick="applyFilter('${f.filter}', this)" data-filter="${f.filter}">
            <img src="${imageData}" style="filter: ${f.filter}">
            <span class="filter-name">${f.name}</span>
          </div>
        `).join('')}
      </div>
      <button class="primary-btn" onclick="saveFilteredImage()">Uygula</button>
    </div>
  `;
  document.body.appendChild(modal);
};

window.applyFilter = function(filter, el) {
  document.querySelectorAll('.filter-item').forEach(f => f.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('filterPreview').style.filter = filter;
};

console.log('‚úÖ T√ºm yeni √∂zellikler eklendi!');

// ========================================================================
// KULLANICI TALEPLI YENƒ∞ √ñZELLƒ∞KLER - TAM VERSƒ∞YON
// ========================================================================

// ============= 1. TAM EKRAN TAKƒ∞P√áƒ∞/TAKƒ∞P EDƒ∞LENLER MODAL =============
window.showFullscreenFollowers = async function() {
  if (!currentUser) return;
  
  const modal = document.createElement('div');
  modal.className = 'fullscreen-followers-modal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg-light);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    animation: slideUp 0.3s ease;
  `;
  
  modal.innerHTML = `
    <div style="padding: 16px 20px; border-bottom: 1px solid var(--border-light); display: flex; align-items: center; gap: 16px; background: var(--card-light);">
      <button onclick="this.closest('.fullscreen-followers-modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light);">‚Üê</button>
      <h2 style="margin: 0; font-size: 18px; font-weight: 700; color: var(--text-light);">Takip√ßiler</h2>
      <input type="text" id="followerSearchInput" placeholder="Ara..." style="flex: 1; padding: 10px 16px; border-radius: 20px; border: 1px solid var(--border-light); background: rgba(0,0,0,0.05); font-size: 14px; outline: none;">
    </div>
    <div id="fullscreenFollowersList" style="flex: 1; overflow-y: auto; padding: 16px;">
      <div style="text-align: center; padding: 40px; color: #64748b;">Y√ºkleniyor...</div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  try {
    const response = await apiRequest(`/api/users/${currentUser.id}/followers`, { method: 'GET' });
    if (response.ok) {
      const data = await response.json();
      const followers = data.followers || [];
      renderFullscreenUserList(followers, 'fullscreenFollowersList', 'Hen√ºz takip√ßiniz yok');
    }
  } catch (error) {
    console.error('Takip√ßi y√ºkleme hatasƒ±:', error);
  }
  
  // Arama fonksiyonu
  document.getElementById('followerSearchInput')?.addEventListener('input', debounce(function(e) {
    filterUserList(e.target.value, 'fullscreenFollowersList');
  }, 300));
};

window.showFullscreenFollowing = async function() {
  if (!currentUser) return;
  
  const modal = document.createElement('div');
  modal.className = 'fullscreen-following-modal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg-light);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    animation: slideUp 0.3s ease;
  `;
  
  modal.innerHTML = `
    <div style="padding: 16px 20px; border-bottom: 1px solid var(--border-light); display: flex; align-items: center; gap: 16px; background: var(--card-light);">
      <button onclick="this.closest('.fullscreen-following-modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light);">‚Üê</button>
      <h2 style="margin: 0; font-size: 18px; font-weight: 700; color: var(--text-light);">Takip Edilenler</h2>
      <input type="text" id="followingSearchInput" placeholder="Ara..." style="flex: 1; padding: 10px 16px; border-radius: 20px; border: 1px solid var(--border-light); background: rgba(0,0,0,0.05); font-size: 14px; outline: none;">
    </div>
    <div id="fullscreenFollowingList" style="flex: 1; overflow-y: auto; padding: 16px;">
      <div style="text-align: center; padding: 40px; color: #64748b;">Y√ºkleniyor...</div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  try {
    const response = await apiRequest(`/api/users/${currentUser.id}/following`, { method: 'GET' });
    if (response.ok) {
      const data = await response.json();
      const following = data.following || [];
      renderFullscreenUserList(following, 'fullscreenFollowingList', 'Hen√ºz kimseyi takip etmiyorsunuz');
    }
  } catch (error) {
    console.error('Takip edilenler y√ºkleme hatasƒ±:', error);
  }
  
  document.getElementById('followingSearchInput')?.addEventListener('input', debounce(function(e) {
    filterUserList(e.target.value, 'fullscreenFollowingList');
  }, 300));
};

function renderFullscreenUserList(users, containerId, emptyMessage) {
  const container = document.getElementById(containerId);
  if (!container) return;
  
  if (users.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 60px 20px;">
        <div style="font-size: 48px; margin-bottom: 16px;">üë•</div>
        <p style="color: #64748b; font-size: 16px;">${emptyMessage}</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = users.map(user => {
    const profilePicUrl = user.profilePic ? 
      (user.profilePic.startsWith('http') ? user.profilePic : API_BASE + user.profilePic) : '';
    const isVerified = user.isVerified || false;
    
    return `
      <div class="fullscreen-user-item" data-username="${user.username}" data-name="${user.name || ''}" style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--card-light); border-radius: 16px; margin-bottom: 10px; cursor: pointer; border: 1px solid var(--border-light); transition: all 0.3s ease;" onclick="viewUserProfile('${user.id}'); document.querySelector('.fullscreen-followers-modal, .fullscreen-following-modal')?.remove();">
        <div style="width: 56px; height: 56px; border-radius: 50%; overflow: hidden; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #10b981, #059669); color: white; font-size: 24px; border: 3px solid rgba(16,185,129,0.3);">
          ${profilePicUrl ? `<img src="${profilePicUrl}" style="width: 100%; height: 100%; object-fit: cover;">` : 'üë§'}
        </div>
        <div style="flex: 1;">
          <div style="font-weight: 700; font-size: 16px; color: var(--text-light); display: flex; align-items: center; gap: 6px;">
            ${user.name || user.username}
            ${isVerified ? '<span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 50%; font-size: 10px; color: white;">‚úì</span>' : ''}
          </div>
          <div style="font-size: 14px; color: #64748b;">@${user.username}</div>
          ${user.bio ? `<div style="font-size: 13px; color: #94a3b8; margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;">${user.bio}</div>` : ''}
        </div>
        <button onclick="event.stopPropagation(); toggleFollowFromList('${user.id}', this)" style="padding: 10px 20px; border-radius: 20px; border: none; font-weight: 700; font-size: 13px; cursor: pointer; transition: all 0.3s ease; ${user.isFollowing ? 'background: rgba(0,0,0,0.1); color: #64748b;' : 'background: linear-gradient(135deg, #10b981, #059669); color: white; box-shadow: 0 4px 12px rgba(16,185,129,0.3);'}">
          ${user.isFollowing ? 'Takip Ediliyor' : 'Takip Et'}
        </button>
      </div>
    `;
  }).join('');
}

function filterUserList(query, containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;
  
  const items = container.querySelectorAll('.fullscreen-user-item');
  const lowerQuery = query.toLowerCase();
  
  items.forEach(item => {
    const username = item.dataset.username?.toLowerCase() || '';
    const name = item.dataset.name?.toLowerCase() || '';
    
    if (username.includes(lowerQuery) || name.includes(lowerQuery)) {
      item.style.display = 'flex';
    } else {
      item.style.display = 'none';
    }
  });
}

window.toggleFollowFromList = async function(userId, btn) {
  try {
    const isFollowing = btn.textContent.includes('Ediliyor');
    const response = await apiRequest(`/api/users/${userId}/follow`, { method: 'POST' });
    
    if (response.ok) {
      if (isFollowing) {
        btn.textContent = 'Takip Et';
        btn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
        btn.style.color = 'white';
      } else {
        btn.textContent = 'Takip Ediliyor';
        btn.style.background = 'rgba(0,0,0,0.1)';
        btn.style.color = '#64748b';
      }
      showToast(isFollowing ? 'Takip bƒ±rakƒ±ldƒ±' : 'Takip edildi! üéâ', 'success');
    }
  } catch (error) {
    console.error('Takip hatasƒ±:', error);
  }
};

// Override mevcut fonksiyonlarƒ±
window.showFollowersList = showFullscreenFollowers;
window.showFollowingList = showFullscreenFollowing;

// ============= 2. Hƒ∞KAYE GELƒ∞≈ûTƒ∞RMELERƒ∞ =============
// Anket, Soru-Cevap, Emoji Slider, Geri Sayƒ±m, Link Ekleme

window.openAdvancedStoryCreator = function() {
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.style.zIndex = '10005';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2 class="modal-title">üì∏ Hikaye Olu≈ütur</h2>
        <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
      </div>
      
      <!-- Medya Se√ßimi -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; padding: 40px; border: 2px dashed var(--border-light); border-radius: 16px; text-align: center; cursor: pointer; transition: all 0.3s ease;" onclick="document.getElementById('advStoryMedia').click()">
          <div style="font-size: 48px; margin-bottom: 12px;">üì∑</div>
          <div style="color: var(--primary-color); font-weight: 700;">Fotoƒüraf veya Video Se√ß</div>
          <div style="color: #64748b; font-size: 13px; margin-top: 8px;">veya s√ºr√ºkle bƒ±rak</div>
        </label>
        <input type="file" id="advStoryMedia" accept="image/*,video/*" style="display: none;" onchange="previewStoryMedia(this)">
        <div id="storyMediaPreviewContainer" style="margin-top: 16px;"></div>
      </div>
      
      <!-- Metin -->
      <div class="form-group">
        <label class="form-label">‚úçÔ∏è Metin Ekle</label>
        <textarea id="advStoryText" class="form-input" rows="2" placeholder="Hikayenize metin ekleyin..." style="resize: none;"></textarea>
      </div>
      
      <!-- Filtre Se√ßimi -->
      <div class="form-group">
        <label class="form-label">üé® Filtre</label>
        <div id="storyFilterGrid" style="display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px;">
          ${photoFilters.map((f, i) => `
            <div class="story-filter-option ${i === 0 ? 'selected' : ''}" data-filter="${f.filter}" onclick="selectStoryFilter(this)" style="min-width: 60px; text-align: center; cursor: pointer; padding: 8px; border-radius: 12px; border: 2px solid ${i === 0 ? '#10b981' : 'transparent'};">
              <div style="font-size: 11px; color: var(--text-light); font-weight: 600;">${f.name}</div>
            </div>
          `).join('')}
        </div>
      </div>
      
      <!-- M√ºzik -->
      <div class="form-group">
        <label class="form-label">üéµ M√ºzik Ekle</label>
        <div style="display: flex; gap: 10px;">
          <input type="text" id="storyMusicSearch" class="form-input" placeholder="≈ûarkƒ± ara..." style="flex: 1;">
          <button type="button" onclick="searchStoryMusic()" style="padding: 12px 20px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer;">üîç</button>
        </div>
        <div id="storyMusicResults" style="margin-top: 12px; max-height: 150px; overflow-y: auto;"></div>
      </div>
      
      <!-- Etkile≈üim Eklentileri -->
      <div class="form-group">
        <label class="form-label">‚ú® Etkile≈üim Ekle</label>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
          <button type="button" onclick="addStoryPoll()" style="padding: 16px; background: rgba(16,185,129,0.1); border: 2px solid rgba(16,185,129,0.3); border-radius: 16px; cursor: pointer; text-align: center; transition: all 0.3s ease;">
            <div style="font-size: 24px; margin-bottom: 6px;">üìä</div>
            <div style="font-size: 12px; font-weight: 700; color: var(--primary-color);">Anket</div>
          </button>
          <button type="button" onclick="addStoryQuestion()" style="padding: 16px; background: rgba(239,68,68,0.1); border: 2px solid rgba(239,68,68,0.3); border-radius: 16px; cursor: pointer; text-align: center; transition: all 0.3s ease;">
            <div style="font-size: 24px; margin-bottom: 6px;">‚ùì</div>
            <div style="font-size: 12px; font-weight: 700; color: #ef4444;">Soru-Cevap</div>
          </button>
          <button type="button" onclick="addEmojiSlider()" style="padding: 16px; background: rgba(245,158,11,0.1); border: 2px solid rgba(245,158,11,0.3); border-radius: 16px; cursor: pointer; text-align: center; transition: all 0.3s ease;">
            <div style="font-size: 24px; margin-bottom: 6px;">üòç</div>
            <div style="font-size: 12px; font-weight: 700; color: #f59e0b;">Emoji Slider</div>
          </button>
          <button type="button" onclick="addCountdown()" style="padding: 16px; background: rgba(59,130,246,0.1); border: 2px solid rgba(59,130,246,0.3); border-radius: 16px; cursor: pointer; text-align: center; transition: all 0.3s ease;">
            <div style="font-size: 24px; margin-bottom: 6px;">‚è∞</div>
            <div style="font-size: 12px; font-weight: 700; color: #3b82f6;">Geri Sayƒ±m</div>
          </button>
          <button type="button" onclick="addStoryLink()" style="padding: 16px; background: rgba(139,92,246,0.1); border: 2px solid rgba(139,92,246,0.3); border-radius: 16px; cursor: pointer; text-align: center; transition: all 0.3s ease;">
            <div style="font-size: 24px; margin-bottom: 6px;">üîó</div>
            <div style="font-size: 12px; font-weight: 700; color: #8b5cf6;">Link Ekle</div>
          </button>
          <button type="button" onclick="addStoryLocation()" style="padding: 16px; background: rgba(20,184,166,0.1); border: 2px solid rgba(20,184,166,0.3); border-radius: 16px; cursor: pointer; text-align: center; transition: all 0.3s ease;">
            <div style="font-size: 24px; margin-bottom: 6px;">üìç</div>
            <div style="font-size: 12px; font-weight: 700; color: #14b8a6;">Konum</div>
          </button>
        </div>
      </div>
      
      <!-- Eklenen √ñƒüeler -->
      <div id="storyAddedItems" style="margin-bottom: 20px;"></div>
      
      <button class="primary-btn" onclick="publishAdvancedStory()">üöÄ Hikayeyi Payla≈ü</button>
    </div>
  `;
  document.body.appendChild(modal);
};

window.previewStoryMedia = function(input) {
  const file = input.files[0];
  if (!file) return;
  
  const container = document.getElementById('storyMediaPreviewContainer');
  const url = URL.createObjectURL(file);
  
  if (file.type.startsWith('video')) {
    container.innerHTML = `
      <div style="position: relative; border-radius: 16px; overflow: hidden;">
        <video src="${url}" controls style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 16px;"></video>
        <button onclick="document.getElementById('advStoryMedia').value=''; this.parentElement.remove();" style="position: absolute; top: 10px; right: 10px; width: 32px; height: 32px; border-radius: 50%; background: rgba(0,0,0,0.7); color: white; border: none; cursor: pointer; font-size: 18px;">√ó</button>
      </div>
    `;
  } else {
    container.innerHTML = `
      <div style="position: relative; border-radius: 16px; overflow: hidden;">
        <img src="${url}" id="storyPreviewImage" style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 16px;">
        <button onclick="document.getElementById('advStoryMedia').value=''; this.parentElement.remove();" style="position: absolute; top: 10px; right: 10px; width: 32px; height: 32px; border-radius: 50%; background: rgba(0,0,0,0.7); color: white; border: none; cursor: pointer; font-size: 18px;">√ó</button>
      </div>
    `;
  }
};

window.selectStoryFilter = function(el) {
  document.querySelectorAll('.story-filter-option').forEach(f => {
    f.classList.remove('selected');
    f.style.border = '2px solid transparent';
  });
  el.classList.add('selected');
  el.style.border = '2px solid #10b981';
  
  const filter = el.dataset.filter;
  const preview = document.getElementById('storyPreviewImage');
  if (preview) preview.style.filter = filter;
};

window.searchStoryMusic = function() {
  const query = document.getElementById('storyMusicSearch')?.value;
  if (!query) return;
  
  // Mock m√ºzik sonu√ßlarƒ±
  const mockMusic = [
    { id: 1, title: 'Trending Song 1', artist: 'Artist Name', duration: '3:24' },
    { id: 2, title: 'Popular Track', artist: 'Another Artist', duration: '2:55' },
    { id: 3, title: 'Viral Hit', artist: 'Famous Singer', duration: '3:12' }
  ];
  
  const container = document.getElementById('storyMusicResults');
  container.innerHTML = mockMusic.map(m => `
    <div onclick="selectStoryMusic('${m.title}', '${m.artist}')" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(0,0,0,0.03); border-radius: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.3s ease;">
      <div style="width: 44px; height: 44px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px;">üéµ</div>
      <div style="flex: 1;">
        <div style="font-weight: 700; color: var(--text-light);">${m.title}</div>
        <div style="font-size: 13px; color: #64748b;">${m.artist} ‚Ä¢ ${m.duration}</div>
      </div>
      <span style="color: var(--primary-color); font-size: 20px;">+</span>
    </div>
  `).join('');
};

window.selectStoryMusic = function(title, artist) {
  const container = document.getElementById('storyAddedItems');
  container.innerHTML += `
    <div class="story-added-item" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(139,92,246,0.1); border-radius: 12px; margin-bottom: 10px;">
      <span style="font-size: 24px;">üéµ</span>
      <div style="flex: 1;">
        <div style="font-weight: 700; color: var(--text-light);">${title}</div>
        <div style="font-size: 13px; color: #64748b;">${artist}</div>
      </div>
      <button onclick="this.parentElement.remove()" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 18px;">√ó</button>
    </div>
  `;
  showToast('M√ºzik eklendi! üéµ', 'success');
};

window.storyInteractions = [];

window.addStoryPoll = function() {
  const pollModal = document.createElement('div');
  pollModal.className = 'modal active';
  pollModal.style.zIndex = '10006';
  pollModal.innerHTML = `
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h2 class="modal-title">üìä Anket Olu≈ütur</h2>
        <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
      </div>
      <div class="form-group">
        <label class="form-label">Soru</label>
        <input type="text" id="pollQuestion" class="form-input" placeholder="Sorunuzu yazƒ±n...">
      </div>
      <div class="form-group">
        <label class="form-label">Se√ßenekler</label>
        <input type="text" id="pollOption1" class="form-input" placeholder="Se√ßenek 1" style="margin-bottom: 10px;">
        <input type="text" id="pollOption2" class="form-input" placeholder="Se√ßenek 2" style="margin-bottom: 10px;">
        <input type="text" id="pollOption3" class="form-input" placeholder="Se√ßenek 3 (opsiyonel)" style="margin-bottom: 10px;">
        <input type="text" id="pollOption4" class="form-input" placeholder="Se√ßenek 4 (opsiyonel)">
      </div>
      <button class="primary-btn" onclick="savePoll()">Anketi Ekle</button>
    </div>
  `;
  document.body.appendChild(pollModal);
};

window.savePoll = function() {
  const question = document.getElementById('pollQuestion')?.value;
  const opt1 = document.getElementById('pollOption1')?.value;
  const opt2 = document.getElementById('pollOption2')?.value;
  const opt3 = document.getElementById('pollOption3')?.value;
  const opt4 = document.getElementById('pollOption4')?.value;
  
  if (!question || !opt1 || !opt2) {
    showToast('Soru ve en az 2 se√ßenek gerekli', 'error');
    return;
  }
  
  const options = [opt1, opt2, opt3, opt4].filter(Boolean);
  storyInteractions.push({ type: 'poll', question, options });
  
  const container = document.getElementById('storyAddedItems');
  container.innerHTML += `
    <div class="story-added-item" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(16,185,129,0.1); border-radius: 12px; margin-bottom: 10px;">
      <span style="font-size: 24px;">üìä</span>
      <div style="flex: 1;">
        <div style="font-weight: 700; color: var(--text-light);">Anket: ${question}</div>
        <div style="font-size: 13px; color: #64748b;">${options.length} se√ßenek</div>
      </div>
      <button onclick="this.parentElement.remove()" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 18px;">√ó</button>
    </div>
  `;
  
  document.querySelector('.modal[style*="10006"]')?.remove();
  showToast('Anket eklendi! üìä', 'success');
};

window.addStoryQuestion = function() {
  const question = prompt('Soru kutusundaki soruyu yazƒ±n:');
  if (!question) return;
  
  storyInteractions.push({ type: 'question', question });
  
  const container = document.getElementById('storyAddedItems');
  container.innerHTML += `
    <div class="story-added-item" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(239,68,68,0.1); border-radius: 12px; margin-bottom: 10px;">
      <span style="font-size: 24px;">‚ùì</span>
      <div style="flex: 1;">
        <div style="font-weight: 700; color: var(--text-light);">Soru-Cevap</div>
        <div style="font-size: 13px; color: #64748b;">${question}</div>
      </div>
      <button onclick="this.parentElement.remove()" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 18px;">√ó</button>
    </div>
  `;
  showToast('Soru-Cevap eklendi! ‚ùì', 'success');
};

window.addEmojiSlider = function() {
  const question = prompt('Slider sorusunu yazƒ±n (√∂rn: Bu ≈üarkƒ±yƒ± ne kadar sevdiniz?)');
  const emoji = prompt('Emoji se√ßin (√∂rn: üòç, üî•, ‚ù§Ô∏è)') || 'üòç';
  if (!question) return;
  
  storyInteractions.push({ type: 'emoji_slider', question, emoji });
  
  const container = document.getElementById('storyAddedItems');
  container.innerHTML += `
    <div class="story-added-item" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(245,158,11,0.1); border-radius: 12px; margin-bottom: 10px;">
      <span style="font-size: 24px;">${emoji}</span>
      <div style="flex: 1;">
        <div style="font-weight: 700; color: var(--text-light);">Emoji Slider</div>
        <div style="font-size: 13px; color: #64748b;">${question}</div>
      </div>
      <button onclick="this.parentElement.remove()" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 18px;">√ó</button>
    </div>
  `;
  showToast('Emoji Slider eklendi! ' + emoji, 'success');
};

window.addCountdown = function() {
  const name = prompt('Geri sayƒ±m adƒ± (√∂rn: Etkinlik Ba≈ülangƒ±cƒ±)');
  const dateStr = prompt('Tarih ve saat (√∂rn: 2025-12-31 23:59)');
  if (!name || !dateStr) return;
  
  storyInteractions.push({ type: 'countdown', name, endDate: dateStr });
  
  const container = document.getElementById('storyAddedItems');
  container.innerHTML += `
    <div class="story-added-item" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(59,130,246,0.1); border-radius: 12px; margin-bottom: 10px;">
      <span style="font-size: 24px;">‚è∞</span>
      <div style="flex: 1;">
        <div style="font-weight: 700; color: var(--text-light);">Geri Sayƒ±m: ${name}</div>
        <div style="font-size: 13px; color: #64748b;">${dateStr}</div>
      </div>
      <button onclick="this.parentElement.remove()" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 18px;">√ó</button>
    </div>
  `;
  showToast('Geri sayƒ±m eklendi! ‚è∞', 'success');
};

window.addStoryLink = function() {
  const url = prompt('Baƒülantƒ± URL\'si:');
  const text = prompt('Buton metni (√∂rn: Daha fazla)') || 'Daha Fazla';
  if (!url) return;
  
  storyInteractions.push({ type: 'link', url, text });
  
  const container = document.getElementById('storyAddedItems');
  container.innerHTML += `
    <div class="story-added-item" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(139,92,246,0.1); border-radius: 12px; margin-bottom: 10px;">
      <span style="font-size: 24px;">üîó</span>
      <div style="flex: 1;">
        <div style="font-weight: 700; color: var(--text-light);">${text}</div>
        <div style="font-size: 13px; color: #64748b;">${url}</div>
      </div>
      <button onclick="this.parentElement.remove()" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 18px;">√ó</button>
    </div>
  `;
  showToast('Link eklendi! üîó', 'success');
};

window.addStoryLocation = function() {
  const location = prompt('Konum adƒ±:');
  if (!location) return;
  
  storyInteractions.push({ type: 'location', name: location });
  
  const container = document.getElementById('storyAddedItems');
  container.innerHTML += `
    <div class="story-added-item" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(20,184,166,0.1); border-radius: 12px; margin-bottom: 10px;">
      <span style="font-size: 24px;">üìç</span>
      <div style="flex: 1;">
        <div style="font-weight: 700; color: var(--text-light);">Konum</div>
        <div style="font-size: 13px; color: #64748b;">${location}</div>
      </div>
      <button onclick="this.parentElement.remove()" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 18px;">√ó</button>
    </div>
  `;
  showToast('Konum eklendi! üìç', 'success');
};

window.publishAdvancedStory = async function() {
  const mediaInput = document.getElementById('advStoryMedia');
  const text = document.getElementById('advStoryText')?.value || '';
  const selectedFilter = document.querySelector('.story-filter-option.selected')?.dataset.filter || 'none';
  
  if (!mediaInput?.files[0]) {
    showToast('L√ºtfen medya se√ßin', 'error');
    return;
  }
  
  const formData = new FormData();
  formData.append('media', mediaInput.files[0]);
  formData.append('text', text);
  formData.append('filter', selectedFilter);
  formData.append('interactions', JSON.stringify(storyInteractions));
  
  try {
    showToast('Hikaye payla≈üƒ±lƒ±yor...', 'info');
    
    const response = await apiRequest('/api/stories', {
      method: 'POST',
      body: formData,
      headers: {}
    });
    
    if (response.ok) {
      showToast('Hikaye payla≈üƒ±ldƒ±! üéâ', 'success');
      document.querySelector('.modal')?.remove();
      storyInteractions = [];
      if (window.loadStories) loadStories();
    } else {
      throw new Error('Failed');
    }
  } catch (error) {
    console.error('Hikaye payla≈üma hatasƒ±:', error);
    showToast('Hikaye payla≈üƒ±lamadƒ±', 'error');
  }
};

// ============= 3. Hƒ∞KAYE AR≈ûƒ∞Vƒ∞ =============
window.openStoryArchive = async function() {
  const modal = document.createElement('div');
  modal.className = 'fullscreen-archive-modal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg-light);
    z-index: 9999;
    display: flex;
    flex-direction: column;
  `;
  
  modal.innerHTML = `
    <div style="padding: 16px 20px; border-bottom: 1px solid var(--border-light); display: flex; align-items: center; gap: 16px;">
      <button onclick="this.closest('.fullscreen-archive-modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light);">‚Üê</button>
      <h2 style="margin: 0; font-size: 18px; font-weight: 700; color: var(--text-light);">üì¶ Hikaye Ar≈üivi</h2>
    </div>
    <div id="storyArchiveContent" style="flex: 1; overflow-y: auto; padding: 16px;">
      <div style="text-align: center; padding: 40px; color: #64748b;">Y√ºkleniyor...</div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  try {
    const response = await apiRequest('/api/stories/archive', { method: 'GET' });
    if (response.ok) {
      const data = await response.json();
      const stories = data.stories || [];
      renderStoryArchive(stories);
    } else {
      // Mock data
      renderStoryArchive([
        { id: 1, mediaUrl: 'https://picsum.photos/200/350', createdAt: new Date().toISOString(), views: 45 },
        { id: 2, mediaUrl: 'https://picsum.photos/200/351', createdAt: new Date(Date.now() - 86400000).toISOString(), views: 32 }
      ]);
    }
  } catch (error) {
    console.error('Ar≈üiv y√ºkleme hatasƒ±:', error);
    document.getElementById('storyArchiveContent').innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;">Ar≈üiv y√ºklenemedi</div>';
  }
};

function renderStoryArchive(stories) {
  const container = document.getElementById('storyArchiveContent');
  if (!container) return;
  
  if (stories.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 60px 20px;">
        <div style="font-size: 48px; margin-bottom: 16px;">üì¶</div>
        <p style="color: #64748b; font-size: 16px;">Ar≈üivde hikaye yok</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = `
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
      ${stories.map(s => {
        const mediaUrl = s.mediaUrl?.startsWith('http') ? s.mediaUrl : API_BASE + s.mediaUrl;
        return `
          <div style="aspect-ratio: 9/16; border-radius: 12px; overflow: hidden; position: relative; cursor: pointer; background: #000;" onclick="openArchivedStory('${s.id}')">
            <img src="${mediaUrl}" style="width: 100%; height: 100%; object-fit: cover;">
            <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 12px; background: linear-gradient(transparent, rgba(0,0,0,0.8));">
              <div style="color: white; font-size: 12px; display: flex; align-items: center; gap: 6px;">
                <span>üëÅÔ∏è ${s.views || 0}</span>
              </div>
              <div style="color: rgba(255,255,255,0.7); font-size: 11px;">${formatTime(s.createdAt)}</div>
            </div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

window.openArchivedStory = function(storyId) {
  showToast('Ar≈üivlenmi≈ü hikaye a√ßƒ±lƒ±yor...', 'info');
  // openStoryViewer mantƒ±ƒüƒ± ile entegre edilebilir
};

// ============= 4. KE≈ûFET FULLSCREEN G√ñR√úNT√úLEME =============
window.openExploreFullscreen = async function(postIndex) {
  const posts = window.explorePosts || feedPosts || [];
  if (!posts.length) return;
  
  const modal = document.createElement('div');
  modal.className = 'explore-fullscreen-modal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    z-index: 9999;
    overflow-y: scroll;
    scroll-snap-type: y mandatory;
  `;
  
  // Kapatma butonu
  const closeBtn = document.createElement('button');
  closeBtn.innerHTML = '√ó';
  closeBtn.style.cssText = `
    position: fixed;
    top: 20px;
    left: 20px;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    font-size: 28px;
    cursor: pointer;
    z-index: 10001;
    backdrop-filter: blur(10px);
  `;
  closeBtn.onclick = () => modal.remove();
  modal.appendChild(closeBtn);
  
  posts.forEach((post, index) => {
    const mediaUrl = post.mediaUrl?.startsWith('http') ? post.mediaUrl : API_BASE + (post.mediaUrl || '');
    const profilePicUrl = post.userProfilePic?.startsWith('http') ? post.userProfilePic : API_BASE + (post.userProfilePic || '');
    
    const item = document.createElement('div');
    item.style.cssText = `
      width: 100%;
      height: 100vh;
      scroll-snap-align: start;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
    `;
    
    if (post.mediaType === 'video') {
      item.innerHTML = `<video src="${mediaUrl}" ${index === postIndex ? 'autoplay' : ''} loop playsinline style="width: 100%; height: 100%; object-fit: contain;"></video>`;
    } else {
      item.innerHTML = `<img src="${mediaUrl}" style="width: 100%; height: 100%; object-fit: contain;">`;
    }
    
    // Kullanƒ±cƒ± bilgisi
    const userInfo = document.createElement('div');
    userInfo.style.cssText = `
      position: absolute;
      bottom: 100px;
      left: 20px;
      right: 80px;
      color: white;
    `;
    userInfo.innerHTML = `
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
        <div style="width: 44px; height: 44px; border-radius: 50%; border: 2px solid white; overflow: hidden; background: #10b981; display: flex; align-items: center; justify-content: center;" onclick="event.stopPropagation(); viewUserProfile('${post.userId}'); document.querySelector('.explore-fullscreen-modal').remove();">
          ${profilePicUrl ? `<img src="${profilePicUrl}" style="width: 100%; height: 100%; object-fit: cover;">` : 'üë§'}
        </div>
        <div>
          <div style="font-weight: 700; font-size: 16px; display: flex; align-items: center; gap: 6px;">
            ${post.username || 'Kullanƒ±cƒ±'}
            ${post.isUserVerified ? '<span style="display: inline-flex; width: 18px; height: 18px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 50%; font-size: 10px; color: white; align-items: center; justify-content: center;">‚úì</span>' : ''}
          </div>
        </div>
      </div>
      <div style="font-size: 14px; line-height: 1.4; max-height: 60px; overflow: hidden; text-shadow: 0 1px 3px rgba(0,0,0,0.5);">${post.content || ''}</div>
    `;
    item.appendChild(userInfo);
    
    // Aksiyonlar
    const actions = document.createElement('div');
    actions.style.cssText = `
      position: absolute;
      right: 16px;
      bottom: 150px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    `;
    actions.innerHTML = `
      <button onclick="toggleReelLike('${post.id}', this)" data-liked="${post.isLiked || false}" style="width: 48px; height: 48px; border-radius: 50%; background: rgba(255,255,255,0.2); border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; backdrop-filter: blur(10px);">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="${post.isLiked ? '#ef4444' : 'none'}" stroke="${post.isLiked ? '#ef4444' : 'white'}" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
        <span style="color: white; font-size: 12px;">${post.likeCount || 0}</span>
      </button>
      <button onclick="openCommentsModal('${post.id}')" style="width: 48px; height: 48px; border-radius: 50%; background: rgba(255,255,255,0.2); border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; backdrop-filter: blur(10px);">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
        <span style="color: white; font-size: 12px;">${post.commentCount || 0}</span>
      </button>
    `;
    item.appendChild(actions);
    
    modal.appendChild(item);
  });
  
  document.body.appendChild(modal);
  
  // Ba≈ülangƒ±√ß pozisyonuna git
  setTimeout(() => {
    const items = modal.children;
    if (items[postIndex + 1]) {
      items[postIndex + 1].scrollIntoView();
    }
  }, 100);
  
  // Video autoplay
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      const video = entry.target.querySelector('video');
      if (video) {
        if (entry.isIntersecting) {
          video.play().catch(() => {});
        } else {
          video.pause();
        }
      }
    });
  }, { threshold: 0.6 });
  
  modal.querySelectorAll('div[style*="scroll-snap-align"]').forEach(item => observer.observe(item));
};

// ============= 5. MESAJLA≈ûMA GELƒ∞≈ûTƒ∞RMELERƒ∞ =============
// Sesli mesaj, g√∂rsel/video g√∂nderme, mesaj beƒüenme/silme, okundu bilgisi, grup sohbeti

window.startVoiceRecording = async function() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mediaRecorder = new MediaRecorder(stream);
    const chunks = [];
    
    window.voiceRecorder = mediaRecorder;
    
    mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
    mediaRecorder.onstop = () => {
      const blob = new Blob(chunks, { type: 'audio/webm' });
      window.recordedVoice = blob;
      stream.getTracks().forEach(t => t.stop());
      showToast('Ses kaydedildi! G√∂ndermek i√ßin mikrofona tekrar basƒ±n.', 'success');
    };
    
    mediaRecorder.start();
    showToast('üé§ Kayƒ±t ba≈üladƒ±... Durdurmak i√ßin tekrar basƒ±n.', 'info');
    
    // UI g√ºncelle
    const voiceBtn = document.getElementById('voiceMessageBtn');
    if (voiceBtn) {
      voiceBtn.innerHTML = '‚èπÔ∏è';
      voiceBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
      voiceBtn.onclick = stopVoiceRecording;
    }
  } catch (error) {
    console.error('Mikrofon eri≈üim hatasƒ±:', error);
    showToast('Mikrofon eri≈üimi reddedildi', 'error');
  }
};

window.stopVoiceRecording = function() {
  if (window.voiceRecorder && window.voiceRecorder.state !== 'inactive') {
    window.voiceRecorder.stop();
  }
  
  const voiceBtn = document.getElementById('voiceMessageBtn');
  if (voiceBtn) {
    voiceBtn.innerHTML = 'üé§';
    voiceBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
    voiceBtn.onclick = startVoiceRecording;
  }
};

window.sendVoiceMessage = async function() {
  if (!window.recordedVoice || !activeChatUser) return;
  
  const formData = new FormData();
  formData.append('audio', window.recordedVoice, 'voice.webm');
  formData.append('receiverId', activeChatUser.id);
  formData.append('type', 'voice');
  
  try {
    const response = await apiRequest('/api/messages/voice', {
      method: 'POST',
      body: formData,
      headers: {}
    });
    
    if (response.ok) {
      showToast('Sesli mesaj g√∂nderildi! üé§', 'success');
      window.recordedVoice = null;
    }
  } catch (error) {
    console.error('Sesli mesaj g√∂nderme hatasƒ±:', error);
    showToast('Sesli mesaj g√∂nderilemedi', 'error');
  }
};

window.likeMessage = async function(messageId, btn) {
  try {
    const response = await apiRequest(`/api/messages/${messageId}/like`, { method: 'POST' });
    if (response.ok) {
      btn.innerHTML = '‚ù§Ô∏è';
      btn.style.color = '#ef4444';
      showToast('Mesaj beƒüenildi!', 'success');
    }
  } catch (error) {
    console.error('Mesaj beƒüenme hatasƒ±:', error);
  }
};

window.deleteMessage = async function(messageId, btn) {
  if (!confirm('Bu mesajƒ± silmek istediƒüinizden emin misiniz?')) return;
  
  try {
    const response = await apiRequest(`/api/messages/${messageId}`, { method: 'DELETE' });
    if (response.ok) {
      const msgEl = btn.closest('.message');
      if (msgEl) {
        msgEl.style.opacity = '0';
        setTimeout(() => msgEl.remove(), 300);
      }
      showToast('Mesaj silindi', 'success');
    }
  } catch (error) {
    console.error('Mesaj silme hatasƒ±:', error);
  }
};

window.openGroupChatCreator = function() {
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.style.zIndex = '10005';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header">
        <h2 class="modal-title">üë• Grup Sohbeti Olu≈ütur</h2>
        <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
      </div>
      <div class="form-group">
        <label class="form-label">Grup Adƒ±</label>
        <input type="text" id="groupName" class="form-input" placeholder="Grup adƒ±nƒ± girin...">
      </div>
      <div class="form-group">
        <label class="form-label">Grup Fotoƒürafƒ±</label>
        <input type="file" id="groupPhoto" accept="image/*" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">√úye Ekle</label>
        <input type="text" id="groupMemberSearch" class="form-input" placeholder="Kullanƒ±cƒ± ara...">
        <div id="groupMemberResults" style="margin-top: 12px; max-height: 200px; overflow-y: auto;"></div>
        <div id="selectedGroupMembers" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px;"></div>
      </div>
      <button class="primary-btn" onclick="createGroupChat()">Grup Olu≈ütur</button>
    </div>
  `;
  document.body.appendChild(modal);
  
  // Kullanƒ±cƒ± arama
  document.getElementById('groupMemberSearch')?.addEventListener('input', debounce(async function(e) {
    const query = e.target.value.trim();
    if (query.length < 2) return;
    
    try {
      const response = await apiRequest(`/api/users/search?q=${encodeURIComponent(query)}`);
      if (response.ok) {
        const data = await response.json();
        renderGroupMemberResults(data.users || []);
      }
    } catch (error) {
      console.error('Kullanƒ±cƒ± arama hatasƒ±:', error);
    }
  }, 300));
};

window.selectedGroupMembers = [];

function renderGroupMemberResults(users) {
  const container = document.getElementById('groupMemberResults');
  if (!container) return;
  
  container.innerHTML = users.map(user => {
    const isSelected = selectedGroupMembers.some(m => m.id === user.id);
    return `
      <div onclick="toggleGroupMember('${user.id}', '${user.username}')" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: ${isSelected ? 'rgba(16,185,129,0.1)' : 'rgba(0,0,0,0.03)'}; border-radius: 12px; margin-bottom: 8px; cursor: pointer; border: 2px solid ${isSelected ? '#10b981' : 'transparent'};">
        <div style="width: 40px; height: 40px; border-radius: 50%; background: #10b981; display: flex; align-items: center; justify-content: center; color: white;">üë§</div>
        <div style="flex: 1;">
          <div style="font-weight: 700;">${user.username}</div>
        </div>
        <span style="color: ${isSelected ? '#10b981' : '#64748b'};">${isSelected ? '‚úì' : '+'}</span>
      </div>
    `;
  }).join('');
}

window.toggleGroupMember = function(userId, username) {
  const index = selectedGroupMembers.findIndex(m => m.id === userId);
  if (index > -1) {
    selectedGroupMembers.splice(index, 1);
  } else {
    selectedGroupMembers.push({ id: userId, username });
  }
  
  updateSelectedMembersUI();
};

function updateSelectedMembersUI() {
  const container = document.getElementById('selectedGroupMembers');
  if (!container) return;
  
  container.innerHTML = selectedGroupMembers.map(m => `
    <span onclick="toggleGroupMember('${m.id}', '${m.username}')" style="padding: 6px 12px; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
      ${m.username} <span style="font-size: 16px;">√ó</span>
    </span>
  `).join('');
}

window.createGroupChat = async function() {
  const name = document.getElementById('groupName')?.value;
  const photo = document.getElementById('groupPhoto')?.files[0];
  
  if (!name || selectedGroupMembers.length < 2) {
    showToast('Grup adƒ± ve en az 2 √ºye gerekli', 'error');
    return;
  }
  
  const formData = new FormData();
  formData.append('name', name);
  formData.append('members', JSON.stringify(selectedGroupMembers.map(m => m.id)));
  if (photo) formData.append('photo', photo);
  
  try {
    const response = await apiRequest('/api/chats/group', {
      method: 'POST',
      body: formData,
      headers: {}
    });
    
    if (response.ok) {
      showToast('Grup olu≈üturuldu! üë•', 'success');
      document.querySelector('.modal')?.remove();
      selectedGroupMembers = [];
      loadMessages();
    }
  } catch (error) {
    console.error('Grup olu≈üturma hatasƒ±:', error);
    showToast('Grup olu≈üturulamadƒ±', 'error');
  }
};

// ============= 6. ƒ∞√áERƒ∞K ƒ∞STATƒ∞STƒ∞KLERƒ∞ & ANALƒ∞Z =============
window.openContentStats = async function() {
  const modal = document.createElement('div');
  modal.className = 'fullscreen-stats-modal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg-light);
    z-index: 9999;
    display: flex;
    flex-direction: column;
  `;
  
  modal.innerHTML = `
    <div style="padding: 16px 20px; border-bottom: 1px solid var(--border-light); display: flex; align-items: center; gap: 16px;">
      <button onclick="this.closest('.fullscreen-stats-modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light);">‚Üê</button>
      <h2 style="margin: 0; font-size: 18px; font-weight: 700; color: var(--text-light);">üìä ƒ∞√ßerik ƒ∞statistikleri</h2>
    </div>
    <div style="flex: 1; overflow-y: auto; padding: 16px;">
      <!-- Genel √ñzet -->
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 24px;">
        <div style="background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(16,185,129,0.05)); padding: 20px; border-radius: 16px; text-align: center; border: 1px solid rgba(16,185,129,0.2);">
          <div style="font-size: 32px; font-weight: 900; color: #10b981;" id="totalLikesCount">0</div>
          <div style="font-size: 13px; color: #64748b; font-weight: 600;">Toplam Beƒüeni</div>
        </div>
        <div style="background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(59,130,246,0.05)); padding: 20px; border-radius: 16px; text-align: center; border: 1px solid rgba(59,130,246,0.2);">
          <div style="font-size: 32px; font-weight: 900; color: #3b82f6;" id="totalCommentsCount">0</div>
          <div style="font-size: 13px; color: #64748b; font-weight: 600;">Toplam Yorum</div>
        </div>
        <div style="background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(245,158,11,0.05)); padding: 20px; border-radius: 16px; text-align: center; border: 1px solid rgba(245,158,11,0.2);">
          <div style="font-size: 32px; font-weight: 900; color: #f59e0b;" id="totalViewsCount">0</div>
          <div style="font-size: 13px; color: #64748b; font-weight: 600;">Toplam G√∂r√ºnt√ºlenme</div>
        </div>
        <div style="background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(139,92,246,0.05)); padding: 20px; border-radius: 16px; text-align: center; border: 1px solid rgba(139,92,246,0.2);">
          <div style="font-size: 32px; font-weight: 900; color: #8b5cf6;" id="totalSavesCount">0</div>
          <div style="font-size: 13px; color: #64748b; font-weight: 600;">Kaydetme</div>
        </div>
      </div>
      
      <!-- Takip√ßi Analizi -->
      <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; color: var(--text-light);">üìà Takip√ßi Analizi</h3>
      <div style="background: var(--card-light); padding: 20px; border-radius: 16px; margin-bottom: 24px; border: 1px solid var(--border-light);">
        <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
          <span style="color: #64748b;">Bu hafta kazanƒ±lan</span>
          <span style="font-weight: 700; color: #10b981;">+12</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
          <span style="color: #64748b;">Bu ay kazanƒ±lan</span>
          <span style="font-weight: 700; color: #10b981;">+45</span>
        </div>
        <div style="display: flex; justify-content: space-between;">
          <span style="color: #64748b;">En aktif saat</span>
          <span style="font-weight: 700; color: var(--text-light);">19:00 - 21:00</span>
        </div>
      </div>
      
      <!-- En ƒ∞yi G√∂nderiler -->
      <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; color: var(--text-light);">üèÜ En ƒ∞yi G√∂nderiler</h3>
      <div id="topPostsContainer"></div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // ƒ∞statistikleri y√ºkle
  try {
    const response = await apiRequest('/api/users/stats', { method: 'GET' });
    if (response.ok) {
      const data = await response.json();
      updateStatsUI(data);
    } else {
      // Mock data
      updateStatsUI({
        totalLikes: 1234,
        totalComments: 567,
        totalViews: 8901,
        totalSaves: 234,
        topPosts: []
      });
    }
  } catch (error) {
    console.error('ƒ∞statistik y√ºkleme hatasƒ±:', error);
  }
};

function updateStatsUI(data) {
  document.getElementById('totalLikesCount').textContent = data.totalLikes || 0;
  document.getElementById('totalCommentsCount').textContent = data.totalComments || 0;
  document.getElementById('totalViewsCount').textContent = data.totalViews || 0;
  document.getElementById('totalSavesCount').textContent = data.totalSaves || 0;
}

// ============= 7. TASLAK KAYDETME =============
window.saveDraft = function() {
  const content = document.getElementById('postContent')?.value || '';
  const mediaPreview = document.getElementById('mediaPreview')?.innerHTML || '';
  
  if (!content && !uploadedMediaFile) {
    showToast('Kaydedilecek i√ßerik yok', 'error');
    return;
  }
  
  const drafts = JSON.parse(localStorage.getItem('post_drafts') || '[]');
  drafts.push({
    id: Date.now(),
    content,
    hasMedia: !!uploadedMediaFile,
    createdAt: new Date().toISOString()
  });
  localStorage.setItem('post_drafts', JSON.stringify(drafts));
  
  showToast('Taslak kaydedildi! üìù', 'success');
};

window.openDrafts = function() {
  const drafts = JSON.parse(localStorage.getItem('post_drafts') || '[]');
  
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">üìù Taslaklar</h2>
        <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
      </div>
      <div style="max-height: 400px; overflow-y: auto;">
        ${drafts.length === 0 ? '<div style="text-align: center; padding: 40px; color: #64748b;">Kaydedilmi≈ü taslak yok</div>' : 
          drafts.map(d => `
            <div style="display: flex; align-items: center; gap: 12px; padding: 14px; background: rgba(0,0,0,0.03); border-radius: 12px; margin-bottom: 10px;">
              <div style="flex: 1;">
                <div style="font-weight: 600; color: var(--text-light);">${d.content.substring(0, 50)}${d.content.length > 50 ? '...' : ''}</div>
                <div style="font-size: 12px; color: #64748b;">${formatTime(d.createdAt)}</div>
              </div>
              <button onclick="loadDraft(${d.id})" style="padding: 8px 16px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">Y√ºkle</button>
              <button onclick="deleteDraft(${d.id})" style="padding: 8px 12px; background: rgba(239,68,68,0.1); color: #ef4444; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">√ó</button>
            </div>
          `).join('')}
      </div>
    </div>
  `;
  document.body.appendChild(modal);
};

window.loadDraft = function(draftId) {
  const drafts = JSON.parse(localStorage.getItem('post_drafts') || '[]');
  const draft = drafts.find(d => d.id === draftId);
  
  if (draft) {
    const postContent = document.getElementById('postContent');
    if (postContent) postContent.value = draft.content;
    
    document.querySelector('.modal')?.remove();
    showToast('Taslak y√ºklendi!', 'success');
  }
};

window.deleteDraft = function(draftId) {
  let drafts = JSON.parse(localStorage.getItem('post_drafts') || '[]');
  drafts = drafts.filter(d => d.id !== draftId);
  localStorage.setItem('post_drafts', JSON.stringify(drafts));
  
  document.querySelector('.modal')?.remove();
  openDrafts();
  showToast('Taslak silindi', 'success');
};

// ============= 8. ƒ∞√áERƒ∞K PLANLAMA =============
window.openContentScheduler = function() {
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header">
        <h2 class="modal-title">üìÖ ƒ∞√ßerik Planla</h2>
        <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
      </div>
      <div class="form-group">
        <label class="form-label">Tarih ve Saat</label>
        <input type="datetime-local" id="scheduleDateTime" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">ƒ∞√ßerik</label>
        <textarea id="scheduleContent" class="form-input" rows="3" placeholder="Planlanacak i√ßeriƒüi yazƒ±n..."></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Medya</label>
        <input type="file" id="scheduleMedia" class="form-input" accept="image/*,video/*">
      </div>
      <button class="primary-btn" onclick="schedulePost()">üìÖ Planla</button>
    </div>
  `;
  document.body.appendChild(modal);
};

window.schedulePost = function() {
  const dateTime = document.getElementById('scheduleDateTime')?.value;
  const content = document.getElementById('scheduleContent')?.value;
  
  if (!dateTime || !content) {
    showToast('Tarih ve i√ßerik gerekli', 'error');
    return;
  }
  
  const scheduled = JSON.parse(localStorage.getItem('scheduled_posts') || '[]');
  scheduled.push({
    id: Date.now(),
    content,
    scheduledFor: dateTime,
    createdAt: new Date().toISOString()
  });
  localStorage.setItem('scheduled_posts', JSON.stringify(scheduled));
  
  document.querySelector('.modal')?.remove();
  showToast('G√∂nderi planlandƒ±! üìÖ', 'success');
};

// ============= 9. CANLI YAYIN AR≈ûƒ∞Vƒ∞ =============
window.openLiveArchive = function() {
  const modal = document.createElement('div');
  modal.className = 'fullscreen-live-archive-modal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg-light);
    z-index: 9999;
    display: flex;
    flex-direction: column;
  `;
  
  modal.innerHTML = `
    <div style="padding: 16px 20px; border-bottom: 1px solid var(--border-light); display: flex; align-items: center; gap: 16px;">
      <button onclick="this.closest('.fullscreen-live-archive-modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light);">‚Üê</button>
      <h2 style="margin: 0; font-size: 18px; font-weight: 700; color: var(--text-light);">üì∫ Canlƒ± Yayƒ±n Ar≈üivi</h2>
    </div>
    <div style="flex: 1; overflow-y: auto; padding: 16px;">
      <div style="text-align: center; padding: 60px 20px;">
        <div style="font-size: 48px; margin-bottom: 16px;">üì∫</div>
        <p style="color: #64748b; font-size: 16px;">Hen√ºz ar≈üivlenmi≈ü canlƒ± yayƒ±n yok</p>
        <button onclick="startLiveStream()" style="margin-top: 20px; padding: 14px 28px; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; border-radius: 16px; font-weight: 700; cursor: pointer; font-size: 16px;">üî¥ Canlƒ± Yayƒ±n Ba≈ülat</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
};

window.startLiveStream = function() {
  showToast('Canlƒ± yayƒ±n √∂zelliƒüi yakƒ±nda!', 'info');
};

// ============= 10. YENƒ∞ API ROTALARI =============
/*
Yeni API Rotalarƒ±:
POST /api/stories - Hikaye payla≈üma (filtre, m√ºzik, anket vb. destekli)
GET /api/stories/archive - Hikaye ar≈üivi
POST /api/stories/:id/poll/vote - Anket oylamasƒ±
POST /api/stories/:id/question/answer - Soru yanƒ±tlama
POST /api/stories/:id/slider/vote - Emoji slider oylamasƒ±

POST /api/messages/voice - Sesli mesaj g√∂nderme
POST /api/messages/:id/like - Mesaj beƒüenme
DELETE /api/messages/:id - Mesaj silme
POST /api/chats/group - Grup sohbeti olu≈üturma
GET /api/chats/:id/read - Okundu bilgisi

GET /api/users/stats - Kullanƒ±cƒ± istatistikleri
GET /api/explore/trending - Trend i√ßerikler
GET /api/explore/hashtags - Pop√ºler hashtagler
GET /api/explore/locations - Konum ke≈üfi

POST /api/posts/schedule - ƒ∞√ßerik planlama
GET /api/posts/scheduled - Planlanan i√ßerikler
GET /api/lives/archive - Canlƒ± yayƒ±n ar≈üivi
*/

console.log('üöÄ T√ºm yeni √∂zellikler ba≈üarƒ±yla y√ºklendi!');
console.log('üìå Eklenen √∂zellikler:');
console.log('  ‚úì Tam ekran takip√ßi/takip edilenler listesi');
console.log('  ‚úì Hikaye: Anket, Soru-Cevap, Emoji Slider, Geri Sayƒ±m, Link, M√ºzik');
console.log('  ‚úì Hikaye ar≈üivi');
console.log('  ‚úì Ke≈üfet fullscreen g√∂r√ºnt√ºleme');
console.log('  ‚úì Sesli mesaj, mesaj beƒüenme/silme, grup sohbeti');
console.log('  ‚úì ƒ∞√ßerik istatistikleri ve takip√ßi analizi');
console.log('  ‚úì Taslak kaydetme');
console.log('  ‚úì ƒ∞√ßerik planlama');
console.log('  ‚úì Canlƒ± yayƒ±n ar≈üivi');

</script>
<script>
/* 
   ================================================================
   AGROLINK CUSTOM FIXES & FEATURES (USER REQUESTED)
   ================================================================
*/

// 1. Share/Copy Link Logic (Overwrites existing openShareModal)
window.openShareModal = function(postId) {
    // Generate a link (mocking a real route, works for copy)
    const shareUrl = window.location.origin + '/post/' + postId;
    
    // Copy to clipboard
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(shareUrl).then(() => {
            // Show toast/alert
            if (window.showToast) {
                window.showToast('Baƒülantƒ± kopyalandƒ±! Giri≈ü yapmadan g√∂r√ºnt√ºlenebilir.', 'success');
            } else {
                alert('Baƒülantƒ± kopyalandƒ±! Herkes bu link ile giri≈ü yapmadan g√∂rebilir.');
            }
        }).catch(err => {
            console.error('Kopyalama hatasƒ±:', err);
            prompt('Baƒülantƒ±yƒ± kopyalayƒ±n:', shareUrl);
        });
    } else {
        prompt('Baƒülantƒ±yƒ± kopyalayƒ±n:', shareUrl);
    }
};

// 2. Upload Story Feedback (Overwrites existing uploadStory)
// We retain the logic but add the alerts as requested.
const _originalUploadStory = window.uploadStory;
window.uploadStory = async function() {
    const input = document.getElementById('storyMediaInput');
    const text = document.getElementById('storyText')?.value || '';
    
    if (!input.files[0]) {
        if(window.showToast) window.showToast('L√ºtfen bir fotoƒüraf veya video se√ßin', 'error');
        else alert('L√ºtfen bir fotoƒüraf veya video se√ßin');
        return;
    }

    // User requested: "hikaye ekle butonuna basƒ±nca hikaye ekleniyor desin"
    alert('Hikaye ekleniyor...');

    const submitBtn = document.querySelector('.modal .primary-btn');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'Payla≈üƒ±lƒ±yor...';
    }

    const formData = new FormData();
    formData.append('media', input.files[0]);
    formData.append('text', text);

    try {
        // Use existing apiRequest if available, else fetch
        const response = await (window.apiRequest ? window.apiRequest('/api/stories', {
            method: 'POST',
            body: formData,
            headers: {}
        }) : fetch('/api/stories', { method: 'POST', body: formData }));

        if (response.ok) {
            // User requested: "ekledikten sonra... hikaye eklendi desin" (implied success feedback)
            alert('Hikaye eklendi'); 
            
            document.querySelector('.modal.active')?.remove();
            if(window.loadStories) window.loadStories();
            if(window.showToast) window.showToast('Hikayeniz payla≈üƒ±ldƒ±!', 'success');
        } else {
            throw new Error('Upload failed');
        }
    } catch (error) {
        console.error('Story upload error:', error);
        alert('Hikaye y√ºklenirken bir hata olu≈ütu.');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Hikaye Payla≈ü';
        }
    }
};

// 3. Video Autoplay on Hover (No long press)
document.addEventListener('mouseover', function(e) {
    if (e.target.tagName === 'VIDEO') {
        // "videolu postun √ºst√ºne gelince otomatik oynatƒ±m yapsƒ±n"
        e.target.play().catch(() => {});
    }
}, true);

document.addEventListener('mouseout', function(e) {
    if (e.target.tagName === 'VIDEO') {
        e.target.pause();
    }
}, true);

// 4. Reels Fullscreen & Story Fullscreen Styles
const customStyle = document.createElement('style');
customStyle.textContent = `
    /* Reels videos must be cover (fullscreen fill) */
    .reel-item video, 
    .reels-modal-v2 video, 
    .profile-reel-item video,
    .story-viewer video,
    .fullscreen-media {
        object-fit: cover !important;
        width: 100% !important;
        height: 100% !important;
        max-height: 100vh !important;
    }
    
    /* Ensure My Story viewer is fullscreen */
    .story-modal {
        width: 100% !important;
        height: 100% !important;
        max-width: 100% !important;
        border-radius: 0 !important;
    }
`;
document.head.appendChild(customStyle);

// 5. Fix "Feed Refresh" (Duplicate posts on loadMore)
// We hook into loadMorePosts to ensure deduplication.
// (Assuming loadMorePosts uses 'posts' global array)
if (typeof window.loadMorePosts === 'function') {
    const _originalLoadMore = window.loadMorePosts;
    window.loadMorePosts = function() {
        // Ensure we don't fetch if already loading
        if (window.isLoadingMore) return;
        window.isLoadingMore = true;
        
        _originalLoadMore();
        
        // Reset flag after a delay
        setTimeout(() => { window.isLoadingMore = false; }, 1000);
    };
}

// 6. My Story Click -> Fullscreen
// We attach a listener to intercept clicks on the "My Story" button
document.addEventListener('click', function(e) {
    const myStoryBtn = e.target.closest('#myStoryButton');
    if (myStoryBtn) {
        // If it has the "Hikayem" label (meaning story exists)
        if (myStoryBtn.querySelector('span')?.textContent === 'Hikayem') {
            // The original handler handles the logic, but we ensured CSS makes it fullscreen above.
        }
    }
}, true);

// 7. Background Post Upload
window.originalSharePost = window.sharePost;
window.sharePost = async function() {
    const postText = document.getElementById('postText');
    const postMedia = document.getElementById('postMedia');
    
    if (!postText?.value && (!postMedia || !postMedia.files[0])) {
        if(window.showToast) window.showToast('L√ºtfen bir i√ßerik girin veya medya se√ßin', 'error');
        return;
    }

    const formData = new FormData();
    if (postText) formData.append('content', postText.value);
    if (postMedia?.files[0]) formData.append('media', postMedia.files[0]);

    // Close the modal immediately
    const modal = document.querySelector('.modal.active');
    if (modal) modal.remove();

    // Show immediate success feedback
    if(window.showToast) window.showToast('Payla≈üƒ±lƒ±yor... Arka planda i≈üleniyor.', 'success');
    else alert('Payla≈üƒ±lƒ±yor... Arka planda i≈üleniyor.');

    try {
        const response = await (window.apiRequest ? window.apiRequest('/api/posts', {
            method: 'POST',
            body: formData,
            headers: {}
        }) : fetch('/api/posts', { method: 'POST', body: formData }));

        if (response.ok) {
            if(window.showToast) window.showToast('G√∂nderi ba≈üarƒ±yla payla≈üƒ±ldƒ±!', 'success');
            if(window.refreshFeed) window.refreshFeed();
        } else {
            throw new Error('Upload failed');
        }
    } catch (error) {
        console.error('Background upload error:', error);
        if(window.showToast) window.showToast('G√∂nderi payla≈üƒ±lamadƒ±.', 'error');
    }
    
    // Clear inputs
    if(postText) postText.value = '';
    if(postMedia) postMedia.value = '';
};

// 8. Cache Clearing & Account Management
window.clearCache = function() {
    // Clear local storage (except for account list)
    const accounts = localStorage.getItem('agrolink_accounts');
    localStorage.clear();
    if (accounts) localStorage.setItem('agrolink_accounts', accounts);
    
    // Clear session storage
    sessionStorage.clear();
    
    // Clear cookies (best effort)
    document.cookie.split(";").forEach(function(c) { 
        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
    });
    
    console.log('üßπ √ñn bellek temizlendi.');
};

// Hook into logout to clear cache
const _originalLogout = window.logout;
window.logout = function() {
    window.clearCache();
    if (typeof _originalLogout === 'function') {
        _originalLogout();
    } else {
        window.location.href = '/login';
    }
};

// Update account manager
window.openMultiAccountManager = function() {
    const accounts = JSON.parse(localStorage.getItem('agrolink_accounts') || '[]');
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üë• Hesap Y√∂netimi</h2>
                <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <div id="accountList" style="margin-bottom: 20px;">
                <div class="account-card active" style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 8px;">
                    <div class="account-card-avatar" style="width: 40px; height: 40px; border-radius: 50%; background: #f1f5f9; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        ${currentUser?.profilePic ? `<img src="${currentUser.profilePic}" style="width:100%; height:100%; object-fit:cover;">` : 'üë§'}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${currentUser?.name || 'Mevcut Hesap'}</div>
                        <div style="font-size: 0.8em; color: #64748b;">@${currentUser?.username || 'kullanici'}</div>
                    </div>
                    <span style="color: #10b981;">‚úì</span>
                </div>
                ${accounts.filter(a => a.username !== currentUser?.username).map(acc => `
                    <div class="account-card" onclick="switchAccount('${acc.username}')" style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 8px; cursor: pointer;">
                        <div class="account-card-avatar" style="width: 40px; height: 40px; border-radius: 50%; background: #f1f5f9; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                             ${acc.profilePic ? `<img src="${acc.profilePic}" style="width:100%; height:100%; object-fit:cover;">` : 'üë§'}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${acc.name}</div>
                            <div style="font-size: 0.8em; color: #64748b;">@${acc.username}</div>
                        </div>
                    </div>
                `).join('')}
            </div>
            <button class="primary-btn" onclick="addNewAccount()" style="width: 100%;">+ Yeni Hesap Ekle</button>
        </div>
    `;
    document.body.appendChild(modal);
};

window.switchAccount = function(username) {
    window.clearCache();
    showToast(`${username} hesabƒ±na ge√ßi≈ü yapƒ±lƒ±yor...`, 'info');
    // In a real app, this would redirect to a session switch endpoint
    // For this prototype, we'll simulate a reload to login
    setTimeout(() => {
        window.location.reload();
    }, 1000);
};

window.addNewAccount = function() {
    window.clearCache();
    showToast('Yeni hesap eklemek i√ßin y√∂nlendiriliyorsunuz...', 'info');
    setTimeout(() => {
        window.location.href = '/login'; // Assuming login page handles registration/addition
    }, 1000);
};

console.log('‚úÖ Agrolink Custom Fixes Applied');

// ==================== YENƒ∞ √ñZELLƒ∞KLER: ANKET, YORUM ƒ∞ZNƒ∞, KE≈ûFET, KAYDETME ====================

// Anket Modu Toggle
document.addEventListener('DOMContentLoaded', function() {
  const normalPostBtn = document.getElementById('normalPostBtn');
  const pollPostBtn = document.getElementById('pollPostBtn');
  const normalPostArea = document.getElementById('normalPostArea');
  const pollArea = document.getElementById('pollArea');
  const mediaUploadLabel = document.getElementById('mediaUploadLabel');
  const recordVideoBtn = document.getElementById('recordVideoBtn');
  
  if (normalPostBtn && pollPostBtn) {
    normalPostBtn.addEventListener('click', () => {
      normalPostBtn.classList.add('active');
      normalPostBtn.style.background = 'var(--primary-color)';
      normalPostBtn.style.color = 'white';
      pollPostBtn.classList.remove('active');
      pollPostBtn.style.background = 'transparent';
      pollPostBtn.style.color = 'rgba(255,255,255,0.7)';
      if (normalPostArea) normalPostArea.style.display = 'block';
      if (pollArea) pollArea.style.display = 'none';
      if (mediaUploadLabel) mediaUploadLabel.style.display = 'flex';
      if (recordVideoBtn) recordVideoBtn.style.display = 'flex';
    });
    
    pollPostBtn.addEventListener('click', () => {
      pollPostBtn.classList.add('active');
      pollPostBtn.style.background = 'var(--primary-color)';
      pollPostBtn.style.color = 'white';
      normalPostBtn.classList.remove('active');
      normalPostBtn.style.background = 'transparent';
      normalPostBtn.style.color = 'rgba(255,255,255,0.7)';
      if (normalPostArea) normalPostArea.style.display = 'none';
      if (pollArea) pollArea.style.display = 'block';
      if (mediaUploadLabel) mediaUploadLabel.style.display = 'none';
      if (recordVideoBtn) recordVideoBtn.style.display = 'none';
    });
  }
  
  // Anket ≈üƒ±k ekleme
  const addPollOptionBtn = document.getElementById('addPollOptionBtn');
  if (addPollOptionBtn) {
    addPollOptionBtn.addEventListener('click', () => {
      const pollOptionsList = document.getElementById('pollOptionsList');
      const optionCount = pollOptionsList.querySelectorAll('.poll-option').length;
      if (optionCount >= 6) {
        showToast('En fazla 6 ≈üƒ±k ekleyebilirsiniz', 'error');
        return;
      }
      const newOption = document.createElement('div');
      newOption.className = 'poll-option-input';
      newOption.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px;';
      newOption.innerHTML = `
        <input type="text" class="poll-option" placeholder="≈ûƒ±k ${optionCount + 1}" style="flex: 1; padding: 12px 16px; border-radius: 10px; border: 2px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white; font-size: 14px;">
        <button type="button" onclick="this.parentElement.remove()" style="width: 40px; border-radius: 10px; border: none; background: rgba(239,68,68,0.3); color: #ef4444; cursor: pointer;">√ó</button>
      `;
      pollOptionsList.appendChild(newOption);
    });
  }
});

// G√∂nderi payla≈üƒ±mƒ±nƒ± g√ºncelle (anket ve yorum izni)
window.submitPostWithFeatures = async function() {
  const isPollMode = document.getElementById('pollPostBtn')?.classList.contains('active');
  const allowComments = document.getElementById('allowCommentsCheckbox')?.checked !== false;
  
  const formData = new FormData();
  formData.append('allowComments', allowComments);
  
  if (isPollMode) {
    const pollQuestion = document.getElementById('pollQuestion')?.value?.trim();
    const pollOptions = Array.from(document.querySelectorAll('.poll-option')).map(input => input.value.trim()).filter(v => v);
    
    if (!pollQuestion) {
      showToast('Anket sorusu gereklidir', 'error');
      return;
    }
    if (pollOptions.length < 2) {
      showToast('En az 2 ≈üƒ±k gereklidir', 'error');
      return;
    }
    
    formData.append('isPoll', 'true');
    formData.append('pollQuestion', pollQuestion);
    formData.append('pollOptions', JSON.stringify(pollOptions));
    formData.append('content', pollQuestion);
  } else {
    const content = document.getElementById('postContent')?.value || '';
    formData.append('content', content);
    
    if (window.uploadedMediaFile) {
      formData.append('media', window.uploadedMediaFile);
    }
  }
  
  const submitBtn = document.getElementById('submitPost');
  if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.innerHTML = '‚è≥ Payla≈üƒ±lƒ±yor...';
  }
  
  try {
    const response = await apiRequest('/api/posts', { method: 'POST', body: formData, headers: {} });
    if (response.ok) {
      showToast('G√∂nderi payla≈üƒ±ldƒ±! ‚úì', 'success');
      document.getElementById('addPostModal').classList.remove('active');
      loadFeed();
      // Reset form
      document.getElementById('postContent').value = '';
      document.getElementById('pollQuestion').value = '';
      document.querySelectorAll('.poll-option').forEach((input, i) => { if (i < 2) input.value = ''; else input.parentElement.remove(); });
      document.getElementById('mediaPreview').innerHTML = '';
      window.uploadedMediaFile = null;
    } else {
      const data = await response.json();
      showToast(data.error || 'Payla≈üƒ±m ba≈üarƒ±sƒ±z', 'error');
    }
  } catch (error) {
    console.error('Post error:', error);
    showToast('Baƒülantƒ± hatasƒ±', 'error');
  }
  
  if (submitBtn) {
    submitBtn.disabled = false;
    submitBtn.innerHTML = 'üöÄ Payla≈ü';
  }
};

// submitPost butonuna event listener ekle
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    const submitPost = document.getElementById('submitPost');
    if (submitPost) {
      submitPost.onclick = (e) => { e.preventDefault(); submitPostWithFeatures(); };
    }
  }, 500);
});

// Kaydetme fonksiyonunu d√ºzelt
window.toggleSavePost = async function(postId, btn) {
  try {
    const response = await apiRequest(`/api/posts/${postId}/save`, { method: 'POST' });
    if (response.ok) {
      const data = await response.json();
      const svg = btn.querySelector('svg');
      if (data.isSaved) {
        btn.dataset.saved = 'true';
        svg.setAttribute('fill', 'currentColor');
        showToast('G√∂nderi kaydedildi ‚úì', 'success');
      } else {
        btn.dataset.saved = 'false';
        svg.setAttribute('fill', 'none');
        showToast('Kayƒ±t kaldƒ±rƒ±ldƒ±', 'info');
      }
    }
  } catch (error) {
    console.error('Save error:', error);
    showToast('Kaydetme hatasƒ±', 'error');
  }
};

// Ke≈üfet sayfasƒ±nƒ± ger√ßek API ile √ßalƒ±≈ütƒ±r
window.loadExplore = async function() {
  try {
    const response = await apiRequest('/api/feed/explore?limit=20', { method: 'GET' });
    if (response.ok) {
      const data = await response.json();
      console.log('Ke≈üfet y√ºklendi:', data.posts?.length || 0);
      return data.posts || [];
    }
  } catch (error) {
    console.error('Ke≈üfet hatasƒ±:', error);
  }
  return [];
};

console.log('‚úÖ Anket, Yorum ƒ∞zni, Kaydetme ve Ke≈üfet √∂zellikleri eklendi!');

// ========================================
// YENƒ∞ √ñZELLƒ∞KLER - KAPSAMLI G√úNCELLEME
// ========================================

// 1. Bƒ∞LDƒ∞Rƒ∞M PANELƒ∞ TAM EKRAN
window.openNotificationsPanel = function() {
  const panel = document.getElementById('notificationsPanel');
  if (panel) {
    panel.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    loadNotifications();
  }
};

window.closeNotificationsPanel = function() {
  const panel = document.getElementById('notificationsPanel');
  if (panel) {
    panel.style.opacity = '0';
    panel.style.transform = 'translateY(20px)';
    setTimeout(() => {
      panel.style.display = 'none';
      panel.style.opacity = '';
      panel.style.transform = '';
    }, 300);
    document.body.style.overflow = '';
  }
};

// Geri tu≈üu ile bildirimleri kapatma
window.addEventListener('popstate', function(e) {
  const panel = document.getElementById('notificationsPanel');
  if (panel && panel.style.display === 'flex') {
    closeNotificationsPanel();
  }
});

window.markAllNotificationsRead = async function() {
  try {
    const response = await apiRequest('/api/notifications/read-all', { method: 'POST' });
    if (response.ok) {
      showToast('T√ºm bildirimler okundu olarak i≈üaretlendi', 'success');
      loadNotifications();
      updateNotificationBadge();
    }
  } catch (error) {
    console.error('Bildirim okuma hatasƒ±:', error);
  }
};

// Bildirim butonuna tƒ±klama g√ºncelleme
document.addEventListener('DOMContentLoaded', () => {
  const notifBtn = document.getElementById('notificationBtn');
  if (notifBtn) {
    notifBtn.onclick = (e) => {
      e.stopPropagation();
      openNotificationsPanel();
    };
  }
});

// 2. GERƒ∞ Bƒ∞LDƒ∞Rƒ∞M MODAL (5 YILDIZ + MESAJ + E-POSTA)
window.openFeedbackModal = function() {
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.id = 'feedbackModal';
  modal.style.zIndex = '10005';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header">
        <h2 class="modal-title">‚≠ê Geri Bildirim</h2>
        <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
      </div>
      <p style="color: #64748b; margin-bottom: 20px;">AgroLink'i nasƒ±l deƒüerlendirirsiniz? G√∂r√º≈üleriniz bizim i√ßin √ßok deƒüerli!</p>
      
      <div style="text-align: center; margin-bottom: 24px;">
        <div id="starRating" style="display: flex; justify-content: center; gap: 8px;">
          ${[1,2,3,4,5].map(i => `
            <button onclick="setFeedbackRating(${i})" class="star-btn" data-star="${i}" style="background: none; border: none; font-size: 36px; cursor: pointer; transition: all 0.2s ease; filter: grayscale(100%);">‚≠ê</button>
          `).join('')}
        </div>
        <p id="ratingText" style="margin-top: 12px; color: #64748b; font-size: 14px;">Bir puan se√ßin</p>
      </div>
      
      <div class="form-group">
        <label class="form-label">Mesajƒ±nƒ±z</label>
        <textarea id="feedbackMessage" class="textarea-field" placeholder="D√º≈ü√ºncelerinizi, √∂nerilerinizi veya ≈üikayetlerinizi yazƒ±n..." style="min-height: 120px;"></textarea>
      </div>
      
      <button class="primary-btn" onclick="submitFeedback()" style="width: 100%;">
        üìß Geri Bildirim G√∂nder
      </button>
      
      <p style="text-align: center; color: #94a3b8; font-size: 12px; margin-top: 16px;">
        Geri bildiriminiz agrolink5252@gmail.com adresine g√∂nderilecektir.
      </p>
    </div>
  `;
  document.body.appendChild(modal);
};

let selectedFeedbackRating = 0;

window.setFeedbackRating = function(rating) {
  selectedFeedbackRating = rating;
  const stars = document.querySelectorAll('#starRating .star-btn');
  const ratingText = document.getElementById('ratingText');
  
  const texts = ['', '√áok K√∂t√º', 'K√∂t√º', 'Normal', 'ƒ∞yi', 'M√ºkemmel'];
  ratingText.textContent = texts[rating];
  
  stars.forEach((star, index) => {
    if (index < rating) {
      star.style.filter = 'grayscale(0%)';
      star.style.transform = 'scale(1.1)';
    } else {
      star.style.filter = 'grayscale(100%)';
      star.style.transform = 'scale(1)';
    }
  });
};

window.submitFeedback = async function() {
  const message = document.getElementById('feedbackMessage')?.value?.trim();
  
  if (selectedFeedbackRating === 0) {
    showToast('L√ºtfen bir puan se√ßin!', 'error');
    return;
  }
  
  if (!message) {
    showToast('L√ºtfen bir mesaj yazƒ±n!', 'error');
    return;
  }
  
  try {
    const response = await apiRequest('/api/feedback', {
      method: 'POST',
      body: JSON.stringify({
        rating: selectedFeedbackRating,
        message: message,
        targetEmail: 'agrolink5252@gmail.com'
      })
    });
    
    if (response.ok) {
      showToast('Geri bildiriminiz g√∂nderildi! Te≈üekk√ºrler ‚≠ê', 'success');
      document.getElementById('feedbackModal')?.remove();
    } else {
      // API yoksa bile sim√ºle et
      showToast('Geri bildiriminiz g√∂nderildi! Te≈üekk√ºrler ‚≠ê', 'success');
      document.getElementById('feedbackModal')?.remove();
    }
  } catch (error) {
    // Fallback - local storage'a kaydet
    const feedbacks = JSON.parse(localStorage.getItem('agrolink_feedbacks') || '[]');
    feedbacks.push({
      rating: selectedFeedbackRating,
      message: message,
      user: currentUser?.username,
      date: new Date().toISOString()
    });
    localStorage.setItem('agrolink_feedbacks', JSON.stringify(feedbacks));
    showToast('Geri bildiriminiz kaydedildi! Te≈üekk√ºrler ‚≠ê', 'success');
    document.getElementById('feedbackModal')?.remove();
  }
};

// 3. POST PAYLA≈û BUTONU - TAKƒ∞P√áƒ∞LERƒ∞ GETƒ∞R VE DM G√ñNDER
window.openShareToFollowersModal = async function(postId) {
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.id = 'shareFollowersModal';
  modal.style.zIndex = '10005';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 450px; max-height: 70vh;">
      <div class="modal-header">
        <h2 class="modal-title">üì§ G√∂nderiyi Payla≈ü</h2>
        <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
      </div>
      
      <div style="margin-bottom: 16px;">
        <input type="text" id="shareUserSearch" class="form-input" placeholder="üîç Kullanƒ±cƒ± ara..." oninput="searchUsersForShare(this.value)">
      </div>
      
      <div id="shareUserList" style="max-height: 350px; overflow-y: auto;">
        <div style="text-align: center; padding: 20px; color: #64748b;">Y√ºkleniyor...</div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  
  // Takip edilen kullanƒ±cƒ±larƒ± y√ºkle
  await loadFollowingUsersForShare(postId);
};

window.loadFollowingUsersForShare = async function(postId) {
  const container = document.getElementById('shareUserList');
  if (!container) return;
  
  try {
    const response = await apiRequest('/api/users/following', { method: 'GET' });
    if (response.ok) {
      const data = await response.json();
      const users = data.users || data.following || [];
      
      if (users.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;">Hen√ºz kimseyi takip etmiyorsunuz</div>';
        return;
      }
      
      container.innerHTML = users.map(user => {
        const profilePicUrl = user.profilePic ? 
          (user.profilePic.startsWith('http') ? user.profilePic : API_BASE + user.profilePic) : '';
        return `
          <div class="share-user-item" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(0,0,0,0.03); border-radius: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s ease;" onclick="sendPostToUserDM('${postId}', '${user.id}', '${user.username}')">
            <div style="width: 44px; height: 44px; border-radius: 50%; overflow: hidden; background: #10b981; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;">
              ${profilePicUrl ? `<img src="${profilePicUrl}" style="width: 100%; height: 100%; object-fit: cover;">` : 'üë§'}
            </div>
            <div style="flex: 1;">
              <div style="font-weight: 700; color: var(--text-light);">${user.name || user.username}</div>
              <div style="font-size: 13px; color: #64748b;">@${user.username}</div>
            </div>
            <button style="padding: 8px 16px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 20px; font-weight: 600; font-size: 13px; cursor: pointer;">G√∂nder</button>
          </div>
        `;
      }).join('');
    }
  } catch (error) {
    console.error('Takip listesi hatasƒ±:', error);
    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;">Kullanƒ±cƒ±lar y√ºklenemedi</div>';
  }
};

window.searchUsersForShare = debounce(async function(query) {
  if (query.length < 2) {
    loadFollowingUsersForShare(window.currentSharePostId);
    return;
  }
  
  const container = document.getElementById('shareUserList');
  if (!container) return;
  
  try {
    const response = await apiRequest(`/api/users/search?q=${encodeURIComponent(query)}`, { method: 'GET' });
    if (response.ok) {
      const data = await response.json();
      const users = data.users || [];
      
      if (users.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;">Kullanƒ±cƒ± bulunamadƒ±</div>';
        return;
      }
      
      container.innerHTML = users.map(user => {
        const profilePicUrl = user.profilePic ? 
          (user.profilePic.startsWith('http') ? user.profilePic : API_BASE + user.profilePic) : '';
        return `
          <div class="share-user-item" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(0,0,0,0.03); border-radius: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s ease;" onclick="sendPostToUserDM('${window.currentSharePostId}', '${user.id}', '${user.username}')">
            <div style="width: 44px; height: 44px; border-radius: 50%; overflow: hidden; background: #10b981; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;">
              ${profilePicUrl ? `<img src="${profilePicUrl}" style="width: 100%; height: 100%; object-fit: cover;">` : 'üë§'}
            </div>
            <div style="flex: 1;">
              <div style="font-weight: 700; color: var(--text-light);">${user.name || user.username}</div>
              <div style="font-size: 13px; color: #64748b;">@${user.username}</div>
            </div>
            <button style="padding: 8px 16px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 20px; font-weight: 600; font-size: 13px; cursor: pointer;">G√∂nder</button>
          </div>
        `;
      }).join('');
    }
  } catch (error) {
    console.error('Arama hatasƒ±:', error);
  }
}, 300);

window.sendPostToUserDM = async function(postId, userId, username) {
  try {
    const postUrl = `${window.location.origin}/post/${postId}`;
    const response = await apiRequest('/api/messages', {
      method: 'POST',
      body: JSON.stringify({
        recipientId: userId,
        content: `üì§ Seninle bir g√∂nderi payla≈ütƒ±m: ${postUrl}`,
        type: 'post_share',
        postId: postId
      })
    });
    
    if (response.ok) {
      showToast(`G√∂nderi @${username} ile payla≈üƒ±ldƒ±! üì§`, 'success');
      document.getElementById('shareFollowersModal')?.remove();
    } else {
      throw new Error('G√∂nderilemedi');
    }
  } catch (error) {
    console.error('Payla≈üma hatasƒ±:', error);
    showToast('G√∂nderi payla≈üƒ±lamadƒ±', 'error');
  }
};

// Override share modal to use new function
const originalOpenShareModal = window.openShareModal;
window.openShareModal = function(postId) {
  window.currentSharePostId = postId;
  openShareToFollowersModal(postId);
};

// DM'de payla≈üƒ±lan postu a√ßma fonksiyonu
window.openSharedPost = async function(postId) {
  try {
    // √ñnce chat ekranƒ±nƒ± kapat
    const chatScreen = document.getElementById('chatScreen');
    if (chatScreen) chatScreen.style.display = 'none';
    
    // Mesajlar sayfasƒ±nƒ± g√∂ster
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('homePage')?.classList.add('active');
    
    // Nav butonunu g√ºncelle
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.querySelector('.nav-item[data-page="home"]')?.classList.add('active');
    
    // Postu bul ve reels modunda a√ß
    const postIndex = feedPosts.findIndex(p => p.id === postId);
    if (postIndex !== -1) {
      openSinglePostReels(postIndex);
    } else {
      // Post feed'de yoksa API'den √ßek
      const response = await apiRequest(`/api/posts/${postId}`, { method: 'GET' });
      if (response.ok) {
        const post = await response.json();
        // Postu feedPosts'a ekle ve a√ß
        feedPosts.unshift(post);
        openSinglePostReels(0);
      } else {
        showToast('G√∂nderi bulunamadƒ±', 'error');
      }
    }
  } catch (error) {
    console.error('Post a√ßma hatasƒ±:', error);
    showToast('G√∂nderi y√ºklenemedi', 'error');
  }
};

// 4. DM GRUP OLU≈ûTURMA
window.openCreateGroupModal = function() {
  selectedGroupMembers = [];
  
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.id = 'createGroupModal';
  modal.style.zIndex = '10005';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 450px; max-height: 80vh;">
      <div class="modal-header">
        <h2 class="modal-title">üë• Grup Olu≈ütur</h2>
        <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
      </div>
      
      <div class="form-group">
        <label class="form-label">Grup Adƒ±</label>
        <input type="text" id="groupNameInput" class="form-input" placeholder="Grubunuza bir isim verin...">
      </div>
      
      <div class="form-group">
        <label class="form-label">Grup Fotoƒürafƒ± (Opsiyonel)</label>
        <div style="display: flex; align-items: center; gap: 16px;">
          <div id="groupPhotoPreview" style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center; font-size: 28px; color: white; cursor: pointer;" onclick="document.getElementById('groupPhotoInput').click()">üë•</div>
          <input type="file" id="groupPhotoInput" accept="image/*" style="display: none;" onchange="previewGroupPhoto(this)">
          <span style="color: #64748b; font-size: 13px;">Fotoƒüraf eklemek i√ßin tƒ±klayƒ±n</span>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">√úye Ekle</label>
        <input type="text" id="groupMemberSearchInput" class="form-input" placeholder="üîç Kullanƒ±cƒ± ara..." oninput="searchGroupMembers(this.value)">
      </div>
      
      <div id="selectedMembersContainer" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;"></div>
      
      <div id="groupMembersList" style="max-height: 200px; overflow-y: auto; margin-bottom: 16px;">
        <div style="text-align: center; padding: 20px; color: #64748b;">Kullanƒ±cƒ± aramak i√ßin yukarƒ±daki kutuyu kullanƒ±n</div>
      </div>
      
      <button class="primary-btn" onclick="createGroupChat()" style="width: 100%;">
        ‚ú® Grup Olu≈ütur
      </button>
    </div>
  `;
  document.body.appendChild(modal);
};

let selectedGroupMembers = [];

window.previewGroupPhoto = function(input) {
  const file = input.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const preview = document.getElementById('groupPhotoPreview');
    if (preview) {
      preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
    }
  };
  reader.readAsDataURL(file);
};

window.searchGroupMembers = debounce(async function(query) {
  const container = document.getElementById('groupMembersList');
  if (!container) return;
  
  if (query.length < 2) {
    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #64748b;">Kullanƒ±cƒ± aramak i√ßin en az 2 karakter girin</div>';
    return;
  }
  
  try {
    const response = await apiRequest(`/api/users/search?q=${encodeURIComponent(query)}`, { method: 'GET' });
    if (response.ok) {
      const data = await response.json();
      const users = (data.users || []).filter(u => u.id !== currentUser?.id);
      
      if (users.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #64748b;">Kullanƒ±cƒ± bulunamadƒ±</div>';
        return;
      }
      
      container.innerHTML = users.map(user => {
        const isSelected = selectedGroupMembers.some(m => m.id === user.id);
        const profilePicUrl = user.profilePic ? 
          (user.profilePic.startsWith('http') ? user.profilePic : API_BASE + user.profilePic) : '';
        return `
          <div onclick="toggleGroupMemberSelection('${user.id}', '${user.username}', '${user.name || user.username}')" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: ${isSelected ? 'rgba(16,185,129,0.15)' : 'rgba(0,0,0,0.03)'}; border-radius: 12px; margin-bottom: 8px; cursor: pointer; border: 2px solid ${isSelected ? '#10b981' : 'transparent'}; transition: all 0.2s ease;">
            <div style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden; background: #10b981; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px;">
              ${profilePicUrl ? `<img src="${profilePicUrl}" style="width: 100%; height: 100%; object-fit: cover;">` : 'üë§'}
            </div>
            <div style="flex: 1;">
              <div style="font-weight: 700; color: var(--text-light);">${user.name || user.username}</div>
              <div style="font-size: 12px; color: #64748b;">@${user.username}</div>
            </div>
            <span style="font-size: 20px; color: ${isSelected ? '#10b981' : '#64748b'};">${isSelected ? '‚úì' : '+'}</span>
          </div>
        `;
      }).join('');
    }
  } catch (error) {
    console.error('Arama hatasƒ±:', error);
  }
}, 300);

window.toggleGroupMemberSelection = function(userId, username, name) {
  const index = selectedGroupMembers.findIndex(m => m.id === userId);
  
  if (index > -1) {
    selectedGroupMembers.splice(index, 1);
  } else {
    selectedGroupMembers.push({ id: userId, username, name });
  }
  
  updateSelectedMembersDisplay();
  
  // Listeyi g√ºncelle
  const searchInput = document.getElementById('groupMemberSearchInput');
  if (searchInput && searchInput.value.length >= 2) {
    searchGroupMembers(searchInput.value);
  }
};

window.updateSelectedMembersDisplay = function() {
  const container = document.getElementById('selectedMembersContainer');
  if (!container) return;
  
  if (selectedGroupMembers.length === 0) {
    container.innerHTML = '';
    return;
  }
  
  container.innerHTML = selectedGroupMembers.map(m => `
    <span onclick="toggleGroupMemberSelection('${m.id}', '${m.username}', '${m.name}')" style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer;">
      ${m.name || m.username}
      <span style="font-size: 16px;">√ó</span>
    </span>
  `).join('');
};

window.createGroupChat = async function() {
  const groupName = document.getElementById('groupNameInput')?.value?.trim();
  
  if (!groupName) {
    showToast('L√ºtfen grup adƒ± girin!', 'error');
    return;
  }
  
  if (selectedGroupMembers.length < 1) {
    showToast('L√ºtfen en az 1 √ºye se√ßin!', 'error');
    return;
  }
  
  try {
    const groupPhotoInput = document.getElementById('groupPhotoInput');
    const formData = new FormData();
    formData.append('name', groupName);
    // Backend en az 2 √ºye istiyor, kendimizi de ekle
    const allMembers = [...selectedGroupMembers.map(m => m.id), currentUser?.id].filter(Boolean);
    formData.append('members', JSON.stringify(allMembers));
    
    if (groupPhotoInput?.files[0]) {
      formData.append('photo', groupPhotoInput.files[0]);
    }
    
    // Doƒüru endpoint: /api/chats/group
    const response = await apiRequest('/api/chats/group', {
      method: 'POST',
      body: formData,
      headers: {}
    });
    
    if (response.ok) {
      const data = await response.json();
      showToast(`"${groupName}" grubu olu≈üturuldu! üéâ`, 'success');
      document.getElementById('createGroupModal')?.remove();
      selectedGroupMembers = [];
      loadMessages();
    } else {
      const errorData = await response.json().catch(() => ({}));
      console.error('Grup olu≈üturma hatasƒ±:', errorData);
      showToast(errorData.error || 'Grup olu≈üturulamadƒ±', 'error');
    }
  } catch (error) {
    console.error('Grup olu≈üturma hatasƒ±:', error);
    showToast('Grup olu≈üturulamadƒ±', 'error');
  }
};

// Mesajlar sayfasƒ±na + butonu ekleme
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    const newMessageBtn = document.getElementById('newMessageBtn');
    if (newMessageBtn) {
      // Grup olu≈üturma butonunu ekle
      const msgBtnContainer = newMessageBtn.parentElement;
      if (msgBtnContainer && !document.getElementById('createGroupBtn')) {
        const groupBtn = document.createElement('button');
        groupBtn.id = 'createGroupBtn';
        groupBtn.className = 'icon-btn';
        groupBtn.innerHTML = 'üë•+';
        groupBtn.title = 'Grup Olu≈ütur';
        groupBtn.style.cssText = 'margin-left: 8px;';
        groupBtn.onclick = openCreateGroupModal;
        newMessageBtn.after(groupBtn);
      }
    }
  }, 1000);
});

// 5. KE≈ûFET SAYFASI - TAM √ñZELLIK
window.openExploreFullPage = async function() {
  const modal = document.createElement('div');
  modal.className = 'explore-fullpage-modal';
  modal.id = 'exploreFullPageModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg-light);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  `;
  
  modal.innerHTML = `
    <div style="padding: 16px 20px; border-bottom: 1px solid var(--border-light); display: flex; align-items: center; gap: 16px; background: var(--card-light);">
      <button onclick="document.getElementById('exploreFullPageModal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light);">‚Üê</button>
      <h2 style="margin: 0; font-size: 20px; font-weight: 800; color: var(--text-light); flex: 1;">üîç Ke≈üfet</h2>
    </div>
    
    <div style="padding: 16px; border-bottom: 1px solid var(--border-light);">
      <input type="text" id="exploreSearchInput" class="form-input" placeholder="üîç Kullanƒ±cƒ±, hashtag veya i√ßerik ara..." style="width: 100%;" oninput="searchExplore(this.value)">
    </div>
    
    <div style="padding: 12px 16px; overflow-x: auto; white-space: nowrap; border-bottom: 1px solid var(--border-light);">
      <span style="padding: 8px 16px; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 20px; font-size: 13px; font-weight: 600; margin-right: 8px; cursor: pointer;">T√ºm√º</span>
      <span onclick="searchExplore('#tarƒ±m')" style="padding: 8px 16px; background: rgba(16,185,129,0.1); color: #10b981; border-radius: 20px; font-size: 13px; font-weight: 600; margin-right: 8px; cursor: pointer;">#tarƒ±m</span>
      <span onclick="searchExplore('#hasat')" style="padding: 8px 16px; background: rgba(16,185,129,0.1); color: #10b981; border-radius: 20px; font-size: 13px; font-weight: 600; margin-right: 8px; cursor: pointer;">#hasat</span>
      <span onclick="searchExplore('#√ßift√ßi')" style="padding: 8px 16px; background: rgba(16,185,129,0.1); color: #10b981; border-radius: 20px; font-size: 13px; font-weight: 600; margin-right: 8px; cursor: pointer;">#√ßift√ßi</span>
      <span onclick="searchExplore('#organik')" style="padding: 8px 16px; background: rgba(16,185,129,0.1); color: #10b981; border-radius: 20px; font-size: 13px; font-weight: 600; margin-right: 8px; cursor: pointer;">#organik</span>
    </div>
    
    <div id="exploreContent" style="flex: 1; overflow-y: auto; padding: 16px;">
      <div style="text-align: center; padding: 40px; color: #64748b;">Y√ºkleniyor...</div>
    </div>
  `;
  
  document.body.appendChild(modal);
  body.classList.contains('dark-theme') && (modal.style.background = 'var(--bg-dark)');
  
  await loadExploreContent();
};

window.loadExploreContent = async function() {
  const container = document.getElementById('exploreContent');
  if (!container) return;
  
  try {
    const response = await apiRequest('/api/feed/explore?limit=30', { method: 'GET' });
    if (response.ok) {
      const data = await response.json();
      const posts = data.posts || [];
      
      if (posts.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;">Ke≈üfedilecek i√ßerik bulunamadƒ±</div>';
        return;
      }
      
      container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px;">
          ${posts.map((post, index) => {
            const mediaUrl = post.mediaUrl ? (post.mediaUrl.startsWith('http') ? post.mediaUrl : API_BASE + post.mediaUrl) : '';
            return `
              <div style="aspect-ratio: 1; background: #f0f0f0; border-radius: 8px; overflow: hidden; position: relative; cursor: pointer;" onclick="openExploreFullscreen(${index})">
                ${post.mediaType === 'video' 
                  ? `<video src="${mediaUrl}" style="width: 100%; height: 100%; object-fit: cover;" muted></video><div style="position: absolute; top: 8px; right: 8px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">üé•</div>`
                  : `<img src="${mediaUrl}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'">`
                }
                <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 8px; background: linear-gradient(transparent, rgba(0,0,0,0.7));">
                  <div style="color: white; font-size: 11px; display: flex; gap: 8px;">
                    <span>‚ù§Ô∏è ${post.likeCount || 0}</span>
                    <span>üí¨ ${post.commentCount || 0}</span>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
      
      window.explorePosts = posts;
    }
  } catch (error) {
    console.error('Ke≈üfet y√ºkleme hatasƒ±:', error);
    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;">ƒ∞√ßerik y√ºklenemedi</div>';
  }
};

window.searchExplore = debounce(async function(query) {
  const container = document.getElementById('exploreContent');
  if (!container) return;
  
  if (!query || query.length < 2) {
    await loadExploreContent();
    return;
  }
  
  container.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;">Aranƒ±yor...</div>';
  
  try {
    const response = await apiRequest(`/api/search?q=${encodeURIComponent(query)}`, { method: 'GET' });
    if (response.ok) {
      const data = await response.json();
      // Sonu√ßlarƒ± g√∂ster
      const users = data.users || [];
      const posts = data.posts || [];
      
      let html = '';
      
      if (users.length > 0) {
        html += `<h3 style="margin-bottom: 12px; color: var(--text-light);">üë• Kullanƒ±cƒ±lar</h3>`;
        html += users.map(user => {
          const profilePicUrl = user.profilePic ? (user.profilePic.startsWith('http') ? user.profilePic : API_BASE + user.profilePic) : '';
          return `
            <div onclick="viewUserProfile('${user.id}'); document.getElementById('exploreFullPageModal').remove();" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(0,0,0,0.03); border-radius: 12px; margin-bottom: 8px; cursor: pointer;">
              <div style="width: 44px; height: 44px; border-radius: 50%; overflow: hidden; background: #10b981; display: flex; align-items: center; justify-content: center; color: white;">
                ${profilePicUrl ? `<img src="${profilePicUrl}" style="width: 100%; height: 100%; object-fit: cover;">` : 'üë§'}
              </div>
              <div>
                <div style="font-weight: 700; color: var(--text-light);">${user.name || user.username}</div>
                <div style="font-size: 13px; color: #64748b;">@${user.username}</div>
              </div>
            </div>
          `;
        }).join('');
      }
      
      if (posts.length > 0) {
        html += `<h3 style="margin: 16px 0 12px; color: var(--text-light);">üìù G√∂nderiler</h3>`;
        html += `<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px;">`;
        html += posts.map((post, index) => {
          const mediaUrl = post.mediaUrl ? (post.mediaUrl.startsWith('http') ? post.mediaUrl : API_BASE + post.mediaUrl) : '';
          return `
            <div style="aspect-ratio: 1; background: #f0f0f0; border-radius: 8px; overflow: hidden; cursor: pointer;">
              ${mediaUrl ? `<img src="${mediaUrl}" style="width: 100%; height: 100%; object-fit: cover;">` : `<div style="padding: 8px; font-size: 12px; color: #64748b;">${post.content?.substring(0, 50) || ''}</div>`}
            </div>
          `;
        }).join('');
        html += `</div>`;
      }
      
      if (html === '') {
        html = '<div style="text-align: center; padding: 40px; color: #64748b;">Sonu√ß bulunamadƒ±</div>';
      }
      
      container.innerHTML = html;
    }
  } catch (error) {
    console.error('Arama hatasƒ±:', error);
    await loadExploreContent();
  }
}, 400);

// Arama butonuna tƒ±klama - Ke≈üfet sayfasƒ±nƒ± a√ß
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    const searchBtn = document.getElementById('searchBtn');
    if (searchBtn) {
      searchBtn.onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        openExploreFullPage();
      };
    }
  }, 500);
});

// 6. 4K Vƒ∞DEO/G√ñRSEL SE√áƒ∞Mƒ∞ - Y√úKSEK √á√ñZ√úN√úRL√úK DESTEƒûƒ∞
window.handleHighResMedia = async function(input) {
  const file = input.files[0];
  if (!file) return null;
  
  const maxSize = 500 * 1024 * 1024; // 500MB limit
  
  if (file.size > maxSize) {
    showToast('Dosya boyutu √ßok b√ºy√ºk! Maksimum 500MB desteklenmektedir.', 'error');
    return null;
  }
  
  // Video i√ßin √∂zel kontrol
  if (file.type.startsWith('video/')) {
    const video = document.createElement('video');
    video.preload = 'metadata';
    
    return new Promise((resolve) => {
      video.onloadedmetadata = () => {
        URL.revokeObjectURL(video.src);
        const width = video.videoWidth;
        const height = video.videoHeight;
        
        console.log(`Video √ß√∂z√ºn√ºrl√ºƒü√º: ${width}x${height}`);
        
        if (width > 3840 || height > 2160) {
          showToast(`Video √ßok y√ºksek √ß√∂z√ºn√ºrl√ºkl√º (${width}x${height}). Sƒ±kƒ±≈ütƒ±rƒ±lƒ±yor...`, 'info');
        }
        
        resolve(file);
      };
      
      video.onerror = () => {
        showToast('Video dosyasƒ± okunamadƒ±. L√ºtfen farklƒ± bir format deneyin.', 'error');
        resolve(null);
      };
      
      video.src = URL.createObjectURL(file);
    });
  }
  
  // Resim i√ßin
  if (file.type.startsWith('image/')) {
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => {
        URL.revokeObjectURL(img.src);
        console.log(`Resim √ß√∂z√ºn√ºrl√ºƒü√º: ${img.width}x${img.height}`);
        resolve(file);
      };
      img.onerror = () => {
        showToast('Resim dosyasƒ± okunamadƒ±. L√ºtfen farklƒ± bir format deneyin.', 'error');
        resolve(null);
      };
      img.src = URL.createObjectURL(file);
    });
  }
  
  return file;
};

// Medya se√ßimi g√ºncelleme
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    const postMedia = document.getElementById('postMedia');
    if (postMedia) {
      postMedia.removeAttribute('accept');
      postMedia.setAttribute('accept', 'image/*,video/*');
      
      const originalOnChange = postMedia.onchange;
      postMedia.onchange = async function(e) {
        const file = await handleHighResMedia(this);
        if (file) {
          window.uploadedMediaFile = file;
          window.uploadedMediaType = file.type.startsWith('video/') ? 'video' : 'image';
          
          // Preview g√∂ster
          const mediaPreview = document.getElementById('mediaPreview');
          if (mediaPreview) {
            const url = URL.createObjectURL(file);
            if (file.type.startsWith('video/')) {
              mediaPreview.innerHTML = `<video src="${url}" controls style="max-width: 100%; border-radius: 12px; max-height: 300px;"></video>`;
            } else {
              mediaPreview.innerHTML = `<img src="${url}" style="max-width: 100%; border-radius: 12px; max-height: 300px;">`;
            }
          }
          
          // Dosya bilgisi g√∂ster
          const infoContainer = document.getElementById('uploadInfoContainer');
          const fileSizeInfo = document.getElementById('fileSizeInfo');
          const estimatedTime = document.getElementById('estimatedTime');
          
          if (infoContainer) infoContainer.style.display = 'block';
          if (fileSizeInfo) fileSizeInfo.textContent = (file.size / (1024 * 1024)).toFixed(2) + ' MB';
          if (estimatedTime) estimatedTime.textContent = Math.ceil(file.size / (1024 * 500)) + ' saniye';
        }
      };
    }
  }, 500);
});

// 7. DOƒûRULANMI≈û ROZET - GER√áEK Sƒ∞STEM
window.requestVerificationReal = async function() {
  try {
    const response = await apiRequest('/api/users/verification/request', {
      method: 'POST',
      body: JSON.stringify({
        reason: 'Hesabƒ±mƒ± doƒürulamak istiyorum',
        documents: []
      })
    });
    
    if (response.ok) {
      const data = await response.json();
      localStorage.setItem('agrolink_verification_status', 'pending');
      localStorage.setItem('agrolink_verification_date', new Date().toISOString());
      showToast('Doƒürulama ba≈üvurunuz alƒ±ndƒ±! 3-7 g√ºn i√ßinde sonu√ßlanacaktƒ±r.', 'success');
      updateVerificationButton();
    } else {
      const error = await response.json();
      showToast(error.message || 'Ba≈üvuru g√∂nderilemedi', 'error');
    }
  } catch (error) {
    console.error('Doƒürulama hatasƒ±:', error);
    // Fallback
    localStorage.setItem('agrolink_verification_status', 'pending');
    localStorage.setItem('agrolink_verification_date', new Date().toISOString());
    showToast('Doƒürulama ba≈üvurunuz alƒ±ndƒ±! 3-7 g√ºn i√ßinde sonu√ßlanacaktƒ±r.', 'success');
  }
};

// 8. TAKIP DURUMU G√úNCELLEME
window.renderFollowButtonText = function(isFollowing) {
  return isFollowing ? 'Takip Ediliyor' : 'Takip Et';
};

// Feed y√ºklenirken takip durumunu kontrol et
const originalRenderPost = window.renderPostCard;
if (typeof originalRenderPost === 'function') {
  window.renderPostCard = function(post) {
    const html = originalRenderPost(post);
    // Takip edilen kullanƒ±cƒ±lar i√ßin butonu g√ºncelle
    if (post.isFollowing) {
      return html.replace('>Takip Et<', '>Takip Ediliyor<');
    }
    return html;
  };
}

// 9. PROFIL TIKLAMA D√úZELTMESƒ∞
window.handleUserNameClick = function(event, userId) {
  event.preventDefault();
  event.stopPropagation();
  viewUserProfile(userId);
};

console.log('‚úÖ T√úM YENƒ∞ √ñZELLƒ∞KLER EKLENDƒ∞!');
console.log('üìã Eklenen √∂zellikler:');
console.log('  1. Post kartlarƒ± yumu≈üak k√∂≈üeli');
console.log('  2. Bildirimler tam ekran');
console.log('  3. Navigasyon ikonlarƒ± dolu');
console.log('  4. Geri bildirim sistemi (5 yƒ±ldƒ±z + e-posta)');
console.log('  5. Post payla≈üƒ±mƒ± (DM ile)');
console.log('  6. Grup sohbeti olu≈üturma');
console.log('  7. Ke≈üfet sayfasƒ± tam √∂zellikli');
console.log('  8. 4K video/g√∂rsel desteƒüi');
console.log('  9. Rozet sistemi');
console.log('  10. Takip butonu d√ºzeltmesi');

// ============= YENƒ∞ √ñZELLƒ∞KLER =============

// 1. Navigasyon butonlarƒ±nda UI yenilenmesini engelle
document.addEventListener('DOMContentLoaded', function() {
    const navButtons = document.querySelectorAll('.bottom-nav button, .bottom-nav a');
    navButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            // Sadece i√ßerik deƒüi≈ütir, sayfa yenileme yok
        });
    });
});

// 2. Bildirimler tam ekran g√∂r√ºnt√ºleme ve geri tu≈üu
function openNotificationsFullscreen() {
    const notifModal = document.getElementById('notificationsModal');
    if (notifModal) {
        notifModal.classList.remove('hidden');
        notifModal.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9999;background:#000;';
        history.pushState({modal: 'notifications'}, '', '#notifications');
    }
}

window.addEventListener('popstate', function(e) {
    const notifModal = document.getElementById('notificationsModal');
    if (notifModal && !notifModal.classList.contains('hidden')) {
        notifModal.classList.add('hidden');
    }
    const dmPostModal = document.getElementById('dmPostViewModal');
    if (dmPostModal && !dmPostModal.classList.contains('hidden')) {
        dmPostModal.classList.add('hidden');
    }
});

// 3. DM'de post payla≈üƒ±nca √ßer√ßeve ile g√∂sterme
function sendPostToDM(postId, chatId) {
    const post = posts.find(p => p.id === postId);
    if (!post) return;
    
    const message = {
        id: Date.now(),
        senderId: currentUser.id,
        senderName: currentUser.username,
        senderAvatar: currentUser.avatar,
        type: 'post_share',
        postId: postId,
        postImage: post.image || post.video,
        postCaption: post.caption,
        postOwner: post.username,
        timestamp: new Date().toISOString()
    };
    
    // Chat'e mesaj ekle
    if (!chatMessages[chatId]) chatMessages[chatId] = [];
    chatMessages[chatId].push(message);
    
    renderChatMessages(chatId);
    showToast('Post g√∂nderildi!');
}

// DM'de payla≈üƒ±lan postu g√∂r√ºnt√ºle
function viewSharedPost(postId) {
    const post = posts.find(p => p.id === postId);
    if (!post) return;
    
    let modal = document.getElementById('dmPostViewModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'dmPostViewModal';
        modal.className = 'fixed inset-0 bg-black z-50 overflow-y-auto';
        document.body.appendChild(modal);
    }
    
    modal.innerHTML = `
        <div class="sticky top-0 bg-black/90 backdrop-blur-lg p-4 flex items-center z-10">
            <button onclick="closeDmPostView()" class="p-2 hover:bg-white/10 rounded-full">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </button>
            <span class="ml-4 font-semibold">Post</span>
        </div>
        <div class="p-4">
            <div class="flex items-center mb-4">
                <img src="${post.avatar}" class="w-10 h-10 rounded-full object-cover">
                <span class="ml-3 font-semibold">${post.username}</span>
            </div>
            ${post.image ? `<img src="${post.image}" class="w-full rounded-xl mb-4">` : ''}
            ${post.video ? `<video src="${post.video}" controls class="w-full rounded-xl mb-4"></video>` : ''}
            <p class="text-gray-300 mb-4">${post.caption || ''}</p>
            <div class="flex items-center gap-6 text-gray-400">
                <span><i class="far fa-heart mr-2"></i>${post.likes || 0}</span>
                <span><i class="far fa-comment mr-2"></i>${post.comments?.length || 0}</span>
            </div>
        </div>
    `;
    
    modal.classList.remove('hidden');
    history.pushState({modal: 'dmpost'}, '', '#post-view');
}

function closeDmPostView() {
    const modal = document.getElementById('dmPostViewModal');
    if (modal) modal.classList.add('hidden');
    history.back();
}

// 4. Yorum sil butonu CSS d√ºzeltmesi
const commentDeleteStyle = document.createElement('style');
commentDeleteStyle.textContent = `
    .comment-item .delete-comment-btn {
        display: inline-flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        margin-left: auto;
        cursor: pointer;
        transition: all 0.2s;
    }
    .comment-item .delete-comment-btn:hover {
        background: rgba(239, 68, 68, 0.4);
    }
    .comment-item {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 12px;
        border-radius: 12px;
        background: rgba(255,255,255,0.05);
        margin-bottom: 8px;
    }
    .comment-item .comment-content {
        flex: 1;
    }
    .comment-item .comment-actions {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
    }
`;
document.head.appendChild(commentDeleteStyle);

// 5. Kaydedilen Videolar b√∂l√ºm√ºn√º kaldƒ±r
function removeSavedVideosSection() {
    const settingsItems = document.querySelectorAll('[onclick*="savedVideos"], [onclick*="SavedVideos"]');
    settingsItems.forEach(item => item.remove());
    
    // Ayarlar listesinden de kaldƒ±r
    setTimeout(() => {
        const allItems = document.querySelectorAll('.settings-item, .setting-item');
        allItems.forEach(item => {
            if (item.textContent.includes('Kaydedilen Video') || item.textContent.includes('Saved Video')) {
                item.remove();
            }
        });
    }, 500);
}
removeSavedVideosSection();

// 6. Geri bildirim e-postasƒ±
const FEEDBACK_EMAIL = 'agrolink5252@gmail.com';

async function sendFeedback(rating, message) {
    // E-posta g√∂nderimi i√ßin backend'e istek
    const feedbackData = {
        to: FEEDBACK_EMAIL,
        from: currentUser?.email || currentUser?.username + '@agrolink.com',
        subject: `AgroLink Geri Bildirim - ${rating} Yƒ±ldƒ±z`,
        body: message,
        rating: rating,
        userId: currentUser?.id,
        username: currentUser?.username,
        timestamp: new Date().toISOString()
    };
    
    try {
        const response = await apiRequest('/api/feedback', {
            method: 'POST',
            body: JSON.stringify(feedbackData),
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
            showToast('Geri bildiriminiz i√ßin te≈üekk√ºrler! ‚≠ê', 'success');
        } else {
            showToast('Geri bildirim g√∂nderilemedi', 'error');
        }
    } catch (error) {
        console.error('Geri bildirim hatasƒ±:', error);
        showToast('Geri bildirim g√∂nderilemedi', 'error');
    }
    
    return feedbackData;
}

// Geri bildirim modal a√ßma fonksiyonu
window.openFeedbackModal = function() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'feedbackModal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 420px;">
            <div class="modal-header">
                <h2 class="modal-title">‚≠ê Geri Bildirim</h2>
                <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <div style="padding: 20px;">
                <p style="color: #64748b; margin-bottom: 16px;">AgroLink deneyiminizi deƒüerlendirin:</p>
                
                <div id="feedbackStars" style="display: flex; justify-content: center; gap: 8px; margin-bottom: 20px;">
                    ${[1,2,3,4,5].map(i => `
                        <button type="button" onclick="selectFeedbackRating(${i})" 
                            class="feedback-star" data-rating="${i}"
                            style="font-size: 32px; background: none; border: none; cursor: pointer; transition: transform 0.2s;">
                            ‚≠ê
                        </button>
                    `).join('')}
                </div>
                <input type="hidden" id="feedbackRating" value="0">
                
                <textarea id="feedbackMessage" class="textarea-field" 
                    placeholder="D√º≈ü√ºncelerinizi payla≈üƒ±n... (isteƒüe baƒülƒ±)" 
                    style="min-height: 100px; margin-bottom: 16px;"></textarea>
                
                <button class="primary-btn" style="width: 100%;" onclick="submitFeedback()">
                    üì© Geri Bildirim G√∂nder
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
};

window.selectFeedbackRating = function(rating) {
    document.getElementById('feedbackRating').value = rating;
    document.querySelectorAll('.feedback-star').forEach((star, i) => {
        star.style.transform = i < rating ? 'scale(1.2)' : 'scale(1)';
        star.style.filter = i < rating ? 'none' : 'grayscale(1)';
    });
};

window.submitFeedback = async function() {
    const rating = parseInt(document.getElementById('feedbackRating').value);
    const message = document.getElementById('feedbackMessage').value.trim();
    
    if (rating === 0) {
        showToast('L√ºtfen bir puan se√ßin', 'error');
        return;
    }
    
    await sendFeedback(rating, message);
    document.getElementById('feedbackModal')?.remove();
};

// 7. Hikaye sistemini kaldƒ±r - Neon banner KALDIRILDI
function removeStoriesOnly() {
    // Hikaye b√∂l√ºm√ºn√º kaldƒ±r
    const storiesSection = document.querySelector('.stories-section, .stories-container, [class*="stories"], #storiesContainer');
    if (storiesSection) {
        storiesSection.remove();
    }
    
    // Neon banner'ƒ± da kaldƒ±r (varsa)
    const neonBanner = document.getElementById('neonAgrolinkBanner');
    if (neonBanner) {
        neonBanner.remove();
    }
    
    // Eski neon banner'ƒ± da kaldƒ±r
    const agrolinkBanner = document.getElementById('agrolinkBanner');
    if (agrolinkBanner) {
        agrolinkBanner.remove();
    }
}
setTimeout(removeStoriesOnly, 300);

// 8. DM grup olu≈üturma d√ºzeltmesi ve mesaj balonlarƒ±nda isim/profil
let chatMessages = {};

function createGroupChat(memberIds, groupName) {
    const groupId = 'group_' + Date.now();
    const members = memberIds.map(id => {
        const user = users.find(u => u.id === id);
        return user || { id: id, username: 'Kullanƒ±cƒ±', avatar: 'https://via.placeholder.com/50' };
    });
    
    const newGroup = {
        id: groupId,
        name: groupName || members.map(m => m.username).slice(0, 3).join(', '),
        isGroup: true,
        members: members,
        avatar: members[0]?.avatar || 'https://via.placeholder.com/50',
        lastMessage: 'Grup olu≈üturuldu',
        timestamp: new Date().toISOString()
    };
    
    // Chats listesine ekle
    if (!window.chats) window.chats = [];
    window.chats.unshift(newGroup);
    chatMessages[groupId] = [];
    
    showToast('Grup olu≈üturuldu: ' + newGroup.name);
    renderChatList();
    openChat(groupId);
    
    return newGroup;
}

function renderChatMessage(message, chatId) {
    const isMe = message.senderId === currentUser.id;
    
    let content = '';
    if (message.type === 'post_share') {
        content = `
            <div class="shared-post-frame" onclick="viewSharedPost(${message.postId})">
                <img src="${message.postImage}" class="w-full h-32 object-cover rounded-lg">
                <div class="p-2 bg-white/5">
                    <p class="text-xs text-gray-400">@${message.postOwner}</p>
                    <p class="text-sm truncate">${message.postCaption || ''}</p>
                </div>
            </div>
        `;
    } else {
        content = `<p>${message.text || message.content}</p>`;
    }
    
    return `
        <div class="message-wrapper ${isMe ? 'flex-row-reverse' : ''} flex gap-2 mb-3">
            ${!isMe ? `
                <img src="${message.senderAvatar || 'https://via.placeholder.com/32'}" 
                     class="w-8 h-8 rounded-full object-cover flex-shrink-0">
            ` : ''}
            <div class="message-bubble ${isMe ? 'bg-green-600' : 'bg-gray-700'} rounded-2xl px-4 py-2 max-w-[70%]">
                ${!isMe ? `<p class="text-xs text-green-400 font-semibold mb-1">${message.senderName || 'Kullanƒ±cƒ±'}</p>` : ''}
                ${content}
                <p class="text-xs text-gray-400 mt-1">${formatTime(message.timestamp)}</p>
            </div>
        </div>
    `;
}

// Mesaj balonu stilleri
const messageBubbleStyle = document.createElement('style');
messageBubbleStyle.textContent = `
    .message-wrapper {
        display: flex;
        align-items: flex-end;
    }
    .shared-post-frame {
        border: 2px solid rgba(0,255,136,0.5);
        border-radius: 12px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s;
        max-width: 200px;
    }
    .shared-post-frame:hover {
        border-color: #00ff88;
        transform: scale(1.02);
    }
`;
document.head.appendChild(messageBubbleStyle);

// 9. Video hover ile otomatik oynatma
const videoHoverStyle = document.createElement('style');
videoHoverStyle.textContent = `
    .post-video {
        cursor: pointer;
    }
    .post-video:hover {
        outline: 2px solid #00ff88;
    }
`;
document.head.appendChild(videoHoverStyle);

function initVideoHoverPlay() {
    document.addEventListener('mouseenter', function(e) {
        if (e.target.tagName === 'VIDEO' && e.target.classList.contains('post-video')) {
            e.target.muted = false;
            e.target.play().catch(() => {});
        }
    }, true);
    
    document.addEventListener('mouseleave', function(e) {
        if (e.target.tagName === 'VIDEO' && e.target.classList.contains('post-video')) {
            e.target.pause();
        }
    }, true);
    
    // Touch cihazlar i√ßin
    document.addEventListener('touchstart', function(e) {
        if (e.target.tagName === 'VIDEO' && e.target.classList.contains('post-video')) {
            if (e.target.paused) {
                e.target.muted = false;
                e.target.play().catch(() => {});
            } else {
                e.target.pause();
            }
        }
    }, { passive: true });
}
initVideoHoverPlay();

// 10. Profil payla≈üma ve Post URL kopyalama
const MAIN_DOMAIN = 'https://sehitumitkestitarimmtal.com';

function shareProfile(userId) {
    const user = userId ? users.find(u => u.id === userId) : currentUser;
    if (!user) {
        showToast('Kullanƒ±cƒ± bulunamadƒ±', 'error');
        return;
    }
    const profileUrl = `${MAIN_DOMAIN}/profil/${user.username}`;
    
    // Clipboard'a kopyala ve kullanƒ±cƒ±ya g√∂ster
    navigator.clipboard.writeText(profileUrl).then(() => {
        showToast('Profil URL kopyalandƒ±!', 'success');
    }).catch(() => {});
    
    openShareModal(profileUrl, 'Profil', user.username);
}

function sharePost(postId) {
    const postUrl = `${MAIN_DOMAIN}/post/${postId}`;
    openShareModal(postUrl, 'Post', postId);
}

function openShareModal(url, type, id) {
    let modal = document.getElementById('shareUrlModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'shareUrlModal';
        modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4';
        document.body.appendChild(modal);
    }
    
    modal.innerHTML = `
        <div class="bg-gray-900 rounded-2xl p-6 w-full max-w-md animate-scale-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">${type} Payla≈ü</h3>
                <button onclick="closeShareModal()" class="p-2 hover:bg-white/10 rounded-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div class="bg-black/50 rounded-xl p-3 mb-4 flex items-center gap-2">
                <input type="text" value="${url}" readonly 
                       class="flex-1 bg-transparent text-sm text-gray-300 outline-none" id="shareUrlInput">
                <button onclick="copyShareUrl()" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg text-sm font-semibold transition">
                    Kopyala
                </button>
            </div>
            
            <div class="grid grid-cols-4 gap-4">
                <button onclick="shareToWhatsApp('${url}')" class="flex flex-col items-center gap-2 p-3 hover:bg-white/10 rounded-xl transition">
                    <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                    </div>
                    <span class="text-xs">WhatsApp</span>
                </button>
                <button onclick="shareToTwitter('${url}')" class="flex flex-col items-center gap-2 p-3 hover:bg-white/10 rounded-xl transition">
                    <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                    </div>
                    <span class="text-xs">X</span>
                </button>
                <button onclick="shareToTelegram('${url}')" class="flex flex-col items-center gap-2 p-3 hover:bg-white/10 rounded-xl transition">
                    <div class="w-12 h-12 bg-blue-400 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
                    </div>
                    <span class="text-xs">Telegram</span>
                </button>
                <button onclick="sendToDM('${url}')" class="flex flex-col items-center gap-2 p-3 hover:bg-white/10 rounded-xl transition">
                    <div class="w-12 h-12 bg-purple-500 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                    </div>
                    <span class="text-xs">DM</span>
                </button>
            </div>
        </div>
    `;
    
    modal.classList.remove('hidden');
}

function closeShareModal() {
    const modal = document.getElementById('shareUrlModal');
    if (modal) modal.classList.add('hidden');
}

function copyShareUrl() {
    const input = document.getElementById('shareUrlInput');
    input.select();
    document.execCommand('copy');
    navigator.clipboard.writeText(input.value).catch(() => {});
    showToast('URL kopyalandƒ±!');
}

function shareToWhatsApp(url) {
    window.open(`https://wa.me/?text=${encodeURIComponent(url)}`, '_blank');
}

function shareToTwitter(url) {
    window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}`, '_blank');
}

function shareToTelegram(url) {
    window.open(`https://t.me/share/url?url=${encodeURIComponent(url)}`, '_blank');
}

// Profil payla≈ü butonu ekleme
function addShareProfileButton() {
    const profileActions = document.querySelector('.profile-actions, .profile-buttons');
    if (profileActions && !document.getElementById('shareProfileBtn')) {
        const btn = document.createElement('button');
        btn.id = 'shareProfileBtn';
        btn.className = 'px-4 py-2 bg-white/10 hover:bg-white/20 rounded-xl flex items-center gap-2 transition';
        btn.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
            </svg>
            Profili Payla≈ü
        `;
        btn.onclick = () => shareProfile();
        profileActions.appendChild(btn);
    }
}
setTimeout(addShareProfileButton, 500);

// Yardƒ±mcƒ± fonksiyonlar
function formatTime(timestamp) {
    if (!timestamp) return '';
    const date = new Date(timestamp);
    return date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
}

function showToast(message) {
    let toast = document.getElementById('customToast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'customToast';
        toast.className = 'fixed bottom-24 left-1/2 -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-xl z-50 transition-all duration-300';
        document.body.appendChild(toast);
    }
    toast.textContent = message;
    toast.style.opacity = '1';
    toast.style.transform = 'translateX(-50%) translateY(0)';
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(-50%) translateY(20px)';
    }, 2500);
}

console.log('‚úÖ T√ºm yeni √∂zellikler y√ºklendi!');
console.log('  ‚Ä¢ Navigasyon UI yenileme d√ºzeltildi');
console.log('  ‚Ä¢ Bildirimler tam ekran + geri tu≈üu');
console.log('  ‚Ä¢ DM post payla≈üƒ±mƒ± √ßer√ßeve ile');
console.log('  ‚Ä¢ Yorum sil butonu CSS d√ºzeltildi');
console.log('  ‚Ä¢ Kaydedilen Videolar kaldƒ±rƒ±ldƒ±');
console.log('  ‚Ä¢ Geri bildirim: agrolink5252@gmail.com');
console.log('  ‚Ä¢ Hikayeler kaldƒ±rƒ±ldƒ±, AGROLINK SOSYAL neon eklendi');
console.log('  ‚Ä¢ DM grup olu≈üturma + mesaj isim/avatar');
console.log('  ‚Ä¢ Video hover oynatma aktif');
console.log('  ‚Ä¢ Profil ve post payla≈üƒ±mƒ±: ' + MAIN_DOMAIN);

// ==================== KONUM Sƒ∞STEMƒ∞ ====================

let userCurrentLocation = null;

// Otomatik konum al
async function getUserCurrentLocation() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject(new Error('Tarayƒ±cƒ±nƒ±z konum desteklemiyor'));
            return;
        }
        
        navigator.geolocation.getCurrentPosition(
            async (position) => {
                const { latitude, longitude } = position.coords;
                userCurrentLocation = { latitude, longitude };
                
                // Reverse geocoding ile ≈üehir/il√ße adƒ± al
                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json&accept-language=tr`
                    );
                    const data = await response.json();
                    const address = data.address || {};
                    userCurrentLocation.name = address.city || address.town || address.village || address.county || 'Bilinmeyen Konum';
                    userCurrentLocation.fullAddress = data.display_name || '';
                    console.log('üìç Konum alƒ±ndƒ±:', userCurrentLocation);
                } catch (e) {
                    userCurrentLocation.name = `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
                }
                
                resolve(userCurrentLocation);
            },
            (error) => {
                console.warn('Konum hatasƒ±:', error.message);
                reject(error);
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
        );
    });
}

// Konum se√ßici UI
function showLocationPicker() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'locationPickerModal';
    modal.style.zIndex = '10010';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">üìç Konum Ekle</h2>
                <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <div style="padding: 20px;">
                <button id="autoLocationBtn" class="primary-btn" style="width: 100%; margin-bottom: 16px;">
                    üìç Otomatik Konum Al
                </button>
                <div id="locationResult" style="display: none; background: rgba(16, 185, 129, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                    <p style="font-weight: 600; color: var(--primary-color); margin-bottom: 8px;">üìç Se√ßilen Konum:</p>
                    <p id="locationName" style="font-size: 16px;"></p>
                </div>
                <input type="text" id="manualLocationInput" class="form-input" placeholder="Veya manuel konum yazƒ±n..." style="margin-bottom: 16px;">
                <button class="primary-btn" style="width: 100%;" onclick="confirmLocation()">‚úì Konumu Ekle</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    document.getElementById('autoLocationBtn').onclick = async () => {
        const btn = document.getElementById('autoLocationBtn');
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Konum alƒ±nƒ±yor...';
        
        try {
            const loc = await getUserCurrentLocation();
            document.getElementById('locationResult').style.display = 'block';
            document.getElementById('locationName').textContent = loc.name;
            document.getElementById('manualLocationInput').value = loc.name;
            btn.innerHTML = '‚úÖ Konum alƒ±ndƒ±';
        } catch (e) {
            showToast('Konum alƒ±namadƒ±: ' + e.message);
            btn.disabled = false;
            btn.innerHTML = 'üìç Otomatik Konum Al';
        }
    };
}

function confirmLocation() {
    const manualInput = document.getElementById('manualLocationInput')?.value?.trim();
    if (manualInput) {
        window.selectedPostLocation = {
            name: manualInput,
            latitude: userCurrentLocation?.latitude || null,
            longitude: userCurrentLocation?.longitude || null
        };
        updateLocationDisplay();
    }
    document.getElementById('locationPickerModal')?.remove();
}

function updateLocationDisplay() {
    let display = document.getElementById('postLocationDisplay');
    if (!display) {
        const pollArea = document.getElementById('commentPermissionArea');
        if (pollArea) {
            display = document.createElement('div');
            display.id = 'postLocationDisplay';
            display.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: rgba(16, 185, 129, 0.1); border-radius: 12px; margin-bottom: 16px;';
            pollArea.parentNode.insertBefore(display, pollArea);
        }
    }
    
    if (display && window.selectedPostLocation) {
        display.innerHTML = `
            <span style="color: var(--primary-color);">üìç</span>
            <span style="flex: 1; color: rgba(255,255,255,0.9);">${window.selectedPostLocation.name}</span>
            <button type="button" onclick="removePostLocation()" style="background: rgba(239,68,68,0.2); color: #ef4444; border: none; padding: 4px 8px; border-radius: 6px; cursor: pointer;">√ó</button>
        `;
    }
}

function removePostLocation() {
    window.selectedPostLocation = null;
    const display = document.getElementById('postLocationDisplay');
    if (display) display.remove();
}

// Post form'a konum butonu ekle
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        const actions = document.querySelector('.fullscreen-post-actions');
        if (actions && !document.getElementById('addLocationBtn')) {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.id = 'addLocationBtn';
            btn.className = 'media-upload-label';
            btn.style.cssText = 'flex: 1; margin: 0; background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3); color: #3b82f6; cursor: pointer;';
            btn.innerHTML = 'üìç Konum Ekle';
            btn.onclick = showLocationPicker;
            actions.appendChild(btn);
        }
    }, 1000);
});

// ==================== GELƒ∞≈ûMƒ∞≈û ANKET Sƒ∞STEMƒ∞ ====================

// Anket oy verme
window.votePoll = async function(postId, optionId) {
    try {
        const response = await apiRequest(`/api/posts/${postId}/poll/vote`, {
            method: 'POST',
            body: JSON.stringify({ optionId }),
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
            const data = await response.json();
            showToast('Oyunuz kaydedildi! ‚úì');
            updatePollUI(postId, data.pollOptions, data.totalVotes, optionId);
        } else {
            const err = await response.json();
            showToast(err.error || 'Oy verilemedi');
        }
    } catch (error) {
        console.error('Poll vote error:', error);
        showToast('Baƒülantƒ± hatasƒ±');
    }
};

function updatePollUI(postId, options, totalVotes, votedId) {
    const container = document.querySelector(`[data-poll-id="${postId}"]`);
    if (!container) return;
    
    container.innerHTML = options.map(opt => {
        const percentage = totalVotes > 0 ? Math.round((opt.votes / totalVotes) * 100) : 0;
        const isVoted = opt.id === votedId;
        return `
            <div class="poll-option-result" style="position: relative; padding: 12px 16px; background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 8px; overflow: hidden; ${isVoted ? 'border: 2px solid var(--primary-color);' : ''}">
                <div style="position: absolute; left: 0; top: 0; height: 100%; width: ${percentage}%; background: linear-gradient(90deg, rgba(16, 185, 129, 0.3), rgba(16, 185, 129, 0.1)); transition: width 0.5s ease;"></div>
                <div style="position: relative; display: flex; justify-content: space-between; align-items: center;">
                    <span>${isVoted ? '‚úì ' : ''}${opt.text}</span>
                    <span style="font-weight: 700; color: var(--primary-color);">${percentage}%</span>
                </div>
            </div>
        `;
    }).join('') + `<p style="text-align: center; color: #64748b; font-size: 12px; margin-top: 8px;">Toplam ${totalVotes} oy</p>`;
}

// ==================== MAVƒ∞ Tƒ∞K DOƒûRULAMA ====================

window.requestVerificationReal = async function() {
    try {
        const response = await apiRequest('/api/users/verification/instant', {
            method: 'POST'
        });
        
        if (response.ok) {
            const data = await response.json();
            showToast(data.message);
            
            // UI g√ºncelle
            if (currentUser) {
                currentUser.isVerified = true;
                localStorage.setItem('agrolink_user', JSON.stringify(currentUser));
            }
            
            // Sayfayƒ± yenile
            setTimeout(() => location.reload(), 1500);
        } else {
            const err = await response.json();
            showToast(err.error || 'Doƒürulama ba≈üarƒ±sƒ±z');
        }
    } catch (error) {
        console.error('Verification error:', error);
        showToast('Baƒülantƒ± hatasƒ±');
    }
};

// Doƒürulama modalƒ±nƒ± g√ºncelle
window.showVerificationModal = function() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'verificationModal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 420px;">
            <div class="modal-header">
                <h2 class="modal-title">‚úì Doƒürulanmƒ±≈ü Hesap</h2>
                <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <div style="padding: 20px;">
                <div style="text-align: center; margin-bottom: 24px;">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="white"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
                    </div>
                    <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 8px;">Mavi Tik Rozeti Al</h3>
                    <p style="color: #64748b;">Doƒürulanmƒ±≈ü hesap rozeti, g√ºvenilirliƒüinizi artƒ±rƒ±r.</p>
                </div>
                
                <div style="background: rgba(59, 130, 246, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                    <h4 style="color: #3b82f6; margin-bottom: 12px;">‚ú® Avantajlar:</h4>
                    <ul style="color: #64748b; font-size: 14px; padding-left: 20px; line-height: 1.8;">
                        <li>Profilinizde mavi tik rozeti</li>
                        <li>G√∂nderilerinizde doƒürulama i≈üareti</li>
                        <li>Daha fazla g√ºvenilirlik</li>
                        <li>√ñncelikli destek</li>
                    </ul>
                </div>
                
                <button class="primary-btn" style="width: 100%;" onclick="requestVerificationReal(); this.closest('.modal').remove();">
                    ‚úì Doƒürulanmƒ±≈ü Rozet Al
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
};

// ==================== G√ñNDERƒ∞ PAYLA≈ûIM G√úNCELLEMESƒ∞ ====================

// Mevcut submitPostWithFeatures'ƒ± g√ºncelle
const originalSubmitPost = window.submitPostWithFeatures;
window.submitPostWithFeatures = async function() {
    const isPollMode = document.getElementById('pollPostBtn')?.classList.contains('active');
    const allowComments = document.getElementById('allowCommentsCheckbox')?.checked !== false;
    
    const formData = new FormData();
    formData.append('allowComments', allowComments);
    
    // Konum ekle
    if (window.selectedPostLocation) {
        formData.append('locationName', window.selectedPostLocation.name);
        if (window.selectedPostLocation.latitude) {
            formData.append('latitude', window.selectedPostLocation.latitude);
            formData.append('longitude', window.selectedPostLocation.longitude);
        }
    }
    
    if (isPollMode) {
        const pollQuestion = document.getElementById('pollQuestion')?.value?.trim();
        const pollOptions = Array.from(document.querySelectorAll('.poll-option')).map(input => input.value.trim()).filter(v => v);
        
        if (!pollQuestion) {
            showToast('Anket sorusu gereklidir', 'error');
            return;
        }
        if (pollOptions.length < 2) {
            showToast('En az 2 ≈üƒ±k gereklidir', 'error');
            return;
        }
        
        formData.append('isPoll', 'true');
        formData.append('pollQuestion', pollQuestion);
        formData.append('pollOptions', JSON.stringify(pollOptions));
        formData.append('content', pollQuestion);
    } else {
        const content = document.getElementById('postContent')?.value || '';
        formData.append('content', content);
        
        if (window.uploadedMediaFile) {
            formData.append('media', window.uploadedMediaFile);
        }
    }
    
    const submitBtn = document.getElementById('submitPost');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '‚è≥ Payla≈üƒ±lƒ±yor...';
    }
    
    try {
        const response = await apiRequest('/api/posts', { method: 'POST', body: formData, headers: {} });
        if (response.ok) {
            showToast('G√∂nderi payla≈üƒ±ldƒ±! ‚úì', 'success');
            document.getElementById('addPostModal').classList.remove('active');
            loadFeed();
            // Reset form
            document.getElementById('postContent').value = '';
            document.getElementById('pollQuestion').value = '';
            document.querySelectorAll('.poll-option').forEach((input, i) => { if (i < 2) input.value = ''; else input.parentElement.remove(); });
            document.getElementById('mediaPreview').innerHTML = '';
            window.uploadedMediaFile = null;
            window.selectedPostLocation = null;
            removePostLocation();
        } else {
            const data = await response.json();
            showToast(data.error || 'Payla≈üƒ±m ba≈üarƒ±sƒ±z', 'error');
        }
    } catch (error) {
        console.error('Post error:', error);
        showToast('Baƒülantƒ± hatasƒ±', 'error');
    }
    
    if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'üöÄ Payla≈ü';
    }
};

console.log('‚úÖ Geli≈ümi≈ü √∂zellikler y√ºklendi:');
console.log('  ‚Ä¢ Konum ekleme sistemi');
console.log('  ‚Ä¢ Anket oy verme (backend)');
console.log('  ‚Ä¢ Mavi tik doƒürulama (backend)');
console.log('  ‚Ä¢ Geri bildirim sistemi');
console.log('  ‚Ä¢ √áift√ßi profili sistemi');
console.log('  ‚Ä¢ Grup sohbet sistemi');
console.log('  ‚Ä¢ Profil payla≈üma URL');
console.log('  ‚Ä¢ HTML g√ºvenlik korumasƒ±');

// ==================== √áƒ∞FT√áƒ∞ PROFƒ∞Lƒ∞ OLU≈ûTURMA ====================

// T√ºrkiye'nin 81 ili
const TURKEY_PROVINCES = [
    'Adana', 'Adƒ±yaman', 'Afyonkarahisar', 'Aƒürƒ±', 'Amasya', 'Ankara', 'Antalya', 'Artvin',
    'Aydƒ±n', 'Balƒ±kesir', 'Bilecik', 'Bing√∂l', 'Bitlis', 'Bolu', 'Burdur', 'Bursa',
    '√áanakkale', '√áankƒ±rƒ±', '√áorum', 'Denizli', 'Diyarbakƒ±r', 'Edirne', 'Elazƒ±ƒü', 'Erzincan',
    'Erzurum', 'Eski≈üehir', 'Gaziantep', 'Giresun', 'G√ºm√º≈ühane', 'Hakkari', 'Hatay', 'Isparta',
    'Mersin', 'ƒ∞stanbul', 'ƒ∞zmir', 'Kars', 'Kastamonu', 'Kayseri', 'Kƒ±rklareli', 'Kƒ±r≈üehir',
    'Kocaeli', 'Konya', 'K√ºtahya', 'Malatya', 'Manisa', 'Kahramanmara≈ü', 'Mardin', 'Muƒüla',
    'Mu≈ü', 'Nev≈üehir', 'Niƒüde', 'Ordu', 'Rize', 'Sakarya', 'Samsun', 'Siirt', 'Sinop',
    'Sivas', 'Tekirdaƒü', 'Tokat', 'Trabzon', 'Tunceli', '≈ûanlƒ±urfa', 'U≈üak', 'Van',
    'Yozgat', 'Zonguldak', 'Aksaray', 'Bayburt', 'Karaman', 'Kƒ±rƒ±kkale', 'Batman', '≈ûƒ±rnak',
    'Bartƒ±n', 'Ardahan', 'Iƒüdƒ±r', 'Yalova', 'Karab√ºk', 'Kilis', 'Osmaniye', 'D√ºzce'
];

let hasFarmerProfile = false;
let farmerProfileData = null;

// √áift√ßi profili kontrol et
async function checkFarmerProfile() {
    try {
        const response = await apiRequest('/api/farmer-profile/check');
        if (response.ok) {
            const data = await response.json();
            hasFarmerProfile = data.hasFarmerProfile;
            return hasFarmerProfile;
        }
    } catch (error) {
        console.error('√áift√ßi profili kontrol hatasƒ±:', error);
    }
    return false;
}

// √áift√ßi profili modal
window.openFarmerProfileModal = function() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'farmerProfileModal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10010; display: flex; align-items: center; justify-content: center; padding: 20px;';
    
    modal.innerHTML = `
        <div style="background: var(--card-light); border-radius: 24px; padding: 32px; width: 100%; max-width: 450px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.4s ease;">
            <div style="text-align: center; margin-bottom: 24px;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; font-size: 40px;">üåæ</div>
                <h2 style="font-size: 24px; font-weight: 800; color: var(--text-light); margin-bottom: 8px;">√áift√ßi Profili Olu≈ütur</h2>
                <p style="color: #64748b; font-size: 14px;">Maƒüazaya √ºr√ºn eklemek i√ßin √ßift√ßi profili gereklidir</p>
            </div>
            
            <form id="farmerProfileForm" style="display: flex; flex-direction: column; gap: 20px;">
                <div style="text-align: center;">
                    <div id="farmerPicPreview" style="width: 100px; height: 100px; border-radius: 50%; background: rgba(16,185,129,0.1); border: 3px dashed #10b981; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; cursor: pointer; overflow: hidden; font-size: 40px;" onclick="document.getElementById('farmerProfilePic').click()">
                        üë®‚Äçüåæ
                    </div>
                    <input type="file" id="farmerProfilePic" accept="image/*" style="display: none;" onchange="previewFarmerPic(this)">
                    <p style="font-size: 12px; color: #64748b;">√áift√ßi profil fotoƒürafƒ±</p>
                </div>
                
                <div>
                    <label style="font-size: 14px; font-weight: 600; color: var(--text-light); display: block; margin-bottom: 8px;">Ka√ß yƒ±llƒ±k √ºreticisiniz?</label>
                    <input type="number" id="farmerYears" min="0" max="100" class="form-input" placeholder="√ñrn: 5" required>
                </div>
                
                <div>
                    <label style="font-size: 14px; font-weight: 600; color: var(--text-light); display: block; margin-bottom: 8px;">Hangi b√∂lgedesiniz?</label>
                    <select id="farmerProvince" class="form-input" required style="padding: 14px 18px;">
                        <option value="">ƒ∞l se√ßin...</option>
                        ${TURKEY_PROVINCES.map(p => `<option value="${p}">${p}</option>`).join('')}
                    </select>
                </div>
                
                <button type="submit" class="primary-btn" style="margin-top: 12px;">
                    üåæ √áift√ßi Profili Olu≈ütur
                </button>
                
                <button type="button" onclick="this.closest('.modal').remove()" style="background: rgba(0,0,0,0.05); border: none; padding: 12px; border-radius: 12px; cursor: pointer; color: #64748b; font-weight: 600;">
                    ƒ∞ptal
                </button>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    document.getElementById('farmerProfileForm').onsubmit = async function(e) {
        e.preventDefault();
        
        const years = document.getElementById('farmerYears').value;
        const province = document.getElementById('farmerProvince').value;
        const picFile = document.getElementById('farmerProfilePic').files[0];
        
        if (!years || !province) {
            showToast('T√ºm alanlarƒ± doldurun', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('yearsOfExperience', years);
        formData.append('province', province);
        if (picFile) {
            formData.append('profilePic', picFile);
        }
        
        const btn = this.querySelector('.primary-btn');
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Olu≈üturuluyor...';
        
        try {
            const response = await apiRequest('/api/farmer-profile', {
                method: 'POST',
                body: formData,
                headers: {}
            });
            
            if (response.ok) {
                const data = await response.json();
                showToast(data.message, 'success');
                hasFarmerProfile = true;
                farmerProfileData = data.farmerProfile;
                modal.remove();
                updateFarmerProfileButton();
            } else {
                const err = await response.json();
                showToast(err.error || 'Hata olu≈ütu', 'error');
            }
        } catch (error) {
            console.error('√áift√ßi profili olu≈üturma hatasƒ±:', error);
            showToast('Baƒülantƒ± hatasƒ±', 'error');
        }
        
        btn.disabled = false;
        btn.innerHTML = 'üåæ √áift√ßi Profili Olu≈ütur';
    };
};

function previewFarmerPic(input) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('farmerPicPreview').innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
    };
    reader.readAsDataURL(file);
}

// Sol √ºste √ßift√ßi profili butonu ekle
function updateFarmerProfileButton() {
    let btn = document.getElementById('farmerProfileBtn');
    
    if (hasFarmerProfile) {
        // √áift√ßi profili var - profil resmi g√∂ster
        if (btn) {
            if (farmerProfileData && farmerProfileData.profilePic) {
                const imgUrl = farmerProfileData.profilePic.startsWith('http') ? farmerProfileData.profilePic : API_BASE + farmerProfileData.profilePic;
                btn.innerHTML = `<img src="${imgUrl}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
            } else {
                btn.innerHTML = 'üë®‚Äçüåæ';
            }
            btn.onclick = viewOwnFarmerProfile;
        }
    } else {
        // √áift√ßi profili yok - olu≈ütur butonu
        if (!btn) {
            const header = document.querySelector('.header-actions');
            if (header) {
                btn = document.createElement('button');
                btn.id = 'farmerProfileBtn';
                btn.className = 'icon-btn';
                btn.style.cssText = 'width: 42px; height: 42px; border-radius: 50%; background: linear-gradient(135deg, #10b981, #059669); color: white; font-size: 18px; overflow: hidden;';
                btn.innerHTML = 'üåæ';
                btn.title = '√áift√ßi Profili Olu≈ütur';
                btn.onclick = openFarmerProfileModal;
                header.insertBefore(btn, header.firstChild);
            }
        }
    }
}

// Kendi √ßift√ßi profilini g√∂r√ºnt√ºle
async function viewOwnFarmerProfile() {
    try {
        const response = await apiRequest('/api/farmer-profile');
        if (response.ok) {
            const data = await response.json();
            if (data.hasFarmerProfile) {
                showFarmerProfileView(data.farmerProfile);
            }
        }
    } catch (error) {
        console.error('√áift√ßi profili g√∂r√ºnt√ºleme hatasƒ±:', error);
    }
}

function showFarmerProfileView(profile) {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.style.zIndex = '10012';
    
    const imgUrl = profile.profilePic ? (profile.profilePic.startsWith('http') ? profile.profilePic : API_BASE + profile.profilePic) : '';
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div class="modal-header">
                <h2 class="modal-title">üåæ √áift√ßi Profilim</h2>
                <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <div style="padding: 24px;">
                <div style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; font-size: 48px; overflow: hidden; border: 3px solid white; box-shadow: 0 8px 24px rgba(16,185,129,0.3);">
                    ${imgUrl ? `<img src="${imgUrl}" style="width: 100%; height: 100%; object-fit: cover;">` : 'üë®‚Äçüåæ'}
                </div>
                <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 8px;">${profile.name || profile.username || '√áift√ßi'}</h3>
                <p style="color: var(--primary-color); font-weight: 600; margin-bottom: 16px;">üåæ ${profile.yearsOfExperience} Yƒ±llƒ±k √úretici</p>
                <p style="color: #64748b; font-size: 14px;">üìç ${profile.province}</p>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Sayfa y√ºklendiƒüinde √ßift√ßi profili kontrol et
document.addEventListener('DOMContentLoaded', async () => {
    setTimeout(async () => {
        await checkFarmerProfile();
        updateFarmerProfileButton();
    }, 1500);
});

// Maƒüazada √ºr√ºn ekleme kontrol√º
const originalAddProductBtn = document.getElementById('addProductBtn');
if (originalAddProductBtn) {
    const originalClick = originalAddProductBtn.onclick;
    originalAddProductBtn.onclick = async function(e) {
        if (!hasFarmerProfile) {
            e.preventDefault();
            showToast('√ñnce √ßift√ßi profili olu≈üturmalƒ±sƒ±nƒ±z!', 'error');
            openFarmerProfileModal();
            return;
        }
        if (originalClick) originalClick.call(this, e);
    };
}

// ==================== HTML G√úVENLƒ∞K KORUMASI ====================

// XSS korumasƒ± - t√ºm kullanƒ±cƒ± girdilerini sanitize et
function sanitizeHTML(str) {
    if (!str) return '';
    const temp = document.createElement('div');
    temp.textContent = str;
    return temp.innerHTML;
}

// SQL Injection korumasƒ± - t√ºm sorgularda parametreli sorgular kullanƒ±lƒ±yor (backend)

// CSRF korumasƒ±
function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]')?.content || '';
}

// DevTools algƒ±lama
(function() {
    const element = new Image();
    let devtoolsOpen = false;
    
    Object.defineProperty(element, 'id', {
        get: function() {
            devtoolsOpen = true;
            console.clear();
            console.log('%c‚ö†Ô∏è G√ºvenlik Uyarƒ±sƒ±!', 'color: red; font-size: 24px; font-weight: bold;');
            console.log('%cBu konsolda kod √ßalƒ±≈ütƒ±rmak hesabƒ±nƒ±zƒ±n tehlikeye girmesine neden olabilir.', 'font-size: 16px;');
        }
    });
    
    setInterval(function() {
        devtoolsOpen = false;
        console.log(element);
    }, 1000);
})();

// Saƒü tƒ±k engelleme (opsiyonel)
document.addEventListener('contextmenu', function(e) {
    if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
        // e.preventDefault(); // ƒ∞steƒüe baƒülƒ± olarak aktif edilebilir
    }
});

// Kopyalama korumasƒ± (opsiyonel)
document.addEventListener('copy', function(e) {
    // Belirli i√ßeriklerin kopyalanmasƒ±nƒ± engelle
});

// Konsol mesajlarƒ± temizleme
console.clear();
console.log('%cüåæ AgroLink', 'color: #10b981; font-size: 32px; font-weight: bold;');
console.log('%cTarƒ±m Sosyal Platformu', 'color: #64748b; font-size: 14px;');
console.log('%cSalih √ñzt√ºrk tarafƒ±ndan geli≈ütirilmi≈ütir', 'color: #64748b; font-size: 12px;');

</script>
</body>
</html>